<html lang="en"><head><meta content="text/html; charset=utf-8" http-equiv="Content-Type"><meta content="width=device-width, initial-scale=1" name="viewport"><meta content="Hi!
I&#39;m evaluating Dhall for generating configs for Fedora CoreOS clusters. There is one topic that I haven&#39;t found any info on: that is secrets handling.
1) Ideally, the configuration generation should entail reading secrets from external databases and creating random secrets on-the-fly. As far as " name="description"><link href="https://funprog.srid.ca/dhall/secrets.html" rel="canonical"><meta property="og:title" content="Secrets - Dhall"><meta property="og:site_name" content="Functional Programming Zulip Archive"><meta property="og:type" content="article"><meta property="og:article:section" content="Dhall"><meta property="og:article:modified_time" content="2020-08-06T14:48:30Z"><meta property="og:article:published_time" content="2020-08-06T08:45:22Z"><title>Secrets - Dhall</title><style type="text/css">
div#thesite
{
  font-family   : "Open Sans", sans-serif;
  font-size     : 1em !important;
  margin-top    : 1em;
  margin-bottom : 1em;
}

div#thesite h1
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite h2
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite h3
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite h4
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite h5
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite h6
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite .ui.breadcrumb.rib .section
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite .header
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite .as-header
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite code, pre, tt
{
  font-family : "SFMono-Regular","Menlo","Monaco","Consolas","Liberation Mono","Courier New", monospace;
}

div#thesite .ui.breadcrumb.rib
{
  margin-bottom : 1em;
}



div#thesite .ui.comments.messages .comment .metadata a
{
  color : #808080;
}

div#thesite .ui.comments.messages .comment a.avatar img
{
  height : auto;
}

div#thesite .subtle
{
  color : #808080;
}


div#thesite .messages pre
{
  font-size : 85%;
  overflow  : auto;
  max-width : 100%;
}

div#thesite .messages .message_embed
{
  border-left  : solid 3px #808080;
  padding-left : 0.69999em;
}

div#thesite .messages .message_inline_image img
{
  max-width     : 100%;
  margin-bottom : 1em;
}


/* Generated with Clay, http://fvisser.nl/clay */</style><link href="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.4.1/semantic.min.css" rel="stylesheet"><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/all.min.css" rel="stylesheet"><link href="https://fonts.googleapis.com/css?family=Open+Sans|Oswald&amp;display=swap" rel="stylesheet"><link href="https://fonts.googleapis.com/css?family=Roboto|Open+Sans&amp;display=swap" rel="stylesheet"></head><body><div id="thesite" class="ui text container"><div class="ui violet inverted top attached center aligned segment"><h1 class="ui huge header">Secrets - Dhall</h1></div><div class="ui attached segment"><div class="ui message"><p>Welcome to the Functional Programming Zulip Chat Archive. You can join the chat <a href="https://funprog.zulipchat.com">here</a>.</p></div><div class="ui breadcrumb rib"><a href="/" class="section">Home</a><i class="right angle icon divider"></i><a href="/dhall/" class="section">#Dhall</a><i class="right angle icon divider"></i><div class="active section">Secrets</div></div><div class="ui comments messages"><div class="comment"><a class="avatar"><img src="https://www.gravatar.com/avatar/7156f7e41738f4adc9cb91c3da670e1e"></a><div class="content"><a class="author">Barnabás Králik</a><div class="metadata"><a href="#206116830" name="206116830"><div>2020-08-06 08:45:22</div></a></div><div class="text"><p>Hi!</p>
<p>I'm evaluating Dhall for generating configs for Fedora CoreOS clusters. There is one topic that I haven't found any info on: that is secrets handling.<br>
1) Ideally, the configuration generation should entail reading secrets from external databases and creating random secrets on-the-fly. As far as I understand this is contrary to Dhall's core concepts. Is there some "unsafe" hack to still do this by e.g. calling an external executable and using its output as import?<br>
2) Is there any way to mark a value as 'secret', i.e. one that should not be shown in debug/error messages, just in the direct output?</p>
<p>Thanks for any input!</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/24b62e7b62bbbc0f4f0617b5ccd66e6f8fe784f6?version=2"></a><div class="content"><a class="author">tristanC</a><div class="metadata"><a href="#206130721" name="206130721"><div>2020-08-06 11:53:08</div></a></div><div class="text"><p>Hello o/</p>
<p>1) You could cheat and read random Text using an http import, e.g. <code>let secret = http://localhost:8080/secret-generator as Text in secret</code>. Though this is unsafe as this requires an extra service to serve the data. Another solution would be to run a secret creation command before interpreting Dhall to import its output using an intermediate file. e.g. <code>uuidgen &gt; .build/secret.txt</code> and then <code>let secret = ./.build/secret.txt in secret</code><br>
2) Have you tried using the <code>--censor</code> flag of the dhall-haskell implementation?</p></div></div></div><div class="comment"><a class="avatar"><img src="https://www.gravatar.com/avatar/7156f7e41738f4adc9cb91c3da670e1e"></a><div class="content"><a class="author">Barnabás Králik</a><div class="metadata"><a href="#206138100" name="206138100"><div>2020-08-06 13:09:59</div></a></div><div class="text"><p>2) Thanks! Should be sufficient.</p>
<p>1) The file-based attempt would be the best shot at this issue then. This would then require a two-stage compilation: firstly, I'll need to get a list of nonexistent secrets, then run the generator, then run dhall again with all the secrets readily available. What I don't see yet is how I'd be able to collect all the secrets scattered around the huge nested record that the configuration is. I would like to keep the configuration as low in syntactic noise as possible, so using some special type instead of records is a no-go. Is there some way to deconstruct any record into e.g. [{ a : Type, b : a }] ?</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/24b62e7b62bbbc0f4f0617b5ccd66e6f8fe784f6?version=2"></a><div class="content"><a class="author">tristanC</a><div class="metadata"><a href="#206139148" name="206139148"><div>2020-08-06 13:19:33</div></a></div><div class="text"><p>Could you share a sample of that Fedora CoreOS cluster config looks like?</p>
<p>One way to manage such thing is by passing the secrets as a record, for example your configuration would look like this:</p>
<div class="codehilite"><pre><span></span><code>let Secrets = { root-password : Text, api-token : Text }
in \(secrets : Secrets) -&gt;
    let config = {
         nested = {
            root-password = secrets.root-password
        }
     }
    in config
</code></pre></div>


<p>That way your configuration becomes a function that takes the secrets as an argument.</p>
<p>Then the first stage would ensure a secret record exists, for example <code>echo "{ root-password = \"$(uuidgen)\", api-token = \"$(uuidgen)\" }" &gt; .build/secrets.dhall</code></p>
<p>And the second stage would interpret the config function like so: <code>dhall-to-yaml &lt;&lt;&lt; './config.dhall ./.build/secrets.dhall'</code></p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/24b62e7b62bbbc0f4f0617b5ccd66e6f8fe784f6?version=2"></a><div class="content"><a class="author">tristanC</a><div class="metadata"><a href="#206139448" name="206139448"><div>2020-08-06 13:22:16</div></a></div><div class="text"><p>Actually it's probably better to generate a json or yaml file using whatever tool, then the second stage would be: <code>dhall-to-yaml &lt;&lt;&lt; "./config.dhall $(json-to-dhall ./.build/secrets.json)"</code>  (use yaml-to-dhall instead if needed)</p></div></div></div><div class="comment"><a class="avatar"><img src="https://www.gravatar.com/avatar/7156f7e41738f4adc9cb91c3da670e1e"></a><div class="content"><a class="author">Barnabás Králik</a><div class="metadata"><a href="#206147959" name="206147959"><div>2020-08-06 14:25:52</div></a></div><div class="text"><p>Sorry, I can't show anything right now that would add to this conversation.</p>
<p>So as a  first  step, I should have a record with all the required secrets as fields in it and a dhall file ("secrets database") that contains a value of this type. When extending the record type with a new field, the database would not match, thus I need to generate values for  the missing files. How do I get to know which fields are missing? My only bad idea is specifying these as Optional and then adding a default None value, then doing something non-Dhall.</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/24b62e7b62bbbc0f4f0617b5ccd66e6f8fe784f6?version=2"></a><div class="content"><a class="author">tristanC</a><div class="metadata"><a href="#206149196" name="206149196"><div>2020-08-06 14:35:12</div></a></div><div class="text"><p>Here is a more concrete example of that workflow. This <a href="https://opendev.org/zuul/zuul-operator/src/branch/master/conf/zuul/input.dhall">input.dhall</a> file defines a completable record (schema) of the input (used by <a href="https://opendev.org/zuul/zuul-operator/src/branch/master/conf/zuul/resources.dhall">this function</a>. Then here is how to evaluate the configuration: <a href="https://opendev.org/zuul/zuul-operator/src/branch/master/CONTRIBUTE.md#user-content-evaluate-the-dhall-expression-manually">procedure</a>.</p>
<p>In other words, if your input type is defined in an <code>input.dhall</code> file, then using <code>(yaml|json)-to-dhall './input.dhall' &lt; generated-input</code> result in a valid record with the optional attribute set to None.</p>
<div class="message_embed"><a class="message_embed_image" href="https://opendev.org/zuul/zuul-operator/src/branch/master/conf/zuul/input.dhall" style="background-image: url(https://opendev.org/user/avatar/zuul/-1)"></a><div class="data-container"><div class="message_embed_title"><a href="https://opendev.org/zuul/zuul-operator/src/branch/master/conf/zuul/input.dhall" title="zuul-operator">zuul-operator</a></div><div class="message_embed_description">A Kubernetes Operator for Zuul</div></div></div><div class="message_embed"><a class="message_embed_image" href="https://opendev.org/zuul/zuul-operator/src/branch/master/conf/zuul/resources.dhall" style="background-image: url(https://opendev.org/user/avatar/zuul/-1)"></a><div class="data-container"><div class="message_embed_title"><a href="https://opendev.org/zuul/zuul-operator/src/branch/master/conf/zuul/resources.dhall" title="zuul-operator">zuul-operator</a></div><div class="message_embed_description">A Kubernetes Operator for Zuul</div></div></div><div class="message_embed"><a class="message_embed_image" href="https://opendev.org/zuul/zuul-operator/src/branch/master/CONTRIBUTE.md#user-content-evaluate-the-dhall-expression-manually" style="background-image: url(https://opendev.org/user/avatar/zuul/-1)"></a><div class="data-container"><div class="message_embed_title"><a href="https://opendev.org/zuul/zuul-operator/src/branch/master/CONTRIBUTE.md#user-content-evaluate-the-dhall-expression-manually" title="zuul-operator">zuul-operator</a></div><div class="message_embed_description">A Kubernetes Operator for Zuul</div></div></div></div></div></div><div class="comment"><a class="avatar"><img src="https://www.gravatar.com/avatar/7156f7e41738f4adc9cb91c3da670e1e"></a><div class="content"><a class="author">Barnabás Králik</a><div class="metadata"><a href="#206151042" name="206151042"><div>2020-08-06 14:48:30</div></a></div><div class="text"><p>Thank you!</p></div></div></div></div></div><div class="ui vertical footer segment"><a href="https://github.com/srid/zulip-archive">Powered by Haskell</a> | Questions? Contact <a href="https://www.srid.ca">srid</a></div></div></body></html>