<html lang="en"><head><meta content="text/html; charset=utf-8" http-equiv="Content-Type"><meta content="width=device-width, initial-scale=1" name="viewport"><meta content="Does polysemy&#39;s async from the Polysemy.Async package have the same gotchas as its equivalent in the async package itself?
The async package recommends to use withAsync to avoid thread leaks. Would this be a problem with polysemy&#39;s async function?" name="description"><link href="https://funprog.srid.ca/polysemy/async.html" rel="canonical"><meta property="og:title" content="Async - Polysemy"><meta property="og:site_name" content="Functional Programming Zulip Archive"><meta property="og:type" content="article"><meta property="og:article:section" content="Polysemy"><meta property="og:article:modified_time" content="2022-03-09T08:01:38Z"><meta property="og:article:published_time" content="2022-03-09T02:24:01Z"><title>Async - Polysemy</title><style type="text/css">
div#thesite
{
  font-family   : "Open Sans", sans-serif;
  font-size     : 1em !important;
  margin-top    : 1em;
  margin-bottom : 1em;
}

div#thesite h1
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite h2
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite h3
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite h4
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite h5
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite h6
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite .ui.breadcrumb.rib .section
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite .header
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite .as-header
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite code, pre, tt
{
  font-family : "SFMono-Regular","Menlo","Monaco","Consolas","Liberation Mono","Courier New", monospace;
}

div#thesite .ui.breadcrumb.rib
{
  margin-bottom : 1em;
}



div#thesite .ui.comments.messages .comment .metadata a
{
  color : #808080;
}

div#thesite .ui.comments.messages .comment a.avatar img
{
  height : auto;
}

div#thesite .subtle
{
  color : #808080;
}


div#thesite .messages pre
{
  font-size : 85%;
  overflow  : auto;
  max-width : 100%;
}

div#thesite .messages .message_embed
{
  border-left  : solid 3px #808080;
  padding-left : 0.69999em;
}

div#thesite .messages .message_inline_image img
{
  max-width     : 100%;
  margin-bottom : 1em;
}


/* Generated with Clay, http://fvisser.nl/clay */</style><link href="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.4.1/semantic.min.css" rel="stylesheet"><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/all.min.css" rel="stylesheet"><link href="https://fonts.googleapis.com/css?family=Open+Sans|Oswald&amp;display=swap" rel="stylesheet"><link href="https://fonts.googleapis.com/css?family=Roboto|Open+Sans&amp;display=swap" rel="stylesheet"></head><body><div id="thesite" class="ui text container"><div class="ui violet inverted top attached center aligned segment"><h1 class="ui huge header">Async - Polysemy</h1></div><div class="ui attached segment"><div class="ui message"><p>Welcome to the Functional Programming Zulip Chat Archive. You can join the chat <a href="https://funprog.zulipchat.com">here</a>.</p></div><div class="ui breadcrumb rib"><a href="/" class="section">Home</a><i class="right angle icon divider"></i><a href="/polysemy/" class="section">#Polysemy</a><i class="right angle icon divider"></i><div class="active section">Async</div></div><div class="ui comments messages"><div class="comment"><a class="avatar"><img src="https://www.gravatar.com/avatar/13a1d3dfd5218c0afc784698aa463a4a"></a><div class="content"><a class="author">Edward Yang</a><div class="metadata"><a href="#274636018" name="274636018"><div>2022-03-09 02:24:01</div></a></div><div class="text"><p>Does polysemy's <code>async</code> from the <code>Polysemy.Async</code> package have the same gotchas as its equivalent in the <code>async</code> package itself?<br>
The <code>async</code> package recommends to use <code>withAsync</code> to avoid thread leaks. Would this be a problem with polysemy's <code>async</code> function?</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/7334dc60b6aef6a75cd9284126231f13c76926a5?version=5"></a><div class="content"><a class="author">Torsten Schmits</a><div class="metadata"><a href="#274638838" name="274638838"><div>2022-03-09 03:14:49</div></a></div><div class="text"><p>yeah, it just wraps the base <code>async</code>. there are some similar combinators here: <a href="https://hackage.haskell.org/package/polysemy-conc-0.6.0.1/docs/Polysemy-Conc-Async.html">https://hackage.haskell.org/package/polysemy-conc-0.6.0.1/docs/Polysemy-Conc-Async.html</a></p></div></div></div><div class="comment"><a class="avatar"><img src="https://www.gravatar.com/avatar/13a1d3dfd5218c0afc784698aa463a4a"></a><div class="content"><a class="author">Edward Yang</a><div class="metadata"><a href="#274653692" name="274653692"><div>2022-03-09 08:01:38</div></a></div><div class="text"><p>Ended up finding a bug: <a href="https://github.com/tek/polysemy-conc/issues/1">https://github.com/tek/polysemy-conc/issues/1</a><br>
I'm looking to fix it, and realized the issue is probably that <code>bracket</code> doesn't catch the async exception.</p>
<p>I'm trying to rewrite the <code>withAsync</code> function to using the implementation from the <code>async</code> package: <a href="https://hackage.haskell.org/package/async-2.2.4/docs/src/Control.Concurrent.Async.html#withAsyncUsing">https://hackage.haskell.org/package/async-2.2.4/docs/src/Control.Concurrent.Async.html#withAsyncUsing</a></p>
<p>Here's my definition so far:</p>
<div class="codehilite" data-code-language="Haskell"><pre><span></span><code><span class="nf">withAsyncUsing</span><span class="w"> </span><span class="ow">::</span><span class="w"></span>
<span class="w">  </span><span class="kt">Members</span><span class="w"> </span><span class="p">[</span><span class="kt">Async</span><span class="p">,</span><span class="w"> </span><span class="kt">Critical</span><span class="p">,</span><span class="w"> </span><span class="kt">Embed</span><span class="w"> </span><span class="kt">IO</span><span class="p">,</span><span class="w"> </span><span class="kt">Mask</span><span class="w"> </span><span class="kt">Restoration</span><span class="p">]</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="ow">=&gt;</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="kt">Sem</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="nb">()</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">Sem</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="kt">ThreadId</span><span class="p">)</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"></span>
<span class="w">  </span><span class="kt">Sem</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="kt">Base</span><span class="o">.</span><span class="kt">Async</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">Sem</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="n">b</span><span class="p">)</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"></span>
<span class="w">  </span><span class="kt">Sem</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="p">(</span><span class="kt">Base</span><span class="o">.</span><span class="kt">Async</span><span class="w"> </span><span class="n">b</span><span class="p">)</span><span class="w"></span>
<span class="nf">withAsyncUsing</span><span class="w"> </span><span class="n">doFork</span><span class="w"> </span><span class="n">action</span><span class="w"> </span><span class="n">inner</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="kr">do</span><span class="w"></span>
<span class="w">  </span><span class="n">var</span><span class="w"> </span><span class="ow">&lt;-</span><span class="w"> </span><span class="n">newEmptyTMVarIO</span><span class="w"></span>
<span class="w">  </span><span class="n">mask</span><span class="w"> </span><span class="n">action</span><span class="w"></span>
<span class="w">  </span><span class="n">undefined</span><span class="w"></span>
</code></pre></div>
<p>This displays this error on <code>mask action</code>:</p>
<div class="codehilite"><pre><span></span><code>[typecheck -Wdeferred-type-errors] [E] • Occurs check: cannot construct the
   27   Members  infinite type:
   28   (Sem r (     r ~ RestoreMask : r
   29   Sem r a    Expected type: Sem (RestoreMask : r) a
   30   (Base.As     Actual type: Sem r a
   31   Sem r (B • In the first argument of ‘mask’, namely ‘action’
   32 withAsyncU   In a stmt of a &#39;do&#39; block: mask action
   33   var &lt;- n   In the expression:
</code></pre></div>
<p>I'm assuming this is because <code>action</code> is missing <code>Restore ': r</code> that effects within <code>mask</code> would have.<br>
Is there a way to lift <code>action</code> into <code>Sem (RestoreMask : r) a</code>?</p></div></div></div></div></div><div class="ui vertical footer segment"><a href="https://github.com/srid/zulip-archive">Powered by Haskell</a> | Questions? Contact <a href="https://www.srid.ca">srid</a></div></div></body></html>