<html lang="en"><head><meta content="text/html; charset=utf-8" http-equiv="Content-Type"><meta content="width=device-width, initial-scale=1" name="viewport"><meta content="https://github.com/tek/polysemy-hasql
This one is still pretty raw and incomplete, some things that grew out of one of my projects.
would love to hear some comments about the schema derivation mechanism!
tek/polysemy-hasqlPolysemy effects for Hasql. Contribute to tek/polysemy-hasql development by cr" name="description"><link href="https://funprog.srid.ca/polysemy/wip-polysemy-hasql.html" rel="canonical"><meta property="og:title" content="WIP: polysemy-hasql - Polysemy"><meta property="og:site_name" content="Functional Programming Zulip Archive"><meta property="og:type" content="article"><meta property="og:article:section" content="Polysemy"><meta property="og:article:modified_time" content="2020-09-22T22:06:12Z"><meta property="og:article:published_time" content="2020-08-30T18:16:12Z"><meta property="og:image" content="https://zulip-avatars.s3.amazonaws.com/13896/7334dc60b6aef6a75cd9284126231f13c76926a5?x=x&amp;version=4"><title>WIP: polysemy-hasql - Polysemy</title><style type="text/css">
div#thesite
{
  font-family   : "Open Sans", sans-serif;
  font-size     : 1em !important;
  margin-top    : 1em;
  margin-bottom : 1em;
}

div#thesite h1
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite h2
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite h3
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite h4
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite h5
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite h6
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite .ui.breadcrumb.rib .section
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite .header
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite .as-header
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite code, pre, tt
{
  font-family : "SFMono-Regular","Menlo","Monaco","Consolas","Liberation Mono","Courier New", monospace;
}

div#thesite .ui.breadcrumb.rib
{
  margin-bottom : 1em;
}



div#thesite .ui.comments.messages .comment .metadata a
{
  color : #808080;
}

div#thesite .ui.comments.messages .comment a.avatar img
{
  height : auto;
}

div#thesite .subtle
{
  color : #808080;
}


div#thesite .messages pre
{
  font-size : 85%;
  overflow  : auto;
  max-width : 100%;
}

div#thesite .messages .message_embed
{
  border-left  : solid 3px #808080;
  padding-left : 0.69999em;
}

div#thesite .messages .message_inline_image img
{
  max-width     : 100%;
  margin-bottom : 1em;
}


/* Generated with Clay, http://fvisser.nl/clay */</style><link href="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.4.1/semantic.min.css" rel="stylesheet"><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/all.min.css" rel="stylesheet"><link href="https://fonts.googleapis.com/css?family=Open+Sans|Oswald&amp;display=swap" rel="stylesheet"><link href="https://fonts.googleapis.com/css?family=Roboto|Open+Sans&amp;display=swap" rel="stylesheet"></head><body><div id="thesite" class="ui text container"><div class="ui violet inverted top attached center aligned segment"><h1 class="ui huge header">WIP: polysemy-hasql - Polysemy</h1></div><div class="ui attached segment"><div class="ui message"><p>Welcome to the Functional Programming Zulip Chat Archive. You can join the chat <a href="https://funprog.zulipchat.com">here</a>.</p></div><div class="ui breadcrumb rib"><a href="/" class="section">Home</a><i class="right angle icon divider"></i><a href="/polysemy/" class="section">#Polysemy</a><i class="right angle icon divider"></i><div class="active section">WIP: polysemy-hasql</div></div><div class="ui comments messages"><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/7334dc60b6aef6a75cd9284126231f13c76926a5?x=x&amp;version=4"></a><div class="content"><a class="author">Torsten Schmits</a><div class="metadata"><a href="#208497557" name="208497557"><div>2020-08-30 18:16:12</div></a></div><div class="text"><p><a href="https://github.com/tek/polysemy-hasql">https://github.com/tek/polysemy-hasql</a></p>
<p>This one is still pretty raw and incomplete, some things that grew out of one of my projects.<br>
would love to hear some comments about the schema derivation mechanism!</p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/tek/polysemy-hasql" style="background-image: url(https://avatars0.githubusercontent.com/u/2632?s=400&amp;v=4)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/tek/polysemy-hasql" title="tek/polysemy-hasql">tek/polysemy-hasql</a></div><div class="message_embed_description">Polysemy effects for Hasql. Contribute to tek/polysemy-hasql development by creating an account on GitHub.</div></div></div></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/cf32e348c646a53534a1a022c022bab8528df176?x=x&amp;version=3"></a><div class="content"><a class="author">Alex Chapman</a><div class="metadata"><a href="#208630513" name="208630513"><div>2020-08-31 23:57:41</div></a></div><div class="text"><p>It looks very cool. Great to be able to switch between an in-memory Store and an actual database with no changes to application code. I hope to try it out some time.</p></div></div></div><div class="comment"><a class="avatar"><img src="https://www.gravatar.com/avatar/1114fd8de67671f83d3a3ef7594b1950"></a><div class="content"><a class="author">Georgi Lyubenov // googleson78</a><div class="metadata"><a href="#208648453" name="208648453"><div>2020-09-01 06:21:39</div></a></div><div class="text"><p>do you have something like group bys, orders and limits? I'm currently thinking about how to fit them (or rather a more restricted version that would work for me) inside either an effect or an ADT so that I can interpret them to both SQL and some other thing (<code>Data.Set</code>)</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/7334dc60b6aef6a75cd9284126231f13c76926a5?x=x&amp;version=4"></a><div class="content"><a class="author">Torsten Schmits</a><div class="metadata"><a href="#208669501" name="208669501"><div>2020-09-01 10:34:35</div></a></div><div class="text"><p>I haven't gotten that far yet.</p>
<p>My concept so far is to create a new instance of <code>StoreQuery q e d</code> for each non-trivial-CRUD query.<br>
So basically the types <code>q</code> and <code>d</code> should encode all of the parameters that fully describe the query, which in your case might include a <code>limit</code> field, like</p>
<div class="codehilite"><pre><span></span><code><span class="kr">data</span> <span class="kt">PostsForTopic</span> <span class="ow">=</span>
  <span class="kt">PostsForTopic</span> <span class="p">{</span>
    <span class="n">topic</span> <span class="ow">::</span> <span class="kt">Topic</span><span class="p">,</span>
    <span class="n">limit</span> <span class="ow">::</span> <span class="kt">Int</span><span class="p">,</span>
    <span class="n">order</span> <span class="ow">::</span> <span class="kt">Order</span>
<span class="p">}</span>
</code></pre></div>


<p>Now the interpreters would figure out how to transform these things into backend structures, be it SQL or some <code>Set</code> combinators.</p>
<p>Of course, this is very high-level abstraction, leaving much room for incoherence under the hood.<br>
The implementations for <code>StoreQuery</code> I have so far are only for multi-column <code>select</code>s that <code>AND</code> the operands, which relies on the data type <code>QueryTable</code> that derives a <code>where</code> clause generically. Those wouldn't work with <code>PostsForTopic</code>, since they would try to match <code>limit</code> and <code>order</code> with <code>d</code> as field names. In that case there needs to be some intermediate machinery that translates the type to more concrete representations of "fields" and "parameters".<br>
So, it devolves into doing most of the work manually behind the interpreter, maybe not optimal.</p>
<p>Another approach would be to add a parameter to the <code>StoreQuery</code> constructor that encodes db params â€“ either something static with predefined query features or another type param that facilitates more targeted derivation of SQL code.</p>
<p>What would you consider to be an ergonomic interface to this, <span class="user-mention" data-user-id="254032">@Georgi Lyubenov // googleson78</span> ?</p></div></div></div><div class="comment"><a class="avatar"><img src="https://www.gravatar.com/avatar/1114fd8de67671f83d3a3ef7594b1950"></a><div class="content"><a class="author">Georgi Lyubenov // googleson78</a><div class="metadata"><a href="#208724396" name="208724396"><div>2020-09-01 18:02:06</div></a></div><div class="text"><p>I think I don't quite understand, due to not having any experience with <code>hasql</code></p></div></div></div><div class="comment"><a class="avatar"><img src="https://www.gravatar.com/avatar/1114fd8de67671f83d3a3ef7594b1950"></a><div class="content"><a class="author">Georgi Lyubenov // googleson78</a><div class="metadata"><a href="#208724488" name="208724488"><div>2020-09-01 18:02:43</div></a></div><div class="text"><p>in your <code>Queries</code> example, how are the values you pass to <code>StoreQuery.basic</code> used?</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/7334dc60b6aef6a75cd9284126231f13c76926a5?x=x&amp;version=4"></a><div class="content"><a class="author">Torsten Schmits</a><div class="metadata"><a href="#208724755" name="208724755"><div>2020-09-01 18:04:50</div></a></div><div class="text"><p>they are inserted into a <code>where</code> clause, something like <code>where a = 1 and b = 2</code></p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/7334dc60b6aef6a75cd9284126231f13c76926a5?x=x&amp;version=4"></a><div class="content"><a class="author">Torsten Schmits</a><div class="metadata"><a href="#208724813" name="208724813"><div>2020-09-01 18:05:13</div></a></div><div class="text"><p>I think this problem isn't really related to hasql</p></div></div></div><div class="comment"><a class="avatar"><img src="https://www.gravatar.com/avatar/1114fd8de67671f83d3a3ef7594b1950"></a><div class="content"><a class="author">Georgi Lyubenov // googleson78</a><div class="metadata"><a href="#208724988" name="208724988"><div>2020-09-01 18:06:07</div></a></div><div class="text"><p>it's hard to tell with the moving parts (a lot of type params) <span aria-label="sweat smile" class="emoji emoji-1f605" role="img" title="sweat smile">:sweat_smile:</span></p></div></div></div><div class="comment"><a class="avatar"><img src="https://www.gravatar.com/avatar/1114fd8de67671f83d3a3ef7594b1950"></a><div class="content"><a class="author">Georgi Lyubenov // googleson78</a><div class="metadata"><a href="#208724988" name="208724988"><div>2020-09-01 18:06:07</div></a></div><div class="text"><p>it's hard to tell with the moving parts (a lot of type params) <span aria-label="sweat smile" class="emoji emoji-1f605" role="img" title="sweat smile">:sweat_smile:</span></p></div></div></div><div class="comment"><a class="avatar"><img src="https://www.gravatar.com/avatar/1114fd8de67671f83d3a3ef7594b1950"></a><div class="content"><a class="author">Georgi Lyubenov // googleson78</a><div class="metadata"><a href="#208725042" name="208725042"><div>2020-09-01 18:06:26</div></a></div><div class="text"><p>so basically you're selecting a subset of your values, determined by a <code>RecordQuery</code></p></div></div></div><div class="comment"><a class="avatar"><img src="https://www.gravatar.com/avatar/1114fd8de67671f83d3a3ef7594b1950"></a><div class="content"><a class="author">Georgi Lyubenov // googleson78</a><div class="metadata"><a href="#208725065" name="208725065"><div>2020-09-01 18:06:35</div></a></div><div class="text"><p>where do you do the "insert into a where"?</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/7334dc60b6aef6a75cd9284126231f13c76926a5?x=x&amp;version=4"></a><div class="content"><a class="author">Torsten Schmits</a><div class="metadata"><a href="#208725169" name="208725169"><div>2020-09-01 18:07:14</div></a></div><div class="text"><p>but what's done with the query type is up to the interpreter, the question I'm asking is what would be a good interface for the abstraction. once you get all the parameters into the native interpreter (be it hasql or anything else), you can do what you want â€“ you could create a different kind of <code>where</code> clause than the <code>and</code> variant</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/7334dc60b6aef6a75cd9284126231f13c76926a5?x=x&amp;version=4"></a><div class="content"><a class="author">Torsten Schmits</a><div class="metadata"><a href="#208725419" name="208725419"><div>2020-09-01 18:08:58</div></a></div><div class="text"><p>well, the interpreter uses the generically derived information about the result type (determining the table name and which columns to select) and the query type (determining on which columns to match) to assemble an SQL statement</p></div></div></div><div class="comment"><a class="avatar"><img src="https://www.gravatar.com/avatar/1114fd8de67671f83d3a3ef7594b1950"></a><div class="content"><a class="author">Georgi Lyubenov // googleson78</a><div class="metadata"><a href="#208725456" name="208725456"><div>2020-09-01 18:09:24</div></a></div><div class="text"><p>well this sounds like a decent interface - it sounds to me like you give the user full power to thread some information (of his own choice of datatype!) from business logic to his interpreter</p></div></div></div><div class="comment"><a class="avatar"><img src="https://www.gravatar.com/avatar/1114fd8de67671f83d3a3ef7594b1950"></a><div class="content"><a class="author">Georgi Lyubenov // googleson78</a><div class="metadata"><a href="#208725465" name="208725465"><div>2020-09-01 18:09:30</div></a></div><div class="text"><p>I'm just not sure how the whole thing works and if this is correct</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/7334dc60b6aef6a75cd9284126231f13c76926a5?x=x&amp;version=4"></a><div class="content"><a class="author">Torsten Schmits</a><div class="metadata"><a href="#208725508" name="208725508"><div>2020-09-01 18:09:58</div></a></div><div class="text"><p>in the example, it would be <code>select elems, number from record where elems = ["one", "two"] and number = 5.5</code></p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/7334dc60b6aef6a75cd9284126231f13c76926a5?x=x&amp;version=4"></a><div class="content"><a class="author">Torsten Schmits</a><div class="metadata"><a href="#208725777" name="208725777"><div>2020-09-01 18:11:26</div></a></div><div class="text"><p>yeah so the question is, how would a good interface for passing in meta-parameters like <code>limit</code> and <code>order</code> look</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/7334dc60b6aef6a75cd9284126231f13c76926a5?x=x&amp;version=4"></a><div class="content"><a class="author">Torsten Schmits</a><div class="metadata"><a href="#208726010" name="208726010"><div>2020-09-01 18:12:56</div></a></div><div class="text"><p>especially if those values are dynamic, e.g. given by the web app user</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/7334dc60b6aef6a75cd9284126231f13c76926a5?x=x&amp;version=4"></a><div class="content"><a class="author">Torsten Schmits</a><div class="metadata"><a href="#208726076" name="208726076"><div>2020-09-01 18:13:39</div></a></div><div class="text"><p>otherwise you could use a query type named <code>First100WhereNumberIs5</code> and handle the details in the implementation</p></div></div></div><div class="comment"><a class="avatar"><img src="https://www.gravatar.com/avatar/1114fd8de67671f83d3a3ef7594b1950"></a><div class="content"><a class="author">Georgi Lyubenov // googleson78</a><div class="metadata"><a href="#208726473" name="208726473"><div>2020-09-01 18:16:40</div></a></div><div class="text"><p><code>Another approach would be to add a parameter to the StoreQuery constructor that encodes db params â€“ either something static with predefined query features or another type param that facilitates more targeted derivation of SQL code.</code><br>
if you're going this route it sounds to me like you're basically going to be implementing an AST for sql</p></div></div></div><div class="comment"><a class="avatar"><img src="https://www.gravatar.com/avatar/1114fd8de67671f83d3a3ef7594b1950"></a><div class="content"><a class="author">Georgi Lyubenov // googleson78</a><div class="metadata"><a href="#208726759" name="208726759"><div>2020-09-01 18:19:18</div></a></div><div class="text"><p>I think letting the user decide what structure he needs, and giving them some predefined things like <code>PostsForTopic</code> but generalised to an <code>a</code> from your example above, is pretty good (for ease of use in common cases)</p>
<p>(maybe I'm just entirely misunderstanding right now though..)</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/7334dc60b6aef6a75cd9284126231f13c76926a5?x=x&amp;version=4"></a><div class="content"><a class="author">Torsten Schmits</a><div class="metadata"><a href="#208727122" name="208727122"><div>2020-09-01 18:22:01</div></a></div><div class="text"><p>what does that "generalised to an <code>a</code>" apply to?</p></div></div></div><div class="comment"><a class="avatar"><img src="https://www.gravatar.com/avatar/1114fd8de67671f83d3a3ef7594b1950"></a><div class="content"><a class="author">Georgi Lyubenov // googleson78</a><div class="metadata"><a href="#208727591" name="208727591"><div>2020-09-01 18:25:39</div></a></div><div class="text"><div class="codehilite"><pre><span></span><code><span class="kr">data</span> <span class="kt">OrderAndLimitFor</span> <span class="n">a</span> <span class="ow">=</span>
  <span class="kt">OrderAndLimitFor</span> <span class="p">{</span>
    <span class="n">topic</span> <span class="ow">::</span> <span class="n">a</span><span class="p">,</span>
    <span class="n">limit</span> <span class="ow">::</span> <span class="kt">Int</span><span class="p">,</span>
    <span class="n">order</span> <span class="ow">::</span> <span class="kt">Order</span>
  <span class="p">}</span>
</code></pre></div>


<p>this kind of thing?</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/7334dc60b6aef6a75cd9284126231f13c76926a5?x=x&amp;version=4"></a><div class="content"><a class="author">Torsten Schmits</a><div class="metadata"><a href="#208727631" name="208727631"><div>2020-09-01 18:25:54</div></a></div><div class="text"><p>ah</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/7334dc60b6aef6a75cd9284126231f13c76926a5?x=x&amp;version=4"></a><div class="content"><a class="author">Torsten Schmits</a><div class="metadata"><a href="#208727787" name="208727787"><div>2020-09-01 18:27:06</div></a></div><div class="text"><p>that would then be the <em>hardcoded</em> variant, but optional</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/7334dc60b6aef6a75cd9284126231f13c76926a5?x=x&amp;version=4"></a><div class="content"><a class="author">Torsten Schmits</a><div class="metadata"><a href="#208727871" name="208727871"><div>2020-09-01 18:28:00</div></a></div><div class="text"><p>I think the best course of action is to build a few test cases and let the code decide what's right <span aria-label="smile" class="emoji emoji-1f642" role="img" title="smile">:smile:</span></p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/7334dc60b6aef6a75cd9284126231f13c76926a5?x=x&amp;version=4"></a><div class="content"><a class="author">Torsten Schmits</a><div class="metadata"><a href="#208727964" name="208727964"><div>2020-09-01 18:28:34</div></a></div><div class="text"><p>I wanted to start with <code>join</code>s, that's probably a bit harder and might produce the rest in its wake</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/7334dc60b6aef6a75cd9284126231f13c76926a5?x=x&amp;version=4"></a><div class="content"><a class="author">Torsten Schmits</a><div class="metadata"><a href="#208728268" name="208728268"><div>2020-09-01 18:31:48</div></a></div><div class="text"><p>what database library are you using, <span class="user-mention" data-user-id="254032">@Georgi Lyubenov // googleson78</span> ?</p></div></div></div><div class="comment"><a class="avatar"><img src="https://www.gravatar.com/avatar/1114fd8de67671f83d3a3ef7594b1950"></a><div class="content"><a class="author">Georgi Lyubenov // googleson78</a><div class="metadata"><a href="#208728408" name="208728408"><div>2020-09-01 18:32:48</div></a></div><div class="text"><p>persistent + esqueleto</p></div></div></div><div class="comment"><a class="avatar"><img src="https://www.gravatar.com/avatar/1114fd8de67671f83d3a3ef7594b1950"></a><div class="content"><a class="author">Georgi Lyubenov // googleson78</a><div class="metadata"><a href="#208728424" name="208728424"><div>2020-09-01 18:32:57</div></a></div><div class="text"><p>due to it being the only (or one of two) things that support mysql</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/7334dc60b6aef6a75cd9284126231f13c76926a5?x=x&amp;version=4"></a><div class="content"><a class="author">Torsten Schmits</a><div class="metadata"><a href="#208728476" name="208728476"><div>2020-09-01 18:33:23</div></a></div><div class="text"><p>they use combinators for <code>where</code> and <code>limit</code> et. al, right?</p></div></div></div><div class="comment"><a class="avatar"><img src="https://www.gravatar.com/avatar/1114fd8de67671f83d3a3ef7594b1950"></a><div class="content"><a class="author">Georgi Lyubenov // googleson78</a><div class="metadata"><a href="#208728503" name="208728503"><div>2020-09-01 18:33:35</div></a></div><div class="text"><p>in esqueleto, yeah</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/7334dc60b6aef6a75cd9284126231f13c76926a5?x=x&amp;version=4"></a><div class="content"><a class="author">Torsten Schmits</a><div class="metadata"><a href="#208728525" name="208728525"><div>2020-09-01 18:33:52</div></a></div><div class="text"><p>I guess that is pretty incompatible with my concept</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/7334dc60b6aef6a75cd9284126231f13c76926a5?x=x&amp;version=4"></a><div class="content"><a class="author">Torsten Schmits</a><div class="metadata"><a href="#208728597" name="208728597"><div>2020-09-01 18:34:18</div></a></div><div class="text"><p>or do these combinators abstract over classes?</p></div></div></div><div class="comment"><a class="avatar"><img src="https://www.gravatar.com/avatar/1114fd8de67671f83d3a3ef7594b1950"></a><div class="content"><a class="author">Georgi Lyubenov // googleson78</a><div class="metadata"><a href="#208728626" name="208728626"><div>2020-09-01 18:34:43</div></a></div><div class="text"><p>why? if you're just passing data you need to construct a query in your effect you can just construct it in your interpreter, as you said</p></div></div></div><div class="comment"><a class="avatar"><img src="https://www.gravatar.com/avatar/1114fd8de67671f83d3a3ef7594b1950"></a><div class="content"><a class="author">Georgi Lyubenov // googleson78</a><div class="metadata"><a href="#208728656" name="208728656"><div>2020-09-01 18:35:09</div></a></div><div class="text"><p>these combinators produce a value that's basically a Writer that you can run to produce your final query</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/7334dc60b6aef6a75cd9284126231f13c76926a5?x=x&amp;version=4"></a><div class="content"><a class="author">Torsten Schmits</a><div class="metadata"><a href="#208728715" name="208728715"><div>2020-09-01 18:35:40</div></a></div><div class="text"><p>right, but wouldn't that reduce the comfort they provide dramatically?</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/7334dc60b6aef6a75cd9284126231f13c76926a5?x=x&amp;version=4"></a><div class="content"><a class="author">Torsten Schmits</a><div class="metadata"><a href="#208728814" name="208728814"><div>2020-09-01 18:36:13</div></a></div><div class="text"><p>I assume that the purpose there is to write sql queries in business logic for readability</p></div></div></div><div class="comment"><a class="avatar"><img src="https://www.gravatar.com/avatar/1114fd8de67671f83d3a3ef7594b1950"></a><div class="content"><a class="author">Georgi Lyubenov // googleson78</a><div class="metadata"><a href="#208728891" name="208728891"><div>2020-09-01 18:37:01</div></a></div><div class="text"><p>I think the purpose is to write "SQL with some type safety" - I'm not sure whether they are "intended" to be used in business logic or not</p></div></div></div><div class="comment"><a class="avatar"><img src="https://www.gravatar.com/avatar/1114fd8de67671f83d3a3ef7594b1950"></a><div class="content"><a class="author">Georgi Lyubenov // googleson78</a><div class="metadata"><a href="#208728921" name="208728921"><div>2020-09-01 18:37:17</div></a></div><div class="text"><p>in any case using them in business logic is nasty for tests afterwards</p></div></div></div><div class="comment"><a class="avatar"><img src="https://www.gravatar.com/avatar/1114fd8de67671f83d3a3ef7594b1950"></a><div class="content"><a class="author">Georgi Lyubenov // googleson78</a><div class="metadata"><a href="#208728937" name="208728937"><div>2020-09-01 18:37:24</div></a></div><div class="text"><p>because you can't convert the Writer thing to pure operations</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/7334dc60b6aef6a75cd9284126231f13c76926a5?x=x&amp;version=4"></a><div class="content"><a class="author">Torsten Schmits</a><div class="metadata"><a href="#208728958" name="208728958"><div>2020-09-01 18:37:40</div></a></div><div class="text"><p>mh, right. could still be useful in interpreters</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/7334dc60b6aef6a75cd9284126231f13c76926a5?x=x&amp;version=4"></a><div class="content"><a class="author">Torsten Schmits</a><div class="metadata"><a href="#208729075" name="208729075"><div>2020-09-01 18:38:26</div></a></div><div class="text"><p>I'll give it a look to see how well I could abstract over different backends</p></div></div></div><div class="comment"><a class="avatar"><img src="https://www.gravatar.com/avatar/1114fd8de67671f83d3a3ef7594b1950"></a><div class="content"><a class="author">Georgi Lyubenov // googleson78</a><div class="metadata"><a href="#208729352" name="208729352"><div>2020-09-01 18:40:19</div></a></div><div class="text"><p>currently I'm doing some form of the "pass data that's required to the interpreter", but my issue is that my effect constructor is a monolith - instead of being composed of "small parts" corresponding to some sql concepts I just have this big thing with lots of parameters, and what ends up happening is that a lot of implicit logic is hidden in my interpreter (which obviously is sucks for testing - if I ever write a pure interpreter I have to remember all this implicit logic I have "built into" the effect constructor)</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/7334dc60b6aef6a75cd9284126231f13c76926a5?x=x&amp;version=4"></a><div class="content"><a class="author">Torsten Schmits</a><div class="metadata"><a href="#208729449" name="208729449"><div>2020-09-01 18:41:10</div></a></div><div class="text"><p>yeah that's how I started out as well</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/7334dc60b6aef6a75cd9284126231f13c76926a5?x=x&amp;version=4"></a><div class="content"><a class="author">Torsten Schmits</a><div class="metadata"><a href="#208729615" name="208729615"><div>2020-09-01 18:42:09</div></a></div><div class="text"><p>send me the link if you ever publish your stuff (or have already published it)</p></div></div></div><div class="comment"><a class="avatar"><img src="https://www.gravatar.com/avatar/1114fd8de67671f83d3a3ef7594b1950"></a><div class="content"><a class="author">Georgi Lyubenov // googleson78</a><div class="metadata"><a href="#208729944" name="208729944"><div>2020-09-01 18:44:28</div></a></div><div class="text"><p>it's an application specific effect for an @work project :/ so I can't share it and even if I could, it's not really anything general enough to make a lib out of</p>
<p>I'm thinking more that there should be some "approach" into modelling such sql applications, but if you actually manage to make the approach into a library it would be even cooler</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/7334dc60b6aef6a75cd9284126231f13c76926a5?x=x&amp;version=4"></a><div class="content"><a class="author">Torsten Schmits</a><div class="metadata"><a href="#208730159" name="208730159"><div>2020-09-01 18:46:10</div></a></div><div class="text"><p>well, maybe you could come up with some reasons why my <code>Store</code> and <code>StoreQuery</code> don't fit some of your use cases, would surely be helpful for me</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/7334dc60b6aef6a75cd9284126231f13c76926a5?x=x&amp;version=4"></a><div class="content"><a class="author">Torsten Schmits</a><div class="metadata"><a href="#208730189" name="208730189"><div>2020-09-01 18:46:24</div></a></div><div class="text"><p>(apart from the missing <code>limit</code> etc <span aria-label="smile" class="emoji emoji-1f642" role="img" title="smile">:smile:</span>  )</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/7334dc60b6aef6a75cd9284126231f13c76926a5?x=x&amp;version=4"></a><div class="content"><a class="author">Torsten Schmits</a><div class="metadata"><a href="#210937434" name="210937434"><div>2020-09-22 22:06:12</div></a></div><div class="text"><p>so I built a pretty fun thing: sum type columns! <span aria-label="tada" class="emoji emoji-1f389" role="img" title="tada">:tada:</span> </p>
<p>given some types:</p>
<div class="codehilite" data-code-language="Haskell"><pre><span></span><code><span class="kr">data</span> <span class="kt">SumRec</span> <span class="ow">=</span>
  <span class="kt">L</span> <span class="p">{</span> <span class="n">d</span> <span class="ow">::</span> <span class="kt">Int</span> <span class="p">}</span>
  <span class="o">|</span>
  <span class="kt">R</span> <span class="p">{</span> <span class="n">e</span> <span class="ow">::</span> <span class="kt">Text</span><span class="p">,</span> <span class="n">f</span> <span class="ow">::</span> <span class="kt">Double</span> <span class="p">}</span>
  <span class="kr">deriving</span> <span class="p">(</span><span class="kt">Generic</span><span class="p">)</span>

<span class="kr">data</span> <span class="kt">Rec</span> <span class="ow">=</span>
  <span class="kt">Rec</span> <span class="p">{</span>
    <span class="n">a</span> <span class="ow">::</span> <span class="kt">Text</span><span class="p">,</span>
    <span class="n">b</span> <span class="ow">::</span> <span class="kt">Int</span><span class="p">,</span>
    <span class="n">c</span> <span class="ow">::</span> <span class="kt">SumRec</span>
  <span class="p">}</span>
  <span class="kr">deriving</span> <span class="p">(</span><span class="kt">Generic</span><span class="p">)</span>

<span class="nf">t</span> <span class="ow">::</span> <span class="kt">TableStructure</span>
<span class="nf">t</span> <span class="ow">=</span>
  <span class="n">tableStructure</span> <span class="o">@</span><span class="kt">Rec</span>
</code></pre></div>

<p>it generates statements like:</p>
<div class="codehilite" data-code-language="SQL"><pre><span></span><code><span class="k">create</span> <span class="k">table</span> <span class="ss">"rec"</span> <span class="p">(</span><span class="ss">"a"</span> <span class="nb">text</span> <span class="k">not</span> <span class="k">null</span><span class="p">,</span> <span class="ss">"b"</span> <span class="nb">bigint</span> <span class="k">not</span> <span class="k">null</span><span class="p">,</span> <span class="ss">"c"</span> <span class="n">sum_rec</span> <span class="k">not</span> <span class="k">null</span><span class="p">)</span>
<span class="k">select</span> <span class="ss">"a"</span><span class="p">,</span> <span class="ss">"b"</span><span class="p">,</span> <span class="p">(</span><span class="ss">"c"</span><span class="p">).</span><span class="n">sum_index</span><span class="p">,</span> <span class="p">(</span><span class="ss">"c"</span><span class="p">).</span><span class="ss">"l"</span><span class="p">.</span><span class="ss">"d"</span><span class="p">,</span> <span class="p">(</span><span class="ss">"c"</span><span class="p">).</span><span class="ss">"r"</span><span class="p">.</span><span class="ss">"e"</span><span class="p">,</span> <span class="p">(</span><span class="ss">"c"</span><span class="p">).</span><span class="ss">"r"</span><span class="p">.</span><span class="ss">"f"</span> <span class="k">from</span> <span class="ss">"rec"</span>
<span class="k">insert</span> <span class="k">into</span> <span class="ss">"rec"</span> <span class="p">(</span><span class="ss">"a"</span><span class="p">,</span> <span class="ss">"b"</span><span class="p">,</span> <span class="ss">"c"</span><span class="p">)</span> <span class="k">values</span> <span class="p">(</span><span class="err">$</span><span class="mi">1</span><span class="p">,</span> <span class="err">$</span><span class="mi">2</span><span class="p">,</span> <span class="k">row</span><span class="p">(</span><span class="err">$</span><span class="mi">4</span><span class="p">,</span> <span class="k">row</span><span class="p">(</span><span class="err">$</span><span class="mi">5</span><span class="p">),</span> <span class="k">row</span><span class="p">(</span><span class="err">$</span><span class="mi">6</span><span class="p">,</span> <span class="err">$</span><span class="mi">7</span><span class="p">)))</span>
</code></pre></div>

<p>plus the corresponding <code>Row</code>/<code>Param</code> values.</p>
<p>now even without <code>SOP.Generic</code> instance!</p></div></div></div></div></div><div class="ui vertical footer segment"><a href="https://github.com/srid/zulip-archive">Powered by Haskell</a> | Questions? Contact <a href="https://www.srid.ca">srid</a></div></div></body></html>