<html lang="en"><head><meta content="text/html; charset=utf-8" http-equiv="Content-Type"><meta content="width=device-width, initial-scale=1" name="viewport"><meta content="Hi all, I&#39;ve looked around this Zulip and the Polysemy repo, but I can&#39;t figure out how to write the following Koka program with Polysemy:
fun show(p : (int, list&lt;int&gt;)) : string
  show-tuple(p, show, show)

effect state&lt;s&gt;
  ctl get() : s
  ctl put(s : s) : ()

fun comp() : &lt;state&lt;int&gt;&gt; int
  val x" name="description"><link href="https://funprog.srid.ca/polysemy/result-of-a-continuation-and-running-code-after-resuming.html" rel="canonical"><meta property="og:title" content="Result of a continuation and running code after resuming - Polysemy"><meta property="og:site_name" content="Functional Programming Zulip Archive"><meta property="og:type" content="article"><meta property="og:article:section" content="Polysemy"><meta property="og:article:modified_time" content="2022-08-23T16:52:19Z"><meta property="og:article:published_time" content="2022-08-23T16:34:07Z"><meta property="og:image" content="https://zulip-avatars.s3.amazonaws.com/13896/bde47c5b03ccef51ffa31163807dcf8923ffbb09?version=2"><title>Result of a continuation and running code after resuming - Polysemy</title><style type="text/css">
div#thesite
{
  font-family   : "Open Sans", sans-serif;
  font-size     : 1em !important;
  margin-top    : 1em;
  margin-bottom : 1em;
}

div#thesite h1
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite h2
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite h3
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite h4
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite h5
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite h6
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite .ui.breadcrumb.rib .section
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite .header
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite .as-header
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite code, pre, tt
{
  font-family : "SFMono-Regular","Menlo","Monaco","Consolas","Liberation Mono","Courier New", monospace;
}

div#thesite .ui.breadcrumb.rib
{
  margin-bottom : 1em;
}



div#thesite .ui.comments.messages .comment .metadata a
{
  color : #808080;
}

div#thesite .ui.comments.messages .comment a.avatar img
{
  height : auto;
}

div#thesite .subtle
{
  color : #808080;
}


div#thesite .messages pre
{
  font-size : 85%;
  overflow  : auto;
  max-width : 100%;
}

div#thesite .messages .message_embed
{
  border-left  : solid 3px #808080;
  padding-left : 0.69999em;
}

div#thesite .messages .message_inline_image img
{
  max-width     : 100%;
  margin-bottom : 1em;
}


/* Generated with Clay, http://fvisser.nl/clay */</style><link href="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.4.1/semantic.min.css" rel="stylesheet"><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/all.min.css" rel="stylesheet"><link href="https://fonts.googleapis.com/css?family=Open+Sans|Oswald&amp;display=swap" rel="stylesheet"><link href="https://fonts.googleapis.com/css?family=Roboto|Open+Sans&amp;display=swap" rel="stylesheet"></head><body><div id="thesite" class="ui text container"><div class="ui violet inverted top attached center aligned segment"><h1 class="ui huge header">Result of a continuation and running code after resuming - Polysemy</h1></div><div class="ui attached segment"><div class="ui message"><p>Welcome to the Functional Programming Zulip Chat Archive. You can join the chat <a href="https://funprog.zulipchat.com">here</a>.</p></div><div class="ui breadcrumb rib"><a href="/" class="section">Home</a><i class="right angle icon divider"></i><a href="/polysemy/" class="section">#Polysemy</a><i class="right angle icon divider"></i><div class="active section">Result of a continuation and running code after resuming</div></div><div class="ui comments messages"><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/bde47c5b03ccef51ffa31163807dcf8923ffbb09?version=2"></a><div class="content"><a class="author">Jesse Sigal</a><div class="metadata"><a href="#294904999" name="294904999"><div>2022-08-23 16:34:07</div></a></div><div class="text"><p>Hi all, I've looked around this Zulip and the Polysemy repo, but I can't figure out how to write the following Koka program with Polysemy:</p>
<div class="codehilite" data-code-language="Koka"><pre><span></span><code><span class="k">fun</span><span class="w"> </span><span class="nf">show</span><span class="p">(</span><span class="n">p</span><span class="w"> </span><span class="na">:</span><span class="w"> </span><span class="na">(int,</span><span class="w"> </span><span class="na">list&lt;int&gt;)</span><span class="p">)</span><span class="w"> </span><span class="na">:</span><span class="w"> </span><span class="na">string</span><span class="w"></span>
<span class="w">  </span><span class="na">show</span><span class="o">-</span><span class="n">tuple</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="n">show</span><span class="p">,</span><span class="w"> </span><span class="n">show</span><span class="p">)</span><span class="w"></span>

<span class="n">effect</span><span class="w"> </span><span class="n">state</span><span class="o">&lt;</span><span class="n">s</span><span class="o">&gt;</span><span class="w"></span>
<span class="w">  </span><span class="n">ctl</span><span class="w"> </span><span class="n">get</span><span class="p">()</span><span class="w"> </span><span class="na">:</span><span class="w"> </span><span class="na">s</span><span class="w"></span>
<span class="w">  </span><span class="na">ctl</span><span class="w"> </span><span class="na">put(</span><span class="n">s</span><span class="w"> </span><span class="na">:</span><span class="w"> </span><span class="na">s)</span><span class="w"> </span><span class="na">:</span><span class="w"> </span><span class="na">()</span><span class="w"></span>

<span class="k">fun</span><span class="w"> </span><span class="nf">comp</span><span class="p">()</span><span class="w"> </span><span class="na">:</span><span class="w"> </span><span class="na">&lt;state&lt;int&gt;&gt;</span><span class="w"> </span><span class="na">int</span><span class="w"></span>
<span class="w">  </span><span class="k">val</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="k">=</span><span class="w"> </span><span class="n">get</span><span class="p">()</span><span class="w"></span>
<span class="w">  </span><span class="n">put</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="na">:</span><span class="w"> </span><span class="na">int</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="k">val</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="k">=</span><span class="w"> </span><span class="n">get</span><span class="p">()</span><span class="w"></span>
<span class="w">  </span><span class="n">put</span><span class="p">(</span><span class="n">y</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="na">:</span><span class="w"> </span><span class="na">int</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="n">get</span><span class="p">()</span><span class="w"></span>

<span class="k">fun</span><span class="w"> </span><span class="nf">logState</span><span class="p">(</span><span class="n">init</span><span class="w"> </span><span class="na">:</span><span class="w"> </span><span class="na">s</span><span class="p">,</span><span class="w"> </span><span class="n">action</span><span class="w"> </span><span class="na">:</span><span class="w"> </span><span class="na">()</span><span class="w"> </span><span class="na">-&gt;</span><span class="w"> </span><span class="na">&lt;state&lt;s&gt;&gt;</span><span class="w"> </span><span class="na">a</span><span class="p">)</span><span class="w"> </span><span class="na">:</span><span class="w"> </span><span class="na">&lt;div&gt;</span><span class="w"> </span><span class="na">(a,</span><span class="w"> </span><span class="na">list&lt;s&gt;)</span><span class="w"></span>
<span class="w">  </span><span class="k">var</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="k">:=</span><span class="w"> </span><span class="n">init</span><span class="w"></span>
<span class="w">  </span><span class="kt">with</span><span class="w"> </span><span class="n">handler</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="k">-&gt;</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="p">[])</span><span class="w"></span>
<span class="w">    </span><span class="n">ctl</span><span class="w"> </span><span class="n">get</span><span class="p">()</span><span class="w"> </span><span class="k">-&gt;</span><span class="w"> </span><span class="n">resume</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="n">ctl</span><span class="w"> </span><span class="n">put</span><span class="p">(</span><span class="n">s</span><span class="sc">') -&gt; {s := s'</span><span class="p">;</span><span class="w"> </span><span class="k">val</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">ss</span><span class="p">)</span><span class="w"> </span><span class="k">=</span><span class="w"> </span><span class="n">resume</span><span class="p">(());</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="ge">Cons</span><span class="p">(</span><span class="n">s</span><span class="sc">', ss))}</span>
<span class="w">  </span><span class="n">action</span><span class="p">()</span><span class="w"></span>
</code></pre></div>
<p>which results in:</p>
<div class="codehilite" data-code-language="Haskell"><pre><span></span><code><span class="o">&gt;</span><span class="w"> </span><span class="n">logState</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="n">comp</span><span class="p">)</span><span class="w"></span>
<span class="nf">check</span><span class="w">  </span><span class="kt">:</span><span class="w"> </span><span class="n">interactive</span><span class="w"></span>
<span class="nf">check</span><span class="w">  </span><span class="kt">:</span><span class="w"> </span><span class="n">interactive</span><span class="w"></span>
<span class="nf">linking</span><span class="kt">:</span><span class="w"> </span><span class="n">interactive</span><span class="w"></span>
<span class="nf">created</span><span class="kt">:</span><span class="w"> </span><span class="o">.</span><span class="n">koka</span><span class="o">/</span><span class="n">v2</span><span class="o">.</span><span class="mf">4.0</span><span class="o">/</span><span class="n">gcc</span><span class="o">-</span><span class="n">debug</span><span class="o">/</span><span class="n">interactive</span><span class="w"></span>

<span class="p">(</span><span class="mi">6</span><span class="p">,[</span><span class="mi">3</span><span class="p">,</span><span class="mi">6</span><span class="p">])</span><span class="w"></span>
</code></pre></div>
<p>The important bits of <code>logState</code> are (i) the use of the result of the computation through the return value of resume and (ii) the bit of code after the call to the resumption. The use of local state (<code>var</code>) isn't important here.</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/20a04d823b7c3891d78ca5f6a188ccd0e4fc5e3d?version=2"></a><div class="content"><a class="author">TheMatten</a><div class="metadata"><a href="#294905789" name="294905789"><div>2022-08-23 16:38:37</div></a></div><div class="text"><p>This sort of looks like <code>Writer</code>?: <a href="https://hackage.haskell.org/package/polysemy-1.7.1.0/docs/Polysemy-Writer.html#t:Writer">https://hackage.haskell.org/package/polysemy-1.7.1.0/docs/Polysemy-Writer.html#t:Writer</a></p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/bde47c5b03ccef51ffa31163807dcf8923ffbb09?version=2"></a><div class="content"><a class="author">Jesse Sigal</a><div class="metadata"><a href="#294906135" name="294906135"><div>2022-08-23 16:40:37</div></a></div><div class="text"><p>Sorry, I should have made clear that this is an illustrative example :P The points (i) and (ii) are what I need, in my actual use case I do more complicated things than append/cons to a list.</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/bde47c5b03ccef51ffa31163807dcf8923ffbb09?version=2"></a><div class="content"><a class="author">Jesse Sigal</a><div class="metadata"><a href="#294907253" name="294907253"><div>2022-08-23 16:46:46</div></a></div><div class="text"><p>This is the best I've been able to do (in <code>fused-effects</code>, sorry xD):</p>
<div class="codehilite" data-code-language="Haskell"><pre><span></span><code><span class="cm">{-# LANGUAGE DeriveFunctor #-}</span><span class="w"></span>
<span class="cm">{-# LANGUAGE FlexibleInstances #-}</span><span class="w"></span>
<span class="cm">{-# LANGUAGE GADTs #-}</span><span class="w"></span>
<span class="cm">{-# LANGUAGE GeneralizedNewtypeDeriving #-}</span><span class="w"></span>
<span class="cm">{-# LANGUAGE KindSignatures #-}</span><span class="w"></span>
<span class="cm">{-# LANGUAGE MultiParamTypeClasses #-}</span><span class="w"></span>
<span class="cm">{-# LANGUAGE RankNTypes #-}</span><span class="w"></span>
<span class="cm">{-# LANGUAGE TypeOperators #-}</span><span class="w"></span>
<span class="cm">{-# LANGUAGE UndecidableInstances #-}</span><span class="w"></span>

<span class="kr">module</span><span class="w"> </span><span class="nn">AfterResume</span><span class="w"> </span><span class="kr">where</span><span class="w"></span>

<span class="kr">import</span><span class="w"> </span><span class="nn">Control.Algebra</span><span class="w"> </span><span class="p">(</span><span class="kt">Algebra</span><span class="w"> </span><span class="p">(</span><span class="o">..</span><span class="p">),</span><span class="w"> </span><span class="kt">Has</span><span class="p">,</span><span class="w"> </span><span class="nf">send</span><span class="p">,</span><span class="w"> </span><span class="nf">type</span><span class="w"> </span><span class="p">(</span><span class="o">:+:</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="o">..</span><span class="p">))</span><span class="w"></span>
<span class="kr">import</span><span class="w"> </span><span class="nn">Control.Carrier.Lift</span><span class="w"> </span><span class="p">(</span><span class="kt">Lift</span><span class="p">,</span><span class="w"> </span><span class="nf">runM</span><span class="p">,</span><span class="w"> </span><span class="nf">sendIO</span><span class="p">)</span><span class="w"></span>
<span class="kr">import</span><span class="w"> </span><span class="nn">Data.Kind</span><span class="w"> </span><span class="p">(</span><span class="kt">Type</span><span class="p">)</span><span class="w"></span>
<span class="kr">import</span><span class="w"> </span><span class="nn">Data.Type.Equality</span><span class="w"> </span><span class="p">()</span><span class="w"></span>
<span class="kr">import</span><span class="w"> </span><span class="nn">Debug.Trace</span><span class="w"> </span><span class="p">(</span><span class="nf">traceM</span><span class="p">)</span><span class="w"></span>

<span class="kr">data</span><span class="w"> </span><span class="kt">After</span><span class="w"> </span><span class="p">(</span><span class="n">m</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="kt">Type</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">Type</span><span class="p">)</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="kr">where</span><span class="w"></span>
<span class="w">  </span><span class="kt">After</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="kt">String</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">After</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="nb">()</span><span class="w"></span>

<span class="nf">after</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="kt">Has</span><span class="w"> </span><span class="kt">After</span><span class="w"> </span><span class="n">sig</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="ow">=&gt;</span><span class="w"> </span><span class="kt">String</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="nb">()</span><span class="w"></span>
<span class="nf">after</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="n">send</span><span class="w"> </span><span class="p">(</span><span class="kt">After</span><span class="w"> </span><span class="n">s</span><span class="p">)</span><span class="w"></span>

<span class="kr">newtype</span><span class="w"> </span><span class="kt">AfterC</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="kt">AfterC</span><span class="w"> </span><span class="p">{</span><span class="n">runAfterC</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="n">forall</span><span class="w"> </span><span class="n">b</span><span class="o">.</span><span class="w"> </span><span class="p">(</span><span class="n">a</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="n">b</span><span class="p">)</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="n">b</span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="kr">deriving</span><span class="w"> </span><span class="p">(</span><span class="kt">Functor</span><span class="p">)</span><span class="w"></span>

<span class="kr">instance</span><span class="w"> </span><span class="kt">Applicative</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="ow">=&gt;</span><span class="w"> </span><span class="kt">Applicative</span><span class="w"> </span><span class="p">(</span><span class="kt">AfterC</span><span class="w"> </span><span class="n">m</span><span class="p">)</span><span class="w"> </span><span class="kr">where</span><span class="w"></span>
<span class="w">  </span><span class="n">pure</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="kt">AfterC</span><span class="w"> </span><span class="p">(</span><span class="o">$</span><span class="w"> </span><span class="n">a</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kt">AfterC</span><span class="w"> </span><span class="n">f</span><span class="w"> </span><span class="o">&lt;*&gt;</span><span class="w"> </span><span class="kt">AfterC</span><span class="w"> </span><span class="n">v</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="kt">AfterC</span><span class="w"> </span><span class="o">$</span><span class="w"> </span><span class="nf">\</span><span class="n">c</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="n">f</span><span class="w"> </span><span class="o">$</span><span class="w"> </span><span class="nf">\</span><span class="n">g</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="n">v</span><span class="w"> </span><span class="p">(</span><span class="n">c</span><span class="w"> </span><span class="o">.</span><span class="w"> </span><span class="n">g</span><span class="p">)</span><span class="w"></span>

<span class="kr">instance</span><span class="w"> </span><span class="kt">Monad</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="ow">=&gt;</span><span class="w"> </span><span class="kt">Monad</span><span class="w"> </span><span class="p">(</span><span class="kt">AfterC</span><span class="w"> </span><span class="n">m</span><span class="p">)</span><span class="w"> </span><span class="kr">where</span><span class="w"></span>
<span class="w">  </span><span class="n">return</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="kt">AfterC</span><span class="w"> </span><span class="p">(</span><span class="o">$</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="n">m</span><span class="w"> </span><span class="o">&gt;&gt;=</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="kt">AfterC</span><span class="w"> </span><span class="o">$</span><span class="w"> </span><span class="nf">\</span><span class="n">c</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="n">runAfterC</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="p">(</span><span class="nf">\</span><span class="n">x</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="n">runAfterC</span><span class="w"> </span><span class="p">(</span><span class="n">k</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="n">c</span><span class="p">)</span><span class="w"></span>

<span class="nf">evalAfterC</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="p">(</span><span class="kt">Monad</span><span class="w"> </span><span class="n">m</span><span class="p">)</span><span class="w"> </span><span class="ow">=&gt;</span><span class="w"> </span><span class="kt">AfterC</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="n">r</span><span class="w"></span>
<span class="nf">evalAfterC</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="n">runAfterC</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="n">return</span><span class="w"></span>

<span class="nf">lift</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="p">(</span><span class="kt">Monad</span><span class="w"> </span><span class="n">m</span><span class="p">)</span><span class="w"> </span><span class="ow">=&gt;</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">AfterC</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="n">a</span><span class="w"></span>
<span class="nf">lift</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="kt">AfterC</span><span class="w"> </span><span class="p">(</span><span class="n">m</span><span class="w"> </span><span class="o">&gt;&gt;=</span><span class="p">)</span><span class="w"></span>

<span class="nf">resetT</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="p">(</span><span class="kt">Monad</span><span class="w"> </span><span class="n">m</span><span class="p">)</span><span class="w"> </span><span class="ow">=&gt;</span><span class="w"> </span><span class="kt">AfterC</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">AfterC</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="n">r</span><span class="w"></span>
<span class="nf">resetT</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="n">lift</span><span class="w"> </span><span class="o">.</span><span class="w"> </span><span class="n">evalAfterC</span><span class="w"></span>

<span class="nf">shiftT</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="kt">Monad</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="ow">=&gt;</span><span class="w"> </span><span class="p">(</span><span class="n">forall</span><span class="w"> </span><span class="n">b</span><span class="o">.</span><span class="w"> </span><span class="p">(</span><span class="n">a</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="n">b</span><span class="p">)</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">AfterC</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="n">b</span><span class="p">)</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">AfterC</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="n">a</span><span class="w"></span>
<span class="nf">shiftT</span><span class="w"> </span><span class="n">f</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="kt">AfterC</span><span class="w"> </span><span class="p">(</span><span class="n">evalAfterC</span><span class="w"> </span><span class="o">.</span><span class="w"> </span><span class="n">f</span><span class="p">)</span><span class="w"></span>

<span class="kr">instance</span><span class="w"> </span><span class="p">(</span><span class="kt">Has</span><span class="w"> </span><span class="p">(</span><span class="kt">Lift</span><span class="w"> </span><span class="kt">IO</span><span class="p">)</span><span class="w"> </span><span class="n">sig</span><span class="w"> </span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="kt">Algebra</span><span class="w"> </span><span class="n">sig</span><span class="w"> </span><span class="n">m</span><span class="p">)</span><span class="w"> </span><span class="ow">=&gt;</span><span class="w"> </span><span class="kt">Algebra</span><span class="w"> </span><span class="p">(</span><span class="kt">After</span><span class="w"> </span><span class="kt">:+:</span><span class="w"> </span><span class="n">sig</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="kt">AfterC</span><span class="w"> </span><span class="n">m</span><span class="p">)</span><span class="w"> </span><span class="kr">where</span><span class="w"></span>
<span class="w">  </span><span class="n">alg</span><span class="w"> </span><span class="n">hdl</span><span class="w"> </span><span class="n">sig</span><span class="w"> </span><span class="n">ctx</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="kr">case</span><span class="w"> </span><span class="n">sig</span><span class="w"> </span><span class="kr">of</span><span class="w"></span>
<span class="w">    </span><span class="kt">L</span><span class="w"> </span><span class="p">(</span><span class="kt">After</span><span class="w"> </span><span class="n">s</span><span class="p">)</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="n">shiftT</span><span class="w"> </span><span class="p">(</span><span class="nf">\</span><span class="n">k</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="n">lift</span><span class="w"> </span><span class="o">$</span><span class="w"> </span><span class="kr">do</span><span class="w"></span>
<span class="w">        </span><span class="n">res</span><span class="w"> </span><span class="ow">&lt;-</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="p">(</span><span class="nb">()</span><span class="w"> </span><span class="o">&lt;$</span><span class="w"> </span><span class="n">ctx</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">sendIO</span><span class="w"> </span><span class="p">(</span><span class="n">putStrLn</span><span class="w"> </span><span class="n">s</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">return</span><span class="w"> </span><span class="n">res</span><span class="w"></span>
<span class="w">      </span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="kt">R</span><span class="w"> </span><span class="n">other</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="n">lift</span><span class="w"> </span><span class="o">$</span><span class="w"> </span><span class="n">alg</span><span class="w"> </span><span class="p">(</span><span class="n">evalAfterC</span><span class="w"> </span><span class="o">.</span><span class="w"> </span><span class="n">hdl</span><span class="p">)</span><span class="w"> </span><span class="n">other</span><span class="w"> </span><span class="n">ctx</span><span class="w"></span>

<span class="nf">test</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="p">(</span><span class="kt">Has</span><span class="w"> </span><span class="kt">After</span><span class="w"> </span><span class="n">sig</span><span class="w"> </span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="kt">Has</span><span class="w"> </span><span class="p">(</span><span class="kt">Lift</span><span class="w"> </span><span class="kt">IO</span><span class="p">)</span><span class="w"> </span><span class="n">sig</span><span class="w"> </span><span class="n">m</span><span class="p">)</span><span class="w"> </span><span class="ow">=&gt;</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="nb">()</span><span class="w"></span>
<span class="nf">test</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="kr">do</span><span class="w"></span>
<span class="w">  </span><span class="n">traceM</span><span class="w"> </span><span class="s">"0"</span><span class="w"></span>
<span class="w">  </span><span class="n">sendIO</span><span class="w"> </span><span class="p">(</span><span class="n">putStrLn</span><span class="w"> </span><span class="s">"a"</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="n">after</span><span class="w"> </span><span class="s">"a"</span><span class="w"></span>
<span class="w">  </span><span class="n">traceM</span><span class="w"> </span><span class="s">"1"</span><span class="w"></span>
<span class="w">  </span><span class="n">sendIO</span><span class="w"> </span><span class="p">(</span><span class="n">putStrLn</span><span class="w"> </span><span class="s">"b"</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="n">after</span><span class="w"> </span><span class="s">"b"</span><span class="w"></span>
<span class="w">  </span><span class="n">traceM</span><span class="w"> </span><span class="s">"2"</span><span class="w"></span>
<span class="w">  </span><span class="n">return</span><span class="w"> </span><span class="nb">()</span><span class="w"></span>

<span class="nf">runTest</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="kt">IO</span><span class="w"> </span><span class="nb">()</span><span class="w"></span>
<span class="nf">runTest</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="kr">do</span><span class="w"></span>
<span class="w">  </span><span class="n">runM</span><span class="w"> </span><span class="o">.</span><span class="w"> </span><span class="n">evalAfterC</span><span class="w"> </span><span class="o">$</span><span class="w"> </span><span class="n">test</span><span class="w"></span>
</code></pre></div>
<p>which produces:</p>
<div class="codehilite" data-code-language="Haskell"><pre><span></span><code><span class="mi">0</span><span class="w"></span>
<span class="nf">a</span><span class="w"></span>
<span class="mi">1</span><span class="w"></span>
<span class="nf">b</span><span class="w"></span>
<span class="mi">2</span><span class="w"></span>
<span class="nf">b</span><span class="w"></span>
<span class="nf">a</span><span class="w"></span>
</code></pre></div>
<p>as desired. </p>
<p>Is this the "right" way to do point (ii)?</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/bde47c5b03ccef51ffa31163807dcf8923ffbb09?version=2"></a><div class="content"><a class="author">Jesse Sigal</a><div class="metadata"><a href="#294907711" name="294907711"><div>2022-08-23 16:49:33</div></a></div><div class="text"><p>The monad carrier is the <code>Codensity</code> monad, so it has delimited continuation operations which I use. But it feels like I must be doing something wrong. Can I somehow explicitly get the continuation for the rest of the computation without using a continuation type monad as the carrier?</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/bde47c5b03ccef51ffa31163807dcf8923ffbb09?version=2"></a><div class="content"><a class="author">Jesse Sigal</a><div class="metadata"><a href="#294908179" name="294908179"><div>2022-08-23 16:52:19</div></a></div><div class="text"><p>Unfortunately, due to the universal quantification of <code>b</code> in <code>AfterC</code>, I can't do anything with the result really. So this doesn't solve point (i).</p></div></div></div></div></div><div class="ui vertical footer segment"><a href="https://github.com/srid/zulip-archive">Powered by Haskell</a> | Questions? Contact <a href="https://www.srid.ca">srid</a></div></div></body></html>