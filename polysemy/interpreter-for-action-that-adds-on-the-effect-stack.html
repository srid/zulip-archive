<html lang="en"><head><meta content="text/html; charset=utf-8" http-equiv="Content-Type"><meta content="width=device-width, initial-scale=1" name="viewport"><meta content="how can I implement runTransaction?
data Db m a where
  -- ...

data Token

runDb :: Member (Embed IO) r =&gt; Token -&gt; Sem (Db &#39;: r) a -&gt; Sem r a
runDb tok = interpret \case

data Transaction m a where
  InTransaction :: Sem (Db &#39;: r) a -&gt; Transaction (Sem r) a

inTransaction :: Member Transaction r =" name="description"><link href="https://funprog.srid.ca/polysemy/interpreter-for-action-that-adds-on-the-effect-stack.html" rel="canonical"><meta property="og:title" content="Interpreter for action that adds on the effect stack - Polysemy"><meta property="og:site_name" content="Functional Programming Zulip Archive"><meta property="og:type" content="article"><meta property="og:article:section" content="Polysemy"><meta property="og:article:modified_time" content="2020-10-09T11:36:58Z"><meta property="og:article:published_time" content="2020-10-08T16:41:15Z"><meta property="og:image" content="https://secure.gravatar.com/avatar/1114fd8de67671f83d3a3ef7594b1950?d=identicon&amp;version=1"><title>Interpreter for action that adds on the effect stack - Polysemy</title><style type="text/css">
div#thesite
{
  font-family   : "Open Sans", sans-serif;
  font-size     : 1em !important;
  margin-top    : 1em;
  margin-bottom : 1em;
}

div#thesite h1
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite h2
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite h3
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite h4
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite h5
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite h6
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite .ui.breadcrumb.rib .section
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite .header
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite .as-header
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite code, pre, tt
{
  font-family : "SFMono-Regular","Menlo","Monaco","Consolas","Liberation Mono","Courier New", monospace;
}

div#thesite .ui.breadcrumb.rib
{
  margin-bottom : 1em;
}



div#thesite .ui.comments.messages .comment .metadata a
{
  color : #808080;
}

div#thesite .ui.comments.messages .comment a.avatar img
{
  height : auto;
}

div#thesite .subtle
{
  color : #808080;
}


div#thesite .messages pre
{
  font-size : 85%;
  overflow  : auto;
  max-width : 100%;
}

div#thesite .messages .message_embed
{
  border-left  : solid 3px #808080;
  padding-left : 0.69999em;
}

div#thesite .messages .message_inline_image img
{
  max-width     : 100%;
  margin-bottom : 1em;
}


/* Generated with Clay, http://fvisser.nl/clay */</style><link href="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.4.1/semantic.min.css" rel="stylesheet"><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/all.min.css" rel="stylesheet"><link href="https://fonts.googleapis.com/css?family=Open+Sans|Oswald&amp;display=swap" rel="stylesheet"><link href="https://fonts.googleapis.com/css?family=Roboto|Open+Sans&amp;display=swap" rel="stylesheet"></head><body><div id="thesite" class="ui text container"><div class="ui violet inverted top attached center aligned segment"><h1 class="ui huge header">Interpreter for action that adds on the effect stack - Polysemy</h1></div><div class="ui attached segment"><div class="ui message"><p>Welcome to the Functional Programming Zulip Chat Archive. You can join the chat <a href="https://funprog.zulipchat.com">here</a>.</p></div><div class="ui breadcrumb rib"><a href="/" class="section">Home</a><i class="right angle icon divider"></i><a href="/polysemy/" class="section">#Polysemy</a><i class="right angle icon divider"></i><div class="active section">Interpreter for action that adds on the effect stack</div></div><div class="ui comments messages"><div class="comment"><a class="avatar"><img src="https://secure.gravatar.com/avatar/1114fd8de67671f83d3a3ef7594b1950?d=identicon&amp;version=1"></a><div class="content"><a class="author">Georgi Lyubenov // googleson78</a><div class="metadata"><a href="#212717313" name="212717313"><div>2020-10-08 16:41:15</div></a></div><div class="text"><p>how can I implement <code>runTransaction</code>?</p>
<div class="codehilite" data-code-language="Haskell"><pre><span></span><code><span class="kr">data</span> <span class="kt">Db</span> <span class="n">m</span> <span class="n">a</span> <span class="kr">where</span>
  <span class="c1">-- ...</span>

<span class="kr">data</span> <span class="kt">Token</span>

<span class="nf">runDb</span> <span class="ow">::</span> <span class="kt">Member</span> <span class="p">(</span><span class="kt">Embed</span> <span class="kt">IO</span><span class="p">)</span> <span class="n">r</span> <span class="ow">=&gt;</span> <span class="kt">Token</span> <span class="ow">-&gt;</span> <span class="kt">Sem</span> <span class="p">(</span><span class="kt">Db</span> <span class="kt">':</span> <span class="n">r</span><span class="p">)</span> <span class="n">a</span> <span class="ow">-&gt;</span> <span class="kt">Sem</span> <span class="n">r</span> <span class="n">a</span>
<span class="nf">runDb</span> <span class="n">tok</span> <span class="ow">=</span> <span class="n">interpret</span> <span class="nf">\</span><span class="kr">case</span>

<span class="kr">data</span> <span class="kt">Transaction</span> <span class="n">m</span> <span class="n">a</span> <span class="kr">where</span>
  <span class="kt">InTransaction</span> <span class="ow">::</span> <span class="kt">Sem</span> <span class="p">(</span><span class="kt">Db</span> <span class="kt">':</span> <span class="n">r</span><span class="p">)</span> <span class="n">a</span> <span class="ow">-&gt;</span> <span class="kt">Transaction</span> <span class="p">(</span><span class="kt">Sem</span> <span class="n">r</span><span class="p">)</span> <span class="n">a</span>

<span class="nf">inTransaction</span> <span class="ow">::</span> <span class="kt">Member</span> <span class="kt">Transaction</span> <span class="n">r</span> <span class="ow">=&gt;</span> <span class="kt">Sem</span> <span class="p">(</span><span class="kt">Db</span> <span class="kt">':</span> <span class="n">r</span><span class="p">)</span> <span class="n">a</span> <span class="ow">-&gt;</span> <span class="kt">Sem</span> <span class="n">r</span> <span class="n">a</span>
<span class="nf">inTransaction</span> <span class="ow">=</span> <span class="n">send</span> <span class="o">.</span> <span class="kt">InTransaction</span>

<span class="nf">runTransaction</span> <span class="ow">::</span>
  <span class="n">forall</span> <span class="n">r</span> <span class="n">a</span><span class="o">.</span>
  <span class="p">(</span><span class="kt">Member</span> <span class="p">(</span><span class="kt">Embed</span> <span class="kt">IO</span><span class="p">)</span> <span class="n">r</span><span class="p">)</span> <span class="ow">=&gt;</span>
  <span class="kt">Sem</span> <span class="n">r</span> <span class="kt">Token</span> <span class="ow">-&gt;</span>
  <span class="p">(</span><span class="kt">Token</span> <span class="ow">-&gt;</span> <span class="kt">Sem</span> <span class="n">r</span> <span class="nb">()</span><span class="p">)</span> <span class="ow">-&gt;</span>
  <span class="kt">Sem</span> <span class="p">(</span><span class="kt">Transaction</span> <span class="kt">':</span> <span class="n">r</span><span class="p">)</span> <span class="n">a</span> <span class="ow">-&gt;</span>
  <span class="kt">Sem</span> <span class="n">r</span> <span class="n">a</span>
<span class="nf">runTransaction</span> <span class="n">acquire</span> <span class="n">release</span> <span class="ow">=</span> <span class="kr">_</span>
</code></pre></div>

<p>this "should be" a straightforward of application and interpretation of <code>Resource</code> (right???), but I'm having issues with the fact that the inside action has a different type from the <code>r</code></p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/7334dc60b6aef6a75cd9284126231f13c76926a5?x=x&amp;version=4"></a><div class="content"><a class="author">Torsten Schmits</a><div class="metadata"><a href="#212718402" name="212718402"><div>2020-10-08 16:49:15</div></a></div><div class="text"><p>do we want to <code>runDb</code> inside <code>runTransaction</code>?</p></div></div></div><div class="comment"><a class="avatar"><img src="https://secure.gravatar.com/avatar/1114fd8de67671f83d3a3ef7594b1950?d=identicon&amp;version=1"></a><div class="content"><a class="author">Georgi Lyubenov // googleson78</a><div class="metadata"><a href="#212718420" name="212718420"><div>2020-10-08 16:49:30</div></a></div><div class="text"><p>yup</p></div></div></div><div class="comment"><a class="avatar"><img src="https://secure.gravatar.com/avatar/1114fd8de67671f83d3a3ef7594b1950?d=identicon&amp;version=1"></a><div class="content"><a class="author">Georgi Lyubenov // googleson78</a><div class="metadata"><a href="#212718446" name="212718446"><div>2020-10-08 16:49:38</div></a></div><div class="text"><p>otherwise you can't dispatch the Db inside</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/7334dc60b6aef6a75cd9284126231f13c76926a5?x=x&amp;version=4"></a><div class="content"><a class="author">Torsten Schmits</a><div class="metadata"><a href="#212722940" name="212722940"><div>2020-10-08 17:23:27</div></a></div><div class="text"><p>tentative solution, without <code>Embed IO</code> on <code>runDb</code>:</p>
<div class="codehilite" data-code-language="Haskell"><pre><span></span><code><span class="nf">runTransaction</span> <span class="ow">::</span>
  <span class="n">forall</span> <span class="n">r</span> <span class="n">a</span><span class="o">.</span>
  <span class="kt">Members</span> <span class="p">[</span><span class="kt">Resource</span><span class="p">,</span> <span class="kt">Embed</span> <span class="kt">IO</span><span class="p">]</span> <span class="n">r</span> <span class="ow">=&gt;</span>
  <span class="kt">Sem</span> <span class="n">r</span> <span class="kt">Token</span> <span class="ow">-&gt;</span>
  <span class="p">(</span><span class="kt">Token</span> <span class="ow">-&gt;</span> <span class="kt">Sem</span> <span class="n">r</span> <span class="nb">()</span><span class="p">)</span> <span class="ow">-&gt;</span>
  <span class="kt">Sem</span> <span class="p">(</span><span class="kt">Transaction</span> <span class="kt">':</span> <span class="n">r</span><span class="p">)</span> <span class="n">a</span> <span class="ow">-&gt;</span>
  <span class="kt">Sem</span> <span class="n">r</span> <span class="n">a</span>
<span class="nf">runTransaction</span> <span class="n">acquire</span> <span class="n">release</span> <span class="ow">=</span>
  <span class="n">interpretH</span> <span class="n">intp</span>
  <span class="kr">where</span>
    <span class="n">intp</span> <span class="ow">::</span>
      <span class="err">∀</span> <span class="n">x</span> <span class="n">f</span> <span class="n">rInitial</span> <span class="o">.</span>
      <span class="kt">Functor</span> <span class="n">f</span> <span class="ow">=&gt;</span>
      <span class="kt">Transaction</span> <span class="p">(</span><span class="kt">Sem</span> <span class="n">rInitial</span><span class="p">)</span> <span class="n">x</span> <span class="ow">-&gt;</span>
      <span class="kt">Sem</span> <span class="p">(</span><span class="kt">WithTactics</span> <span class="kt">Transaction</span> <span class="n">f</span> <span class="p">(</span><span class="kt">Sem</span> <span class="n">rInitial</span><span class="p">)</span> <span class="n">r</span><span class="p">)</span> <span class="p">(</span><span class="n">f</span> <span class="n">x</span><span class="p">)</span>
    <span class="n">intp</span> <span class="ow">=</span> <span class="nf">\</span><span class="kr">case</span>
      <span class="kt">InTransaction</span> <span class="n">ma</span> <span class="ow">-&gt;</span>
        <span class="n">bracket</span> <span class="p">(</span><span class="n">raise</span> <span class="n">acquire</span><span class="p">)</span> <span class="p">(</span><span class="n">raise</span> <span class="o">.</span> <span class="n">release</span><span class="p">)</span> <span class="n">run</span>
        <span class="kr">where</span>
          <span class="n">run</span> <span class="ow">::</span> <span class="kt">Token</span> <span class="ow">-&gt;</span> <span class="kt">Sem</span> <span class="p">(</span><span class="kt">Tactics</span> <span class="n">f</span> <span class="p">(</span><span class="kt">Sem</span> <span class="n">rInitial</span><span class="p">)</span> <span class="p">(</span><span class="kt">Transaction</span> <span class="kt">:</span> <span class="n">r</span><span class="p">)</span> <span class="kt">:</span> <span class="n">r</span><span class="p">)</span> <span class="p">(</span><span class="n">f</span> <span class="n">x</span><span class="p">)</span>
          <span class="n">run</span> <span class="n">tok</span> <span class="ow">=</span> <span class="kr">do</span>
            <span class="kr">let</span>
              <span class="n">ma'</span> <span class="ow">::</span> <span class="kt">Sem</span> <span class="p">(</span><span class="kt">Db</span> <span class="kt">:</span> <span class="n">rInitial</span><span class="p">)</span> <span class="n">x</span>
              <span class="n">ma'</span> <span class="ow">=</span> <span class="n">ma</span>
              <span class="n">ran</span> <span class="ow">::</span> <span class="kt">Sem</span> <span class="n">rInitial</span> <span class="n">x</span>
              <span class="n">ran</span> <span class="ow">=</span> <span class="n">runDb</span> <span class="n">tok</span> <span class="n">ma'</span>
            <span class="n">a</span> <span class="ow">::</span> <span class="kt">Sem</span> <span class="p">(</span><span class="kt">Transaction</span> <span class="kt">:</span> <span class="n">r</span><span class="p">)</span> <span class="p">(</span><span class="n">f</span> <span class="n">x</span><span class="p">)</span> <span class="ow">&lt;-</span> <span class="n">runT</span> <span class="n">ran</span>
            <span class="n">raise</span> <span class="p">(</span><span class="n">runTransaction</span> <span class="n">acquire</span> <span class="n">release</span> <span class="n">a</span><span class="p">)</span>
</code></pre></div></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/7334dc60b6aef6a75cd9284126231f13c76926a5?x=x&amp;version=4"></a><div class="content"><a class="author">Torsten Schmits</a><div class="metadata"><a href="#212722975" name="212722975"><div>2020-10-08 17:23:44</div></a></div><div class="text"><p>I've left all the signatures in for analysis</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/7334dc60b6aef6a75cd9284126231f13c76926a5?x=x&amp;version=4"></a><div class="content"><a class="author">Torsten Schmits</a><div class="metadata"><a href="#212723060" name="212723060"><div>2020-10-08 17:24:13</div></a></div><div class="text"><p>so it definitely helps for type inference to make all the existentials explicit</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/7334dc60b6aef6a75cd9284126231f13c76926a5?x=x&amp;version=4"></a><div class="content"><a class="author">Torsten Schmits</a><div class="metadata"><a href="#212723198" name="212723198"><div>2020-10-08 17:25:38</div></a></div><div class="text"><p>and it is very notable here that our <code>ma</code> is already concretely typed, but <code>runT</code> can still be used since it has <code>∀ m</code> that is just instantiated to our visible <code>Sem rInitial</code></p></div></div></div><div class="comment"><a class="avatar"><img src="https://secure.gravatar.com/avatar/1114fd8de67671f83d3a3ef7594b1950?d=identicon&amp;version=1"></a><div class="content"><a class="author">Georgi Lyubenov // googleson78</a><div class="metadata"><a href="#212723370" name="212723370"><div>2020-10-08 17:27:01</div></a></div><div class="text"><p>do you think you'll need an explicit way to show that <code>Member (Embed IO) (Db ': r)</code> implies <code>Member (Embed IO) rInitial</code>?</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/7334dc60b6aef6a75cd9284126231f13c76926a5?x=x&amp;version=4"></a><div class="content"><a class="author">Torsten Schmits</a><div class="metadata"><a href="#212723581" name="212723581"><div>2020-10-08 17:28:45</div></a></div><div class="text"><p>it works if you put the constraint in the <code>InTransaction</code> ctor as well</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/7334dc60b6aef6a75cd9284126231f13c76926a5?x=x&amp;version=4"></a><div class="content"><a class="author">Torsten Schmits</a><div class="metadata"><a href="#212723646" name="212723646"><div>2020-10-08 17:29:31</div></a></div><div class="text"><p>but optimally I guess you'd just pass <code>runDb</code> as an argument to <code>runTransaction</code></p></div></div></div><div class="comment"><a class="avatar"><img src="https://secure.gravatar.com/avatar/1114fd8de67671f83d3a3ef7594b1950?d=identicon&amp;version=1"></a><div class="content"><a class="author">Georgi Lyubenov // googleson78</a><div class="metadata"><a href="#212723708" name="212723708"><div>2020-10-08 17:30:02</div></a></div><div class="text"><p>how does that help?</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/7334dc60b6aef6a75cd9284126231f13c76926a5?x=x&amp;version=4"></a><div class="content"><a class="author">Torsten Schmits</a><div class="metadata"><a href="#212723787" name="212723787"><div>2020-10-08 17:30:28</div></a></div><div class="text"><p><code>Embed IO</code> won't be visible to <code>runTransaction</code> then</p></div></div></div><div class="comment"><a class="avatar"><img src="https://secure.gravatar.com/avatar/1114fd8de67671f83d3a3ef7594b1950?d=identicon&amp;version=1"></a><div class="content"><a class="author">Georgi Lyubenov // googleson78</a><div class="metadata"><a href="#212723864" name="212723864"><div>2020-10-08 17:31:04</div></a></div><div class="text"><p>if you pass it in as an argument and use it you'll still get the constraint tho?</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/7334dc60b6aef6a75cd9284126231f13c76926a5?x=x&amp;version=4"></a><div class="content"><a class="author">Torsten Schmits</a><div class="metadata"><a href="#212723884" name="212723884"><div>2020-10-08 17:31:13</div></a></div><div class="text"><p>but at the callsite</p></div></div></div><div class="comment"><a class="avatar"><img src="https://secure.gravatar.com/avatar/1114fd8de67671f83d3a3ef7594b1950?d=identicon&amp;version=1"></a><div class="content"><a class="author">Georgi Lyubenov // googleson78</a><div class="metadata"><a href="#212723907" name="212723907"><div>2020-10-08 17:31:29</div></a></div><div class="text"><p>ah so you mean <code>run :: Token -&gt; Sem r a</code></p></div></div></div><div class="comment"><a class="avatar"><img src="https://secure.gravatar.com/avatar/1114fd8de67671f83d3a3ef7594b1950?d=identicon&amp;version=1"></a><div class="content"><a class="author">Georgi Lyubenov // googleson78</a><div class="metadata"><a href="#212723917" name="212723917"><div>2020-10-08 17:31:35</div></a></div><div class="text"><p>and not the specialised version</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/7334dc60b6aef6a75cd9284126231f13c76926a5?x=x&amp;version=4"></a><div class="content"><a class="author">Torsten Schmits</a><div class="metadata"><a href="#212724016" name="212724016"><div>2020-10-08 17:32:10</div></a></div><div class="text"><p>hmmm</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/7334dc60b6aef6a75cd9284126231f13c76926a5?x=x&amp;version=4"></a><div class="content"><a class="author">Torsten Schmits</a><div class="metadata"><a href="#212724043" name="212724043"><div>2020-10-08 17:32:27</div></a></div><div class="text"><p>one sec</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/7334dc60b6aef6a75cd9284126231f13c76926a5?x=x&amp;version=4"></a><div class="content"><a class="author">Torsten Schmits</a><div class="metadata"><a href="#212724181" name="212724181"><div>2020-10-08 17:33:47</div></a></div><div class="text"><div class="codehilite" data-code-language="Haskell"><pre><span></span><code><span class="nf">runTransaction</span> <span class="ow">::</span>
  <span class="n">forall</span> <span class="n">r</span> <span class="n">a</span><span class="o">.</span>
  <span class="kt">Member</span> <span class="kt">Resource</span> <span class="n">r</span> <span class="ow">=&gt;</span>
  <span class="p">(</span><span class="err">∀</span> <span class="n">r'</span> <span class="o">.</span> <span class="kt">Token</span> <span class="ow">-&gt;</span> <span class="kt">InterpreterFor</span> <span class="kt">Db</span> <span class="n">r'</span><span class="p">)</span> <span class="ow">-&gt;</span>
  <span class="kt">Sem</span> <span class="n">r</span> <span class="kt">Token</span> <span class="ow">-&gt;</span>
  <span class="p">(</span><span class="kt">Token</span> <span class="ow">-&gt;</span> <span class="kt">Sem</span> <span class="n">r</span> <span class="nb">()</span><span class="p">)</span> <span class="ow">-&gt;</span>
  <span class="kt">Sem</span> <span class="p">(</span><span class="kt">Transaction</span> <span class="kt">':</span> <span class="n">r</span><span class="p">)</span> <span class="n">a</span> <span class="ow">-&gt;</span>
  <span class="kt">Sem</span> <span class="n">r</span> <span class="n">a</span>
<span class="nf">runTransaction</span> <span class="n">runDb'</span> <span class="n">acquire</span> <span class="n">release</span> <span class="ow">=</span>
  <span class="n">interpretH</span> <span class="n">intp</span>
  <span class="kr">where</span>
    <span class="n">intp</span> <span class="ow">::</span>
      <span class="err">∀</span> <span class="n">x</span> <span class="n">f</span> <span class="n">rInitial</span> <span class="o">.</span>
      <span class="kt">Functor</span> <span class="n">f</span> <span class="ow">=&gt;</span>
      <span class="kt">Transaction</span> <span class="p">(</span><span class="kt">Sem</span> <span class="n">rInitial</span><span class="p">)</span> <span class="n">x</span> <span class="ow">-&gt;</span>
      <span class="kt">Sem</span> <span class="p">(</span><span class="kt">WithTactics</span> <span class="kt">Transaction</span> <span class="n">f</span> <span class="p">(</span><span class="kt">Sem</span> <span class="n">rInitial</span><span class="p">)</span> <span class="n">r</span><span class="p">)</span> <span class="p">(</span><span class="n">f</span> <span class="n">x</span><span class="p">)</span>
    <span class="n">intp</span> <span class="ow">=</span> <span class="nf">\</span><span class="kr">case</span>
      <span class="kt">InTransaction</span> <span class="n">ma</span> <span class="ow">-&gt;</span>
        <span class="n">bracket</span> <span class="p">(</span><span class="n">raise</span> <span class="n">acquire</span><span class="p">)</span> <span class="p">(</span><span class="n">raise</span> <span class="o">.</span> <span class="n">release</span><span class="p">)</span> <span class="n">run</span>
        <span class="kr">where</span>
          <span class="n">run</span> <span class="ow">::</span> <span class="kt">Token</span> <span class="ow">-&gt;</span> <span class="kt">Sem</span> <span class="p">(</span><span class="kt">Tactics</span> <span class="n">f</span> <span class="p">(</span><span class="kt">Sem</span> <span class="n">rInitial</span><span class="p">)</span> <span class="p">(</span><span class="kt">Transaction</span> <span class="kt">:</span> <span class="n">r</span><span class="p">)</span> <span class="kt">:</span> <span class="n">r</span><span class="p">)</span> <span class="p">(</span><span class="n">f</span> <span class="n">x</span><span class="p">)</span>
          <span class="n">run</span> <span class="n">tok</span> <span class="ow">=</span> <span class="kr">do</span>
            <span class="kr">let</span>
              <span class="n">ma'</span> <span class="ow">::</span> <span class="kt">Sem</span> <span class="p">(</span><span class="kt">Db</span> <span class="kt">:</span> <span class="n">rInitial</span><span class="p">)</span> <span class="n">x</span>
              <span class="n">ma'</span> <span class="ow">=</span> <span class="n">ma</span>
              <span class="n">ran</span> <span class="ow">::</span> <span class="kt">Sem</span> <span class="n">rInitial</span> <span class="n">x</span>
              <span class="n">ran</span> <span class="ow">=</span> <span class="n">runDb'</span> <span class="n">tok</span> <span class="n">ma'</span>
            <span class="n">a</span> <span class="ow">::</span> <span class="kt">Sem</span> <span class="p">(</span><span class="kt">Transaction</span> <span class="kt">:</span> <span class="n">r</span><span class="p">)</span> <span class="p">(</span><span class="n">f</span> <span class="n">x</span><span class="p">)</span> <span class="ow">&lt;-</span> <span class="n">runT</span> <span class="n">ran</span>
            <span class="n">raise</span> <span class="p">(</span><span class="n">runTransaction</span> <span class="n">runDb'</span> <span class="n">acquire</span> <span class="n">release</span> <span class="n">a</span><span class="p">)</span>
</code></pre></div></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/7334dc60b6aef6a75cd9284126231f13c76926a5?x=x&amp;version=4"></a><div class="content"><a class="author">Torsten Schmits</a><div class="metadata"><a href="#212724288" name="212724288"><div>2020-10-08 17:34:30</div></a></div><div class="text"><p>like this. but this might have to be tweaked, search the <code>polysemy-resume</code> topic for <em>significantly relaxed</em> <span aria-label="sweat smile" class="emoji emoji-1f605" role="img" title="sweat smile">:sweat_smile:</span></p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/7334dc60b6aef6a75cd9284126231f13c76926a5?x=x&amp;version=4"></a><div class="content"><a class="author">Torsten Schmits</a><div class="metadata"><a href="#212724394" name="212724394"><div>2020-10-08 17:35:24</div></a></div><div class="text"><p>but with this, you should be able to experiment more easily</p></div></div></div><div class="comment"><a class="avatar"><img src="https://secure.gravatar.com/avatar/1114fd8de67671f83d3a3ef7594b1950?d=identicon&amp;version=1"></a><div class="content"><a class="author">Georgi Lyubenov // googleson78</a><div class="metadata"><a href="#212724610" name="212724610"><div>2020-10-08 17:37:07</div></a></div><div class="text"><p>cool, thanks!</p>
<p>still not sure how to navigate the Tactics/Strategy related type sigs/errors</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/7334dc60b6aef6a75cd9284126231f13c76926a5?x=x&amp;version=4"></a><div class="content"><a class="author">Torsten Schmits</a><div class="metadata"><a href="#212724698" name="212724698"><div>2020-10-08 17:37:58</div></a></div><div class="text"><p>well, the most important thing is to internalize that <code>Tactics</code> is just a regular effect that has to be at the head everywhere in <code>interpretH</code></p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/7334dc60b6aef6a75cd9284126231f13c76926a5?x=x&amp;version=4"></a><div class="content"><a class="author">Torsten Schmits</a><div class="metadata"><a href="#212724791" name="212724791"><div>2020-10-08 17:38:33</div></a></div><div class="text"><p>and that it carries an <code>m</code>, which corresponds to the <code>Sem r</code> in you higher-order thunk in the constructor <code>InTransaction</code></p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/7334dc60b6aef6a75cd9284126231f13c76926a5?x=x&amp;version=4"></a><div class="content"><a class="author">Torsten Schmits</a><div class="metadata"><a href="#212724828" name="212724828"><div>2020-10-08 17:38:58</div></a></div><div class="text"><p>and then you only need to find the right combinator from the <code>Tactics</code> module to lift your thunk into the right signature</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/7334dc60b6aef6a75cd9284126231f13c76926a5?x=x&amp;version=4"></a><div class="content"><a class="author">Torsten Schmits</a><div class="metadata"><a href="#212724928" name="212724928"><div>2020-10-08 17:39:52</div></a></div><div class="text"><p><code>runT</code> does that here, it's <code>Sem rInitial a -&gt; Sem (Transaction : r) (f a)</code> effectively</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/7334dc60b6aef6a75cd9284126231f13c76926a5?x=x&amp;version=4"></a><div class="content"><a class="author">Torsten Schmits</a><div class="metadata"><a href="#212725039" name="212725039"><div>2020-10-08 17:40:33</div></a></div><div class="text"><p>where <code>rInitial</code> is the <code>r</code> from <code>InTransaction</code> as seen from the perspective of <code>interpretH</code>, where <code>r</code> is the final stack</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/7334dc60b6aef6a75cd9284126231f13c76926a5?x=x&amp;version=4"></a><div class="content"><a class="author">Torsten Schmits</a><div class="metadata"><a href="#212725417" name="212725417"><div>2020-10-08 17:43:56</div></a></div><div class="text"><p>really curious to see if this works well at runtime <span aria-label="sweat smile" class="emoji emoji-1f605" role="img" title="sweat smile">:sweat_smile:</span></p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/7334dc60b6aef6a75cd9284126231f13c76926a5?x=x&amp;version=4"></a><div class="content"><a class="author">Torsten Schmits</a><div class="metadata"><a href="#212725815" name="212725815"><div>2020-10-08 17:47:20</div></a></div><div class="text"><p>btw if you want to allow nested calls to <code>inTransaction</code>, you will have to switch out the interpreter in the last line to avoid double bracketing</p></div></div></div><div class="comment"><a class="avatar"><img src="https://secure.gravatar.com/avatar/1114fd8de67671f83d3a3ef7594b1950?d=identicon&amp;version=1"></a><div class="content"><a class="author">Georgi Lyubenov // googleson78</a><div class="metadata"><a href="#212725829" name="212725829"><div>2020-10-08 17:47:28</div></a></div><div class="text"><p>if this doesn't work, Resource probably won't too <span aria-label="thinking" class="emoji emoji-1f914" role="img" title="thinking">:thinking:</span> it's almost directly a Resource usage<br>
in fact now that I think about it, you can probably do away with <code>Transaction</code> entirely</p></div></div></div><div class="comment"><a class="avatar"><img src="https://secure.gravatar.com/avatar/1114fd8de67671f83d3a3ef7594b1950?d=identicon&amp;version=1"></a><div class="content"><a class="author">Georgi Lyubenov // googleson78</a><div class="metadata"><a href="#212725951" name="212725951"><div>2020-10-08 17:48:21</div></a></div><div class="text"><p><span class="user-mention silent" data-user-id="260881">Torsten Schmits</span> <a href="#narrow/stream/216942-Polysemy/topic/Interpreter.20for.20action.20that.20adds.20on.20the.20effect.20stack/near/212725815">said</a>:</p>
<blockquote>
<p>btw if you want to allow nested calls to <code>inTransaction</code>, you will have to switch out the interpreter in the last line to avoid double bracketing</p>
</blockquote>
<p>won't the semantics be right? in nested <code>inTransaction</code>s you're using the "innermost" transaction</p></div></div></div><div class="comment"><a class="avatar"><img src="https://secure.gravatar.com/avatar/1114fd8de67671f83d3a3ef7594b1950?d=identicon&amp;version=1"></a><div class="content"><a class="author">Georgi Lyubenov // googleson78</a><div class="metadata"><a href="#212725986" name="212725986"><div>2020-10-08 17:48:40</div></a></div><div class="text"><p>which is what I'd expected (e.g. from name shadowing)</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/7334dc60b6aef6a75cd9284126231f13c76926a5?x=x&amp;version=4"></a><div class="content"><a class="author">Torsten Schmits</a><div class="metadata"><a href="#212725989" name="212725989"><div>2020-10-08 17:48:42</div></a></div><div class="text"><p>guess so!</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/7334dc60b6aef6a75cd9284126231f13c76926a5?x=x&amp;version=4"></a><div class="content"><a class="author">Torsten Schmits</a><div class="metadata"><a href="#212726119" name="212726119"><div>2020-10-08 17:49:52</div></a></div><div class="text"><p>and using Resource directly just means that you can't use a pure interpreter</p></div></div></div><div class="comment"><a class="avatar"><img src="https://secure.gravatar.com/avatar/1114fd8de67671f83d3a3ef7594b1950?d=identicon&amp;version=1"></a><div class="content"><a class="author">Georgi Lyubenov // googleson78</a><div class="metadata"><a href="#212726301" name="212726301"><div>2020-10-08 17:51:07</div></a></div><div class="text"><p>you can still <code>runIgnoreResource</code> which just drops alloc and dealloc (not in library), if you want to use a <code>Set</code> instead of an actual db</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/7334dc60b6aef6a75cd9284126231f13c76926a5?x=x&amp;version=4"></a><div class="content"><a class="author">Torsten Schmits</a><div class="metadata"><a href="#212726347" name="212726347"><div>2020-10-08 17:51:28</div></a></div><div class="text"><p>I see!</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/7334dc60b6aef6a75cd9284126231f13c76926a5?x=x&amp;version=4"></a><div class="content"><a class="author">Torsten Schmits</a><div class="metadata"><a href="#212726601" name="212726601"><div>2020-10-08 17:53:09</div></a></div><div class="text"><p>for completeness:</p>
<div class="codehilite" data-code-language="Haskell"><pre><span></span><code><span class="nf">runTransaction'</span> <span class="ow">::</span>
  <span class="n">forall</span> <span class="n">t</span> <span class="n">r</span> <span class="o">.</span>
  <span class="kt">Member</span> <span class="kt">Resource</span> <span class="n">r</span> <span class="ow">=&gt;</span>
  <span class="p">(</span><span class="err">∀</span> <span class="n">r'</span> <span class="o">.</span> <span class="n">t</span> <span class="ow">-&gt;</span> <span class="kt">InterpreterFor</span> <span class="kt">Db</span> <span class="n">r'</span><span class="p">)</span> <span class="ow">-&gt;</span>
  <span class="kt">Sem</span> <span class="n">r</span> <span class="n">t</span> <span class="ow">-&gt;</span>
  <span class="p">(</span><span class="n">t</span> <span class="ow">-&gt;</span> <span class="kt">Sem</span> <span class="n">r</span> <span class="nb">()</span><span class="p">)</span> <span class="ow">-&gt;</span>
  <span class="kt">InterpreterFor</span> <span class="kt">Transaction</span> <span class="n">r</span>
<span class="nf">runTransaction'</span> <span class="n">runDb'</span> <span class="n">acquire</span> <span class="n">release</span> <span class="ow">=</span>
  <span class="n">interpretH</span> <span class="nf">\</span><span class="kr">case</span>
    <span class="kt">InTransaction</span> <span class="n">ma</span> <span class="ow">-&gt;</span>
      <span class="n">bracket</span> <span class="p">(</span><span class="n">raise</span> <span class="n">acquire</span><span class="p">)</span> <span class="p">(</span><span class="n">raise</span> <span class="o">.</span> <span class="n">release</span><span class="p">)</span> <span class="nf">\</span> <span class="n">tok</span> <span class="ow">-&gt;</span>
        <span class="n">raise</span> <span class="o">.</span> <span class="n">runTransaction</span> <span class="n">runDb'</span> <span class="n">acquire</span> <span class="n">release</span> <span class="o">=&lt;&lt;</span> <span class="n">runT</span> <span class="p">(</span><span class="n">runDb'</span> <span class="n">tok</span> <span class="n">ma</span><span class="p">)</span>
</code></pre></div></div></div></div><div class="comment"><a class="avatar"><img src="https://secure.gravatar.com/avatar/1114fd8de67671f83d3a3ef7594b1950?d=identicon&amp;version=1"></a><div class="content"><a class="author">Georgi Lyubenov // googleson78</a><div class="metadata"><a href="#212726874" name="212726874"><div>2020-10-08 17:55:10</div></a></div><div class="text"><p>btw, do you know how the Tactics internals actually "give you" the next <code>Transaction</code> that you might need</p></div></div></div><div class="comment"><a class="avatar"><img src="https://secure.gravatar.com/avatar/1114fd8de67671f83d3a3ef7594b1950?d=identicon&amp;version=1"></a><div class="content"><a class="author">Georgi Lyubenov // googleson78</a><div class="metadata"><a href="#212726884" name="212726884"><div>2020-10-08 17:55:13</div></a></div><div class="text"><p>for the recursive call</p></div></div></div><div class="comment"><a class="avatar"><img src="https://secure.gravatar.com/avatar/1114fd8de67671f83d3a3ef7594b1950?d=identicon&amp;version=1"></a><div class="content"><a class="author">Georgi Lyubenov // googleson78</a><div class="metadata"><a href="#212726943" name="212726943"><div>2020-10-08 17:55:53</div></a></div><div class="text"><p>afaiu you're peeling off all the possible <code>Transaction</code> invocations (and in general, when you use Tactics and make that recursive call you're doing that)</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/7334dc60b6aef6a75cd9284126231f13c76926a5?x=x&amp;version=4"></a><div class="content"><a class="author">Torsten Schmits</a><div class="metadata"><a href="#212727205" name="212727205"><div>2020-10-08 17:57:54</div></a></div><div class="text"><p>when you recurse, you basically run the interpreter on the <code>ma</code>, since it <em>might</em> contain repeated uses of it, afaiu. I recommend (re-)reading Sandy's blogposts on the matter</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/7334dc60b6aef6a75cd9284126231f13c76926a5?x=x&amp;version=4"></a><div class="content"><a class="author">Torsten Schmits</a><div class="metadata"><a href="#212727415" name="212727415"><div>2020-10-08 17:59:14</div></a></div><div class="text"><p>because at that point, your <code>ma</code> is still untouched and you're already in the interpreter</p></div></div></div><div class="comment"><a class="avatar"><img src="https://secure.gravatar.com/avatar/1114fd8de67671f83d3a3ef7594b1950?d=identicon&amp;version=1"></a><div class="content"><a class="author">Georgi Lyubenov // googleson78</a><div class="metadata"><a href="#212736544" name="212736544"><div>2020-10-08 19:14:54</div></a></div><div class="text"><p>funny, you can't do that transformation</p></div></div></div><div class="comment"><a class="avatar"><img src="https://secure.gravatar.com/avatar/1114fd8de67671f83d3a3ef7594b1950?d=identicon&amp;version=1"></a><div class="content"><a class="author">Georgi Lyubenov // googleson78</a><div class="metadata"><a href="#212736574" name="212736574"><div>2020-10-08 19:15:11</div></a></div><div class="text"><div class="codehilite" data-code-language="Haskell"><pre><span></span><code>        <span class="n">bracket</span> <span class="p">(</span><span class="n">raise</span> <span class="n">acquire</span><span class="p">)</span> <span class="p">(</span><span class="n">raise</span> <span class="o">.</span> <span class="n">release</span><span class="p">)</span> <span class="nf">\</span><span class="n">tok</span> <span class="ow">-&gt;</span> <span class="kr">do</span>
          <span class="n">a</span> <span class="ow">&lt;-</span> <span class="p">(</span><span class="kr">let</span> <span class="n">x</span> <span class="ow">=</span> <span class="n">runT</span> <span class="o">$</span> <span class="n">runDb'</span> <span class="n">tok</span> <span class="n">ma</span> <span class="kr">in</span> <span class="n">x</span><span class="p">)</span>
          <span class="kr">let</span> <span class="n">g</span> <span class="ow">=</span> <span class="n">raise</span> <span class="o">.</span> <span class="n">runTransaction</span> <span class="n">runDb'</span> <span class="n">acquire</span> <span class="n">release</span>
          <span class="n">g</span> <span class="n">a</span>
</code></pre></div>

<p>this is fine</p></div></div></div><div class="comment"><a class="avatar"><img src="https://secure.gravatar.com/avatar/1114fd8de67671f83d3a3ef7594b1950?d=identicon&amp;version=1"></a><div class="content"><a class="author">Georgi Lyubenov // googleson78</a><div class="metadata"><a href="#212736717" name="212736717"><div>2020-10-08 19:16:17</div></a></div><div class="text"><p>nvm, just sleepy</p></div></div></div><div class="comment"><a class="avatar"><img src="https://secure.gravatar.com/avatar/1114fd8de67671f83d3a3ef7594b1950?d=identicon&amp;version=1"></a><div class="content"><a class="author">Georgi Lyubenov // googleson78</a><div class="metadata"><a href="#212738160" name="212738160"><div>2020-10-08 19:27:48</div></a></div><div class="text"><p>aand the <code>Transaction</code>-less version is uh..</p>
<div class="codehilite" data-code-language="Haskell"><pre><span></span><code><span class="nf">runTransaction</span> <span class="ow">::</span>
  <span class="kt">Member</span> <span class="kt">Resource</span> <span class="n">r</span> <span class="ow">=&gt;</span>
  <span class="kt">Sem</span> <span class="n">r</span> <span class="kt">Token</span> <span class="ow">-&gt;</span>
  <span class="p">(</span><span class="kt">Token</span> <span class="ow">-&gt;</span> <span class="kt">Sem</span> <span class="n">r</span> <span class="nb">()</span><span class="p">)</span> <span class="ow">-&gt;</span>
  <span class="p">(</span><span class="n">forall</span> <span class="n">r'</span><span class="o">.</span> <span class="kt">Token</span> <span class="ow">-&gt;</span> <span class="n">forall</span> <span class="n">b</span><span class="o">.</span> <span class="kt">Sem</span> <span class="p">(</span><span class="kt">Db</span> <span class="kt">':</span> <span class="n">r'</span><span class="p">)</span> <span class="n">b</span> <span class="ow">-&gt;</span> <span class="kt">Sem</span> <span class="n">r'</span> <span class="n">b</span><span class="p">)</span> <span class="ow">-&gt;</span>
  <span class="kt">Sem</span> <span class="p">(</span><span class="kt">Db</span> <span class="kt">':</span> <span class="n">r</span><span class="p">)</span> <span class="n">a</span> <span class="ow">-&gt;</span>
  <span class="kt">Sem</span> <span class="n">r</span> <span class="n">a</span>
<span class="nf">runTransaction</span> <span class="n">acquire</span> <span class="n">release</span> <span class="n">act</span> <span class="n">query</span> <span class="ow">=</span>
  <span class="n">bracket</span> <span class="n">acquire</span> <span class="n">release</span> <span class="p">(`</span><span class="n">act</span><span class="p">`</span> <span class="n">query</span><span class="p">)</span>
</code></pre></div></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/7334dc60b6aef6a75cd9284126231f13c76926a5?x=x&amp;version=4"></a><div class="content"><a class="author">Torsten Schmits</a><div class="metadata"><a href="#212738478" name="212738478"><div>2020-10-08 19:30:07</div></a></div><div class="text"><p>and that's better?</p></div></div></div><div class="comment"><a class="avatar"><img src="https://secure.gravatar.com/avatar/1114fd8de67671f83d3a3ef7594b1950?d=identicon&amp;version=1"></a><div class="content"><a class="author">Georgi Lyubenov // googleson78</a><div class="metadata"><a href="#212738516" name="212738516"><div>2020-10-08 19:30:31</div></a></div><div class="text"><p>¯\_(ツ)_/¯</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/7334dc60b6aef6a75cd9284126231f13c76926a5?x=x&amp;version=4"></a><div class="content"><a class="author">Torsten Schmits</a><div class="metadata"><a href="#212738572" name="212738572"><div>2020-10-08 19:31:00</div></a></div><div class="text"><p>you won't be able to switch <code>acquire</code> and <code>release</code> for no-ops outside of the program</p></div></div></div><div class="comment"><a class="avatar"><img src="https://secure.gravatar.com/avatar/1114fd8de67671f83d3a3ef7594b1950?d=identicon&amp;version=1"></a><div class="content"><a class="author">Georgi Lyubenov // googleson78</a><div class="metadata"><a href="#212739539" name="212739539"><div>2020-10-08 19:38:59</div></a></div><div class="text"><p>if I make <code>Token</code> polymorphic it'll be fine</p></div></div></div><div class="comment"><a class="avatar"><img src="https://secure.gravatar.com/avatar/1114fd8de67671f83d3a3ef7594b1950?d=identicon&amp;version=1"></a><div class="content"><a class="author">Georgi Lyubenov // googleson78</a><div class="metadata"><a href="#212739575" name="212739575"><div>2020-10-08 19:39:14</div></a></div><div class="text"><p>then I can use <code>token ~ ()</code></p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/7334dc60b6aef6a75cd9284126231f13c76926a5?x=x&amp;version=4"></a><div class="content"><a class="author">Torsten Schmits</a><div class="metadata"><a href="#212739604" name="212739604"><div>2020-10-08 19:39:31</div></a></div><div class="text"><p>how are you using that function then? won't you call it in business logic?</p></div></div></div><div class="comment"><a class="avatar"><img src="https://secure.gravatar.com/avatar/1114fd8de67671f83d3a3ef7594b1950?d=identicon&amp;version=1"></a><div class="content"><a class="author">Georgi Lyubenov // googleson78</a><div class="metadata"><a href="#212740151" name="212740151"><div>2020-10-08 19:44:19</div></a></div><div class="text"><p>yeah yeah, it's worse</p></div></div></div><div class="comment"><a class="avatar"><img src="https://secure.gravatar.com/avatar/1114fd8de67671f83d3a3ef7594b1950?d=identicon&amp;version=1"></a><div class="content"><a class="author">Georgi Lyubenov // googleson78</a><div class="metadata"><a href="#212740161" name="212740161"><div>2020-10-08 19:44:25</div></a></div><div class="text"><p>you're basically doing the work of polysemy manually</p></div></div></div><div class="comment"><a class="avatar"><img src="https://secure.gravatar.com/avatar/1114fd8de67671f83d3a3ef7594b1950?d=identicon&amp;version=1"></a><div class="content"><a class="author">Georgi Lyubenov // googleson78</a><div class="metadata"><a href="#212740180" name="212740180"><div>2020-10-08 19:44:34</div></a></div><div class="text"><p>because you'll end up threading all your functions as arguments</p></div></div></div><div class="comment"><a class="avatar"><img src="https://secure.gravatar.com/avatar/1114fd8de67671f83d3a3ef7594b1950?d=identicon&amp;version=1"></a><div class="content"><a class="author">Georgi Lyubenov // googleson78</a><div class="metadata"><a href="#212740200" name="212740200"><div>2020-10-08 19:44:41</div></a></div><div class="text"><p>that you need to mock</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/7334dc60b6aef6a75cd9284126231f13c76926a5?x=x&amp;version=4"></a><div class="content"><a class="author">Torsten Schmits</a><div class="metadata"><a href="#212740249" name="212740249"><div>2020-10-08 19:45:14</div></a></div><div class="text"><p>just so I'm on the same page, you would have passed <code>acquire</code> etc into the business logic?</p></div></div></div><div class="comment"><a class="avatar"><img src="https://secure.gravatar.com/avatar/1114fd8de67671f83d3a3ef7594b1950?d=identicon&amp;version=1"></a><div class="content"><a class="author">Georgi Lyubenov // googleson78</a><div class="metadata"><a href="#212740411" name="212740411"><div>2020-10-08 19:46:46</div></a></div><div class="text"><p>if I wanted to use the <code>Transaction</code>-less version, I would have made my "business logic" functions take polymorphic functions (the acquire, release and act) to use</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/7334dc60b6aef6a75cd9284126231f13c76926a5?x=x&amp;version=4"></a><div class="content"><a class="author">Torsten Schmits</a><div class="metadata"><a href="#212740447" name="212740447"><div>2020-10-08 19:47:18</div></a></div><div class="text"><p>that sounds very uncomfortable!</p></div></div></div><div class="comment"><a class="avatar"><img src="https://secure.gravatar.com/avatar/1114fd8de67671f83d3a3ef7594b1950?d=identicon&amp;version=1"></a><div class="content"><a class="author">Georgi Lyubenov // googleson78</a><div class="metadata"><a href="#212742734" name="212742734"><div>2020-10-08 20:07:51</div></a></div><div class="text"><p>I think you can't actually call (in a "meaningful way") <code>runTransaction</code> with that type signature</p>
<p>since you have to provide a <code>runDb :: (forall r'. t -&gt; InterpreterFor Db r')</code> that means that your <code>runDb</code> has to work for any <code>r'</code>, or in other words, you can't rely on any effects (other than <code>Db</code>) being in the stack <span aria-label="thinking" class="emoji emoji-1f914" role="img" title="thinking">:thinking:</span></p></div></div></div><div class="comment"><a class="avatar"><img src="https://secure.gravatar.com/avatar/1114fd8de67671f83d3a3ef7594b1950?d=identicon&amp;version=1"></a><div class="content"><a class="author">Georgi Lyubenov // googleson78</a><div class="metadata"><a href="#212749363" name="212749363"><div>2020-10-08 21:08:21</div></a></div><div class="text"><p>I can add a constraint like so</p>
<div class="codehilite" data-code-language="Haskell"><pre><span></span><code><span class="kr">data</span> <span class="kt">Transaction</span> <span class="n">eff</span> <span class="n">m</span> <span class="n">a</span> <span class="kr">where</span>
  <span class="kt">InTransaction</span> <span class="ow">::</span> <span class="n">forall</span> <span class="n">eff</span> <span class="n">inn</span> <span class="n">a</span><span class="o">.</span> <span class="kt">Member</span> <span class="n">eff</span> <span class="n">inn</span> <span class="ow">=&gt;</span> <span class="kt">Sem</span> <span class="p">(</span><span class="kt">Db</span> <span class="kt">':</span> <span class="n">inn</span><span class="p">)</span> <span class="n">a</span> <span class="ow">-&gt;</span> <span class="kt">Transaction</span> <span class="n">eff</span> <span class="p">(</span><span class="kt">Sem</span> <span class="n">inn</span><span class="p">)</span> <span class="n">a</span>
</code></pre></div>

<p>but now I can't write the "send" function <span aria-label="thinking" class="emoji emoji-1f914" role="img" title="thinking">:thinking:</span></p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/7334dc60b6aef6a75cd9284126231f13c76926a5?x=x&amp;version=4"></a><div class="content"><a class="author">Torsten Schmits</a><div class="metadata"><a href="#212750251" name="212750251"><div>2020-10-08 21:14:46</div></a></div><div class="text"><p>yeah, that's what I meant earlier with "look at the other thread" <span aria-label="smile" class="emoji emoji-1f642" role="img" title="smile">:smile:</span></p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/7334dc60b6aef6a75cd9284126231f13c76926a5?x=x&amp;version=4"></a><div class="content"><a class="author">Torsten Schmits</a><div class="metadata"><a href="#212750278" name="212750278"><div>2020-10-08 21:15:13</div></a></div><div class="text"><p>why can't you write the function?</p></div></div></div><div class="comment"><a class="avatar"><img src="https://secure.gravatar.com/avatar/1114fd8de67671f83d3a3ef7594b1950?d=identicon&amp;version=1"></a><div class="content"><a class="author">Georgi Lyubenov // googleson78</a><div class="metadata"><a href="#212751042" name="212751042"><div>2020-10-08 21:22:54</div></a></div><div class="text"><p>when I so much as mention <code>InTransaction</code> e.g.</p>
<div class="codehilite" data-code-language="Haskell"><pre><span></span><code><span class="nf">inTransaction</span> <span class="ow">::</span> <span class="n">forall</span> <span class="n">eff</span> <span class="n">r</span> <span class="n">a</span><span class="o">.</span> <span class="kt">Member</span> <span class="p">(</span><span class="kt">Transaction</span> <span class="n">eff</span><span class="p">)</span> <span class="n">r</span> <span class="ow">=&gt;</span> <span class="kt">Sem</span> <span class="p">(</span><span class="kt">Db</span> <span class="kt">':</span> <span class="n">r</span><span class="p">)</span> <span class="n">a</span> <span class="ow">-&gt;</span> <span class="kt">Sem</span> <span class="n">r</span> <span class="n">a</span>
<span class="nf">inTransaction</span> <span class="kr">_</span> <span class="ow">=</span> <span class="n">undefined</span> <span class="o">$</span> <span class="p">(</span><span class="kt">InTransaction</span> <span class="o">@</span><span class="n">eff</span> <span class="o">@</span><span class="n">r</span> <span class="o">@</span><span class="n">a</span> <span class="n">undefined</span><span class="p">)</span>
</code></pre></div>

<p>I get a "can't find the effect <code>eff</code>" (<code>Could not deduce LocateEff eff r ~ '()</code>)</p></div></div></div><div class="comment"><a class="avatar"><img src="https://secure.gravatar.com/avatar/1114fd8de67671f83d3a3ef7594b1950?d=identicon&amp;version=1"></a><div class="content"><a class="author">Georgi Lyubenov // googleson78</a><div class="metadata"><a href="#212751081" name="212751081"><div>2020-10-08 21:23:24</div></a></div><div class="text"><p>maybe my signature should be different</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/7334dc60b6aef6a75cd9284126231f13c76926a5?x=x&amp;version=4"></a><div class="content"><a class="author">Torsten Schmits</a><div class="metadata"><a href="#212751221" name="212751221"><div>2020-10-08 21:24:37</div></a></div><div class="text"><p><code>Member eff r =&gt;</code>?</p></div></div></div><div class="comment"><a class="avatar"><img src="https://secure.gravatar.com/avatar/1114fd8de67671f83d3a3ef7594b1950?d=identicon&amp;version=1"></a><div class="content"><a class="author">Georgi Lyubenov // googleson78</a><div class="metadata"><a href="#212751256" name="212751256"><div>2020-10-08 21:25:02</div></a></div><div class="text"><p>:facepalm:</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/7334dc60b6aef6a75cd9284126231f13c76926a5?x=x&amp;version=4"></a><div class="content"><a class="author">Torsten Schmits</a><div class="metadata"><a href="#212751265" name="212751265"><div>2020-10-08 21:25:08</div></a></div><div class="text"><p>but I think you need to change the signature of the interpreter parameter in the Transaction interpreter</p></div></div></div><div class="comment"><a class="avatar"><img src="https://secure.gravatar.com/avatar/1114fd8de67671f83d3a3ef7594b1950?d=identicon&amp;version=1"></a><div class="content"><a class="author">Georgi Lyubenov // googleson78</a><div class="metadata"><a href="#212751292" name="212751292"><div>2020-10-08 21:25:30</div></a></div><div class="text"><p>going to sleep first, this is not productive <span aria-label="big smile" class="emoji emoji-1f604" role="img" title="big smile">:big_smile:</span></p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/7334dc60b6aef6a75cd9284126231f13c76926a5?x=x&amp;version=4"></a><div class="content"><a class="author">Torsten Schmits</a><div class="metadata"><a href="#212751318" name="212751318"><div>2020-10-08 21:25:51</div></a></div><div class="text"><p><span aria-label="big smile" class="emoji emoji-1f604" role="img" title="big smile">:big_smile:</span> I'll take a look later as well</p></div></div></div><div class="comment"><a class="avatar"><img src="https://secure.gravatar.com/avatar/1114fd8de67671f83d3a3ef7594b1950?d=identicon&amp;version=1"></a><div class="content"><a class="author">Georgi Lyubenov // googleson78</a><div class="metadata"><a href="#212751326" name="212751326"><div>2020-10-08 21:26:01</div></a></div><div class="text"><p><span class="user-mention silent" data-user-id="260881">Torsten Schmits</span> <a href="#narrow/stream/216942-Polysemy/topic/Interpreter.20for.20action.20that.20adds.20on.20the.20effect.20stack/near/212751265">said</a>:</p>
<blockquote>
<p>but I think you need to change the signature of the interpreter parameter in the Transaction interpreter</p>
</blockquote>
<p>from experience with trying a similar thing?</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/7334dc60b6aef6a75cd9284126231f13c76926a5?x=x&amp;version=4"></a><div class="content"><a class="author">Torsten Schmits</a><div class="metadata"><a href="#212751376" name="212751376"><div>2020-10-08 21:26:11</div></a></div><div class="text"><p>exactly</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/7334dc60b6aef6a75cd9284126231f13c76926a5?x=x&amp;version=4"></a><div class="content"><a class="author">Torsten Schmits</a><div class="metadata"><a href="#212751453" name="212751453"><div>2020-10-08 21:27:00</div></a></div><div class="text"><p><a href="#narrow/stream/216942-Polysemy/topic/cross-interpreter.20errors/near/212495795">https://funprog.zulipchat.com/#narrow/stream/216942-Polysemy/topic/cross-interpreter.20errors/near/212495795</a></p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/7334dc60b6aef6a75cd9284126231f13c76926a5?x=x&amp;version=4"></a><div class="content"><a class="author">Torsten Schmits</a><div class="metadata"><a href="#212751813" name="212751813"><div>2020-10-08 21:30:47</div></a></div><div class="text"><p>might be sufficient to just use <code>r</code> instead of an existential</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/7334dc60b6aef6a75cd9284126231f13c76926a5?x=x&amp;version=4"></a><div class="content"><a class="author">Torsten Schmits</a><div class="metadata"><a href="#212764092" name="212764092"><div>2020-10-09 00:01:06</div></a></div><div class="text"><p>I took another look and I don't see how it could be possible for this to work. we can only hope <span class="user-mention" data-user-id="254034">@Love Waern (King of the Homeless)</span> has some dark magic up his sleeve</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/f1ec33bcc6144366b30e479d6b3bed74cdb9f611?x=x&amp;version=4"></a><div class="content"><a class="author">Love Waern (King of the Homeless)</a><div class="metadata"><a href="#212801533" name="212801533"><div>2020-10-09 09:24:16</div></a></div><div class="text"><p>Seems so. Here's my first go:</p>
<div class="codehilite" data-code-language="Haskell"><pre><span></span><code><span class="kr">data</span> <span class="kt">Transaction</span> <span class="n">s</span> <span class="n">m</span> <span class="n">a</span> <span class="kr">where</span>
  <span class="kt">Trade</span> <span class="ow">::</span> <span class="n">s</span> <span class="ow">-&gt;</span> <span class="kt">Db</span> <span class="n">m</span> <span class="n">a</span> <span class="ow">-&gt;</span> <span class="kt">Transaction</span> <span class="n">s</span> <span class="n">m</span> <span class="n">a</span>
  <span class="kt">InTransaction</span> <span class="ow">::</span> <span class="p">(</span><span class="n">s</span> <span class="ow">-&gt;</span> <span class="n">m</span> <span class="n">a</span><span class="p">)</span> <span class="ow">-&gt;</span> <span class="kt">Transaction</span> <span class="n">s</span> <span class="n">m</span> <span class="n">a</span>

<span class="nf">interpretH'</span> <span class="ow">::</span> <span class="p">(</span><span class="n">forall</span> <span class="n">x</span><span class="o">.</span> <span class="kt">Weaving</span> <span class="n">e</span> <span class="p">(</span><span class="kt">Sem</span> <span class="p">(</span><span class="n">e</span> <span class="kt">':</span> <span class="n">r</span><span class="p">))</span> <span class="n">x</span> <span class="ow">-&gt;</span> <span class="kt">Sem</span> <span class="n">r</span> <span class="n">x</span><span class="p">)</span>
            <span class="ow">-&gt;</span> <span class="kt">Sem</span> <span class="p">(</span><span class="n">e</span> <span class="kt">':</span> <span class="n">r</span><span class="p">)</span> <span class="n">a</span>
            <span class="ow">-&gt;</span> <span class="kt">Sem</span> <span class="n">r</span> <span class="n">a</span>
<span class="nf">interpretH'</span> <span class="n">h</span> <span class="n">sem</span> <span class="ow">=</span> <span class="kt">Sem</span> <span class="o">$</span> <span class="nf">\</span><span class="n">k</span> <span class="ow">-&gt;</span> <span class="n">runSem</span> <span class="n">sem</span> <span class="o">$</span> <span class="nf">\</span><span class="n">u</span> <span class="ow">-&gt;</span> <span class="kr">case</span> <span class="n">decomp</span> <span class="n">u</span> <span class="kr">of</span>
  <span class="kt">Right</span> <span class="n">wav</span> <span class="ow">-&gt;</span> <span class="n">runSem</span> <span class="p">(</span><span class="n">h</span> <span class="n">wav</span><span class="p">)</span> <span class="n">k</span>
  <span class="kt">Left</span>  <span class="n">g</span>   <span class="ow">-&gt;</span> <span class="n">k</span> <span class="o">$</span> <span class="n">hoist</span> <span class="p">(</span><span class="n">interpretH'</span> <span class="n">h</span><span class="p">)</span> <span class="n">g</span>

<span class="nf">inTransaction</span> <span class="ow">::</span> <span class="n">forall</span> <span class="n">s</span> <span class="n">r</span> <span class="n">a</span><span class="o">.</span> <span class="kt">Member</span> <span class="p">(</span><span class="kt">Transaction</span> <span class="n">s</span><span class="p">)</span> <span class="n">r</span> <span class="ow">=&gt;</span> <span class="kt">Sem</span> <span class="p">(</span><span class="kt">Db</span> <span class="kt">':</span> <span class="n">r</span><span class="p">)</span> <span class="n">a</span> <span class="ow">-&gt;</span> <span class="kt">Sem</span> <span class="n">r</span> <span class="n">a</span>
<span class="nf">inTransaction</span> <span class="n">main</span> <span class="ow">=</span> <span class="n">send</span> <span class="o">$</span> <span class="kt">InTransaction</span> <span class="o">@</span><span class="n">s</span> <span class="o">$</span> <span class="nf">\</span><span class="n">token</span> <span class="ow">-&gt;</span> <span class="n">transform</span> <span class="p">(</span><span class="kt">Trade</span> <span class="n">token</span><span class="p">)</span> <span class="n">main</span>

<span class="nf">runTransaction</span> <span class="ow">::</span>
  <span class="n">forall</span> <span class="n">t</span> <span class="n">r</span> <span class="n">a</span><span class="o">.</span>
  <span class="kt">Member</span> <span class="kt">Resource</span> <span class="n">r</span> <span class="ow">=&gt;</span>
  <span class="p">(</span><span class="n">t</span> <span class="ow">-&gt;</span> <span class="kt">InterpreterFor</span> <span class="kt">Db</span> <span class="n">r</span><span class="p">)</span> <span class="ow">-&gt;</span>
  <span class="kt">Sem</span> <span class="n">r</span> <span class="n">t</span> <span class="ow">-&gt;</span>
  <span class="p">(</span><span class="n">t</span> <span class="ow">-&gt;</span> <span class="kt">Sem</span> <span class="n">r</span> <span class="nb">()</span><span class="p">)</span> <span class="ow">-&gt;</span>
  <span class="kt">Sem</span> <span class="p">(</span><span class="kt">Transaction</span> <span class="n">t</span> <span class="kt">':</span> <span class="n">r</span><span class="p">)</span> <span class="n">a</span> <span class="ow">-&gt;</span>
  <span class="kt">Sem</span> <span class="n">r</span> <span class="n">a</span>
<span class="nf">runTransaction</span> <span class="n">runner</span> <span class="n">acquire</span> <span class="n">release</span> <span class="ow">=</span>
  <span class="kr">let</span>
    <span class="n">go</span> <span class="ow">::</span> <span class="n">forall</span> <span class="n">x</span><span class="o">.</span> <span class="kt">Sem</span> <span class="p">(</span><span class="kt">Transaction</span> <span class="n">t</span> <span class="kt">':</span> <span class="n">r</span><span class="p">)</span> <span class="n">x</span> <span class="ow">-&gt;</span> <span class="kt">Sem</span> <span class="n">r</span> <span class="n">x</span>
    <span class="n">go</span> <span class="ow">=</span> <span class="n">interpretH'</span> <span class="o">$</span> <span class="nf">\</span><span class="p">(</span><span class="kt">Weaving</span> <span class="n">eff</span> <span class="n">s</span> <span class="n">wv</span> <span class="n">ex</span> <span class="n">ins</span><span class="p">)</span> <span class="ow">-&gt;</span> <span class="kr">case</span> <span class="n">eff</span> <span class="kr">of</span>
      <span class="kt">Trade</span> <span class="n">token</span> <span class="n">db</span> <span class="ow">-&gt;</span> <span class="n">runner</span> <span class="n">token</span> <span class="p">(</span><span class="n">liftSem</span> <span class="o">$</span> <span class="n">injWeaving</span> <span class="o">$</span> <span class="kt">Weaving</span> <span class="n">db</span> <span class="n">s</span> <span class="p">(</span><span class="n">raise</span> <span class="o">.</span> <span class="n">go</span> <span class="o">.</span> <span class="n">wv</span><span class="p">)</span> <span class="n">ex</span> <span class="n">ins</span><span class="p">)</span>
      <span class="kt">InTransaction</span> <span class="n">main</span> <span class="ow">-&gt;</span> <span class="kr">do</span>
        <span class="kr">let</span> <span class="n">main'</span> <span class="n">token</span> <span class="ow">=</span> <span class="n">go</span> <span class="o">$</span> <span class="n">wv</span> <span class="p">(</span><span class="n">main</span> <span class="n">token</span> <span class="o">&lt;$</span> <span class="n">s</span><span class="p">)</span>
        <span class="n">ex</span> <span class="o">&lt;$&gt;</span> <span class="n">bracket</span> <span class="n">acquire</span> <span class="n">release</span> <span class="n">main'</span>
  <span class="kr">in</span>
    <span class="n">go</span>
</code></pre></div>

<p>Yet again <code>interpretH</code> fails me and I need to work with <code>Weaving</code>s directly.<br>
This might or might not be safe depending on the semantics of the runner. Is it ok if it's used multiple times for a single token -- once per <code>Db</code> action -- as long as the block within a specific token is used is delimited by <code>acquire</code> and <code>release</code>? If so, then this is safe. If not, then this is not safe.</p>
<p>Note that <code>Transaction</code> now needs a type variable. This is like <code>Cont</code>, where application code is expected to keep it fully polymorphic.</p>
<p>There's probably  a more elegant solution. Maybe. I'll look into it more later.</p></div></div></div><div class="comment"><a class="avatar"><img src="https://secure.gravatar.com/avatar/1114fd8de67671f83d3a3ef7594b1950?d=identicon&amp;version=1"></a><div class="content"><a class="author">Georgi Lyubenov // googleson78</a><div class="metadata"><a href="#212802600" name="212802600"><div>2020-10-09 09:37:02</div></a></div><div class="text"><p>what is the <code>Trade</code> for?</p></div></div></div><div class="comment"><a class="avatar"><img src="https://secure.gravatar.com/avatar/1114fd8de67671f83d3a3ef7594b1950?d=identicon&amp;version=1"></a><div class="content"><a class="author">Georgi Lyubenov // googleson78</a><div class="metadata"><a href="#212802732" name="212802732"><div>2020-10-09 09:38:39</div></a></div><div class="text"><p>so I guess there's no "easy" way to "limit" what effects you can use inside <code>InTransaction</code> (or any HO effect for that matter) <span aria-label="thinking" class="emoji emoji-1f914" role="img" title="thinking">:thinking:</span> and hide them from the "outside world" so that it can't interpret them however it pleases</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/f1ec33bcc6144366b30e479d6b3bed74cdb9f611?x=x&amp;version=4"></a><div class="content"><a class="author">Love Waern (King of the Homeless)</a><div class="metadata"><a href="#212802881" name="212802881"><div>2020-10-09 09:40:31</div></a></div><div class="text"><p>The way my definition of <code>Transaction</code> works is that <code>InTransaction</code> provides the means of executing effects of <code>Db</code> locally within a region through some token.  Executing actions of <code>Db</code> is done through <code>Trade</code>. Combining these, you can create the <code>inTransaction</code> action, where you gain access to a token locally so that you may execute actions of <code>Db</code>, and then you interpret the <code>Db</code> effect by using <code>Trade</code>.<br>
This is an implementation detail: users should never use the constructors <code>InTransaction</code> and <code>Trade</code> directly.</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/f1ec33bcc6144366b30e479d6b3bed74cdb9f611?x=x&amp;version=4"></a><div class="content"><a class="author">Love Waern (King of the Homeless)</a><div class="metadata"><a href="#212803154" name="212803154"><div>2020-10-09 09:43:15</div></a></div><div class="text"><p>The only way to "limit" what effects you can use inside a <code>InTransaction</code> is to have a parametrized monad:</p>
<div class="codehilite" data-code-language="Haskell"><pre><span></span><code><span class="kr">data</span> <span class="kt">Transaction</span> <span class="n">rTransaction</span> <span class="n">m</span> <span class="n">a</span> <span class="kr">where</span>
  <span class="kt">InTransaction</span> <span class="ow">::</span> <span class="kt">Sem</span> <span class="p">(</span><span class="kt">Db</span> <span class="kt">':</span> <span class="n">rTransaction</span><span class="p">)</span> <span class="n">a</span> <span class="ow">-&gt;</span> <span class="kt">Transaction</span> <span class="n">rTransaction</span> <span class="n">m</span> <span class="n">a</span>
</code></pre></div>

<p>This is as easy to interpret as it is difficult for application code to use. It's not even a higher-order effect. It's like defining:</p>
<div class="codehilite" data-code-language="Haskell"><pre><span></span><code><span class="kr">data</span> <span class="kt">StMTransaction</span> <span class="n">m</span> <span class="n">a</span> <span class="kr">where</span>
  <span class="kt">Atomically</span> <span class="ow">::</span> <span class="kt">StM</span> <span class="n">a</span> <span class="ow">-&gt;</span> <span class="kt">StMTransaction</span> <span class="n">m</span> <span class="n">a</span>
</code></pre></div></div></div></div><div class="comment"><a class="avatar"><img src="https://secure.gravatar.com/avatar/1114fd8de67671f83d3a3ef7594b1950?d=identicon&amp;version=1"></a><div class="content"><a class="author">Georgi Lyubenov // googleson78</a><div class="metadata"><a href="#212803294" name="212803294"><div>2020-10-09 09:44:37</div></a></div><div class="text"><p>or the "wooden" way of</p>
<div class="codehilite" data-code-language="Haskell"><pre><span></span><code><span class="kr">data</span> <span class="kt">Transaction</span> <span class="n">t</span> <span class="n">m</span> <span class="n">a</span> <span class="kr">where</span>
  <span class="kt">InTransaction</span> <span class="ow">::</span> <span class="p">(</span><span class="n">t</span> <span class="ow">-&gt;</span> <span class="n">m</span> <span class="n">a</span><span class="p">)</span> <span class="ow">-&gt;</span> <span class="kt">Transaction</span> <span class="n">t</span> <span class="n">m</span> <span class="n">a</span>

<span class="kr">data</span> <span class="kt">Db</span> <span class="n">t</span> <span class="n">m</span> <span class="n">a</span> <span class="kr">where</span>
  <span class="o">..</span><span class="n">add</span> <span class="n">a</span> <span class="n">t</span> <span class="n">argument</span> <span class="n">to</span> <span class="n">all</span> <span class="n">the</span> <span class="n">actions</span><span class="o">..</span>
</code></pre></div>

<p><span aria-label="big smile" class="emoji emoji-1f604" role="img" title="big smile">:big_smile:</span></p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/f1ec33bcc6144366b30e479d6b3bed74cdb9f611?x=x&amp;version=4"></a><div class="content"><a class="author">Love Waern (King of the Homeless)</a><div class="metadata"><a href="#212803344" name="212803344"><div>2020-10-09 09:45:11</div></a></div><div class="text"><p>Eh. That leaks implementation details of <code>Transaction</code> to <code>Db</code>. I prefer the <code>Trade</code> approach.</p></div></div></div><div class="comment"><a class="avatar"><img src="https://secure.gravatar.com/avatar/1114fd8de67671f83d3a3ef7594b1950?d=identicon&amp;version=1"></a><div class="content"><a class="author">Georgi Lyubenov // googleson78</a><div class="metadata"><a href="#212803470" name="212803470"><div>2020-10-09 09:46:22</div></a></div><div class="text"><p>yep, as a library writer!</p></div></div></div><div class="comment"><a class="avatar"><img src="https://secure.gravatar.com/avatar/1114fd8de67671f83d3a3ef7594b1950?d=identicon&amp;version=1"></a><div class="content"><a class="author">Georgi Lyubenov // googleson78</a><div class="metadata"><a href="#212805581" name="212805581"><div>2020-10-09 10:10:09</div></a></div><div class="text"><p>in <code>inTransaction</code> you're replacing all the <code>Db</code> actions with the same actions but with <code>Trade</code>s around them, right?</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/f1ec33bcc6144366b30e479d6b3bed74cdb9f611?x=x&amp;version=4"></a><div class="content"><a class="author">Love Waern (King of the Homeless)</a><div class="metadata"><a href="#212805727" name="212805727"><div>2020-10-09 10:12:02</div></a></div><div class="text"><p>Yes.</p></div></div></div><div class="comment"><a class="avatar"><img src="https://secure.gravatar.com/avatar/1114fd8de67671f83d3a3ef7594b1950?d=identicon&amp;version=1"></a><div class="content"><a class="author">Georgi Lyubenov // googleson78</a><div class="metadata"><a href="#212806061" name="212806061"><div>2020-10-09 10:15:48</div></a></div><div class="text"><p>cool, thanks!</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/f1ec33bcc6144366b30e479d6b3bed74cdb9f611?x=x&amp;version=4"></a><div class="content"><a class="author">Love Waern (King of the Homeless)</a><div class="metadata"><a href="#212808671" name="212808671"><div>2020-10-09 10:45:14</div></a></div><div class="text"><p>oh yeah I can use <code>transform</code> for that. Forgot that existed.</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/f1ec33bcc6144366b30e479d6b3bed74cdb9f611?x=x&amp;version=4"></a><div class="content"><a class="author">Love Waern (King of the Homeless)</a><div class="metadata"><a href="#212808775" name="212808775"><div>2020-10-09 10:46:10</div></a></div><div class="text"><div class="codehilite" data-code-language="Haskell"><pre><span></span><code><span class="nf">inTransaction</span> <span class="ow">::</span> <span class="n">forall</span> <span class="n">s</span> <span class="n">r</span> <span class="n">a</span><span class="o">.</span> <span class="kt">Member</span> <span class="p">(</span><span class="kt">Transaction</span> <span class="n">s</span><span class="p">)</span> <span class="n">r</span> <span class="ow">=&gt;</span> <span class="kt">Sem</span> <span class="p">(</span><span class="kt">Db</span> <span class="kt">':</span> <span class="n">r</span><span class="p">)</span> <span class="n">a</span> <span class="ow">-&gt;</span> <span class="kt">Sem</span> <span class="n">r</span> <span class="n">a</span>
<span class="nf">inTransaction</span> <span class="n">main</span> <span class="ow">=</span> <span class="n">send</span> <span class="o">$</span> <span class="kt">InTransaction</span> <span class="o">@</span><span class="n">s</span> <span class="o">$</span> <span class="nf">\</span><span class="n">token</span> <span class="ow">-&gt;</span> <span class="n">transform</span> <span class="p">(</span><span class="kt">Trade</span> <span class="n">token</span><span class="p">)</span> <span class="n">main</span>
</code></pre></div></div></div></div><div class="comment"><a class="avatar"><img src="https://secure.gravatar.com/avatar/1114fd8de67671f83d3a3ef7594b1950?d=identicon&amp;version=1"></a><div class="content"><a class="author">Georgi Lyubenov // googleson78</a><div class="metadata"><a href="#212809107" name="212809107"><div>2020-10-09 10:50:31</div></a></div><div class="text"><p>so mayber <code>interpretH'</code> should also be somewhere in the library, especially if you've had to rely on it more than once?</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/f1ec33bcc6144366b30e479d6b3bed74cdb9f611?x=x&amp;version=4"></a><div class="content"><a class="author">Love Waern (King of the Homeless)</a><div class="metadata"><a href="#212809261" name="212809261"><div>2020-10-09 10:52:11</div></a></div><div class="text"><p>I've been humming and hawing about that. Honestly, I'm not satisfied with <code>interpretH</code>. It's too complicated for it's own good.</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/f1ec33bcc6144366b30e479d6b3bed74cdb9f611?x=x&amp;version=4"></a><div class="content"><a class="author">Love Waern (King of the Homeless)</a><div class="metadata"><a href="#212809292" name="212809292"><div>2020-10-09 10:52:35</div></a></div><div class="text"><p>In fact, personally, I learned how <code>Weaving</code>s worked before I learned how <code>interpretH</code> worked!</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/f1ec33bcc6144366b30e479d6b3bed74cdb9f611?x=x&amp;version=4"></a><div class="content"><a class="author">Love Waern (King of the Homeless)</a><div class="metadata"><a href="#212809752" name="212809752"><div>2020-10-09 10:58:24</div></a></div><div class="text"><p>Maybe this could be added as an alternative:</p>
<div class="codehilite" data-code-language="Haskell"><pre><span></span><code><span class="nf">interpretH'</span> <span class="ow">::</span> <span class="p">(</span>  <span class="n">forall</span> <span class="n">s</span> <span class="n">r0</span> <span class="n">x</span>
                <span class="o">.</span> <span class="n">s</span> <span class="nb">()</span>
               <span class="ow">-&gt;</span> <span class="p">(</span><span class="n">forall</span> <span class="n">y</span><span class="o">.</span> <span class="n">s</span> <span class="p">(</span><span class="kt">Sem</span> <span class="n">r0</span> <span class="n">y</span><span class="p">)</span> <span class="ow">-&gt;</span> <span class="kt">Sem</span> <span class="p">(</span><span class="n">e</span> <span class="kt">':</span> <span class="n">r</span><span class="p">)</span> <span class="p">(</span><span class="n">s</span> <span class="n">y</span><span class="p">))</span>
               <span class="ow">-&gt;</span> <span class="p">(</span><span class="n">forall</span> <span class="n">y</span><span class="o">.</span> <span class="n">s</span> <span class="n">y</span> <span class="ow">-&gt;</span> <span class="kt">Maybe</span> <span class="n">y</span><span class="p">)</span>
               <span class="ow">-&gt;</span> <span class="n">e</span> <span class="p">(</span><span class="kt">Sem</span> <span class="n">r0</span><span class="p">)</span> <span class="n">x</span>
               <span class="ow">-&gt;</span> <span class="kt">Sem</span> <span class="n">r</span> <span class="p">(</span><span class="n">s</span> <span class="n">x</span><span class="p">)</span>
               <span class="p">)</span>
            <span class="ow">-&gt;</span> <span class="kt">Sem</span> <span class="p">(</span><span class="n">e</span> <span class="kt">':</span> <span class="n">r</span><span class="p">)</span> <span class="n">a</span>
            <span class="ow">-&gt;</span> <span class="kt">Sem</span> <span class="n">r</span> <span class="n">a</span>
</code></pre></div>

<p>Which basically inlines the <code>Weaving</code>.</p>
<p>Alternatively, maybe the design of <code>Tactical</code> could be revamped. Not sure.</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/f1ec33bcc6144366b30e479d6b3bed74cdb9f611?x=x&amp;version=4"></a><div class="content"><a class="author">Love Waern (King of the Homeless)</a><div class="metadata"><a href="#212812183" name="212812183"><div>2020-10-09 11:26:31</div></a></div><div class="text"><p>You know what would be really neat? This:</p>
<div class="codehilite" data-code-language="Haskell"><pre><span></span><code><span class="nf">interpretHGood</span> <span class="ow">::</span> <span class="p">(</span>  <span class="n">forall</span> <span class="n">q</span> <span class="n">x</span>
                   <span class="o">.</span> <span class="p">(</span><span class="n">forall</span> <span class="n">x</span><span class="o">.</span> <span class="n">z</span> <span class="n">y</span> <span class="ow">-&gt;</span> <span class="kt">Sem</span> <span class="p">(</span><span class="kt">Opaque</span> <span class="n">q</span> <span class="kt">':</span> <span class="n">r</span><span class="p">)</span> <span class="n">y</span><span class="p">)</span>
                  <span class="ow">-&gt;</span> <span class="n">e</span> <span class="n">z</span> <span class="n">x</span>
                  <span class="ow">-&gt;</span> <span class="kt">Sem</span> <span class="p">(</span><span class="kt">Opaque</span> <span class="n">q</span> <span class="kt">':</span> <span class="n">r</span><span class="p">)</span> <span class="n">x</span>
                  <span class="p">)</span>
               <span class="ow">-&gt;</span> <span class="kt">Sem</span> <span class="p">(</span><span class="n">e</span> <span class="kt">':</span> <span class="n">r</span><span class="p">)</span> <span class="n">a</span>
               <span class="ow">-&gt;</span> <span class="kt">Sem</span> <span class="n">r</span> <span class="n">a</span>
</code></pre></div>

<p>Where <code>Opaque</code> is simply a newtype-wrapper to prevent the polymorphic <code>q</code> from messing with <code>Member</code>.<br>
No weird state threading required! Believe it or not, this is <em>almost</em> possible! You can switch from the <code>weave</code> abstraction to a different mechanism with all the same restrictions, but is able to support <code>interpretHGood</code>. Still, there's so much tied to the <code>weave</code> abstraction that doing that switch would cause massive breakage. Something for v2.0 maybe.</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/7334dc60b6aef6a75cd9284126231f13c76926a5?x=x&amp;version=4"></a><div class="content"><a class="author">Torsten Schmits</a><div class="metadata"><a href="#212812939" name="212812939"><div>2020-10-09 11:35:54</div></a></div><div class="text"><p>since we now had two discussions of that kind within a few days, I think we need an <code>interpretH</code> that specializes in <code>e (Sem r1) a -&gt; Tactical e (Sem r2) r x</code>, or whatever would make sense.<br>
or at least <code>r1 ~ eff : r2</code></p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/7334dc60b6aef6a75cd9284126231f13c76926a5?x=x&amp;version=4"></a><div class="content"><a class="author">Torsten Schmits</a><div class="metadata"><a href="#212813063" name="212813063"><div>2020-10-09 11:36:58</div></a></div><div class="text"><p>and nice solution with the <code>Trade</code>!!!</p></div></div></div></div></div><div class="ui vertical footer segment"><a href="https://github.com/srid/zulip-archive">Powered by Haskell</a> | Questions? Contact <a href="https://www.srid.ca">srid</a></div></div></body></html>