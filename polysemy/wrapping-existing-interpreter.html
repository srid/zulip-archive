<html lang="en"><head><meta content="text/html; charset=utf-8" http-equiv="Content-Type"><meta content="width=device-width, initial-scale=1" name="viewport"><meta content="Hi All!
Please help me to a higher order effect:
data Fx (m :: Type -&gt; Type) a where
  WithTempDir ::  m x -&gt; Fx m x

runShellIO :: forall r a. Members &#39;[Shell.Fx, Final IO] r =&gt; Sem (Fx &#39;: r) a -&gt; Sem r a
runShellIO = interpretH $ \case
  WithTempDir  fx -&gt;
      runShellIO (runT fx) -- &lt;-- this do" name="description"><link href="https://funprog.srid.ca/polysemy/wrapping-existing-interpreter.html" rel="canonical"><meta property="og:title" content="Wrapping existing interpreter - Polysemy"><meta property="og:site_name" content="Functional Programming Zulip Archive"><meta property="og:type" content="article"><meta property="og:article:section" content="Polysemy"><meta property="og:article:modified_time" content="2019-12-28T16:13:13Z"><meta property="og:article:published_time" content="2019-12-28T11:11:28Z"><title>Wrapping existing interpreter - Polysemy</title><style type="text/css">
div#thesite
{
  font-family   : "Open Sans", sans-serif;
  font-size     : 1em !important;
  margin-top    : 1em;
  margin-bottom : 1em;
}

div#thesite h1
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite h2
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite h3
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite h4
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite h5
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite h6
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite .ui.breadcrumb.rib .section
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite .header
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite .as-header
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite code, pre, tt
{
  font-family : "SFMono-Regular","Menlo","Monaco","Consolas","Liberation Mono","Courier New", monospace;
}

div#thesite .ui.breadcrumb.rib
{
  margin-bottom : 1em;
}



div#thesite .ui.comments.messages .comment .metadata a
{
  color : #808080;
}

div#thesite .ui.comments.messages .comment a.avatar img
{
  height : auto;
}

div#thesite .subtle
{
  color : #808080;
}


div#thesite .messages pre
{
  font-size : 85%;
  overflow  : auto;
  max-width : 100%;
}

div#thesite .messages .message_embed
{
  border-left  : solid 3px #808080;
  padding-left : 0.69999em;
}

div#thesite .messages .message_inline_image img
{
  max-width     : 100%;
  margin-bottom : 1em;
}


/* Generated with Clay, http://fvisser.nl/clay */</style><link href="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.4.1/semantic.min.css" rel="stylesheet"><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/all.min.css" rel="stylesheet"><link href="https://fonts.googleapis.com/css?family=Open+Sans|Oswald&amp;display=swap" rel="stylesheet"><link href="https://fonts.googleapis.com/css?family=Roboto|Open+Sans&amp;display=swap" rel="stylesheet"></head><body><div id="thesite" class="ui text container"><div class="ui violet inverted top attached center aligned segment"><h1 class="ui huge header">Wrapping existing interpreter - Polysemy</h1></div><div class="ui attached segment"><div class="ui message"><p>Welcome to the Functional Programming Zulip Chat Archive. You can join the chat <a href="https://funprog.zulipchat.com">here</a>.</p></div><div class="ui breadcrumb rib"><a href="/" class="section">Home</a><i class="right angle icon divider"></i><a href="/polysemy/" class="section">#Polysemy</a><i class="right angle icon divider"></i><div class="active section">Wrapping existing interpreter</div></div><div class="ui comments messages"><div class="comment"><a class="avatar"></a><div class="content"><a class="author">Yuriy Lazarev</a><div class="metadata"><a href="#184370722" name="184370722"><div>2019-12-28 11:11:28</div></a></div><div class="text"><p>Hi All!</p>
<p>Please help me to a higher order effect:</p>
<div class="codehilite"><pre><span></span>data Fx (m :: Type -&gt; Type) a where
  WithTempDir ::  m x -&gt; Fx m x

runShellIO :: forall r a. Members &#39;[Shell.Fx, Final IO] r =&gt; Sem (Fx &#39;: r) a -&gt; Sem r a
runShellIO = interpretH $ \case
  WithTempDir  fx -&gt;
      runShellIO (runT fx) -- &lt;-- this does not compile with a cryptic error message.. what am I doing wrong?
</pre></div></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/20a04d823b7c3891d78ca5f6a188ccd0e4fc5e3d?x=x&amp;version=2"></a><div class="content"><a class="author">TheMatten</a><div class="metadata"><a href="#184371176" name="184371176"><div>2019-12-28 11:24:08</div></a></div><div class="text"><p><span class="user-mention" data-user-id="255717">@Yuriy Lazarev</span> What's the signature of <code>runShellIO</code>?</p></div></div></div><div class="comment"><a class="avatar"></a><div class="content"><a class="author">Yuriy Lazarev</a><div class="metadata"><a href="#184371180" name="184371180"><div>2019-12-28 11:24:45</div></a></div><div class="text"><div class="codehilite"><pre><span></span>runShellIO :: forall r a. Members &#39;[Shell.Fx, Final IO] r =&gt; Sem (Fx &#39;: r) a -&gt; Sem r a
</pre></div></div></div></div><div class="comment"><a class="avatar"></a><div class="content"><a class="author">Yuriy Lazarev</a><div class="metadata"><a href="#184371191" name="184371191"><div>2019-12-28 11:25:21</div></a></div><div class="text"><p>I basically interpret <code>Fx</code> in terms of other effects: <code>Shell.Fx</code>, <code>Final IO</code></p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/20a04d823b7c3891d78ca5f6a188ccd0e4fc5e3d?x=x&amp;version=2"></a><div class="content"><a class="author">TheMatten</a><div class="metadata"><a href="#184371680" name="184371680"><div>2019-12-28 11:40:45</div></a></div><div class="text"><p>What should <code>withTempDir</code> do?</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/20a04d823b7c3891d78ca5f6a188ccd0e4fc5e3d?x=x&amp;version=2"></a><div class="content"><a class="author">TheMatten</a><div class="metadata"><a href="#184371772" name="184371772"><div>2019-12-28 11:43:45</div></a></div><div class="text"><p>Interpreting in terms of other effects usually means using them in body of <code>interpret</code> - but <code>runShellIO</code> just calls itself recursively</p></div></div></div><div class="comment"><a class="avatar"></a><div class="content"><a class="author">Yuriy Lazarev</a><div class="metadata"><a href="#184371777" name="184371777"><div>2019-12-28 11:44:01</div></a></div><div class="text"><p>The idea is that it creates a temp directory, then runs action in that directory, drops directory afterwards. Like a bracket.</p></div></div></div><div class="comment"><a class="avatar"></a><div class="content"><a class="author">Yuriy Lazarev</a><div class="metadata"><a href="#184371822" name="184371822"><div>2019-12-28 11:44:50</div></a></div><div class="text"><p><code>fx</code> here is an effect that needs to be run inside temp directory</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/20a04d823b7c3891d78ca5f6a188ccd0e4fc5e3d?x=x&amp;version=2"></a><div class="content"><a class="author">TheMatten</a><div class="metadata"><a href="#184371823" name="184371823"><div>2019-12-28 11:45:01</div></a></div><div class="text"><p>Alright - So <code>Shell.Fx</code> has some actions that depend on that directory?</p></div></div></div><div class="comment"><a class="avatar"></a><div class="content"><a class="author">Yuriy Lazarev</a><div class="metadata"><a href="#184371837" name="184371837"><div>2019-12-28 11:45:24</div></a></div><div class="text"><p>yes</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/20a04d823b7c3891d78ca5f6a188ccd0e4fc5e3d?x=x&amp;version=2"></a><div class="content"><a class="author">TheMatten</a><div class="metadata"><a href="#184371838" name="184371838"><div>2019-12-28 11:45:34</div></a></div><div class="text"><p>How does it look like?</p></div></div></div><div class="comment"><a class="avatar"></a><div class="content"><a class="author">Yuriy Lazarev</a><div class="metadata"><a href="#184371884" name="184371884"><div>2019-12-28 11:46:38</div></a></div><div class="text"><p>Shell.Fx runs an external program (using shell command) inside a temp folder and then collects all files that external program has created in the temp dir.</p></div></div></div><div class="comment"><a class="avatar"></a><div class="content"><a class="author">Yuriy Lazarev</a><div class="metadata"><a href="#184371900" name="184371900"><div>2019-12-28 11:47:51</div></a></div><div class="text"><p>so its like a bracket:<br>
init = create temp dir<br>
finalize = drop temp dir<br>
use = run external program via shell command</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/20a04d823b7c3891d78ca5f6a188ccd0e4fc5e3d?x=x&amp;version=2"></a><div class="content"><a class="author">TheMatten</a><div class="metadata"><a href="#184371941" name="184371941"><div>2019-12-28 11:48:26</div></a></div><div class="text"><p>Okay - it seems like "the effect of interest" here is actually <code>Shell.Fx</code> - <code>withTempDir</code> actually better fits description of an interpreter, because it runs <code>Shell.Fx</code> effect in concrete directory</p></div></div></div><div class="comment"><a class="avatar"></a><div class="content"><a class="author">Yuriy Lazarev</a><div class="metadata"><a href="#184371943" name="184371943"><div>2019-12-28 11:48:41</div></a></div><div class="text"><p>I was thinking to wrap this function call:<br>
<a href="https://hackage.haskell.org/package/temporary-1.3/docs/src/System.IO.Temp.html#withTempDirectory" target="_blank" title="https://hackage.haskell.org/package/temporary-1.3/docs/src/System.IO.Temp.html#withTempDirectory">https://hackage.haskell.org/package/temporary-1.3/docs/src/System.IO.Temp.html#withTempDirectory</a></p></div></div></div><div class="comment"><a class="avatar"></a><div class="content"><a class="author">Yuriy Lazarev</a><div class="metadata"><a href="#184371997" name="184371997"><div>2019-12-28 11:50:28</div></a></div><div class="text"><p>I already have a Shell effect/interpreter that runs any cmd, I was thinking to re-use it</p></div></div></div><div class="comment"><a class="avatar"></a><div class="content"><a class="author">Yuriy Lazarev</a><div class="metadata"><a href="#184372015" name="184372015"><div>2019-12-28 11:51:40</div></a></div><div class="text"><div class="codehilite"><pre><span></span>module Shell
  ( Fx,
    runLogIO,
    run,
    run_,
    Arguments,
    Command,
  )
where

import qualified Data.Text as Text
import qualified Log
import Polysemy hiding (run)
import System.Process.Typed

type Command = Text

type Arguments = [Text]

data Fx (m :: Type -&gt; Type) a where
  Run :: Command -&gt; Arguments -&gt; Fx m LByteString
  Run_ :: Command -&gt; Arguments -&gt; Fx m ()

runLogIO ::
  forall r a.
  Members &#39;[Log.Fx, Final IO] r =&gt;
  Sem (Fx &#39;: r) a -&gt;
  Sem r a
runLogIO = interpret $ \case
  Run command arguments -&gt; sh readProcessStdout_ command arguments
  Run_ command arguments -&gt; sh runProcess_ command arguments
  where
    sh :: (ProcessConfig () () () -&gt; IO x) -&gt; Text -&gt; [Text] -&gt; Sem r x
    sh f command arguments = do
      let cmd = Text.unwords $ command : arguments
      Log.exec cmd
      embedFinal @IO . f . shell . toString $ cmd

$(makeSem &#39;&#39;Fx)
</pre></div></div></div></div><div class="comment"><a class="avatar"></a><div class="content"><a class="author">Yuriy Lazarev</a><div class="metadata"><a href="#184372207" name="184372207"><div>2019-12-28 11:56:32</div></a></div><div class="text"><p>Sure, I can extend shell interpreter, say by adding a "run in temp folder" parameter, but it feels wrong... Instead, it makes sense to interpret shell effect as a higher order effect, surrounded by some other effect (similar to Resource)</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/20a04d823b7c3891d78ca5f6a188ccd0e4fc5e3d?x=x&amp;version=2"></a><div class="content"><a class="author">TheMatten</a><div class="metadata"><a href="#184373351" name="184373351"><div>2019-12-28 12:31:59</div></a></div><div class="text"><p><span class="user-mention" data-user-id="255717">@Yuriy Lazarev</span> Okay, maybe something like this?:</p>
<div class="codehilite"><pre><span></span><span class="nf">runInTempDir</span> <span class="ow">::</span> <span class="n">forall</span> <span class="n">r</span> <span class="n">a</span><span class="o">.</span> <span class="kt">Members</span> <span class="kt">&#39;[Log.Fx, Final IO]</span> <span class="n">r</span> <span class="ow">=&gt;</span> <span class="kt">FilePath</span> <span class="ow">-&gt;</span> <span class="kt">String</span> <span class="ow">-&gt;</span> <span class="p">(</span><span class="kt">FilePath</span> <span class="ow">-&gt;</span> <span class="kt">Sem</span> <span class="p">(</span><span class="kt">Fx</span> <span class="kt">:</span> <span class="n">r</span><span class="p">)</span> <span class="n">a</span><span class="p">)</span> <span class="ow">-&gt;</span> <span class="kt">Sem</span> <span class="n">r</span> <span class="n">a</span>
<span class="nf">runInTempDir</span> <span class="n">dir</span> <span class="n">template</span> <span class="n">m</span> <span class="ow">=</span> <span class="n">resourceToIOFinal</span> <span class="o">$</span> <span class="n">bracket</span>
  <span class="p">(</span><span class="n">embedFinal</span> <span class="o">$</span> <span class="n">createTempDirectory</span> <span class="n">dir</span> <span class="n">template</span><span class="p">)</span>
  <span class="p">(</span><span class="n">embedFinal</span> <span class="o">.</span> <span class="n">removeDirectoryRecursive</span><span class="p">)</span>
  <span class="p">(</span><span class="n">raise</span> <span class="o">.</span> <span class="n">runLogIO</span> <span class="o">.</span> <span class="n">m</span><span class="p">)</span>
</pre></div></div></div></div><div class="comment"><a class="avatar"></a><div class="content"><a class="author">Yuriy Lazarev</a><div class="metadata"><a href="#184379073" name="184379073"><div>2019-12-28 15:21:41</div></a></div><div class="text"><p>This would work (and most likely I'll end up doing it this way) however, this is a workaround for the higher-order effect problem, not a solution. I wanted to get a working example how to use <code>Tactics</code> stuff to be able to use higher-order effects in other cases too.</p></div></div></div><div class="comment"><a class="avatar"></a><div class="content"><a class="author">Yuriy Lazarev</a><div class="metadata"><a href="#184379078" name="184379078"><div>2019-12-28 15:21:59</div></a></div><div class="text"><p>Anyway, thank for the suggestion!</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/20a04d823b7c3891d78ca5f6a188ccd0e4fc5e3d?x=x&amp;version=2"></a><div class="content"><a class="author">TheMatten</a><div class="metadata"><a href="#184379476" name="184379476"><div>2019-12-28 15:32:32</div></a></div><div class="text"><p>I'm not sure why it should be considered a workaround - running commands in specific directory is actually sort of interpretation.<br>
You're "pinning" your effect to some specific meaning - if we instead made separate effect that extends this one with support for temporary directories, it's not going to provide any value, because it's just going to duplicate or wrap interface of existing one - that only adds more boilerplate to manage.</p></div></div></div><div class="comment"><a class="avatar"></a><div class="content"><a class="author">Yuriy Lazarev</a><div class="metadata"><a href="#184379554" name="184379554"><div>2019-12-28 15:35:07</div></a></div><div class="text"><p>I want to delay interpretation of <code>withTempDir :: Fx m-&gt; Sem r ()</code> to be able to interpret it differently, e.g. not to create temp directory in tests at all</p></div></div></div><div class="comment"><a class="avatar"></a><div class="content"><a class="author">Yuriy Lazarev</a><div class="metadata"><a href="#184379680" name="184379680"><div>2019-12-28 15:38:05</div></a></div><div class="text"><p>This is an example of effect that takes other effect as a parameter. Lets call it <code>sandbox</code> effect for example, then I want to interpret things inside a sandbox effect, where there could be different interpretations (meaning) of what sandbox means.</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/20a04d823b7c3891d78ca5f6a188ccd0e4fc5e3d?x=x&amp;version=2"></a><div class="content"><a class="author">TheMatten</a><div class="metadata"><a href="#184379687" name="184379687"><div>2019-12-28 15:38:49</div></a></div><div class="text"><p>Tests are still going to be run in some directory, aren't they?</p></div></div></div><div class="comment"><a class="avatar"></a><div class="content"><a class="author">Yuriy Lazarev</a><div class="metadata"><a href="#184379697" name="184379697"><div>2019-12-28 15:39:14</div></a></div><div class="text"><p>in tests there could be no file io at all</p></div></div></div><div class="comment"><a class="avatar"></a><div class="content"><a class="author">Yuriy Lazarev</a><div class="metadata"><a href="#184379703" name="184379703"><div>2019-12-28 15:39:32</div></a></div><div class="text"><p>instead, interpretation of "temp dir" could be just logging</p></div></div></div><div class="comment"><a class="avatar"></a><div class="content"><a class="author">Yuriy Lazarev</a><div class="metadata"><a href="#184379757" name="184379757"><div>2019-12-28 15:41:02</div></a></div><div class="text"><p>I have already a FileSystem effect that abstracts over file/dir operations</p></div></div></div><div class="comment"><a class="avatar"></a><div class="content"><a class="author">Yuriy Lazarev</a><div class="metadata"><a href="#184379763" name="184379763"><div>2019-12-28 15:41:19</div></a></div><div class="text"><p>so it makes sense to abstract over temp directory creation</p></div></div></div><div class="comment"><a class="avatar"></a><div class="content"><a class="author">Yuriy Lazarev</a><div class="metadata"><a href="#184379773" name="184379773"><div>2019-12-28 15:41:49</div></a></div><div class="text"><div class="codehilite"><pre><span></span>data Fx (m :: Type -&gt; Type) a where
  Copy :: (AbsRel ar, FileDir fd) =&gt; Path ar fd -&gt; Path ar fd -&gt; Fx m ()
  MoveFile :: AbsRel ar =&gt; FilePath ar -&gt; FilePath ar -&gt; Fx m ()
  TestFile :: AbsRel ar =&gt; FilePath ar -&gt; Fx m Bool
  GetCurrentDirectory :: Fx m AbsDir
  SetCurrentDirectory :: AbsRel ar =&gt; DirPath ar -&gt; Fx m ()
  MakeDirectory :: AbsRel ar =&gt; DirPath ar -&gt; Fx m ()
  MoveDirectory :: AbsRel ar =&gt; DirPath ar -&gt; DirPath ar -&gt; Fx m ()
  RemoveDirectoryEmpty :: AbsRel ar =&gt; DirPath ar -&gt; Fx m ()
  RemoveDirectoryRecursive :: AbsRel ar =&gt; DirPath ar -&gt; Fx m ()
</pre></div></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/20a04d823b7c3891d78ca5f6a188ccd0e4fc5e3d?x=x&amp;version=2"></a><div class="content"><a class="author">TheMatten</a><div class="metadata"><a href="#184379776" name="184379776"><div>2019-12-28 15:41:50</div></a></div><div class="text"><p>Then <code>runLogIO</code> and <code>runInTempDir</code>won't be used at all during testing<br>
Hmm, so you are parsing and executing shell commands in some specific way during testing?</p></div></div></div><div class="comment"><a class="avatar"></a><div class="content"><a class="author">Yuriy Lazarev</a><div class="metadata"><a href="#184379830" name="184379830"><div>2019-12-28 15:43:07</div></a></div><div class="text"><p>Depending on the interpreter I could run shell commands insider Docker for example</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/20a04d823b7c3891d78ca5f6a188ccd0e4fc5e3d?x=x&amp;version=2"></a><div class="content"><a class="author">TheMatten</a><div class="metadata"><a href="#184379839" name="184379839"><div>2019-12-28 15:43:53</div></a></div><div class="text"><p>This effect is pretty different from what you've described above - in this case, I would probably implement <code>createTemporaryDirectory</code> directly in it instead of using <code>IO</code></p></div></div></div><div class="comment"><a class="avatar"></a><div class="content"><a class="author">Yuriy Lazarev</a><div class="metadata"><a href="#184379885" name="184379885"><div>2019-12-28 15:44:27</div></a></div><div class="text"><p>I apologize for not describing my use-case well enough</p></div></div></div><div class="comment"><a class="avatar"></a><div class="content"><a class="author">Yuriy Lazarev</a><div class="metadata"><a href="#184379901" name="184379901"><div>2019-12-28 15:45:48</div></a></div><div class="text"><p>I have effects for OS processes, File operations, and some business logic, I want File operations effect to wrap around other effects (receiving them as higher-order parameters)</p></div></div></div><div class="comment"><a class="avatar"></a><div class="content"><a class="author">Yuriy Lazarev</a><div class="metadata"><a href="#184379941" name="184379941"><div>2019-12-28 15:46:20</div></a></div><div class="text"><p>where some file operations could be interpreted into shell effects (e.g. calling <code>cp</code> command) others could be interpreted into IO</p></div></div></div><div class="comment"><a class="avatar"></a><div class="content"><a class="author">Yuriy Lazarev</a><div class="metadata"><a href="#184380013" name="184380013"><div>2019-12-28 15:49:18</div></a></div><div class="text"><p>Here is the bigger picture:</p>
<div class="codehilite"><pre><span></span>data Fx (m :: Type -&gt; Type) a where
  Copy :: (AbsRel ar, FileDir fd) =&gt; Path ar fd -&gt; Path ar fd -&gt; Fx m ()
  MoveFile :: AbsRel ar =&gt; FilePath ar -&gt; FilePath ar -&gt; Fx m ()
  TestFile :: AbsRel ar =&gt; FilePath ar -&gt; Fx m Bool
  GetCurrentDirectory :: Fx m AbsDir
  SetCurrentDirectory :: AbsRel ar =&gt; DirPath ar -&gt; Fx m ()
  MakeDirectory :: AbsRel ar =&gt; DirPath ar -&gt; Fx m ()
  MoveDirectory :: AbsRel ar =&gt; DirPath ar -&gt; DirPath ar -&gt; Fx m ()
  RemoveDirectoryEmpty :: AbsRel ar =&gt; DirPath ar -&gt; Fx m ()
  RemoveDirectoryRecursive :: AbsRel ar =&gt; DirPath ar -&gt; Fx m ()
  TestDirectory :: AbsRel ar =&gt; DirPath ar -&gt; Fx m Bool
  WithTempDir :: AbsDir -&gt; m x -&gt; Fx m x

runShellIO :: forall r a. Members &#39;[Shell.Fx, Final IO] r =&gt; Sem (Fx &#39;: r) a -&gt; Sem r a
runShellIO = interpretH $ \case
  Copy src dst -&gt;
    Shell.run_ &quot;mv&quot; [Path.toText src, Path.toText dst]
  MoveFile src dst -&gt;
    embedFinal $ Dir.renameFile src dst
  TestFile file -&gt;
    embedFinal $ Dir.doesFileExist file
  GetCurrentDirectory -&gt;
    embedFinal Dir.getCurrentDirectory
  SetCurrentDirectory dir -&gt;
    embedFinal $ Dir.setCurrentDirectory dir
  MakeDirectory dir -&gt;
    embedFinal $ Dir.createDirectory dir
  MoveDirectory src dst -&gt;
    embedFinal $ Dir.renameDirectory src dst
  RemoveDirectoryEmpty dir -&gt;
    embedFinal $ Dir.removeDirectory dir
  RemoveDirectoryRecursive dir -&gt;
    embedFinal $ Dir.removeDirectoryRecursive dir
  TestDirectory dir -&gt;
    embedFinal $ Dir.doesDirectoryExist dir
  WithTempDir parent fx -&gt;
      _ (runT fx)
    where
      wtd :: IO ()
      wtd = withTempDirectory parentFilePath &quot;hasmer_&quot; $ \dir -&gt; pure ()
      parentFilePath = toString . Path.toText $ parent

$(makeSem &#39;&#39;Fx)
</pre></div></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/20a04d823b7c3891d78ca5f6a188ccd0e4fc5e3d?x=x&amp;version=2"></a><div class="content"><a class="author">TheMatten</a><div class="metadata"><a href="#184380827" name="184380827"><div>2019-12-28 16:13:13</div></a></div><div class="text"><p>One does usually wrap other effect ~ create "effect transformer", when they want to alter <em>meaning</em> of effect in some way - in what way should file-effect alter meaning of other effects?</p></div></div></div></div></div><div class="ui vertical footer segment"><a href="https://github.com/srid/zulip-archive">Powered by Haskell</a> | Questions? Contact <a href="https://www.srid.ca">srid</a></div></div></body></html>