<html lang="en"><head><meta content="text/html; charset=utf-8" http-equiv="Content-Type"><meta content="width=device-width, initial-scale=1" name="viewport"><meta content="Does anyone have an example of doing this? In particular looking to wrap MonadHttp from the req library, and see what it takes to handle its http errors the polysemy way. 
cf. https://hackage.haskell.org/package/req-3.2.0/docs/Network-HTTP-Req.html#v:handleHttpException" name="description"><link href="https://funprog.srid.ca/polysemy/using-existing-mtl-classes.html" rel="canonical"><meta property="og:title" content="Using existing mtl classes - Polysemy"><meta property="og:site_name" content="Functional Programming Zulip Archive"><meta property="og:type" content="article"><meta property="og:article:section" content="Polysemy"><meta property="og:article:modified_time" content="2020-06-21T16:42:17Z"><meta property="og:article:published_time" content="2020-06-20T23:28:34Z"><meta property="og:image" content="https://zulip-avatars.s3.amazonaws.com/13896/4429aa8b689608f24a4ad712843ce29862e330d2?version=2"><title>Using existing mtl classes - Polysemy</title><style type="text/css">
div#thesite
{
  font-family   : "Open Sans", sans-serif;
  font-size     : 1em !important;
  margin-top    : 1em;
  margin-bottom : 1em;
}

div#thesite h1
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite h2
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite h3
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite h4
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite h5
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite h6
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite .ui.breadcrumb.rib .section
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite .header
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite .as-header
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite code, pre, tt
{
  font-family : "SFMono-Regular","Menlo","Monaco","Consolas","Liberation Mono","Courier New", monospace;
}

div#thesite .ui.breadcrumb.rib
{
  margin-bottom : 1em;
}



div#thesite .ui.comments.messages .comment .metadata a
{
  color : #808080;
}

div#thesite .ui.comments.messages .comment a.avatar img
{
  height : auto;
}

div#thesite .subtle
{
  color : #808080;
}


div#thesite .messages pre
{
  font-size : 85%;
  overflow  : auto;
  max-width : 100%;
}

div#thesite .messages .message_embed
{
  border-left  : solid 3px #808080;
  padding-left : 0.69999em;
}

div#thesite .messages .message_inline_image img
{
  max-width     : 100%;
  margin-bottom : 1em;
}


/* Generated with Clay, http://fvisser.nl/clay */</style><link href="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.4.1/semantic.min.css" rel="stylesheet"><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/all.min.css" rel="stylesheet"><link href="https://fonts.googleapis.com/css?family=Open+Sans|Oswald&amp;display=swap" rel="stylesheet"><link href="https://fonts.googleapis.com/css?family=Roboto|Open+Sans&amp;display=swap" rel="stylesheet"></head><body><div id="thesite" class="ui text container"><div class="ui violet inverted top attached center aligned segment"><h1 class="ui huge header">Using existing mtl classes - Polysemy</h1></div><div class="ui attached segment"><div class="ui message"><p>Welcome to the Functional Programming Zulip Chat Archive. You can join the chat <a href="https://funprog.zulipchat.com">here</a>.</p></div><div class="ui breadcrumb rib"><a href="/" class="section">Home</a><i class="right angle icon divider"></i><a href="/polysemy/" class="section">#Polysemy</a><i class="right angle icon divider"></i><div class="active section">Using existing mtl classes</div></div><div class="ui comments messages"><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/4429aa8b689608f24a4ad712843ce29862e330d2?version=2"></a><div class="content"><a class="author">Sridhar Ratnakumar</a><div class="metadata"><a href="#201503908" name="201503908"><div>2020-06-20 23:28:34</div></a></div><div class="text"><p>Does anyone have an example of doing this? In particular looking to wrap <code>MonadHttp</code> from the <code>req</code> library, and see what it takes to handle its http errors the polysemy way. </p>
<p>cf. <a href="https://hackage.haskell.org/package/req-3.2.0/docs/Network-HTTP-Req.html#v:handleHttpException">https://hackage.haskell.org/package/req-3.2.0/docs/Network-HTTP-Req.html#v:handleHttpException</a></p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/7334dc60b6aef6a75cd9284126231f13c76926a5?version=5"></a><div class="content"><a class="author">Torsten Schmits</a><div class="metadata"><a href="#201506557" name="201506557"><div>2020-06-21 00:18:12</div></a></div><div class="text"><p>explicit dictionary passing? would be really nice to have some more infrastructure for that. no idea if ConstraintAbsorber is suitable for arbitrary classes, it looked to be a bit above my pay grade</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/4429aa8b689608f24a4ad712843ce29862e330d2?version=2"></a><div class="content"><a class="author">Sridhar Ratnakumar</a><div class="metadata"><a href="#201507012" name="201507012"><div>2020-06-21 00:29:58</div></a></div><div class="text"><p>Going with plain old mtl for now, <a href="https://www.srid.ca/088b7edd.html">https://www.srid.ca/088b7edd.html</a></p></div></div></div><div class="comment"><a class="avatar"><img src="https://www.gravatar.com/avatar/1114fd8de67671f83d3a3ef7594b1950"></a><div class="content"><a class="author">Georgi Lyubenov // googleson78</a><div class="metadata"><a href="#201519610" name="201519610"><div>2020-06-21 06:10:53</div></a></div><div class="text"><p>I made an orphan to deal with this exact problem:</p>
<div class="codehilite"><pre><span></span><code><span class="kr">instance</span> <span class="kt">Members</span> <span class="p">[</span><span class="kt">Embed</span> <span class="kt">IO</span><span class="p">,</span> <span class="o">&lt;</span><span class="n">whatever</span><span class="o">-</span><span class="n">errors</span><span class="o">-</span><span class="kt">I</span><span class="o">-</span><span class="n">want</span><span class="o">-</span><span class="n">for</span><span class="o">-</span><span class="n">http</span><span class="o">-</span><span class="n">errors</span><span class="o">&gt;</span><span class="p">]</span> <span class="n">r</span> <span class="ow">=&gt;</span> <span class="kt">MonadHttp</span> <span class="p">(</span><span class="kt">Sem</span> <span class="n">r</span><span class="p">)</span> <span class="kr">where</span>
<span class="c1">-- something like this, don&#39;t exactly remember the IO part</span>
<span class="c1">-- but you need some form of it, because of the MonadIO constraint on MonadHttp</span>
</code></pre></div>


<p>It's not very pretty, but I don't care too much, since it's "application code"</p></div></div></div><div class="comment"><a class="avatar"><img src="https://www.gravatar.com/avatar/1114fd8de67671f83d3a3ef7594b1950"></a><div class="content"><a class="author">Georgi Lyubenov // googleson78</a><div class="metadata"><a href="#201519720" name="201519720"><div>2020-06-21 06:14:30</div></a></div><div class="text"><p>Yeah, you can probably use <code>reflection</code> to do this, but it would also be more complicated, so I guess I avoided it</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/20a04d823b7c3891d78ca5f6a188ccd0e4fc5e3d?version=2"></a><div class="content"><a class="author">TheMatten</a><div class="metadata"><a href="#201522752" name="201522752"><div>2020-06-21 07:54:03</div></a></div><div class="text"><p>Or, because <code>req</code> interface is pretty small, you could just define <code>Http</code> effect that interprets into <code>Embed Req</code>, which in turn can be run in e.g. <code>Embed IO</code></p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/7334dc60b6aef6a75cd9284126231f13c76926a5?version=5"></a><div class="content"><a class="author">Torsten Schmits</a><div class="metadata"><a href="#201530195" name="201530195"><div>2020-06-21 11:22:21</div></a></div><div class="text"><p><span class="user-mention silent" data-user-id="254032">Georgi Lyubenov // googleson78</span> <a href="#narrow/stream/216942-Polysemy/topic/Using.20existing.20mtl.20classes/near/201519610">said</a>:</p>
<blockquote>
<p>I made an orphan to deal with this exact problem:</p>
<div class="codehilite"><pre><span></span><code><span class="kr">instance</span> <span class="kt">Members</span> <span class="p">[</span><span class="kt">Embed</span> <span class="kt">IO</span><span class="p">,</span> <span class="o">&lt;</span><span class="n">whatever</span><span class="o">-</span><span class="n">errors</span><span class="o">-</span><span class="kt">I</span><span class="o">-</span><span class="n">want</span><span class="o">-</span><span class="n">for</span><span class="o">-</span><span class="n">http</span><span class="o">-</span><span class="n">errors</span><span class="o">&gt;</span><span class="p">]</span> <span class="n">r</span> <span class="ow">=&gt;</span> <span class="kt">MonadHttp</span> <span class="p">(</span><span class="kt">Sem</span> <span class="n">r</span><span class="p">)</span> <span class="kr">where</span>
<span class="c1">-- something like this, don&#39;t exactly remember the IO part</span>
<span class="c1">-- but you need some form of it, because of the MonadIO constraint on MonadHttp</span>
</code></pre></div>


<p>It's not very pretty, but I don't care too much, since it's "application code"</p>
</blockquote>
<p>does that work in general??</p></div></div></div><div class="comment"><a class="avatar"><img src="https://www.gravatar.com/avatar/1114fd8de67671f83d3a3ef7594b1950"></a><div class="content"><a class="author">Georgi Lyubenov // googleson78</a><div class="metadata"><a href="#201530806" name="201530806"><div>2020-06-21 11:41:41</div></a></div><div class="text"><p>what do you mean? you're having doubts whether this thing works "correctly"?</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/7334dc60b6aef6a75cd9284126231f13c76926a5?version=5"></a><div class="content"><a class="author">Torsten Schmits</a><div class="metadata"><a href="#201531025" name="201531025"><div>2020-06-21 11:48:45</div></a></div><div class="text"><p><span class="user-mention silent" data-user-id="254032">Georgi Lyubenov // googleson78</span> <a href="#narrow/stream/216942-Polysemy/topic/Using.20existing.20mtl.20classes/near/201530806">said</a>:</p>
<blockquote>
<p>what do you mean? you're having doubts whether this thing works "correctly"?</p>
</blockquote>
<p>Primarily whether it is practical or possible for a wider selection of transformers to provide an instance for <code>Sem r</code>. I guess stuff like <code>MonadSnap</code> that depend on <code>MonadBaseControl</code> should be problematic…<br>
Also whether it's ergonomic to integrate this into a polysemy program. Do you have some example code?</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/20a04d823b7c3891d78ca5f6a188ccd0e4fc5e3d?version=2"></a><div class="content"><a class="author">TheMatten</a><div class="metadata"><a href="#201533026" name="201533026"><div>2020-06-21 12:48:38</div></a></div><div class="text"><blockquote>
<p>Primarily whether it is practical or possible for a wider selection of transformers to provide an instance for <code>Sem r</code>.</p>
</blockquote>
<p>Classes with fundeps like <code>MonadReader</code> won't really work with <code>Sem</code>, which has to be polymorphic in effects stack to be useful</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/4429aa8b689608f24a4ad712843ce29862e330d2?version=2"></a><div class="content"><a class="author">Sridhar Ratnakumar</a><div class="metadata"><a href="#201535947" name="201535947"><div>2020-06-21 14:15:17</div></a></div><div class="text"><p><span class="user-mention silent" data-user-id="225127">TheMatten</span> <a href="#narrow/stream/216942-Polysemy/topic/Using.20existing.20mtl.20classes/near/201522752">said</a>:</p>
<blockquote>
<p>Or, because <code>req</code> interface is pretty small, you could just define <code>Http</code> effect that interprets into <code>Embed Req</code>, which in turn can be run in e.g. <code>Embed IO</code></p>
</blockquote>
<p>This looks like an approach that I could deal with when coming back to the code after a year without worrying about not being able to understand it. </p>
<p>IIUC, <code>req</code> is the only method I use on MonadHttp; so this <code>Http</code> effect would have one constructor called <code>Req</code>? Okay, that's worth playing with.</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/20a04d823b7c3891d78ca5f6a188ccd0e4fc5e3d?version=2"></a><div class="content"><a class="author">TheMatten</a><div class="metadata"><a href="#201536936" name="201536936"><div>2020-06-21 14:36:08</div></a></div><div class="text"><p>You should just need to pass all the arguments to original <code>req</code></p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/4429aa8b689608f24a4ad712843ce29862e330d2?version=2"></a><div class="content"><a class="author">Sridhar Ratnakumar</a><div class="metadata"><a href="#201536948" name="201536948"><div>2020-06-21 14:37:03</div></a></div><div class="text"><p>Yea. I also have a <code>GitHub</code> effect. So my <code>githubToIO</code> function can now take the <code>Http</code> effect as its member.</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/4429aa8b689608f24a4ad712843ce29862e330d2?version=2"></a><div class="content"><a class="author">Sridhar Ratnakumar</a><div class="metadata"><a href="#201536954" name="201536954"><div>2020-06-21 14:37:30</div></a></div><div class="text"><p>Oh, and I can perhaps move the API request logging effect to Http itself.</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/20a04d823b7c3891d78ca5f6a188ccd0e4fc5e3d?version=2"></a><div class="content"><a class="author">TheMatten</a><div class="metadata"><a href="#201537040" name="201537040"><div>2020-06-21 14:39:49</div></a></div><div class="text"><p>I wonder whether this wouldn't be possible to automate - some TH for wrapping incompatible interfaces into effect with interpreter over <code>Embed</code>ded monad</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/7334dc60b6aef6a75cd9284126231f13c76926a5?version=5"></a><div class="content"><a class="author">Torsten Schmits</a><div class="metadata"><a href="#201537086" name="201537086"><div>2020-06-21 14:40:39</div></a></div><div class="text"><p>yes please!</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/20a04d823b7c3891d78ca5f6a188ccd0e4fc5e3d?version=2"></a><div class="content"><a class="author">TheMatten</a><div class="metadata"><a href="#201537302" name="201537302"><div>2020-06-21 14:46:27</div></a></div><div class="text"><p>Haha, I guess I will open both this and <a href="#narrow/stream/216942-Polysemy/topic/Plugin.20package/near/200407539">https://funprog.zulipchat.com/#narrow/stream/216942-Polysemy/topic/Plugin.20package/near/200407539</a> as issues so that we don't forget about them <span aria-label="slight smile" class="emoji emoji-1f642" role="img" title="slight smile">:slight_smile:</span></p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/7334dc60b6aef6a75cd9284126231f13c76926a5?version=5"></a><div class="content"><a class="author">Torsten Schmits</a><div class="metadata"><a href="#201537516" name="201537516"><div>2020-06-21 14:54:01</div></a></div><div class="text"><p>great!</p></div></div></div><div class="comment"><a class="avatar"><img src="https://www.gravatar.com/avatar/1114fd8de67671f83d3a3ef7594b1950"></a><div class="content"><a class="author">Georgi Lyubenov // googleson78</a><div class="metadata"><a href="#201542651" name="201542651"><div>2020-06-21 16:37:38</div></a></div><div class="text"><p><span class="user-mention" data-user-id="260881">@Torsten Schmits</span> my "example" code is not very interesting:</p>
<div class="codehilite"><pre><span></span><code><span class="kr">instance</span> <span class="kt">Members</span> <span class="p">[</span><span class="kt">Error</span> <span class="kt">Unauthorised</span><span class="p">,</span> <span class="kt">Error</span> <span class="kt">Unauthenticated</span><span class="p">,</span> <span class="kt">Error</span> <span class="kt">InternalServerError</span><span class="p">,</span> <span class="kt">Embed</span> <span class="kt">IO</span><span class="p">]</span> <span class="n">r</span>
  <span class="ow">=&gt;</span> <span class="kt">MonadHttp</span> <span class="p">(</span><span class="kt">Sem</span> <span class="n">r</span><span class="p">)</span> <span class="kr">where</span>
  <span class="n">handleHttpException</span> <span class="p">(</span><span class="kt">VanillaHttpException</span> <span class="p">(</span><span class="kt">HttpExceptionRequest</span> <span class="kr">_</span> <span class="p">(</span><span class="kt">StatusCodeException</span> <span class="n">response</span> <span class="kr">_</span><span class="p">)))</span> <span class="ow">=</span>
    <span class="kr">case</span> <span class="n">statusCode</span> <span class="o">$</span> <span class="n">responseStatus</span> <span class="n">response</span> <span class="kr">of</span>
      <span class="mi">401</span> <span class="ow">-&gt;</span> <span class="n">throw</span> <span class="kt">Unauthenticated</span>
      <span class="mi">403</span> <span class="ow">-&gt;</span> <span class="n">throw</span> <span class="kt">Unauthorised</span>
      <span class="kr">_</span> <span class="ow">-&gt;</span> <span class="n">throw</span> <span class="kt">InternalServerError</span>
  <span class="n">handleHttpException</span> <span class="kr">_</span> <span class="ow">=</span> <span class="n">throw</span> <span class="kt">InternalServerError</span>
</code></pre></div>


<p>and later in my chain of interpreters I have something that is basically the same as <a href="https://hackage.haskell.org/package/polysemy-1.3.0.0/docs/Polysemy-Input.html#v:runInputSem">runInputSem</a>, in which I do <code>req</code></p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/7334dc60b6aef6a75cd9284126231f13c76926a5?version=5"></a><div class="content"><a class="author">Torsten Schmits</a><div class="metadata"><a href="#201542848" name="201542848"><div>2020-06-21 16:42:17</div></a></div><div class="text"><p>cool thanks!</p></div></div></div></div></div><div class="ui vertical footer segment"><a href="https://github.com/srid/zulip-archive">Powered by Haskell</a> | Questions? Contact <a href="https://www.srid.ca">srid</a></div></div></body></html>