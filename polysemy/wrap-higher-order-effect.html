<html lang="en"><head><meta content="text/html; charset=utf-8" http-equiv="Content-Type"><meta content="width=device-width, initial-scale=1" name="viewport"><meta content="I&#39;m trying to call async in an interpretH:
data W m a where
  W :: m a -&gt; W m ()

makeSem &#39;&#39;W

interpretW ::
  Member Async r =&gt;
  InterpreterFor W r
interpretW =
  interpretH $ \case
    W m -&gt; do
      mm &lt;- raise . interpretW =&lt;&lt; runT m
      mm1 &lt;- runT m
      async mm
      async mm1
      und" name="description"><link href="https://funprog.srid.ca/polysemy/wrap-higher-order-effect.html" rel="canonical"><meta property="og:title" content="wrap higher-order effect - Polysemy"><meta property="og:site_name" content="Functional Programming Zulip Archive"><meta property="og:type" content="article"><meta property="og:article:section" content="Polysemy"><meta property="og:article:modified_time" content="2020-03-24T23:15:54Z"><meta property="og:article:published_time" content="2020-03-10T20:33:01Z"><meta property="og:image" content="https://zulip-avatars.s3.amazonaws.com/13896/7334dc60b6aef6a75cd9284126231f13c76926a5?version=4"><title>wrap higher-order effect - Polysemy</title><style type="text/css">
div#thesite
{
  font-family   : "Open Sans", sans-serif;
  font-size     : 1em !important;
  margin-top    : 1em;
  margin-bottom : 1em;
}

div#thesite h1
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite h2
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite h3
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite h4
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite h5
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite h6
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite .ui.breadcrumb.rib .section
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite .header
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite .as-header
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite code, pre, tt
{
  font-family : "SFMono-Regular","Menlo","Monaco","Consolas","Liberation Mono","Courier New", monospace;
}

div#thesite .ui.breadcrumb.rib
{
  margin-bottom : 1em;
}



div#thesite .ui.comments.messages .comment .metadata a
{
  color : #808080;
}

div#thesite .ui.comments.messages .comment a.avatar img
{
  height : auto;
}

div#thesite .subtle
{
  color : #808080;
}


div#thesite .messages pre
{
  font-size : 85%;
  overflow  : auto;
  max-width : 100%;
}

div#thesite .messages .message_embed
{
  border-left  : solid 3px #808080;
  padding-left : 0.69999em;
}

div#thesite .messages .message_inline_image img
{
  max-width     : 100%;
  margin-bottom : 1em;
}


/* Generated with Clay, http://fvisser.nl/clay */</style><link href="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.4.1/semantic.min.css" rel="stylesheet"><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/all.min.css" rel="stylesheet"><link href="https://fonts.googleapis.com/css?family=Open+Sans|Oswald&amp;display=swap" rel="stylesheet"><link href="https://fonts.googleapis.com/css?family=Roboto|Open+Sans&amp;display=swap" rel="stylesheet"></head><body><div id="thesite" class="ui text container"><div class="ui violet inverted top attached center aligned segment"><h1 class="ui huge header">wrap higher-order effect - Polysemy</h1></div><div class="ui attached segment"><div class="ui message"><p>Welcome to the Functional Programming Zulip Chat Archive. You can join the chat <a href="https://funprog.zulipchat.com">here</a>.</p></div><div class="ui breadcrumb rib"><a href="/" class="section">Home</a><i class="right angle icon divider"></i><a href="/polysemy/" class="section">#Polysemy</a><i class="right angle icon divider"></i><div class="active section">wrap higher-order effect</div></div><div class="ui comments messages"><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/7334dc60b6aef6a75cd9284126231f13c76926a5?version=4"></a><div class="content"><a class="author">Torsten Schmits</a><div class="metadata"><a href="#190221119" name="190221119"><div>2020-03-10 20:33:01</div></a></div><div class="text"><p>I'm trying to call <code>async</code> in an <code>interpretH</code>:</p>
<div class="codehilite"><pre><span></span><span class="kr">data</span> <span class="kt">W</span> <span class="n">m</span> <span class="n">a</span> <span class="kr">where</span>
  <span class="kt">W</span> <span class="ow">::</span> <span class="n">m</span> <span class="n">a</span> <span class="ow">-&gt;</span> <span class="kt">W</span> <span class="n">m</span> <span class="nb">()</span>

<span class="nf">makeSem</span> <span class="kt">&#39;&#39;W</span>

<span class="nf">interpretW</span> <span class="ow">::</span>
  <span class="kt">Member</span> <span class="kt">Async</span> <span class="n">r</span> <span class="ow">=&gt;</span>
  <span class="kt">InterpreterFor</span> <span class="kt">W</span> <span class="n">r</span>
<span class="nf">interpretW</span> <span class="ow">=</span>
  <span class="n">interpretH</span> <span class="o">$</span> <span class="nf">\</span><span class="kr">case</span>
    <span class="kt">W</span> <span class="n">m</span> <span class="ow">-&gt;</span> <span class="kr">do</span>
      <span class="n">mm</span> <span class="ow">&lt;-</span> <span class="n">raise</span> <span class="o">.</span> <span class="n">interpretW</span> <span class="o">=&lt;&lt;</span> <span class="n">runT</span> <span class="n">m</span>
      <span class="n">mm1</span> <span class="ow">&lt;-</span> <span class="n">runT</span> <span class="n">m</span>
      <span class="n">async</span> <span class="n">mm</span>
      <span class="n">async</span> <span class="n">mm1</span>
      <span class="n">undefined</span>
</pre></div>


<p>I'm struggling to get the right shape for the <code>async</code> call, in the first case I get an <code>f a</code>, in the second case it's a <code>Sem</code> that has one <code>W</code> too many in the <code>Tactics</code> part. Any pointers?</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/20a04d823b7c3891d78ca5f6a188ccd0e4fc5e3d?version=2"></a><div class="content"><a class="author">TheMatten</a><div class="metadata"><a href="#190270082" name="190270082"><div>2020-03-11 11:07:34</div></a></div><div class="text"><p><span class="user-mention" data-user-id="260881">@Torsten Schmits</span> What's the goal of <code>W</code>?</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/7334dc60b6aef6a75cd9284126231f13c76926a5?version=4"></a><div class="content"><a class="author">Torsten Schmits</a><div class="metadata"><a href="#190273821" name="190273821"><div>2020-03-11 12:03:20</div></a></div><div class="text"><p><span class="user-mention" data-user-id="225127">@TheMatten</span> my use case is just bundling a few effects to shorten the <code>Members</code> list</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/20a04d823b7c3891d78ca5f6a188ccd0e4fc5e3d?version=2"></a><div class="content"><a class="author">TheMatten</a><div class="metadata"><a href="#190274088" name="190274088"><div>2020-03-11 12:07:37</div></a></div><div class="text"><p><span class="user-mention" data-user-id="260881">@Torsten Schmits</span> use <a href="https://www.stackage.org/haddock/nightly-2020-03-10/polysemy-1.3.0.0/Polysemy-Bundle.html" target="_blank" title="https://www.stackage.org/haddock/nightly-2020-03-10/polysemy-1.3.0.0/Polysemy-Bundle.html">https://www.stackage.org/haddock/nightly-2020-03-10/polysemy-1.3.0.0/Polysemy-Bundle.html</a> then</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/7334dc60b6aef6a75cd9284126231f13c76926a5?version=4"></a><div class="content"><a class="author">Torsten Schmits</a><div class="metadata"><a href="#190277418" name="190277418"><div>2020-03-11 12:55:52</div></a></div><div class="text"><p><span class="user-mention" data-user-id="225127">@TheMatten</span> thanks! that's a nice tool. In my case though, the function for which I want to bundle is not a <code>Sem</code>, but a <code>Stream (Of a) (Sem r) ()</code>, and I can't get it to work there (I tried <code>MFunctor.hoist (sendBundle @Async)</code>.</p>
<p>Also, my impression is that calling other effects from an interpreter is a fairly integral mechanism, so shouldn't it be possible with higher-order effects? Do you know if there's a way? I tried dissecting the machinery with <code>decomp</code> and fiddling with the <code>Weaving</code> and <code>Union</code> stuff, but it probably takes a while to internalize this enough to be able to work with it competently.</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/7334dc60b6aef6a75cd9284126231f13c76926a5?version=4"></a><div class="content"><a class="author">Torsten Schmits</a><div class="metadata"><a href="#190279621" name="190279621"><div>2020-03-11 13:20:10</div></a></div><div class="text"><p>ok, I see now that I can use <code>lift $ send $ injBundle $ Async.Async m</code> inside of the function. A bit verbose, but it will do.<br>
Still interested in how to do the thing from the first post though!</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/7334dc60b6aef6a75cd9284126231f13c76926a5?version=4"></a><div class="content"><a class="author">Torsten Schmits</a><div class="metadata"><a href="#190280701" name="190280701"><div>2020-03-11 13:31:05</div></a></div><div class="text"><p>also I want to use helpers like <code>sequenceConcurrently</code>, I'll try to find a way to bundle those</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/7334dc60b6aef6a75cd9284126231f13c76926a5?version=4"></a><div class="content"><a class="author">Torsten Schmits</a><div class="metadata"><a href="#190281192" name="190281192"><div>2020-03-11 13:36:01</div></a></div><div class="text"><p>oh whoops, I can just use <code>lift . sendBundle</code> <span aria-label="big smile" class="emoji emoji-1f604" role="img" title="big smile">:big_smile:</span></p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/7334dc60b6aef6a75cd9284126231f13c76926a5?version=4"></a><div class="content"><a class="author">Torsten Schmits</a><div class="metadata"><a href="#190302837" name="190302837"><div>2020-03-11 16:36:59</div></a></div><div class="text"><p>so I'm trying my best but I can't get the bundle to work with expressions like</p>
<div class="codehilite"><pre><span></span><span class="nf">sendBundle</span> <span class="p">(</span><span class="n">sem</span> <span class="p">`</span><span class="n">finally</span><span class="p">`</span> <span class="n">sendBundle</span> <span class="n">otherBundledEffectSem</span><span class="p">)</span>
</pre></div>


<p>i.e. if there are higher order effects, again (<code>Resource</code> here).</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/7334dc60b6aef6a75cd9284126231f13c76926a5?version=4"></a><div class="content"><a class="author">Torsten Schmits</a><div class="metadata"><a href="#190303541" name="190303541"><div>2020-03-11 16:43:28</div></a></div><div class="text"><p>real code:</p>
<div class="codehilite"><pre><span></span><span class="nf">closeQueueBundle</span> <span class="ow">::</span>
  <span class="err">∀</span> <span class="n">a</span> <span class="n">r</span> <span class="n">r0</span> <span class="o">.</span>
  <span class="kt">Member</span> <span class="p">(</span><span class="kt">StmQueue</span> <span class="n">a</span><span class="p">)</span> <span class="n">r0</span> <span class="ow">=&gt;</span>
  <span class="kt">Member</span> <span class="p">(</span><span class="kt">Bundle</span> <span class="n">r0</span><span class="p">)</span> <span class="n">r</span> <span class="ow">=&gt;</span>
  <span class="kt">Sem</span> <span class="n">r</span> <span class="nb">()</span>
<span class="nf">closeQueueBundle</span> <span class="ow">=</span>
  <span class="n">sendBundle</span> <span class="kt">StmQueue</span><span class="o">.</span><span class="n">closeQueue</span>

<span class="nf">finalizeBundle</span> <span class="ow">::</span>
  <span class="err">∀</span> <span class="n">a</span> <span class="n">r</span> <span class="n">r0</span> <span class="n">o</span> <span class="o">.</span>
  <span class="kt">Member</span> <span class="p">(</span><span class="kt">StmQueue</span> <span class="n">a</span><span class="p">)</span> <span class="n">r0</span> <span class="ow">=&gt;</span>
  <span class="kt">Member</span> <span class="kt">Resource</span> <span class="n">r0</span> <span class="ow">=&gt;</span>
  <span class="kt">Member</span> <span class="p">(</span><span class="kt">Bundle</span> <span class="n">r0</span><span class="p">)</span> <span class="n">r</span> <span class="ow">=&gt;</span>
  <span class="kt">Sem</span> <span class="n">r</span> <span class="n">o</span> <span class="ow">-&gt;</span>
  <span class="kt">Sem</span> <span class="n">r</span> <span class="n">o</span>
<span class="nf">finalizeBundle</span> <span class="n">s</span> <span class="ow">=</span>
  <span class="n">sendBundle</span> <span class="p">(</span><span class="n">s</span> <span class="p">`</span><span class="n">finally</span><span class="p">`</span> <span class="n">closeQueueBundle</span><span class="p">)</span>
</pre></div>


<p>saying <code>Expected type: Sem (Resource : r) o, Actual type: Sem r o</code> on the <code>finally</code> expression</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/7334dc60b6aef6a75cd9284126231f13c76926a5?version=4"></a><div class="content"><a class="author">Torsten Schmits</a><div class="metadata"><a href="#190306750" name="190306750"><div>2020-03-11 17:10:20</div></a></div><div class="text"><p>ok, that was easily solved with <code>raise</code> <span aria-label="slight smile" class="emoji emoji-1f642" role="img" title="slight smile">:slight_smile:</span></p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/7334dc60b6aef6a75cd9284126231f13c76926a5?version=4"></a><div class="content"><a class="author">Torsten Schmits</a><div class="metadata"><a href="#190307603" name="190307603"><div>2020-03-11 17:16:53</div></a></div><div class="text"><div class="codehilite"><pre><span></span><span class="nf">bundle</span> <span class="ow">::</span>
  <span class="kt">Member</span> <span class="n">e</span> <span class="n">r0</span> <span class="ow">=&gt;</span>
  <span class="kt">Member</span> <span class="p">(</span><span class="kt">Bundle</span> <span class="n">r0</span><span class="p">)</span> <span class="n">r</span> <span class="ow">=&gt;</span>
  <span class="p">(</span><span class="kt">Sem</span> <span class="p">(</span><span class="n">e</span> <span class="kt">:</span> <span class="n">r</span><span class="p">)</span> <span class="n">a</span> <span class="ow">-&gt;</span> <span class="kt">Sem</span> <span class="p">(</span><span class="n">e</span> <span class="kt">:</span> <span class="n">r</span><span class="p">)</span> <span class="n">b</span><span class="p">)</span> <span class="ow">-&gt;</span>
  <span class="kt">Sem</span> <span class="n">r</span> <span class="n">a</span> <span class="ow">-&gt;</span>
  <span class="kt">Sem</span> <span class="n">r</span> <span class="n">b</span>
<span class="nf">bundle</span> <span class="n">f</span> <span class="n">s</span> <span class="ow">=</span>
  <span class="n">sendBundle</span> <span class="p">(</span><span class="n">f</span> <span class="p">(</span><span class="n">raise</span> <span class="n">s</span><span class="p">))</span>
</pre></div>


<p>this does the trick: <code>bundle async sem</code>!</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/7334dc60b6aef6a75cd9284126231f13c76926a5?version=4"></a><div class="content"><a class="author">Torsten Schmits</a><div class="metadata"><a href="#190317850" name="190317850"><div>2020-03-11 18:52:58</div></a></div><div class="text"><p>final version:</p>
<div class="codehilite"><pre><span></span><span class="nf">bundle</span> <span class="ow">::</span>
  <span class="kt">Member</span> <span class="n">e</span> <span class="n">r0</span> <span class="ow">=&gt;</span>
  <span class="kt">Member</span> <span class="p">(</span><span class="kt">Bundle</span> <span class="n">r0</span><span class="p">)</span> <span class="n">r</span> <span class="ow">=&gt;</span>
  <span class="p">(</span><span class="kt">Sem</span> <span class="p">(</span><span class="n">e</span> <span class="kt">:</span> <span class="n">r</span><span class="p">)</span> <span class="n">a</span> <span class="ow">-&gt;</span> <span class="kt">Sem</span> <span class="p">(</span><span class="n">e</span> <span class="kt">:</span> <span class="n">r</span><span class="p">)</span> <span class="n">b</span><span class="p">)</span> <span class="ow">-&gt;</span>
  <span class="kt">Sem</span> <span class="n">r</span> <span class="n">a</span> <span class="ow">-&gt;</span>
  <span class="kt">Sem</span> <span class="n">r</span> <span class="n">b</span>
<span class="nf">bundle</span> <span class="n">f</span> <span class="n">s</span> <span class="ow">=</span>
  <span class="n">sendBundle</span> <span class="p">(</span><span class="n">f</span> <span class="p">(</span><span class="n">raise</span> <span class="n">s</span><span class="p">))</span>

<span class="nf">bundle2</span> <span class="ow">::</span>
  <span class="kt">Member</span> <span class="n">e</span> <span class="n">r0</span> <span class="ow">=&gt;</span>
  <span class="kt">Member</span> <span class="p">(</span><span class="kt">Bundle</span> <span class="n">r0</span><span class="p">)</span> <span class="n">r</span> <span class="ow">=&gt;</span>
  <span class="p">(</span><span class="kt">Sem</span> <span class="p">(</span><span class="n">e</span> <span class="kt">:</span> <span class="n">r</span><span class="p">)</span> <span class="n">a</span> <span class="ow">-&gt;</span> <span class="kt">Sem</span> <span class="p">(</span><span class="n">e</span> <span class="kt">:</span> <span class="n">r</span><span class="p">)</span> <span class="n">b</span> <span class="ow">-&gt;</span> <span class="kt">Sem</span> <span class="p">(</span><span class="n">e</span> <span class="kt">:</span> <span class="n">r</span><span class="p">)</span> <span class="n">c</span><span class="p">)</span> <span class="ow">-&gt;</span>
  <span class="kt">Sem</span> <span class="n">r</span> <span class="n">a</span> <span class="ow">-&gt;</span>
  <span class="kt">Sem</span> <span class="n">r</span> <span class="n">b</span> <span class="ow">-&gt;</span>
  <span class="kt">Sem</span> <span class="n">r</span> <span class="n">c</span>
<span class="nf">bundle2</span> <span class="n">f</span> <span class="n">s1</span> <span class="n">s2</span> <span class="ow">=</span>
  <span class="n">sendBundle</span> <span class="p">(</span><span class="n">f</span> <span class="p">(</span><span class="n">raise</span> <span class="n">s1</span><span class="p">)</span> <span class="p">(</span><span class="n">raise</span> <span class="n">s2</span><span class="p">))</span>

<span class="nf">sequenceBundled</span> <span class="ow">::</span>
  <span class="kt">Traversable</span> <span class="n">t</span> <span class="ow">=&gt;</span>
  <span class="kt">Member</span> <span class="kt">Async</span> <span class="n">r0</span> <span class="ow">=&gt;</span>
  <span class="kt">Member</span> <span class="p">(</span><span class="kt">Bundle</span> <span class="n">r0</span><span class="p">)</span> <span class="n">r</span> <span class="ow">=&gt;</span>
  <span class="n">t</span> <span class="p">(</span><span class="kt">Sem</span> <span class="n">r</span> <span class="nb">()</span><span class="p">)</span> <span class="ow">-&gt;</span>
  <span class="kt">Sem</span> <span class="n">r</span> <span class="p">(</span><span class="n">t</span> <span class="p">(</span><span class="kt">Maybe</span> <span class="nb">()</span><span class="p">))</span>
<span class="nf">sequenceBundled</span> <span class="ow">=</span>
  <span class="n">sendBundle</span> <span class="o">.</span> <span class="n">sequenceConcurrently</span> <span class="o">.</span> <span class="n">fmap</span> <span class="n">raise</span>

<span class="nf">raiseStream</span> <span class="ow">::</span>
  <span class="kt">Stream</span> <span class="p">(</span><span class="kt">Of</span> <span class="n">a</span><span class="p">)</span> <span class="p">(</span><span class="kt">Sem</span> <span class="n">r</span><span class="p">)</span> <span class="n">x</span> <span class="ow">-&gt;</span>
  <span class="kt">Stream</span> <span class="p">(</span><span class="kt">Of</span> <span class="n">a</span><span class="p">)</span> <span class="p">(</span><span class="kt">Sem</span> <span class="p">(</span><span class="n">e</span> <span class="kt">:</span> <span class="n">r</span><span class="p">))</span> <span class="n">x</span>
<span class="nf">raiseStream</span> <span class="ow">=</span>
  <span class="kt">MM</span><span class="o">.</span><span class="n">hoist</span> <span class="n">raise</span>

<span class="nf">bundleStream</span> <span class="ow">::</span>
  <span class="kt">Member</span> <span class="n">e</span> <span class="n">r0</span> <span class="ow">=&gt;</span>
  <span class="kt">Member</span> <span class="p">(</span><span class="kt">Bundle</span> <span class="n">r0</span><span class="p">)</span> <span class="n">r</span> <span class="ow">=&gt;</span>
  <span class="p">(</span><span class="kt">Stream</span> <span class="p">(</span><span class="kt">Of</span> <span class="n">a</span><span class="p">)</span> <span class="p">(</span><span class="kt">Sem</span> <span class="p">(</span><span class="n">e</span> <span class="kt">:</span> <span class="n">r</span><span class="p">))</span> <span class="n">o</span> <span class="ow">-&gt;</span> <span class="kt">Sem</span> <span class="p">(</span><span class="n">e</span> <span class="kt">:</span> <span class="n">r</span><span class="p">)</span> <span class="n">o2</span><span class="p">)</span> <span class="ow">-&gt;</span>
  <span class="kt">Stream</span> <span class="p">(</span><span class="kt">Of</span> <span class="n">a</span><span class="p">)</span> <span class="p">(</span><span class="kt">Sem</span> <span class="n">r</span><span class="p">)</span> <span class="n">o</span> <span class="ow">-&gt;</span>
  <span class="kt">Sem</span> <span class="n">r</span> <span class="n">o2</span>
<span class="nf">bundleStream</span> <span class="n">f</span> <span class="ow">=</span>
  <span class="n">sendBundle</span> <span class="o">.</span> <span class="n">f</span> <span class="o">.</span> <span class="n">raiseStream</span>

<span class="nf">mergeStreams</span> <span class="ow">::</span>
  <span class="kt">Members</span> <span class="p">[</span><span class="kt">Resource</span><span class="p">,</span> <span class="kt">Async</span><span class="p">,</span> <span class="kt">StmQueue</span> <span class="n">a</span><span class="p">]</span> <span class="n">r0</span> <span class="ow">=&gt;</span>
  <span class="kt">Member</span> <span class="p">(</span><span class="kt">Bundle</span> <span class="n">r0</span><span class="p">)</span> <span class="n">r</span> <span class="ow">=&gt;</span>
  <span class="kt">Traversable</span> <span class="n">t</span> <span class="ow">=&gt;</span>
  <span class="n">t</span> <span class="p">(</span><span class="kt">Stream</span> <span class="p">(</span><span class="kt">Of</span> <span class="n">a</span><span class="p">)</span> <span class="p">(</span><span class="kt">Sem</span> <span class="n">r</span><span class="p">)</span> <span class="nb">()</span><span class="p">)</span> <span class="ow">-&gt;</span>
  <span class="kt">Stream</span> <span class="p">(</span><span class="kt">Of</span> <span class="n">a</span><span class="p">)</span> <span class="p">(</span><span class="kt">Sem</span> <span class="n">r</span><span class="p">)</span> <span class="nb">()</span>
<span class="nf">mergeStreams</span> <span class="n">strs</span> <span class="ow">=</span> <span class="kr">do</span>
  <span class="n">inThread</span> <span class="ow">&lt;-</span> <span class="n">lift</span> <span class="o">$</span> <span class="n">bundle</span> <span class="n">async</span> <span class="n">mergedProducer</span>
  <span class="kt">Stream</span><span class="o">.</span><span class="n">untilLeft</span> <span class="n">consume</span> <span class="o">&lt;*</span> <span class="n">lift</span> <span class="p">(</span><span class="n">sendBundle</span> <span class="kt">StmQueue</span><span class="o">.</span><span class="n">closeQueue</span> <span class="o">*&gt;</span> <span class="n">sendBundle</span> <span class="p">(</span><span class="n">await</span> <span class="n">inThread</span><span class="p">))</span>
  <span class="kr">where</span>
    <span class="n">mergedProducer</span> <span class="ow">=</span>
      <span class="n">bundle2</span> <span class="n">finally</span> <span class="p">(</span><span class="n">sequenceBundled</span> <span class="p">(</span><span class="n">bundleStream</span> <span class="n">producer</span> <span class="o">&lt;$&gt;</span> <span class="n">strs</span><span class="p">))</span> <span class="p">(</span><span class="n">sendBundle</span> <span class="kt">StmQueue</span><span class="o">.</span><span class="n">closeQueue</span><span class="p">)</span>
    <span class="n">consume</span> <span class="ow">=</span>
      <span class="n">maybeToRight</span> <span class="nb">()</span> <span class="o">&lt;$&gt;</span> <span class="n">sendBundle</span> <span class="kt">StmQueue</span><span class="o">.</span><span class="n">readQueue</span>
</pre></div>


<p>pretty verbose. It would be really nice to hide this in an actual effect interpreter.</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/7334dc60b6aef6a75cd9284126231f13c76926a5?version=4"></a><div class="content"><a class="author">Torsten Schmits</a><div class="metadata"><a href="#191620052" name="191620052"><div>2020-03-24 14:49:42</div></a></div><div class="text"><p>FYI!<br>
After having fortified my intuition about Polysemy, I took another stab at this and it turned out to be quite simple with a piece of code from the interpreter for <code>Async</code>:</p>
<div class="codehilite"><pre><span></span><span class="kr">data</span> <span class="kt">W</span> <span class="n">m</span> <span class="n">a</span> <span class="kr">where</span>
  <span class="kt">W</span> <span class="ow">::</span> <span class="n">m</span> <span class="n">a</span> <span class="ow">-&gt;</span> <span class="kt">W</span> <span class="n">m</span> <span class="nb">()</span>

<span class="nf">makeSem</span> <span class="kt">&#39;&#39;W</span>

<span class="nf">interpretW</span> <span class="ow">::</span>
  <span class="kt">Member</span> <span class="kt">Async</span> <span class="n">r</span> <span class="ow">=&gt;</span>
  <span class="kt">InterpreterFor</span> <span class="kt">W</span> <span class="n">r</span>
<span class="nf">interpretW</span> <span class="ow">=</span>
  <span class="n">interpretH</span> <span class="o">$</span> <span class="nf">\</span><span class="kr">case</span>
      <span class="kt">W</span> <span class="n">m</span> <span class="ow">-&gt;</span> <span class="kr">do</span>
      <span class="n">ins</span> <span class="ow">&lt;-</span> <span class="n">getInspectorT</span>
      <span class="n">handle</span> <span class="ow">&lt;-</span> <span class="n">raise</span> <span class="o">.</span> <span class="n">async</span> <span class="o">.</span> <span class="n">interpretW</span> <span class="o">=&lt;&lt;</span> <span class="n">runT</span> <span class="n">m</span>
      <span class="p">(</span><span class="n">fmap</span> <span class="n">void</span><span class="p">)</span> <span class="o">$</span> <span class="n">pureT</span> <span class="p">(</span><span class="n">fmap</span> <span class="p">(</span><span class="o">&gt;&gt;=</span> <span class="n">inspect</span> <span class="n">ins</span><span class="p">)</span> <span class="n">handle</span><span class="p">)</span>
</pre></div></div></div></div><div class="comment"><a class="avatar"><img src="https://www.gravatar.com/avatar/3d24a4100b3eab34d8ce3059d789c543"></a><div class="content"><a class="author">Sandy Maguire</a><div class="metadata"><a href="#191662154" name="191662154"><div>2020-03-24 19:39:41</div></a></div><div class="text"><p>sweet mother of mary that's beginning to look like ghcjs code</p></div></div></div><div class="comment"><a class="avatar"><img src="https://www.gravatar.com/avatar/3d24a4100b3eab34d8ce3059d789c543"></a><div class="content"><a class="author">Sandy Maguire</a><div class="metadata"><a href="#191662158" name="191662158"><div>2020-03-24 19:39:45</div></a></div><div class="text"><p>what have i unleashed upon the world</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/7334dc60b6aef6a75cd9284126231f13c76926a5?version=4"></a><div class="content"><a class="author">Torsten Schmits</a><div class="metadata"><a href="#191664820" name="191664820"><div>2020-03-24 20:03:37</div></a></div><div class="text"><p><span class="user-mention" data-user-id="251120">@Sandy Maguire</span> I'm open to suggestions <span aria-label="slight smile" class="emoji emoji-1f642" role="img" title="slight smile">:slight_smile:</span></p></div></div></div><div class="comment"><a class="avatar"><img src="https://www.gravatar.com/avatar/3d24a4100b3eab34d8ce3059d789c543"></a><div class="content"><a class="author">Sandy Maguire</a><div class="metadata"><a href="#191666129" name="191666129"><div>2020-03-24 20:16:14</div></a></div><div class="text"><p>sorry, let me rephrase that</p></div></div></div><div class="comment"><a class="avatar"><img src="https://www.gravatar.com/avatar/3d24a4100b3eab34d8ce3059d789c543"></a><div class="content"><a class="author">Sandy Maguire</a><div class="metadata"><a href="#191666141" name="191666141"><div>2020-03-24 20:16:22</div></a></div><div class="text"><p>"why is polysemy so complicated that that stuff is necessary?"</p></div></div></div><div class="comment"><a class="avatar"><img src="https://www.gravatar.com/avatar/3d24a4100b3eab34d8ce3059d789c543"></a><div class="content"><a class="author">Sandy Maguire</a><div class="metadata"><a href="#191666147" name="191666147"><div>2020-03-24 20:16:27</div></a></div><div class="text"><p>your code is fine!</p></div></div></div><div class="comment"><a class="avatar"><img src="https://www.gravatar.com/avatar/3d24a4100b3eab34d8ce3059d789c543"></a><div class="content"><a class="author">Sandy Maguire</a><div class="metadata"><a href="#191666289" name="191666289"><div>2020-03-24 20:17:45</div></a></div><div class="text"><p>my code is not :(</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/7334dc60b6aef6a75cd9284126231f13c76926a5?version=4"></a><div class="content"><a class="author">Torsten Schmits</a><div class="metadata"><a href="#191666512" name="191666512"><div>2020-03-24 20:19:56</div></a></div><div class="text"><p>well, after having worked with it intensely for a month, I would say that compared to other concepts I've used it is, on average, less complicated <span aria-label="slight smile" class="emoji emoji-1f642" role="img" title="slight smile">:slight_smile:</span> the Tactics thing is pretty intense, sure.</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/7334dc60b6aef6a75cd9284126231f13c76926a5?version=4"></a><div class="content"><a class="author">Torsten Schmits</a><div class="metadata"><a href="#191667161" name="191667161"><div>2020-03-24 20:24:33</div></a></div><div class="text"><p>as far as I could tell, using Tactics directly isn't exactly popular (searching github for the functions yields few real results), so I'd assume that it needs more feedback to evolve into something more intuitive</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/7334dc60b6aef6a75cd9284126231f13c76926a5?version=4"></a><div class="content"><a class="author">Torsten Schmits</a><div class="metadata"><a href="#191667300" name="191667300"><div>2020-03-24 20:25:54</div></a></div><div class="text"><p>and almost all results just use a simple <code>m a</code> from the interpreter effect, not others, and no transformers.</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/7334dc60b6aef6a75cd9284126231f13c76926a5?version=4"></a><div class="content"><a class="author">Torsten Schmits</a><div class="metadata"><a href="#191667973" name="191667973"><div>2020-03-24 20:30:39</div></a></div><div class="text"><p>I have now reimplemented the stream merging effect I posted earlier, and I'm hitting another wall:</p>
<div class="codehilite"><pre><span></span><span class="nf">liftStreamEffect</span> <span class="ow">::</span>
  <span class="kt">Functor</span> <span class="n">f</span> <span class="ow">=&gt;</span>
  <span class="kt">Members</span> <span class="p">[</span><span class="kt">StmQueue</span> <span class="n">d</span><span class="p">,</span> <span class="kt">Resource</span><span class="p">,</span> <span class="kt">Async</span><span class="p">]</span> <span class="n">r</span> <span class="ow">=&gt;</span>
  <span class="n">m</span> <span class="n">a</span> <span class="ow">-&gt;</span>
  <span class="kt">Sem</span> <span class="p">(</span><span class="kt">WithTactics</span> <span class="p">(</span><span class="kt">MergeStreams</span> <span class="kt">ThreadHandle</span> <span class="n">d</span><span class="p">)</span> <span class="n">f</span> <span class="n">m</span> <span class="n">r</span><span class="p">)</span> <span class="n">a</span>
<span class="nf">liftStreamEffect</span> <span class="n">s</span> <span class="ow">=</span> <span class="kr">do</span>
  <span class="n">s1</span> <span class="ow">&lt;-</span> <span class="n">runT</span> <span class="n">s</span>
  <span class="n">liftT</span> <span class="p">(</span><span class="n">interpretMergeStreamsWith</span> <span class="n">s1</span><span class="p">)</span>

<span class="nf">runMerge</span> <span class="ow">::</span>
  <span class="err">∀</span> <span class="n">t</span> <span class="n">d</span> <span class="n">m</span> <span class="n">f</span> <span class="n">r</span> <span class="n">a</span> <span class="o">.</span>
  <span class="kt">Functor</span> <span class="n">f</span> <span class="ow">=&gt;</span>
  <span class="kt">Members</span> <span class="p">[</span><span class="kt">StmQueue</span> <span class="n">d</span><span class="p">,</span> <span class="kt">Resource</span><span class="p">,</span> <span class="kt">Async</span><span class="p">]</span> <span class="n">r</span> <span class="ow">=&gt;</span>
  <span class="kt">Traversable</span> <span class="n">t</span> <span class="ow">=&gt;</span>
  <span class="n">t</span> <span class="p">(</span><span class="kt">Stream</span> <span class="p">(</span><span class="kt">Of</span> <span class="n">d</span><span class="p">)</span> <span class="n">m</span> <span class="n">a</span><span class="p">)</span> <span class="ow">-&gt;</span>
  <span class="kt">Sem</span> <span class="p">(</span><span class="kt">WithTactics</span> <span class="p">(</span><span class="kt">MergeStreams</span> <span class="kt">ThreadHandle</span> <span class="n">d</span><span class="p">)</span> <span class="n">f</span> <span class="n">m</span> <span class="n">r</span><span class="p">)</span> <span class="p">(</span><span class="n">f</span> <span class="p">(</span><span class="kt">ThreadHandle</span> <span class="nb">()</span><span class="p">))</span>
<span class="nf">runMerge</span> <span class="n">ps</span> <span class="ow">=</span> <span class="kr">do</span>
  <span class="n">handle</span> <span class="ow">&lt;-</span> <span class="n">async</span> <span class="p">(</span><span class="n">finally</span> <span class="p">(</span><span class="n">sequenceConcurrently</span> <span class="n">prod</span><span class="p">)</span> <span class="kt">StmQueue</span><span class="o">.</span><span class="n">closeQueue</span><span class="p">)</span>
  <span class="n">pureT</span> <span class="p">(</span><span class="kt">ThreadHandle</span> <span class="p">(</span><span class="n">void</span> <span class="o">&lt;$&gt;</span> <span class="n">handle</span><span class="p">))</span>
  <span class="kr">where</span>
    <span class="n">prod</span> <span class="ow">=</span>
      <span class="n">producer</span> <span class="o">.</span> <span class="kt">Stream</span><span class="o">.</span><span class="n">hoistExposedPost</span> <span class="n">liftStreamEffect</span> <span class="o">&lt;$&gt;</span> <span class="n">ps</span>

<span class="nf">interpretMergeStreamsWith</span> <span class="ow">::</span>
  <span class="err">∀</span> <span class="n">d</span> <span class="n">r</span> <span class="n">k</span> <span class="o">.</span>
  <span class="kt">Members</span> <span class="p">[</span><span class="kt">StmQueue</span> <span class="n">d</span><span class="p">,</span> <span class="kt">Resource</span><span class="p">,</span> <span class="kt">Async</span><span class="p">]</span> <span class="n">r</span> <span class="ow">=&gt;</span>
  <span class="kt">InterpreterFor</span> <span class="p">(</span><span class="kt">MergeStreams</span> <span class="kt">ThreadHandle</span> <span class="n">d</span><span class="p">)</span> <span class="n">r</span>
</pre></div>


<p>In <code>liftStreamEffect</code>, I need to return an <code>a</code>, while I have an <code>f a</code>, like in the <code>W</code> example. But I can't use the inspector trick, because it seems to swallow the stream's state (it produces the first element ad infinitum).</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/7334dc60b6aef6a75cd9284126231f13c76926a5?version=4"></a><div class="content"><a class="author">Torsten Schmits</a><div class="metadata"><a href="#191668388" name="191668388"><div>2020-03-24 20:33:40</div></a></div><div class="text"><p>would it be possible to implement a constructor for <code>Tactics</code> that absorbs an <code>f</code> back into the monad?</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/7334dc60b6aef6a75cd9284126231f13c76926a5?version=4"></a><div class="content"><a class="author">Torsten Schmits</a><div class="metadata"><a href="#191684600" name="191684600"><div>2020-03-24 23:15:54</div></a></div><div class="text"><p>finally!! My mistake was to put some of the logic in the interpreter. I just had to prepare the producer Sems in the program:</p>
<div class="codehilite"><pre><span></span><span class="kr">newtype</span> <span class="kt">ThreadHandle</span> <span class="n">a</span> <span class="ow">=</span>
  <span class="kt">ThreadHandle</span> <span class="p">(</span><span class="kt">CC</span><span class="o">.</span><span class="kt">Async</span> <span class="p">(</span><span class="kt">Maybe</span> <span class="n">a</span><span class="p">))</span>

<span class="nf">producer</span> <span class="ow">::</span>
  <span class="kt">Member</span> <span class="p">(</span><span class="kt">Tagged</span> <span class="n">k</span> <span class="p">(</span><span class="kt">MergeStreams</span> <span class="n">h</span> <span class="n">d</span><span class="p">))</span> <span class="n">r</span> <span class="ow">=&gt;</span>
  <span class="kt">Stream</span> <span class="p">(</span><span class="kt">Of</span> <span class="n">d</span><span class="p">)</span> <span class="p">(</span><span class="kt">Sem</span> <span class="n">r</span><span class="p">)</span> <span class="n">o</span> <span class="ow">-&gt;</span>
  <span class="kt">Sem</span> <span class="n">r</span> <span class="nb">()</span>
<span class="nf">producer</span> <span class="ow">=</span>
  <span class="n">traverse_</span> <span class="n">next</span> <span class="o">&lt;=&lt;</span> <span class="kt">Stream</span><span class="o">.</span><span class="n">next</span>
  <span class="kr">where</span>
    <span class="n">next</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">str&#39;</span><span class="p">)</span> <span class="ow">=</span>
      <span class="n">unlessM</span> <span class="p">(</span><span class="n">tag</span> <span class="kt">MergeStreams</span><span class="o">.</span><span class="n">terminated</span><span class="p">)</span> <span class="p">(</span><span class="n">tag</span> <span class="p">(</span><span class="kt">MergeStreams</span><span class="o">.</span><span class="n">write</span> <span class="n">a</span><span class="p">)</span> <span class="o">*&gt;</span> <span class="n">producer</span> <span class="n">str&#39;</span><span class="p">)</span>

<span class="nf">mergeStreams</span> <span class="ow">::</span>
  <span class="kt">Member</span> <span class="p">(</span><span class="kt">Tagged</span> <span class="n">k</span> <span class="p">(</span><span class="kt">MergeStreams</span> <span class="n">h</span> <span class="n">d</span><span class="p">))</span> <span class="n">r</span> <span class="ow">=&gt;</span>
  <span class="kt">Traversable</span> <span class="n">t</span> <span class="ow">=&gt;</span>
  <span class="n">t</span> <span class="p">(</span><span class="kt">Stream</span> <span class="p">(</span><span class="kt">Of</span> <span class="n">d</span><span class="p">)</span> <span class="p">(</span><span class="kt">Sem</span> <span class="p">(</span><span class="kt">MergeStreams</span> <span class="n">h</span> <span class="n">d</span> <span class="kt">:</span> <span class="n">r</span><span class="p">))</span> <span class="nb">()</span><span class="p">)</span> <span class="ow">-&gt;</span>
  <span class="kt">Stream</span> <span class="p">(</span><span class="kt">Of</span> <span class="n">d</span><span class="p">)</span> <span class="p">(</span><span class="kt">Sem</span> <span class="n">r</span><span class="p">)</span> <span class="nb">()</span>
<span class="nf">mergeStreams</span> <span class="n">inputs</span> <span class="ow">=</span> <span class="kr">do</span>
  <span class="n">producerThread</span> <span class="ow">&lt;-</span> <span class="n">lift</span> <span class="p">(</span><span class="n">tag</span> <span class="p">(</span><span class="kt">MergeStreams</span><span class="o">.</span><span class="n">runProducer</span> <span class="p">(</span><span class="n">producer</span> <span class="o">&lt;$&gt;</span> <span class="n">inputs</span><span class="p">)))</span>
  <span class="kt">Stream</span><span class="o">.</span><span class="n">untilLeft</span> <span class="n">consume</span> <span class="o">&lt;*</span> <span class="n">lift</span> <span class="p">(</span><span class="n">tag</span> <span class="p">(</span><span class="kt">MergeStreams</span><span class="o">.</span><span class="n">finalize</span> <span class="n">producerThread</span><span class="p">))</span>
  <span class="kr">where</span>
    <span class="n">consume</span> <span class="ow">=</span>
      <span class="n">maybeToRight</span> <span class="nb">()</span> <span class="o">&lt;$&gt;</span> <span class="n">tag</span> <span class="kt">MergeStreams</span><span class="o">.</span><span class="n">consume</span>

<span class="nf">interpretMergeStreamsWith</span> <span class="ow">::</span>
  <span class="kt">Members</span> <span class="p">[</span><span class="kt">StmQueue</span> <span class="n">d</span><span class="p">,</span> <span class="kt">Resource</span><span class="p">,</span> <span class="kt">Async</span><span class="p">]</span> <span class="n">r</span> <span class="ow">=&gt;</span>
  <span class="kt">InterpreterFor</span> <span class="p">(</span><span class="kt">MergeStreams</span> <span class="kt">ThreadHandle</span> <span class="n">d</span><span class="p">)</span> <span class="n">r</span>
<span class="nf">interpretMergeStreamsWith</span> <span class="ow">=</span>
  <span class="n">interpretH</span> <span class="o">$</span> <span class="nf">\</span><span class="kr">case</span>
    <span class="kt">RunProducer</span> <span class="n">ps</span> <span class="ow">-&gt;</span> <span class="kr">do</span>
      <span class="n">handle</span> <span class="ow">&lt;-</span> <span class="n">async</span> <span class="p">(</span><span class="n">finally</span> <span class="p">(</span><span class="n">sequenceConcurrently</span> <span class="p">(</span><span class="n">recurse</span> <span class="o">&lt;$&gt;</span> <span class="n">ps</span><span class="p">))</span> <span class="kt">StmQueue</span><span class="o">.</span><span class="n">closeQueue</span><span class="p">)</span>
      <span class="n">pureT</span> <span class="p">(</span><span class="kt">ThreadHandle</span> <span class="p">(</span><span class="n">void</span> <span class="o">&lt;$&gt;</span> <span class="n">handle</span><span class="p">))</span>
      <span class="kr">where</span>
        <span class="n">recurse</span> <span class="ow">=</span>
          <span class="n">raise</span> <span class="o">.</span> <span class="n">interpretMergeStreamsWith</span> <span class="o">&lt;=&lt;</span> <span class="n">runT</span>
    <span class="kt">Consume</span> <span class="ow">-&gt;</span>
      <span class="n">liftT</span> <span class="kt">StmQueue</span><span class="o">.</span><span class="n">readQueue</span>
    <span class="kt">Finalize</span> <span class="p">(</span><span class="kt">ThreadHandle</span> <span class="n">producerThread</span><span class="p">)</span> <span class="ow">-&gt;</span>
      <span class="n">liftT</span> <span class="p">(</span><span class="kt">StmQueue</span><span class="o">.</span><span class="n">closeQueue</span> <span class="o">*&gt;</span> <span class="n">await</span> <span class="n">producerThread</span><span class="p">)</span>
    <span class="kt">Terminated</span> <span class="ow">-&gt;</span>
      <span class="n">liftT</span> <span class="kt">StmQueue</span><span class="o">.</span><span class="n">closedQueue</span>
    <span class="kt">Write</span> <span class="n">d</span> <span class="ow">-&gt;</span>
      <span class="n">liftT</span> <span class="p">(</span><span class="kt">StmQueue</span><span class="o">.</span><span class="n">writeQueue</span> <span class="n">d</span><span class="p">)</span>
</pre></div>


<p>Kinda obvious in hindsight, but I've learned a lot <span aria-label="grinning face with smiling eyes" class="emoji emoji-1f601" role="img" title="grinning face with smiling eyes">:grinning_face_with_smiling_eyes:</span></p></div></div></div></div></div><div class="ui vertical footer segment"><a href="https://github.com/srid/zulip-archive">Powered by Haskell</a> | Questions? Contact <a href="https://www.srid.ca">srid</a></div></div></body></html>