<html lang="en"><head><meta content="text/html; charset=utf-8" http-equiv="Content-Type"><meta content="width=device-width, initial-scale=1" name="viewport"><meta content="Can anyone give me an example of using Bundle? I can&#39;t even work out how to make a newtype using it :(" name="description"><link href="https://funprog.srid.ca/polysemy/bundle-example.html" rel="canonical"><meta property="og:title" content="Bundle example - Polysemy"><meta property="og:site_name" content="Functional Programming Zulip Archive"><meta property="og:type" content="article"><meta property="og:article:section" content="Polysemy"><meta property="og:article:modified_time" content="2020-05-12T06:37:19Z"><meta property="og:article:published_time" content="2020-05-09T02:28:40Z"><meta property="og:image" content="https://zulip-avatars.s3.amazonaws.com/13896/cf32e348c646a53534a1a022c022bab8528df176?version=3"><title>Bundle example - Polysemy</title><style type="text/css">
div#thesite
{
  font-family   : "Open Sans", sans-serif;
  font-size     : 1em !important;
  margin-top    : 1em;
  margin-bottom : 1em;
}

div#thesite h1
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite h2
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite h3
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite h4
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite h5
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite h6
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite .ui.breadcrumb.rib .section
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite .header
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite .as-header
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite code, pre, tt
{
  font-family : "SFMono-Regular","Menlo","Monaco","Consolas","Liberation Mono","Courier New", monospace;
}

div#thesite .ui.breadcrumb.rib
{
  margin-bottom : 1em;
}



div#thesite .ui.comments.messages .comment .metadata a
{
  color : #808080;
}

div#thesite .ui.comments.messages .comment a.avatar img
{
  height : auto;
}

div#thesite .subtle
{
  color : #808080;
}


div#thesite .messages pre
{
  font-size : 85%;
  overflow  : auto;
  max-width : 100%;
}

div#thesite .messages .message_embed
{
  border-left  : solid 3px #808080;
  padding-left : 0.69999em;
}

div#thesite .messages .message_inline_image img
{
  max-width     : 100%;
  margin-bottom : 1em;
}


/* Generated with Clay, http://fvisser.nl/clay */</style><link href="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.4.1/semantic.min.css" rel="stylesheet"><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/all.min.css" rel="stylesheet"><link href="https://fonts.googleapis.com/css?family=Open+Sans|Oswald&amp;display=swap" rel="stylesheet"><link href="https://fonts.googleapis.com/css?family=Roboto|Open+Sans&amp;display=swap" rel="stylesheet"></head><body><div id="thesite" class="ui text container"><div class="ui violet inverted top attached center aligned segment"><h1 class="ui huge header">Bundle example - Polysemy</h1></div><div class="ui attached segment"><div class="ui message"><p>Welcome to the Functional Programming Zulip Chat Archive. You can join the chat <a href="https://funprog.zulipchat.com">here</a>.</p></div><div class="ui breadcrumb rib"><a href="/" class="section">Home</a><i class="right angle icon divider"></i><a href="/polysemy/" class="section">#Polysemy</a><i class="right angle icon divider"></i><div class="active section">Bundle example</div></div><div class="ui comments messages"><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/cf32e348c646a53534a1a022c022bab8528df176?version=3"></a><div class="content"><a class="author">Alex Chapman</a><div class="metadata"><a href="#196969088" name="196969088"><div>2020-05-09 02:28:40</div></a></div><div class="text"><p>Can anyone give me an example of using <code>Bundle</code>? I can't even work out how to make a newtype using it :(</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/7334dc60b6aef6a75cd9284126231f13c76926a5?version=6"></a><div class="content"><a class="author">Torsten Schmits</a><div class="metadata"><a href="#196985337" name="196985337"><div>2020-05-09 10:46:21</div></a></div><div class="text"><p><a href="#narrow/stream/216942-Polysemy/topic/wrap.20higher-order.20effect/near/190317850" title="#narrow/stream/216942-Polysemy/topic/wrap.20higher-order.20effect/near/190317850">https://funprog.zulipchat.com/#narrow/stream/216942-Polysemy/topic/wrap.20higher-order.20effect/near/190317850</a></p>
<p>I did some live coding on here figuring it out <span aria-label="laughing" class="emoji emoji-1f606" role="img" title="laughing">:laughing:</span></p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/cf32e348c646a53534a1a022c022bab8528df176?version=3"></a><div class="content"><a class="author">Alex Chapman</a><div class="metadata"><a href="#196986195" name="196986195"><div>2020-05-09 11:06:52</div></a></div><div class="text"><p>Ah, so it isn't used with newtype at all? I was imagining something along the lines of</p>
<div class="codehilite"><pre><span></span><code><span class="kr">newtype</span> <span class="kt">App</span> <span class="n">i</span> <span class="n">o</span> <span class="n">m</span> <span class="n">a</span> <span class="ow">=</span> <span class="kt">App</span> <span class="p">(</span><span class="kt">Bundle</span> <span class="p">(</span><span class="kt">&#39;[Input i, Output o]</span> <span class="n">m</span> <span class="n">a</span><span class="p">))</span>
</code></pre></div></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/7334dc60b6aef6a75cd9284126231f13c76926a5?version=6"></a><div class="content"><a class="author">Torsten Schmits</a><div class="metadata"><a href="#196986940" name="196986940"><div>2020-05-09 11:25:42</div></a></div><div class="text"><p>well I guess you <em>can</em> do that, but it's not necessary</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/f1ec33bcc6144366b30e479d6b3bed74cdb9f611?version=4"></a><div class="content"><a class="author">Love Waern (King of the Homeless)</a><div class="metadata"><a href="#197080115" name="197080115"><div>2020-05-10 21:33:05</div></a></div><div class="text"><p>That's its intended use, actually. I find<code>sendBundle</code> too clumsy to work with in practice. Intended use is to <code>newtype</code> <code>Bundle</code> and then use <code>rewrite</code>/<code>transform</code> together with <code>injBundle</code> and <code>runBundle</code> to create actions/interpreters on the newtype.</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/f1ec33bcc6144366b30e479d6b3bed74cdb9f611?version=4"></a><div class="content"><a class="author">Love Waern (King of the Homeless)</a><div class="metadata"><a href="#197081640" name="197081640"><div>2020-05-10 22:10:28</div></a></div><div class="text"><p>Here's an example, by using your <code>App</code>:</p>
<div class="codehilite"><pre><span></span><code><span class="kr">newtype</span> <span class="kt">App</span> <span class="n">i</span> <span class="n">o</span> <span class="n">m</span> <span class="n">a</span> <span class="ow">=</span> <span class="kt">App</span> <span class="p">(</span><span class="kt">Bundle</span> <span class="kt">&#39;[Input i, Output o]</span> <span class="n">m</span> <span class="n">a</span><span class="p">)</span>

<span class="nf">runApp</span> <span class="ow">::</span> <span class="kt">Sem</span> <span class="n">r</span> <span class="n">i</span> <span class="ow">-&gt;</span> <span class="p">(</span><span class="n">o</span> <span class="ow">-&gt;</span> <span class="kt">Sem</span> <span class="n">r</span> <span class="nb">()</span><span class="p">)</span> <span class="ow">-&gt;</span> <span class="kt">Sem</span> <span class="p">(</span><span class="kt">App</span> <span class="n">i</span> <span class="n">o</span> <span class="kt">&#39;:</span> <span class="n">r</span><span class="p">)</span> <span class="n">a</span> <span class="ow">-&gt;</span> <span class="kt">Sem</span> <span class="n">r</span> <span class="n">a</span>
<span class="nf">runApp</span> <span class="n">onI</span> <span class="n">onO</span> <span class="ow">=</span>
    <span class="n">runOutputSem</span> <span class="n">onO</span>
  <span class="o">.</span> <span class="n">runInputSem</span> <span class="p">(</span><span class="n">raise</span> <span class="n">onI</span><span class="p">)</span>
  <span class="o">.</span> <span class="n">runBundle</span>
  <span class="o">.</span> <span class="n">rewrite</span> <span class="p">(</span><span class="nf">\</span><span class="p">(</span><span class="kt">App</span> <span class="n">bundle</span><span class="p">)</span> <span class="ow">-&gt;</span> <span class="n">bundle</span><span class="p">)</span>

<span class="nf">ping</span> <span class="ow">::</span> <span class="n">forall</span> <span class="n">i</span> <span class="n">o</span> <span class="n">r</span><span class="o">.</span> <span class="kt">Member</span> <span class="p">(</span><span class="kt">App</span> <span class="n">i</span> <span class="n">o</span><span class="p">)</span> <span class="n">r</span> <span class="ow">=&gt;</span> <span class="n">o</span> <span class="ow">-&gt;</span> <span class="kt">Sem</span> <span class="n">r</span> <span class="nb">()</span>
<span class="nf">ping</span> <span class="n">o</span> <span class="ow">=</span> <span class="n">transform</span> <span class="p">(</span><span class="kt">App</span> <span class="o">@</span><span class="n">i</span> <span class="o">@</span><span class="n">o</span> <span class="o">.</span> <span class="n">injBundle</span> <span class="o">@</span><span class="p">(</span><span class="kt">Output</span> <span class="n">o</span><span class="p">))</span> <span class="p">(</span><span class="n">output</span> <span class="n">o</span><span class="p">)</span>

<span class="nf">pong</span> <span class="ow">::</span> <span class="n">forall</span> <span class="n">i</span> <span class="n">o</span> <span class="n">r</span><span class="o">.</span> <span class="kt">Member</span> <span class="p">(</span><span class="kt">App</span> <span class="n">i</span> <span class="n">o</span><span class="p">)</span> <span class="n">r</span> <span class="ow">=&gt;</span> <span class="kt">Sem</span> <span class="n">r</span> <span class="n">i</span>
<span class="nf">pong</span> <span class="ow">=</span> <span class="n">transform</span> <span class="p">(</span><span class="kt">App</span> <span class="o">@</span><span class="n">i</span> <span class="o">@</span><span class="n">o</span> <span class="o">.</span> <span class="n">injBundle</span> <span class="o">@</span><span class="p">(</span><span class="kt">Input</span> <span class="n">i</span><span class="p">))</span> <span class="n">input</span>

<span class="nf">pingpong</span> <span class="ow">::</span> <span class="n">forall</span> <span class="n">i</span> <span class="n">o</span> <span class="n">r</span><span class="o">.</span> <span class="kt">Member</span> <span class="p">(</span><span class="kt">App</span> <span class="n">i</span> <span class="n">o</span><span class="p">)</span> <span class="n">r</span> <span class="ow">=&gt;</span> <span class="n">o</span> <span class="ow">-&gt;</span> <span class="kt">Sem</span> <span class="n">r</span> <span class="n">i</span>
<span class="nf">pingpong</span> <span class="n">o</span> <span class="ow">=</span> <span class="kr">do</span>
  <span class="n">transform</span> <span class="p">(</span><span class="kt">App</span> <span class="o">@</span><span class="n">i</span> <span class="o">@</span><span class="n">o</span> <span class="o">.</span> <span class="n">injBundle</span> <span class="o">@</span><span class="p">(</span><span class="kt">Output</span> <span class="n">o</span><span class="p">))</span> <span class="p">(</span><span class="n">output</span> <span class="n">o</span><span class="p">)</span>
  <span class="n">transform</span> <span class="p">(</span><span class="kt">App</span> <span class="o">@</span><span class="n">i</span> <span class="o">@</span><span class="n">o</span> <span class="o">.</span> <span class="n">injBundle</span> <span class="o">@</span><span class="p">(</span><span class="kt">Input</span> <span class="n">i</span><span class="p">))</span> <span class="n">input</span>
</code></pre></div>


<p>This also shows how you have the choice of between providing direct corresponding actions of the bundled effects (like <code>ping</code> and <code>pong</code>), or choosing only to expose certain combinations of these (like <code>pingpong</code>), similar to how you may restrictively expose power with normal newtypes.</p>
<p>All these ugly type applications arise as an effect of <code>App</code> being polymorphic (in <code>i</code> and <code>o</code>). You don't need them if your effect newtype is monomorphic, <em>or</em> if you use <code>polysemy-plugin</code>.</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/f1ec33bcc6144366b30e479d6b3bed74cdb9f611?version=4"></a><div class="content"><a class="author">Love Waern (King of the Homeless)</a><div class="metadata"><a href="#197081792" name="197081792"><div>2020-05-10 22:14:06</div></a></div><div class="text"><p>Effect newtypes aren't that special if you're only using them to represent first-order effects, since <code>re/interpret</code> and friends is a just as nice or nicer way to do the same job. They become more interesting if you want to build up a higher-order effect because, y'know, it allows you to avoid having to deal with <code>interpretH</code>.</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/f1ec33bcc6144366b30e479d6b3bed74cdb9f611?version=4"></a><div class="content"><a class="author">Love Waern (King of the Homeless)</a><div class="metadata"><a href="#197082526" name="197082526"><div>2020-05-10 22:27:49</div></a></div><div class="text"><p>A very neat example I just thought of is a <code>Mask</code> effect that relies on <code>Final IO</code>:</p>
<div class="codehilite"><pre><span></span><code><span class="kr">import</span> <span class="k">qualified</span> <span class="nn">Control.Exception</span> <span class="k">as</span> <span class="n">X</span>
<span class="kr">import</span> <span class="nn">Polysemy.Final</span>

<span class="kr">newtype</span> <span class="kt">Mask</span> <span class="n">m</span> <span class="n">a</span> <span class="ow">=</span> <span class="kt">Mask</span> <span class="p">(</span><span class="kt">Final</span> <span class="kt">IO</span> <span class="n">m</span> <span class="n">a</span><span class="p">)</span>

<span class="nf">mask</span> <span class="ow">::</span> <span class="kt">Member</span> <span class="kt">Mask</span> <span class="n">r</span> <span class="ow">=&gt;</span> <span class="p">((</span><span class="n">forall</span> <span class="n">x</span><span class="o">.</span> <span class="kt">Sem</span> <span class="n">r</span> <span class="n">x</span> <span class="ow">-&gt;</span> <span class="kt">Sem</span> <span class="n">r</span> <span class="n">x</span><span class="p">)</span> <span class="ow">-&gt;</span> <span class="kt">Sem</span> <span class="n">r</span> <span class="n">a</span><span class="p">)</span> <span class="ow">-&gt;</span> <span class="kt">Sem</span> <span class="n">r</span> <span class="n">a</span>
<span class="nf">mask</span> <span class="n">main</span> <span class="ow">=</span> <span class="n">transform</span> <span class="kt">Mask</span> <span class="o">$</span> <span class="n">withWeavingToFinal</span> <span class="o">$</span> <span class="nf">\</span><span class="n">s</span> <span class="n">wv</span> <span class="kr">_</span> <span class="ow">-&gt;</span> <span class="kt">X</span><span class="o">.</span><span class="n">mask</span> <span class="o">$</span> <span class="nf">\</span><span class="n">restore</span> <span class="ow">-&gt;</span> <span class="kr">do</span>
  <span class="kr">let</span>
    <span class="n">restore&#39;</span> <span class="ow">::</span> <span class="kt">Member</span> <span class="kt">Mask</span> <span class="n">r</span> <span class="ow">=&gt;</span> <span class="kt">Sem</span> <span class="n">r</span> <span class="n">x</span> <span class="ow">-&gt;</span> <span class="kt">Sem</span> <span class="n">r</span> <span class="n">x</span>
    <span class="n">restore&#39;</span> <span class="n">m</span> <span class="ow">=</span> <span class="n">transform</span> <span class="kt">Mask</span> <span class="o">$</span> <span class="n">withWeavingToFinal</span> <span class="o">$</span> <span class="nf">\</span><span class="n">s&#39;</span> <span class="n">wv&#39;</span> <span class="kr">_</span> <span class="ow">-&gt;</span> <span class="n">restore</span> <span class="o">$</span> <span class="n">wv&#39;</span> <span class="p">(</span><span class="n">raise</span> <span class="n">m</span> <span class="o">&lt;$</span> <span class="n">s&#39;</span><span class="p">)</span>
  <span class="n">wv</span> <span class="p">(</span><span class="n">raise</span> <span class="p">(</span><span class="n">main</span> <span class="n">restore&#39;</span><span class="p">)</span> <span class="o">&lt;$</span> <span class="n">s</span><span class="p">)</span>

<span class="nf">maskToIO</span> <span class="ow">::</span> <span class="kt">Member</span> <span class="p">(</span><span class="kt">Final</span> <span class="kt">IO</span><span class="p">)</span> <span class="n">r</span> <span class="ow">=&gt;</span> <span class="kt">Sem</span> <span class="p">(</span><span class="kt">Mask</span> <span class="kt">&#39;:</span> <span class="n">r</span><span class="p">)</span> <span class="n">a</span> <span class="ow">-&gt;</span> <span class="kt">Sem</span> <span class="n">r</span> <span class="n">a</span>
<span class="nf">maskToIO</span> <span class="ow">=</span> <span class="n">transform</span> <span class="p">(</span><span class="nf">\</span><span class="p">(</span><span class="kt">Mask</span> <span class="n">e</span><span class="p">)</span> <span class="ow">-&gt;</span> <span class="n">e</span><span class="p">)</span>
</code></pre></div>


<p>Although this doesn't need <code>Bundle</code>.</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/7334dc60b6aef6a75cd9284126231f13c76926a5?version=6"></a><div class="content"><a class="author">Torsten Schmits</a><div class="metadata"><a href="#197083054" name="197083054"><div>2020-05-10 22:36:19</div></a></div><div class="text"><p>awesome</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/cf32e348c646a53534a1a022c022bab8528df176?version=3"></a><div class="content"><a class="author">Alex Chapman</a><div class="metadata"><a href="#197089121" name="197089121"><div>2020-05-11 00:49:01</div></a></div><div class="text"><p>Thanks <span class="user-mention" data-user-id="254034">@Love Waern (King of the Homeless)</span>, that example is very helpful!</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/cf32e348c646a53534a1a022c022bab8528df176?version=3"></a><div class="content"><a class="author">Alex Chapman</a><div class="metadata"><a href="#197089329" name="197089329"><div>2020-05-11 00:55:35</div></a></div><div class="text"><p>I'm having trouble getting this thing to work:</p>
<div class="codehilite"><pre><span></span><code><span class="kr">data</span> <span class="kt">Function</span> <span class="n">a</span> <span class="n">b</span> <span class="n">m</span> <span class="n">c</span> <span class="kr">where</span>
  <span class="kt">Apply</span> <span class="ow">::</span> <span class="n">a</span> <span class="ow">-&gt;</span> <span class="kt">Function</span> <span class="n">a</span> <span class="n">b</span> <span class="n">m</span> <span class="n">b</span>

<span class="nf">makeSem</span> <span class="kt">&#39;&#39;Function</span>

<span class="nf">runPureFunction</span> <span class="ow">::</span> <span class="p">(</span><span class="n">a</span> <span class="ow">-&gt;</span> <span class="n">b</span><span class="p">)</span> <span class="ow">-&gt;</span> <span class="kt">InterpreterFor</span> <span class="p">(</span><span class="kt">Function</span> <span class="n">a</span> <span class="n">b</span><span class="p">)</span> <span class="n">r</span>
<span class="nf">runPureFunction</span> <span class="n">f</span> <span class="ow">=</span> <span class="n">interpret</span> <span class="o">$</span> <span class="nf">\</span><span class="kr">case</span>
  <span class="kt">Apply</span> <span class="n">x</span> <span class="ow">-&gt;</span> <span class="n">pure</span> <span class="o">$</span> <span class="n">f</span> <span class="n">x</span>

<span class="nf">runEffectfulFunction</span> <span class="ow">::</span> <span class="p">(</span><span class="n">a</span> <span class="ow">-&gt;</span> <span class="kt">Sem</span> <span class="n">r</span> <span class="n">b</span><span class="p">)</span> <span class="ow">-&gt;</span> <span class="kt">InterpreterFor</span> <span class="p">(</span><span class="kt">Function</span> <span class="n">a</span> <span class="n">b</span><span class="p">)</span> <span class="n">r</span>
<span class="nf">runEffectfulFunction</span> <span class="n">f</span> <span class="ow">=</span> <span class="n">interpret</span> <span class="o">$</span> <span class="nf">\</span><span class="kr">case</span>
  <span class="kt">Apply</span> <span class="n">x</span> <span class="ow">-&gt;</span> <span class="n">f</span> <span class="n">x</span>

<span class="nf">runCompose</span>
  <span class="ow">::</span> <span class="n">forall</span> <span class="n">a</span> <span class="n">b</span> <span class="n">c</span> <span class="n">r</span> <span class="n">d</span><span class="o">.</span>
  <span class="kt">Member</span> <span class="p">(</span><span class="kt">Function</span> <span class="n">b</span> <span class="n">c</span><span class="p">)</span> <span class="p">(</span><span class="kt">Function</span> <span class="n">a</span> <span class="n">b</span> <span class="kt">&#39;:</span> <span class="kt">Function</span> <span class="n">b</span> <span class="n">c</span> <span class="kt">&#39;:</span> <span class="n">r</span><span class="p">)</span>
  <span class="ow">=&gt;</span> <span class="p">(</span><span class="kt">Sem</span> <span class="p">(</span><span class="kt">Function</span> <span class="n">b</span> <span class="n">c</span> <span class="kt">&#39;:</span> <span class="n">r</span><span class="p">)</span> <span class="n">d</span> <span class="ow">-&gt;</span> <span class="kt">Sem</span> <span class="n">r</span> <span class="n">d</span><span class="p">)</span>
  <span class="ow">-&gt;</span> <span class="p">(</span><span class="kt">Sem</span> <span class="p">(</span><span class="kt">Function</span> <span class="n">a</span> <span class="n">b</span> <span class="kt">&#39;:</span> <span class="kt">Function</span> <span class="n">b</span> <span class="n">c</span> <span class="kt">&#39;:</span> <span class="n">r</span><span class="p">)</span> <span class="n">d</span> <span class="ow">-&gt;</span> <span class="kt">Sem</span> <span class="p">(</span><span class="kt">Function</span> <span class="n">b</span> <span class="n">c</span> <span class="kt">&#39;:</span> <span class="n">r</span><span class="p">)</span> <span class="n">d</span><span class="p">)</span>
  <span class="ow">-&gt;</span> <span class="kt">Sem</span> <span class="p">(</span><span class="kt">Function</span> <span class="n">a</span> <span class="n">c</span> <span class="kt">&#39;:</span> <span class="n">r</span><span class="p">)</span> <span class="n">d</span> <span class="ow">-&gt;</span> <span class="kt">Sem</span> <span class="n">r</span> <span class="n">d</span>
<span class="nf">runCompose</span> <span class="n">bc</span> <span class="n">ab</span> <span class="ow">=</span> <span class="n">bc</span> <span class="o">.</span> <span class="n">ab</span> <span class="o">.</span> <span class="n">reinterpret2</span> <span class="p">(</span><span class="nf">\</span><span class="kr">case</span>
  <span class="kt">Apply</span> <span class="n">x</span> <span class="ow">-&gt;</span> <span class="n">apply</span> <span class="o">@</span><span class="n">a</span> <span class="o">@</span><span class="n">b</span> <span class="n">x</span> <span class="o">&gt;&gt;=</span> <span class="n">apply</span> <span class="o">@</span><span class="n">b</span> <span class="o">@</span><span class="n">c</span><span class="p">)</span>

<span class="kr">newtype</span> <span class="kt">Boomerang</span> <span class="n">a</span> <span class="n">b</span> <span class="n">m</span> <span class="n">c</span> <span class="ow">=</span> <span class="kt">Boomerang</span> <span class="p">{</span> <span class="n">unBoomerang</span> <span class="ow">::</span> <span class="kt">Bundle</span> <span class="kt">&#39;[Function a b, Function b a]</span> <span class="n">m</span> <span class="n">c</span> <span class="p">}</span>

<span class="nf">runBoomerang</span>
  <span class="ow">::</span> <span class="n">forall</span> <span class="n">a</span> <span class="n">b</span> <span class="n">r</span> <span class="n">c</span><span class="o">.</span>
  <span class="p">(</span><span class="kt">Sem</span> <span class="p">(</span><span class="kt">Function</span> <span class="n">a</span> <span class="n">b</span> <span class="kt">&#39;:</span> <span class="kt">Function</span> <span class="n">b</span> <span class="n">a</span> <span class="kt">&#39;:</span> <span class="n">r</span><span class="p">)</span> <span class="n">c</span> <span class="ow">-&gt;</span> <span class="kt">Sem</span> <span class="p">(</span><span class="kt">Function</span> <span class="n">b</span> <span class="n">a</span> <span class="kt">&#39;:</span> <span class="n">r</span><span class="p">)</span> <span class="n">c</span><span class="p">)</span>
  <span class="ow">-&gt;</span> <span class="p">(</span><span class="kt">Sem</span> <span class="p">(</span><span class="kt">Function</span> <span class="n">b</span> <span class="n">a</span> <span class="kt">&#39;:</span> <span class="n">r</span><span class="p">)</span> <span class="n">c</span> <span class="ow">-&gt;</span> <span class="kt">Sem</span> <span class="n">r</span> <span class="n">c</span><span class="p">)</span>
  <span class="ow">-&gt;</span> <span class="kt">Sem</span> <span class="p">(</span><span class="kt">Boomerang</span> <span class="n">a</span> <span class="n">b</span> <span class="kt">&#39;:</span> <span class="n">r</span><span class="p">)</span> <span class="n">c</span> <span class="ow">-&gt;</span> <span class="kt">Sem</span> <span class="n">r</span> <span class="n">c</span>
<span class="nf">runBoomerang</span> <span class="n">ab</span> <span class="n">ba</span> <span class="ow">=</span> <span class="n">ba</span> <span class="o">.</span> <span class="n">ab</span> <span class="o">.</span> <span class="n">runBundle</span> <span class="o">.</span> <span class="n">rewrite</span> <span class="n">unBoomerang</span>

<span class="nf">forward</span> <span class="ow">::</span> <span class="n">forall</span> <span class="n">a</span> <span class="n">b</span> <span class="n">r</span><span class="o">.</span> <span class="kt">Member</span> <span class="p">(</span><span class="kt">Boomerang</span> <span class="n">a</span> <span class="n">b</span><span class="p">)</span> <span class="n">r</span> <span class="ow">=&gt;</span> <span class="n">a</span> <span class="ow">-&gt;</span> <span class="kt">Sem</span> <span class="n">r</span> <span class="n">b</span>
<span class="nf">forward</span> <span class="n">x</span> <span class="ow">=</span> <span class="n">transform</span> <span class="p">(</span><span class="kt">Boomerang</span> <span class="o">@</span><span class="n">a</span> <span class="o">@</span><span class="n">b</span> <span class="o">.</span> <span class="n">injBundle</span> <span class="o">@</span><span class="p">(</span><span class="kt">Function</span> <span class="n">a</span> <span class="n">b</span><span class="p">))</span> <span class="p">(</span><span class="n">apply</span> <span class="o">@</span><span class="n">a</span> <span class="o">@</span><span class="n">b</span> <span class="n">x</span><span class="p">)</span>

<span class="nf">reverse</span> <span class="ow">::</span> <span class="n">forall</span> <span class="n">a</span> <span class="n">b</span> <span class="n">r</span><span class="o">.</span> <span class="kt">Member</span> <span class="p">(</span><span class="kt">Boomerang</span> <span class="n">a</span> <span class="n">b</span><span class="p">)</span> <span class="n">r</span> <span class="ow">=&gt;</span> <span class="n">b</span> <span class="ow">-&gt;</span> <span class="kt">Sem</span> <span class="n">r</span> <span class="n">a</span>
<span class="nf">reverse</span> <span class="n">x</span> <span class="ow">=</span> <span class="n">transform</span> <span class="p">(</span><span class="kt">Boomerang</span> <span class="o">@</span><span class="n">a</span> <span class="o">@</span><span class="n">b</span> <span class="o">.</span> <span class="n">injBundle</span> <span class="o">@</span><span class="p">(</span><span class="kt">Function</span> <span class="n">b</span> <span class="n">a</span><span class="p">))</span> <span class="p">(</span><span class="n">apply</span> <span class="o">@</span><span class="n">b</span> <span class="o">@</span><span class="n">a</span> <span class="n">x</span><span class="p">)</span>
</code></pre></div>


<p>Everything works up until <code>reverse</code> (although the type signatures of <code>runCompose</code> and <code>runBoomerang</code> are strange), but <code>reverse</code> gives me this compiler error: <code>Could not deduce: a ~ b arising from a use of ‘injBundle’</code>.</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/cf32e348c646a53534a1a022c022bab8528df176?version=3"></a><div class="content"><a class="author">Alex Chapman</a><div class="metadata"><a href="#197089426" name="197089426"><div>2020-05-11 00:58:05</div></a></div><div class="text"><p>(eventually I want to be able to compose Boomerangs, so that I can build a decode/encode chain out of a mixture of pure and effectful functions)</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/cf32e348c646a53534a1a022c022bab8528df176?version=3"></a><div class="content"><a class="author">Alex Chapman</a><div class="metadata"><a href="#197092927" name="197092927"><div>2020-05-11 02:23:20</div></a></div><div class="text"><p>I think I need a function of type <code>(Sem (e1 ': r) a -&gt; Sem r a) -&gt; Sem (e1 ': e2 ': r) a -&gt; Sem (e2 ': r) a</code></p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/f1ec33bcc6144366b30e479d6b3bed74cdb9f611?version=4"></a><div class="content"><a class="author">Love Waern (King of the Homeless)</a><div class="metadata"><a href="#197095118" name="197095118"><div>2020-05-11 03:14:11</div></a></div><div class="text"><p>Ha! You just found one of the few cases where <code>Member</code> inference breaks even with type applications! Basically, Haskell can't tell that <code>Function a b</code> IS NOT <code>Function b a</code>, so the send is ambiguous (oversimplifying a bit; the reason <code>forward</code> works but <code>reverse</code> doesn't despite <code>forward</code> has the same ambiguity issue is due to how <code>Member</code> works.)</p>
<p>Solution is to import <code>Polysemy.Membership</code> and write this:</p>
<div class="codehilite"><pre><span></span><code><span class="nf">reverse</span> <span class="n">x</span> <span class="ow">=</span> <span class="n">transform</span> <span class="p">(</span><span class="kt">Boomerang</span> <span class="o">@</span><span class="n">a</span> <span class="o">@</span><span class="n">b</span> <span class="o">.</span> <span class="kt">Bundle</span> <span class="p">(</span><span class="kt">There</span> <span class="kt">Here</span><span class="p">))</span> <span class="p">(</span><span class="n">apply</span> <span class="o">@</span><span class="n">b</span> <span class="o">@</span><span class="n">a</span><span class="p">)</span>
</code></pre></div>


<p>That should fix it.</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/f1ec33bcc6144366b30e479d6b3bed74cdb9f611?version=4"></a><div class="content"><a class="author">Love Waern (King of the Homeless)</a><div class="metadata"><a href="#197095143" name="197095143"><div>2020-05-11 03:14:38</div></a></div><div class="text"><p>I think. Haven't checked.</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/cf32e348c646a53534a1a022c022bab8528df176?version=3"></a><div class="content"><a class="author">Alex Chapman</a><div class="metadata"><a href="#197095683" name="197095683"><div>2020-05-11 03:24:47</div></a></div><div class="text"><p>Yes, that fixes it. Thanks :)</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/cf32e348c646a53534a1a022c022bab8528df176?version=3"></a><div class="content"><a class="author">Alex Chapman</a><div class="metadata"><a href="#197095725" name="197095725"><div>2020-05-11 03:25:25</div></a></div><div class="text"><p>What about the strange types of <code>runCompose</code> and <code>runBoomerang</code>? Is there a way to simplify these?</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/f1ec33bcc6144366b30e479d6b3bed74cdb9f611?version=4"></a><div class="content"><a class="author">Love Waern (King of the Homeless)</a><div class="metadata"><a href="#197096372" name="197096372"><div>2020-05-11 03:36:33</div></a></div><div class="text"><p>For <code>runBoomerang</code>, unfortunately not really.   For <code>runCompose</code>, only a tiny bit:</p>
<div class="codehilite"><pre><span></span><code><span class="nf">runCompose</span>
  <span class="ow">::</span> <span class="n">forall</span> <span class="n">a</span> <span class="n">b</span> <span class="n">c</span> <span class="n">r</span> <span class="n">d</span>
   <span class="o">.</span> <span class="p">(</span><span class="kt">Sem</span> <span class="p">(</span><span class="kt">Function</span> <span class="n">b</span> <span class="n">c</span> <span class="kt">&#39;:</span> <span class="n">r</span><span class="p">)</span> <span class="n">d</span> <span class="ow">-&gt;</span> <span class="kt">Sem</span> <span class="n">r</span> <span class="n">d</span><span class="p">)</span>
  <span class="ow">-&gt;</span> <span class="p">(</span><span class="kt">Sem</span> <span class="p">(</span><span class="kt">Function</span> <span class="n">a</span> <span class="n">b</span> <span class="kt">&#39;:</span> <span class="kt">Function</span> <span class="n">b</span> <span class="n">c</span> <span class="kt">&#39;:</span> <span class="n">r</span><span class="p">)</span> <span class="n">d</span> <span class="ow">-&gt;</span> <span class="kt">Sem</span> <span class="p">(</span><span class="kt">Function</span> <span class="n">b</span> <span class="n">c</span> <span class="kt">&#39;:</span> <span class="n">r</span><span class="p">)</span> <span class="n">d</span><span class="p">)</span>
  <span class="ow">-&gt;</span> <span class="kt">Sem</span> <span class="p">(</span><span class="kt">Function</span> <span class="n">a</span> <span class="n">c</span> <span class="kt">&#39;:</span> <span class="n">r</span><span class="p">)</span> <span class="n">d</span> <span class="ow">-&gt;</span> <span class="kt">Sem</span> <span class="n">r</span> <span class="n">d</span>
<span class="nf">runCompose</span> <span class="n">bc</span> <span class="n">ab</span> <span class="ow">=</span> <span class="n">bc</span> <span class="o">.</span> <span class="n">ab</span> <span class="o">.</span> <span class="n">reinterpret2</span> <span class="p">(</span><span class="nf">\</span><span class="kr">case</span>
  <span class="kt">Apply</span> <span class="n">x</span> <span class="ow">-&gt;</span> <span class="n">apply</span> <span class="o">@</span><span class="n">a</span> <span class="o">@</span><span class="n">b</span> <span class="n">x</span> <span class="o">&gt;&gt;=</span> <span class="n">raise</span> <span class="o">.</span> <span class="n">apply</span> <span class="o">@</span><span class="n">b</span> <span class="o">@</span><span class="n">c</span><span class="p">)</span>
</code></pre></div>


<p>Interpreters that take interpreters as arguments often have this problem. If you're always gonna postcompose <code>ab</code> and <code>bc</code>, I recommend removing them as arguments to <code>runCompose</code>:</p>
<div class="codehilite"><pre><span></span><code><span class="nf">runCompose</span>
  <span class="ow">::</span> <span class="n">forall</span> <span class="n">a</span> <span class="n">b</span> <span class="n">c</span> <span class="n">r</span> <span class="n">d</span>
   <span class="o">.</span> <span class="kt">Sem</span> <span class="p">(</span><span class="kt">Function</span> <span class="n">a</span> <span class="n">c</span> <span class="kt">&#39;:</span> <span class="n">r</span><span class="p">)</span> <span class="n">d</span> <span class="ow">-&gt;</span> <span class="kt">Sem</span> <span class="p">(</span><span class="kt">Function</span> <span class="n">a</span> <span class="n">b</span> <span class="kt">&#39;:</span> <span class="kt">Function</span> <span class="n">b</span> <span class="n">c</span> <span class="kt">&#39;:</span> <span class="n">r</span><span class="p">)</span> <span class="n">d</span>
<span class="nf">runCompose</span> <span class="ow">=</span> <span class="n">reinterpret2</span> <span class="o">$</span> <span class="nf">\</span><span class="kr">case</span>
  <span class="kt">Apply</span> <span class="n">x</span> <span class="ow">-&gt;</span> <span class="n">apply</span> <span class="o">@</span><span class="n">a</span> <span class="o">@</span><span class="n">b</span> <span class="n">x</span> <span class="o">&gt;&gt;=</span> <span class="n">raise</span> <span class="o">.</span> <span class="n">apply</span> <span class="o">@</span><span class="n">b</span> <span class="o">@</span><span class="n">c</span>
</code></pre></div>


<p>And then apply <code>ab</code> and <code>bc</code> through simple composition.</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/f1ec33bcc6144366b30e479d6b3bed74cdb9f611?version=4"></a><div class="content"><a class="author">Love Waern (King of the Homeless)</a><div class="metadata"><a href="#197096385" name="197096385"><div>2020-05-11 03:37:53</div></a></div><div class="text"><p>And of course, the same thing can be done for <code>runBoomerang</code>:</p>
<div class="codehilite"><pre><span></span><code><span class="nf">runBoomerang</span>
  <span class="ow">::</span> <span class="n">forall</span> <span class="n">a</span> <span class="n">b</span> <span class="n">r</span> <span class="n">c</span><span class="o">.</span>
    <span class="kt">Sem</span> <span class="p">(</span><span class="kt">Boomerang</span> <span class="n">a</span> <span class="n">b</span> <span class="kt">&#39;:</span> <span class="n">r</span><span class="p">)</span> <span class="n">c</span> <span class="ow">-&gt;</span> <span class="kt">Sem</span> <span class="p">(</span><span class="kt">Function</span> <span class="n">a</span> <span class="n">b</span> <span class="kt">&#39;:</span> <span class="kt">Function</span> <span class="n">b</span> <span class="n">a</span> <span class="kt">&#39;:</span> <span class="n">r</span><span class="p">)</span> <span class="n">c</span>
<span class="nf">runBoomerang</span> <span class="ow">=</span> <span class="n">runBundle</span> <span class="o">.</span> <span class="n">rewrite</span> <span class="n">unBoomerang</span>
</code></pre></div></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/cf32e348c646a53534a1a022c022bab8528df176?version=3"></a><div class="content"><a class="author">Alex Chapman</a><div class="metadata"><a href="#197096773" name="197096773"><div>2020-05-11 03:45:47</div></a></div><div class="text"><p>Ok, I'll work with that :)</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/cf32e348c646a53534a1a022c022bab8528df176?version=3"></a><div class="content"><a class="author">Alex Chapman</a><div class="metadata"><a href="#197125529" name="197125529"><div>2020-05-11 10:30:22</div></a></div><div class="text"><p>Ok, I'm nearly there. I have a <code>Function</code> effect:</p>
<div class="codehilite"><pre><span></span><code><span class="c1">-- | An effect for calling functions.</span>
<span class="c1">--</span>
<span class="c1">-- Examples:</span>
<span class="c1">--</span>
<span class="c1">-- &gt;&gt;&gt;  (apply 1 &gt;&gt;= apply @Int @String &gt;&gt;= embed . putStrLn)</span>
<span class="c1">--      &amp; runPureFunction show</span>
<span class="c1">--      &amp; runPureFunction (+1)</span>
<span class="c1">--      &amp; runM</span>
<span class="c1">-- 2</span>
<span class="c1">--</span>
<span class="c1">-- &gt;&gt;&gt; (apply 1 &gt;&gt;= embed . putStrLn)</span>
<span class="c1">--     &amp; subsumeCompose @Int @Int @String</span>
<span class="c1">--     &amp; runPureFunction show</span>
<span class="c1">--     &amp; runPureFunction (+1)</span>
<span class="c1">--     &amp; runM</span>
<span class="c1">-- 2</span>
<span class="kr">data</span> <span class="kt">Function</span> <span class="n">a</span> <span class="n">b</span> <span class="n">m</span> <span class="n">c</span> <span class="kr">where</span>
  <span class="kt">Apply</span> <span class="ow">::</span> <span class="n">a</span> <span class="ow">-&gt;</span> <span class="kt">Function</span> <span class="n">a</span> <span class="n">b</span> <span class="n">m</span> <span class="n">b</span>

<span class="nf">makeSem</span> <span class="kt">&#39;&#39;Function</span>

<span class="c1">-- | Run this &#39;Function&#39; as a pure function.</span>
<span class="nf">runPureFunction</span> <span class="ow">::</span> <span class="p">(</span><span class="n">a</span> <span class="ow">-&gt;</span> <span class="n">b</span><span class="p">)</span> <span class="ow">-&gt;</span> <span class="kt">InterpreterFor</span> <span class="p">(</span><span class="kt">Function</span> <span class="n">a</span> <span class="n">b</span><span class="p">)</span> <span class="n">r</span>
<span class="nf">runPureFunction</span> <span class="n">f</span> <span class="ow">=</span> <span class="n">interpret</span> <span class="o">$</span> <span class="nf">\</span><span class="kr">case</span>
  <span class="kt">Apply</span> <span class="n">x</span> <span class="ow">-&gt;</span> <span class="n">pure</span> <span class="o">$</span> <span class="n">f</span> <span class="n">x</span>

<span class="c1">-- | Run this &#39;Function&#39; as a function with effects.</span>
<span class="nf">runEffectfulFunction</span> <span class="ow">::</span> <span class="p">(</span><span class="n">a</span> <span class="ow">-&gt;</span> <span class="kt">Sem</span> <span class="n">r</span> <span class="n">b</span><span class="p">)</span> <span class="ow">-&gt;</span> <span class="kt">InterpreterFor</span> <span class="p">(</span><span class="kt">Function</span> <span class="n">a</span> <span class="n">b</span><span class="p">)</span> <span class="n">r</span>
<span class="nf">runEffectfulFunction</span> <span class="n">f</span> <span class="ow">=</span> <span class="n">interpret</span> <span class="o">$</span> <span class="nf">\</span><span class="kr">case</span>
  <span class="kt">Apply</span> <span class="n">x</span> <span class="ow">-&gt;</span> <span class="n">f</span> <span class="n">x</span>

<span class="c1">-- | Run this &#39;Function&#39; in terms of two other &#39;Function&#39;s which compose.</span>
<span class="c1">-- The other function interpreters must come immediately after this.</span>
<span class="c1">-- Note that any of the functions may or may not have side effects.</span>
<span class="nf">runCompose</span>
  <span class="ow">::</span> <span class="n">forall</span> <span class="n">a</span> <span class="n">b</span> <span class="n">c</span> <span class="n">r</span> <span class="n">d</span>
   <span class="o">.</span> <span class="kt">Sem</span> <span class="p">(</span><span class="kt">Function</span> <span class="n">a</span> <span class="n">c</span> <span class="kt">&#39;:</span> <span class="n">r</span><span class="p">)</span> <span class="n">d</span> <span class="ow">-&gt;</span> <span class="kt">Sem</span> <span class="p">(</span><span class="kt">Function</span> <span class="n">a</span> <span class="n">b</span> <span class="kt">&#39;:</span> <span class="kt">Function</span> <span class="n">b</span> <span class="n">c</span> <span class="kt">&#39;:</span> <span class="n">r</span><span class="p">)</span> <span class="n">d</span>
<span class="nf">runCompose</span> <span class="ow">=</span> <span class="n">reinterpret2</span> <span class="o">$</span> <span class="nf">\</span><span class="kr">case</span>
  <span class="kt">Apply</span> <span class="n">x</span> <span class="ow">-&gt;</span> <span class="n">apply</span> <span class="o">@</span><span class="n">a</span> <span class="o">@</span><span class="n">b</span> <span class="n">x</span> <span class="o">&gt;&gt;=</span> <span class="n">raise</span> <span class="o">.</span> <span class="n">apply</span> <span class="o">@</span><span class="n">b</span> <span class="o">@</span><span class="n">c</span>

<span class="c1">-- | Run this &#39;Function&#39; in terms of two other &#39;Function&#39;s which compose.</span>
<span class="c1">-- The other function interpreters may be anywhere in the remaining effect stack.</span>
<span class="c1">-- Note that any of the functions may or may not have side effects.</span>
<span class="nf">subsumeCompose</span>
  <span class="ow">::</span> <span class="n">forall</span> <span class="n">a</span> <span class="n">b</span> <span class="n">c</span> <span class="n">r</span> <span class="n">d</span>
   <span class="o">.</span> <span class="kt">Members</span>
     <span class="kt">&#39;[ Function a b</span>
<span class="kt">      , Function b c</span>
<span class="kt">      ]</span> <span class="n">r</span>
  <span class="ow">=&gt;</span> <span class="kt">InterpreterFor</span> <span class="p">(</span><span class="kt">Function</span> <span class="n">a</span> <span class="n">c</span><span class="p">)</span> <span class="n">r</span>
<span class="nf">subsumeCompose</span> <span class="ow">=</span> <span class="n">interpret</span> <span class="o">$</span> <span class="nf">\</span><span class="kr">case</span>
  <span class="kt">Apply</span> <span class="n">x</span> <span class="ow">-&gt;</span> <span class="n">apply</span> <span class="o">@</span><span class="n">a</span> <span class="o">@</span><span class="n">b</span> <span class="n">x</span> <span class="o">&gt;&gt;=</span> <span class="n">apply</span> <span class="o">@</span><span class="n">b</span> <span class="o">@</span><span class="n">c</span>
</code></pre></div>


<p>And I have a <code>Boomerang</code> effect:</p>
<div class="codehilite"><pre><span></span><code><span class="c1">-- | An effect for wrapping pairs of invertible functions.</span>
<span class="kr">newtype</span> <span class="kt">Boomerang</span> <span class="n">a</span> <span class="n">b</span> <span class="n">m</span> <span class="n">c</span> <span class="ow">=</span> <span class="kt">Boomerang</span>
  <span class="p">{</span> <span class="n">unBoomerang</span> <span class="ow">::</span> <span class="kt">Bundle</span> <span class="kt">&#39;[Function a b, Function b a]</span> <span class="n">m</span> <span class="n">c</span> <span class="p">}</span>

<span class="nf">forward</span> <span class="ow">::</span> <span class="kt">Member</span> <span class="p">(</span><span class="kt">Boomerang</span> <span class="n">a</span> <span class="n">b</span><span class="p">)</span> <span class="n">r</span> <span class="ow">=&gt;</span> <span class="n">a</span> <span class="ow">-&gt;</span> <span class="kt">Sem</span> <span class="n">r</span> <span class="n">b</span>
<span class="nf">forward</span> <span class="ow">=</span> <span class="n">transform</span> <span class="p">(</span><span class="kt">Boomerang</span> <span class="o">.</span> <span class="n">injBundle</span><span class="p">)</span> <span class="o">.</span> <span class="n">apply</span>

<span class="nf">backward</span> <span class="ow">::</span> <span class="kt">Member</span> <span class="p">(</span><span class="kt">Boomerang</span> <span class="n">a</span> <span class="n">b</span><span class="p">)</span> <span class="n">r</span> <span class="ow">=&gt;</span> <span class="n">b</span> <span class="ow">-&gt;</span> <span class="kt">Sem</span> <span class="n">r</span> <span class="n">a</span>
<span class="nf">backward</span> <span class="ow">=</span> <span class="n">transform</span> <span class="p">(</span><span class="kt">Boomerang</span> <span class="o">.</span> <span class="kt">Bundle</span> <span class="p">(</span><span class="kt">There</span> <span class="kt">Here</span><span class="p">))</span> <span class="o">.</span> <span class="n">apply</span>

<span class="c1">-- | Run in terms of two &#39;Function&#39;s, either of which may have effects.</span>
<span class="c1">-- The functions should be provided next.</span>
<span class="nf">runBoomerang</span>
  <span class="ow">::</span> <span class="kt">Sem</span> <span class="p">(</span><span class="kt">Boomerang</span> <span class="n">a</span> <span class="n">b</span> <span class="kt">&#39;:</span> <span class="n">r</span><span class="p">)</span> <span class="n">c</span> <span class="ow">-&gt;</span> <span class="kt">Sem</span> <span class="p">(</span><span class="kt">Function</span> <span class="n">a</span> <span class="n">b</span> <span class="kt">&#39;:</span> <span class="kt">Function</span> <span class="n">b</span> <span class="n">a</span> <span class="kt">&#39;:</span> <span class="n">r</span><span class="p">)</span> <span class="n">c</span>
<span class="nf">runBoomerang</span> <span class="ow">=</span> <span class="n">runBundle</span> <span class="o">.</span> <span class="n">rewrite</span> <span class="n">unBoomerang</span>

<span class="c1">-- | Run in terms of an isomorphism.</span>
<span class="nf">runBoomerangIso</span>
  <span class="ow">::</span> <span class="kt">Iso&#39;</span> <span class="n">a</span> <span class="n">b</span> <span class="ow">-&gt;</span> <span class="kt">Sem</span> <span class="p">(</span><span class="kt">Boomerang</span> <span class="n">a</span> <span class="n">b</span> <span class="kt">&#39;:</span> <span class="n">r</span><span class="p">)</span> <span class="n">c</span> <span class="ow">-&gt;</span> <span class="kt">Sem</span> <span class="n">r</span> <span class="n">c</span>
<span class="nf">runBoomerangIso</span> <span class="n">l</span> <span class="ow">=</span>
  <span class="n">runPureFunction</span> <span class="p">(</span><span class="n">view</span> <span class="o">$</span> <span class="n">from</span> <span class="n">l</span><span class="p">)</span>
  <span class="o">.</span> <span class="n">runPureFunction</span> <span class="p">(</span><span class="n">view</span> <span class="n">l</span><span class="p">)</span>
  <span class="o">.</span> <span class="n">runBoomerang</span>

<span class="c1">-- | Run in terms of two &#39;Function&#39;s, either of which may have effects.</span>
<span class="c1">-- These functions can be anywhere in the effect stack, so can be reused for multiple &#39;Boomerang&#39;s.</span>
<span class="nf">subsumeBoomerang</span>
  <span class="ow">::</span> <span class="kt">Members</span> <span class="kt">&#39;[Function a b, Function b a]</span> <span class="n">r</span>
  <span class="ow">=&gt;</span> <span class="kt">InterpreterFor</span> <span class="p">(</span><span class="kt">Boomerang</span> <span class="n">a</span> <span class="n">b</span><span class="p">)</span> <span class="n">r</span>
<span class="nf">subsumeBoomerang</span> <span class="ow">=</span> <span class="n">subsumeBundle</span> <span class="o">.</span> <span class="n">rewrite</span> <span class="n">unBoomerang</span>

<span class="c1">-- | Run this &#39;Boomerang&#39; in terms of two other &#39;Boomerang&#39;s which compose (in both directions!)</span>
<span class="c1">-- The other boomerangs must be run immediately after this.</span>
<span class="nf">runComposeBoomerang</span>
  <span class="ow">::</span> <span class="n">forall</span> <span class="n">a</span> <span class="n">b</span> <span class="n">c</span> <span class="n">d</span> <span class="n">r</span>
   <span class="o">.</span> <span class="kt">Sem</span> <span class="p">(</span><span class="kt">Boomerang</span> <span class="n">a</span> <span class="n">c</span> <span class="kt">&#39;:</span> <span class="n">r</span><span class="p">)</span> <span class="n">d</span>
   <span class="ow">-&gt;</span> <span class="kt">Sem</span> <span class="p">(</span><span class="kt">Boomerang</span> <span class="n">a</span> <span class="n">b</span> <span class="kt">&#39;:</span> <span class="kt">Boomerang</span> <span class="n">b</span> <span class="n">c</span> <span class="kt">&#39;:</span> <span class="n">r</span><span class="p">)</span> <span class="n">d</span>
<span class="nf">runComposeBoomerang</span> <span class="ow">=</span> <span class="n">subsumeComposeBoomerang</span> <span class="o">@</span><span class="n">a</span> <span class="o">@</span><span class="n">b</span> <span class="o">@</span><span class="n">c</span> <span class="o">.</span> <span class="n">raiseUnder2</span>

<span class="c1">-- | Run this &#39;Boomerang&#39; in terms of two other &#39;Boomerang&#39;s which compose (in both directions!)</span>
<span class="c1">-- The other &#39;Boomerang&#39;s may appear anywhere in the effect stack.</span>
<span class="nf">subsumeComposeBoomerang</span>
  <span class="ow">::</span> <span class="n">forall</span> <span class="n">a</span> <span class="n">b</span> <span class="n">c</span> <span class="n">r</span>
   <span class="o">.</span> <span class="kt">Members</span> <span class="kt">&#39;[Boomerang a b, Boomerang b c]</span> <span class="n">r</span>
  <span class="ow">=&gt;</span> <span class="kt">InterpreterFor</span> <span class="p">(</span><span class="kt">Boomerang</span> <span class="n">a</span> <span class="n">c</span><span class="p">)</span> <span class="n">r</span>
<span class="nf">subsumeComposeBoomerang</span> <span class="ow">=</span>
  <span class="n">runEffectfulFunction</span> <span class="p">(</span><span class="n">backward</span> <span class="o">@</span><span class="n">b</span> <span class="o">@</span><span class="n">c</span> <span class="o">&gt;=&gt;</span> <span class="n">backward</span> <span class="o">@</span><span class="n">a</span> <span class="o">@</span><span class="n">b</span><span class="p">)</span>
  <span class="o">.</span> <span class="n">runEffectfulFunction</span> <span class="p">(</span><span class="n">forward</span> <span class="o">@</span><span class="n">a</span> <span class="o">@</span><span class="n">b</span> <span class="o">&gt;=&gt;</span> <span class="n">forward</span> <span class="o">@</span><span class="n">b</span> <span class="o">@</span><span class="n">c</span><span class="p">)</span>
  <span class="o">.</span> <span class="n">runBundle</span>
  <span class="o">.</span> <span class="n">rewrite</span> <span class="n">unBoomerang</span>
</code></pre></div>


<p>But that <code>runComposeBoomerang</code> doesn't compile. The error is similar to before, <span class="user-mention" data-user-id="254034">@Love Waern (King of the Homeless)</span> , <code>Couldn't match type ‘b’ with ‘a’ arising from a use of ‘subsumeComposeBoomerang’</code>. But I can't see a way around it this time :/</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/f1ec33bcc6144366b30e479d6b3bed74cdb9f611?version=4"></a><div class="content"><a class="author">Love Waern (King of the Homeless)</a><div class="metadata"><a href="#197135231" name="197135231"><div>2020-05-11 12:05:07</div></a></div><div class="text"><p>I don't think there is one! <code>subsumeComposeBoomerang</code> has the problem I mentioned above: Haskell can't distinguish <code>Function a b</code> and <code>Function b a</code>, and thus when trying to resolve<code>(Member (Boomerang a b) r, Member (Boomerang b a) r)</code>, it will attempt to unify <code>a</code> and <code>b</code>. Above, I fixed this by either <code>raise</code>ing or throwing in explicit membership proofs, but that trick only works when the effect stack <code>r</code> is at least partly known. In <code>subsumeComposeBoomerang</code>, <code>r</code>is completely polymorphic; you only have <code>Member</code> to work with, and in this case, it just doesn't work.</p>
<p>There are two ways to solve this. One way is to distinguish between the two effects by wrapping one in a newtype, and unwrapping them later. <code>Tagged</code> can be used for this purpose.</p>
<p>What I recommend instead is that you inline the definition of<code>subsumeComposeBoomerang</code>in <code>runComposeBoomerang</code>. That way, you can do the <code>raise</code> trick again.</p>
<div class="codehilite"><pre><span></span><code><span class="nf">runComposeBoomerang</span>
  <span class="ow">::</span> <span class="n">forall</span> <span class="n">a</span> <span class="n">b</span> <span class="n">c</span> <span class="n">d</span> <span class="n">r</span>
   <span class="o">.</span> <span class="kt">Sem</span> <span class="p">(</span><span class="kt">Boomerang</span> <span class="n">a</span> <span class="n">c</span> <span class="kt">&#39;:</span> <span class="n">r</span><span class="p">)</span> <span class="n">d</span>
   <span class="ow">-&gt;</span> <span class="kt">Sem</span> <span class="p">(</span><span class="kt">Boomerang</span> <span class="n">a</span> <span class="n">b</span> <span class="kt">&#39;:</span> <span class="kt">Boomerang</span> <span class="n">b</span> <span class="n">c</span> <span class="kt">&#39;:</span> <span class="n">r</span><span class="p">)</span> <span class="n">d</span>
<span class="nf">runComposeBoomerang</span> <span class="ow">=</span>
    <span class="n">runEffectfulFunction</span> <span class="p">(</span><span class="n">raise</span> <span class="o">.</span> <span class="n">backward</span> <span class="o">@</span><span class="n">b</span> <span class="o">@</span><span class="n">c</span> <span class="o">&gt;=&gt;</span> <span class="n">backward</span> <span class="o">@</span><span class="n">a</span> <span class="o">@</span><span class="n">b</span><span class="p">)</span>
  <span class="o">.</span> <span class="n">runEffectfulFunction</span> <span class="p">(</span><span class="n">forward</span> <span class="o">@</span><span class="n">a</span> <span class="o">@</span><span class="n">b</span> <span class="o">&gt;=&gt;</span> <span class="n">raise</span> <span class="o">.</span> <span class="n">raise</span> <span class="o">.</span> <span class="n">forward</span> <span class="o">@</span><span class="n">b</span> <span class="o">@</span><span class="n">c</span><span class="p">)</span>
  <span class="o">.</span> <span class="n">runBundle</span>
  <span class="o">.</span> <span class="n">rewrite</span> <span class="n">unBoomerang</span>
  <span class="o">.</span> <span class="n">raiseUnder2</span>
</code></pre></div>


<p>See if that works.</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/cf32e348c646a53534a1a022c022bab8528df176?version=3"></a><div class="content"><a class="author">Alex Chapman</a><div class="metadata"><a href="#197206771" name="197206771"><div>2020-05-11 21:26:05</div></a></div><div class="text"><p>Ah yes, that's why <code>subsumeComposeBoomerang</code> requires <code>AllowAmbiguousTypes</code> to compile. It's the same with <code>subsumeCompose</code>. The latter works though, once you give it concrete types to work with.</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/cf32e348c646a53534a1a022c022bab8528df176?version=3"></a><div class="content"><a class="author">Alex Chapman</a><div class="metadata"><a href="#197206807" name="197206807"><div>2020-05-11 21:26:27</div></a></div><div class="text"><p>Yes, your <code>runComposeBoomerang</code> works :)</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/cf32e348c646a53534a1a022c022bab8528df176?version=3"></a><div class="content"><a class="author">Alex Chapman</a><div class="metadata"><a href="#197206842" name="197206842"><div>2020-05-11 21:26:53</div></a></div><div class="text"><p>It took me a while to work out how the <code>raise</code> trick works, but I think I have it now.</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/cf32e348c646a53534a1a022c022bab8528df176?version=3"></a><div class="content"><a class="author">Alex Chapman</a><div class="metadata"><a href="#197206991" name="197206991"><div>2020-05-11 21:28:31</div></a></div><div class="text"><p>I don't see why Haskell can't distinguish between <code>Function a b</code> and <code>Function b a</code> though, at least when using <code>ScopedTypeVariables</code> and <code>TypeApplications</code>.</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/20a04d823b7c3891d78ca5f6a188ccd0e4fc5e3d?version=2"></a><div class="content"><a class="author">TheMatten</a><div class="metadata"><a href="#197237307" name="197237307"><div>2020-05-12 06:19:53</div></a></div><div class="text"><p>It distinguishes between e.g. <code>Function Int Float</code> and <code>Function Float Int</code> of course, but with polymorphic <code>Function a b</code> compiler can't be sure that <code>a ~ b</code> doesn't appear somewhere in the program</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/cf32e348c646a53534a1a022c022bab8528df176?version=3"></a><div class="content"><a class="author">Alex Chapman</a><div class="metadata"><a href="#197238110" name="197238110"><div>2020-05-12 06:37:19</div></a></div><div class="text"><p>Oh, I think I see, because it can't exclude that possibility, it can't exclude using the first effect on the stack.</p></div></div></div></div></div><div class="ui vertical footer segment"><a href="https://github.com/srid/zulip-archive">Powered by Haskell</a> | Questions? Contact <a href="https://www.srid.ca">srid</a></div></div></body></html>