<html lang="en"><head><meta content="text/html; charset=utf-8" http-equiv="Content-Type"><meta content="width=device-width, initial-scale=1" name="viewport"><meta content="I have a record and a FromRow instance for it but when I try to evaluate an action using that query in the REPL it just seems to hang. I&#39;ve tried everything I can think of but maybe I&#39;m missing something? The code, simplified:
-- MyModuleA.hs
data MyRow
  = MyRow
  { _myRowRowId :: UUID
  , _myRowOt" name="description"><link href="https://funprog.srid.ca/haskell/postgresql-simple-hanging-query.html" rel="canonical"><meta property="og:title" content="postgresql-simple hanging query - Haskell"><meta property="og:site_name" content="Functional Programming Zulip Archive"><meta property="og:type" content="article"><meta property="og:article:section" content="Haskell"><meta property="og:article:modified_time" content="2020-01-20T15:47:59Z"><meta property="og:article:published_time" content="2020-01-17T21:35:45Z"><title>postgresql-simple hanging query - Haskell</title><style type="text/css">
div#thesite
{
  font-family   : "Open Sans", sans-serif;
  font-size     : 1em !important;
  margin-top    : 1em;
  margin-bottom : 1em;
}

div#thesite h1
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite h2
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite h3
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite h4
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite h5
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite h6
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite .ui.breadcrumb.rib .section
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite .header
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite .as-header
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite code, pre, tt
{
  font-family : "SFMono-Regular","Menlo","Monaco","Consolas","Liberation Mono","Courier New", monospace;
}

div#thesite .ui.breadcrumb.rib
{
  margin-bottom : 1em;
}



div#thesite .ui.comments.messages .comment .metadata a
{
  color : #808080;
}

div#thesite .ui.comments.messages .comment a.avatar img
{
  height : auto;
}

div#thesite .subtle
{
  color : #808080;
}


div#thesite .messages pre
{
  font-size : 85%;
  overflow  : auto;
  max-width : 100%;
}

div#thesite .messages .message_embed
{
  border-left  : solid 3px #808080;
  padding-left : 0.69999em;
}

div#thesite .messages .message_inline_image img
{
  max-width     : 100%;
  margin-bottom : 1em;
}


/* Generated with Clay, http://fvisser.nl/clay */</style><link href="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.4.1/semantic.min.css" rel="stylesheet"><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/all.min.css" rel="stylesheet"><link href="https://fonts.googleapis.com/css?family=Open+Sans|Oswald&amp;display=swap" rel="stylesheet"><link href="https://fonts.googleapis.com/css?family=Roboto|Open+Sans&amp;display=swap" rel="stylesheet"></head><body><div id="thesite" class="ui text container"><div class="ui violet inverted top attached center aligned segment"><h1 class="ui huge header">postgresql-simple hanging query - Haskell</h1></div><div class="ui attached segment"><div class="ui message"><p>Welcome to the Functional Programming Zulip Chat Archive. You can join the chat <a href="https://funprog.zulipchat.com">here</a>.</p></div><div class="ui breadcrumb rib"><a href="/" class="section">Home</a><i class="right angle icon divider"></i><a href="/haskell/" class="section">#Haskell</a><i class="right angle icon divider"></i><div class="active section">postgresql-simple hanging query</div></div><div class="ui comments messages"><div class="comment"><a class="avatar"><img src="https://www.gravatar.com/avatar/4ba4faf2fc5818d37c0aed6acb5b69a2"></a><div class="content"><a class="author">James King</a><div class="metadata"><a href="#185960186" name="185960186"><div>2020-01-17 21:35:45</div></a></div><div class="text"><p>I have a record and a <code>FromRow</code> instance for it but when I try to evaluate an action using that query in the REPL it just seems to hang. I've tried everything I can think of but maybe I'm missing something? The code, simplified:</p>
<div class="codehilite"><pre><span></span>-- MyModuleA.hs
data MyRow
  = MyRow
  { _myRowRowId :: UUID
  , _myRowOtherId :: UUID
  , _myRowDescription :: Text
  }
  deriving (Eq, Generic, Show)

instance FromRow MyRow where
  fromRow =
    MyRow
    &lt;$&gt; field
    &lt;*&gt; field
    &lt;*&gt; field

-- MyModuleB.hs
getMyRow :: Connection -&gt; MyRowId -&gt; IO (Maybe MyRow)
getMyRow conn rid = do
  r &lt;- query conn
    [sql| select id, other_id, description from my_row where id = ? |] [rid]
  case r of
    [] -&gt; pure $ Nothing
    (r&#39; : _) -&gt; pure $ Just r&#39;
</pre></div>


<p>But in the REPL...</p>
<div class="codehilite"><pre><span></span>Î»\=&gt; r &lt;- getMyRow conn rid
</pre></div>


<p>Just hangs. I'm able to execute other similar IO actions from the REPL, but not this one for some reason. I've tried various incantations of the parameter list, annotations, etc... it's weird. The query works fine in raw SQL.</p></div></div></div><div class="comment"><a class="avatar"><img src="https://www.gravatar.com/avatar/4ba4faf2fc5818d37c0aed6acb5b69a2"></a><div class="content"><a class="author">James King</a><div class="metadata"><a href="#185962522" name="185962522"><div>2020-01-17 22:02:39</div></a></div><div class="text"><p>Hm... it may have to do with one of the fields having a JSON column and the <code>parseJSON</code> failing.</p></div></div></div><div class="comment"><a class="avatar"><img src="https://www.gravatar.com/avatar/4ba4faf2fc5818d37c0aed6acb5b69a2"></a><div class="content"><a class="author">James King</a><div class="metadata"><a href="#186112576" name="186112576"><div>2020-01-20 15:47:07</div></a></div><div class="text"><p>I did narrow this down to the <code>FromRow</code> instance for my type. It can return a value of type <code>Value</code> but it doesn't try to parse that if I try to give the value a type that has a <code>FromJSON</code> instance. Some reason this causes <code>fromRow</code> to hang.</p></div></div></div><div class="comment"><a class="avatar"><img src="https://www.gravatar.com/avatar/4ba4faf2fc5818d37c0aed6acb5b69a2"></a><div class="content"><a class="author">James King</a><div class="metadata"><a href="#186112624" name="186112624"><div>2020-01-20 15:47:59</div></a></div><div class="text"><p>So the lesson here is to get your row and deserialize your JSON values in a separate computation.</p></div></div></div></div></div><div class="ui vertical footer segment"><a href="https://github.com/srid/zulip-archive">Powered by Haskell</a> | Questions? Contact <a href="https://www.srid.ca">srid</a></div></div></body></html>