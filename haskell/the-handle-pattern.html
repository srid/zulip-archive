<html lang="en"><head><meta content="text/html; charset=utf-8" http-equiv="Content-Type"><meta content="width=device-width, initial-scale=1" name="viewport"><meta content="Hello, I recently discovered the handle pattern and it looks too good to be true :) I first tried the mtl style approach with the ReaderT pattern but I find it too difficult to implement custom instances for testing. With the Handle pattern it seems simple to create a new handle with pure functions " name="description"><link href="https://funprog.srid.ca/haskell/the-handle-pattern.html" rel="canonical"><meta property="og:title" content="The Handle Pattern - Haskell"><meta property="og:site_name" content="Functional Programming Zulip Archive"><meta property="og:type" content="article"><meta property="og:article:section" content="Haskell"><meta property="og:article:modified_time" content="2021-01-23T22:13:40Z"><meta property="og:article:published_time" content="2020-09-21T20:24:01Z"><meta property="og:image" content="https://zulip-avatars.s3.amazonaws.com/13896/24b62e7b62bbbc0f4f0617b5ccd66e6f8fe784f6?version=2"><title>The Handle Pattern - Haskell</title><style type="text/css">
div#thesite
{
  font-family   : "Open Sans", sans-serif;
  font-size     : 1em !important;
  margin-top    : 1em;
  margin-bottom : 1em;
}

div#thesite h1
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite h2
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite h3
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite h4
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite h5
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite h6
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite .ui.breadcrumb.rib .section
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite .header
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite .as-header
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite code, pre, tt
{
  font-family : "SFMono-Regular","Menlo","Monaco","Consolas","Liberation Mono","Courier New", monospace;
}

div#thesite .ui.breadcrumb.rib
{
  margin-bottom : 1em;
}



div#thesite .ui.comments.messages .comment .metadata a
{
  color : #808080;
}

div#thesite .ui.comments.messages .comment a.avatar img
{
  height : auto;
}

div#thesite .subtle
{
  color : #808080;
}


div#thesite .messages pre
{
  font-size : 85%;
  overflow  : auto;
  max-width : 100%;
}

div#thesite .messages .message_embed
{
  border-left  : solid 3px #808080;
  padding-left : 0.69999em;
}

div#thesite .messages .message_inline_image img
{
  max-width     : 100%;
  margin-bottom : 1em;
}


/* Generated with Clay, http://fvisser.nl/clay */</style><link href="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.4.1/semantic.min.css" rel="stylesheet"><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/all.min.css" rel="stylesheet"><link href="https://fonts.googleapis.com/css?family=Open+Sans|Oswald&amp;display=swap" rel="stylesheet"><link href="https://fonts.googleapis.com/css?family=Roboto|Open+Sans&amp;display=swap" rel="stylesheet"></head><body><div id="thesite" class="ui text container"><div class="ui violet inverted top attached center aligned segment"><h1 class="ui huge header">The Handle Pattern - Haskell</h1></div><div class="ui attached segment"><div class="ui message"><p>Welcome to the Functional Programming Zulip Chat Archive. You can join the chat <a href="https://funprog.zulipchat.com">here</a>.</p></div><div class="ui breadcrumb rib"><a href="/" class="section">Home</a><i class="right angle icon divider"></i><a href="/haskell/" class="section">#Haskell</a><i class="right angle icon divider"></i><div class="active section">The Handle Pattern</div></div><div class="ui comments messages"><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/24b62e7b62bbbc0f4f0617b5ccd66e6f8fe784f6?version=2"></a><div class="content"><a class="author">tristanC</a><div class="metadata"><a href="#210794900" name="210794900"><div>2020-09-21 20:24:01</div></a></div><div class="text"><p>Hello, I recently discovered the <a href="https://jaspervdj.be/posts/2018-03-08-handle-pattern.html">handle pattern</a> and it looks too good to be true :) I first tried the mtl style approach with the ReaderT pattern but I find it too difficult to implement custom instances for testing. With the Handle pattern it seems simple to create a new handle with pure functions to mock the IOs, without using special extensions or typeclass.</p>
<p>So I am trying this pattern with an application slightly more complicated than i am used to do in Haskell.  I am working on a service to query monitoring alerts, then run custom command and send report to operators over irc... Is this a good design to begin with and would you recommend it?</p></div></div></div><div class="comment"><a class="avatar"><img src="https://www.gravatar.com/avatar/4ba4faf2fc5818d37c0aed6acb5b69a2"></a><div class="content"><a class="author">James King</a><div class="metadata"><a href="#210796901" name="210796901"><div>2020-09-21 20:40:36</div></a></div><div class="text"><p>I don't know how you would measure, "good." If it was me I would be satisfied if it allowed me to update my application as it evolved without too much hassle.</p>
<p>If I'm building a web application and I can change the database serialization code without affecting the route-plumbing code then that's good!</p>
<p>If I end up having to structure my application in highly-coupled ways in order to satisfy the architecture... I find that not-so-good.</p></div></div></div><div class="comment"><a class="avatar"><img src="https://www.gravatar.com/avatar/4ba4faf2fc5818d37c0aed6acb5b69a2"></a><div class="content"><a class="author">James King</a><div class="metadata"><a href="#210797177" name="210797177"><div>2020-09-21 20:42:47</div></a></div><div class="text"><p>If the Handle Pattern works for you, it's probably a good pattern. :)</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/20a04d823b7c3891d78ca5f6a188ccd0e4fc5e3d?version=2"></a><div class="content"><a class="author">TheMatten</a><div class="metadata"><a href="#210833921" name="210833921"><div>2020-09-22 07:02:46</div></a></div><div class="text"><p>I would argue that variant of such approach could actually be treated as full-fledged effect system, and that it isn't really that far of existing ones:<br>
Let's have</p>
<div class="codehilite" data-code-language="Haskell"><pre><span></span><code><span class="kr">data</span> <span class="kt">App</span> <span class="n">m</span> <span class="ow">=</span> <span class="kt">App</span>
  <span class="p">{</span> <span class="n">createUser</span> <span class="ow">::</span> <span class="kt">Text</span> <span class="ow">-&gt;</span> <span class="n">m</span> <span class="kt">User</span>
  <span class="p">,</span> <span class="n">getUserMail</span> <span class="ow">::</span> <span class="kt">User</span> <span class="ow">-&gt;</span> <span class="n">m</span> <span class="p">[</span><span class="kt">Mail</span><span class="p">]</span>
  <span class="p">,</span> <span class="n">log</span> <span class="ow">::</span> <span class="kt">DebugLevel</span> <span class="ow">-&gt;</span> <span class="kt">Text</span> <span class="ow">-&gt;</span> <span class="n">m</span> <span class="nb">()</span>
  <span class="p">,</span> <span class="o">..</span>
  <span class="p">}</span>
</code></pre></div>

<p>Just by parametrizing handle over monad, you "recover purity" by abstracting out <code>IO</code> and easily get injection - you can run your app in mocked environment, multiple alternative environemts (e.g. on client and server) or easily modify or swap final monad if it no longer fits your needs. You simply use it like</p>
<div class="codehilite" data-code-language="Haskell"><pre><span></span><code><span class="nf">foo</span> <span class="ow">::</span> <span class="kt">App</span> <span class="n">m</span> <span class="ow">-&gt;</span> <span class="o">..</span> <span class="ow">-&gt;</span> <span class="n">m</span> <span class="kt">Stuff</span>
<span class="nf">foo</span> <span class="n">h</span> <span class="ow">=</span> <span class="kr">do</span>
  <span class="o">..</span>
  <span class="n">user</span> <span class="ow">&lt;-</span> <span class="n">createUser</span> <span class="n">h</span> <span class="s">"Tristan"</span>
  <span class="n">log</span> <span class="n">h</span> <span class="s">"Created new user"</span>
  <span class="o">..</span>
</code></pre></div>

<p>If your app grows in size and responsibilites of specific parts get more concrete, you can split it's fields into subhandles that you can then pass to specific subparts - this way you get more flexible if those subparts need different set of functionality from their monads.</p>
<p>One cherry on top - with <code>RecordDotSyntax</code> we'll be able to write</p>
<div class="codehilite" data-code-language="Haskell"><pre><span></span><code><span class="nf">h</span><span class="o">.</span><span class="n">createUser</span> <span class="s">"Tristan"</span>
</code></pre></div>

<p>And another one - you can use <code>ImplicitParams</code> to recover implicit handle passing:</p>
<div class="codehilite" data-code-language="Haskell"><pre><span></span><code><span class="kr">type</span> <span class="kt">HasApp</span> <span class="n">m</span> <span class="ow">=</span> <span class="o">?</span><span class="n">app</span> <span class="ow">::</span> <span class="kt">App</span> <span class="n">m</span>

<span class="nf">main</span> <span class="ow">=</span> <span class="kr">let</span> <span class="o">?</span><span class="n">app</span> <span class="ow">=</span> <span class="n">stuff</span> <span class="kr">in</span> <span class="o">..</span>

<span class="nf">foo</span> <span class="ow">::</span> <span class="kt">HasApp</span> <span class="n">m</span> <span class="ow">=&gt;</span> <span class="o">..</span> <span class="ow">-&gt;</span> <span class="n">m</span> <span class="kt">Stuff</span>
<span class="nf">foo</span> <span class="ow">=</span> <span class="kr">do</span>
  <span class="o">..</span>
  <span class="n">user</span> <span class="ow">&lt;-</span> <span class="o">?</span><span class="n">app</span><span class="o">.</span><span class="n">createUser</span> <span class="s">"Tristran"</span>
  <span class="o">?</span><span class="n">app</span><span class="o">.</span><span class="n">log</span> <span class="s">"Created new user"</span>
  <span class="o">..</span>

<span class="nf">bar</span> <span class="ow">::</span> <span class="kt">HasApp</span> <span class="n">m</span> <span class="ow">=&gt;</span> <span class="o">..</span> <span class="ow">-&gt;</span> <span class="n">m</span> <span class="kt">OtherStuff</span>
<span class="nf">bar</span> <span class="ow">=</span> <span class="kr">do</span>
  <span class="o">..</span>
  <span class="n">stuff</span> <span class="ow">&lt;-</span> <span class="n">foo</span> <span class="o">..</span>
  <span class="o">..</span>
</code></pre></div>

<p>All of that without traditional "class mess" <span aria-label="smile" class="emoji emoji-1f642" role="img" title="smile">:smile:</span></p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/7334dc60b6aef6a75cd9284126231f13c76926a5?version=5"></a><div class="content"><a class="author">Torsten Schmits</a><div class="metadata"><a href="#210859835" name="210859835"><div>2020-09-22 12:04:05</div></a></div><div class="text"><p>isn't that tagless final?</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/20a04d823b7c3891d78ca5f6a188ccd0e4fc5e3d?version=2"></a><div class="content"><a class="author">TheMatten</a><div class="metadata"><a href="#210861486" name="210861486"><div>2020-09-22 12:21:31</div></a></div><div class="text"><p>Well, thing is, in Haskell, all "ad-hoc polymorphism" is some sort of "tagless final" at the end <span aria-label="big smile" class="emoji emoji-1f604" role="img" title="big smile">:big_smile:</span></p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/7334dc60b6aef6a75cd9284126231f13c76926a5?version=5"></a><div class="content"><a class="author">Torsten Schmits</a><div class="metadata"><a href="#210861512" name="210861512"><div>2020-09-22 12:21:51</div></a></div><div class="text"><p>right <span aria-label="smile" class="emoji emoji-1f642" role="img" title="smile">:smile:</span></p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/24b62e7b62bbbc0f4f0617b5ccd66e6f8fe784f6?version=2"></a><div class="content"><a class="author">tristanC</a><div class="metadata"><a href="#210867117" name="210867117"><div>2020-09-22 13:09:18</div></a></div><div class="text"><p>Thank you very much for the insightful comments. If I understand correctly, handles are not as fine grained as other effect system, but designing my application with handles works for me so far, and most importantly, it is easy to explain. I also like the consistency of module that exports a common <code>Config</code>, <code>Handle</code> and <code>withHandle</code> api.</p>
<p>Parametrizing the handle over monad looks like a great improvement, thank you for the snippets <span class="user-mention" data-user-id="225127">@TheMatten</span> ! It's also nice to see how <code>ImplicitParams</code> can be used, though I rather avoid using extensions so that i don't have to explain them :-)</p></div></div></div><div class="comment"><a class="avatar"><img src="https://www.gravatar.com/avatar/45175015b9eb3dd3f6c740b3fe920fed"></a><div class="content"><a class="author">Joel McCracken</a><div class="metadata"><a href="#210870956" name="210870956"><div>2020-09-22 13:41:21</div></a></div><div class="text"><p>we're using it. So far i haven't found it to be too annoying</p></div></div></div><div class="comment"><a class="avatar"><img src="https://www.gravatar.com/avatar/45175015b9eb3dd3f6c740b3fe920fed"></a><div class="content"><a class="author">Joel McCracken</a><div class="metadata"><a href="#210871284" name="210871284"><div>2020-09-22 13:43:48</div></a></div><div class="text"><p>which is, i think, the kind of what you hope to have from a thing that is a whole-application infrastructure thing. because as soon as you touch it you're going to be fixing other parts of the codebase which have nothing to do with what you're working on, so guaranteed annoying</p></div></div></div><div class="comment"><a class="avatar"><img src="https://www.gravatar.com/avatar/ab9eda4f7b8c088d2b98539634c62149"></a><div class="content"><a class="author">HateUsernames007</a><div class="metadata"><a href="#223654485" name="223654485"><div>2021-01-22 15:18:55</div></a></div><div class="text"><p><span class="user-mention" data-user-id="282115">@tristanC</span> could you contrast this handle pattern with Polysemy?</p></div></div></div><div class="comment"><a class="avatar"><img src="https://www.gravatar.com/avatar/ab9eda4f7b8c088d2b98539634c62149"></a><div class="content"><a class="author">HateUsernames007</a><div class="metadata"><a href="#223654768" name="223654768"><div>2021-01-22 15:21:04</div></a></div><div class="text"><p><span class="user-mention" data-user-id="252949">@Joel McCracken</span> what would you consider switching to if migration wasn't a problem</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/24b62e7b62bbbc0f4f0617b5ccd66e6f8fe784f6?version=2"></a><div class="content"><a class="author">tristanC</a><div class="metadata"><a href="#223664080" name="223664080"><div>2021-01-22 16:24:25</div></a></div><div class="text"><p><span class="user-mention" data-user-id="268686">@HateUsernames007</span> I'm not very familiar with Polysemy,  but it seems like the handle pattern is simpler (e.g. it does not requiresextensions or complex types), and I guess Polysemy enables more ergonomic composition by using type constrain instead of explicit arguments?</p></div></div></div><div class="comment"><a class="avatar"><img src="https://www.gravatar.com/avatar/45175015b9eb3dd3f6c740b3fe920fed"></a><div class="content"><a class="author">Joel McCracken</a><div class="metadata"><a href="#223687206" name="223687206"><div>2021-01-22 19:29:19</div></a></div><div class="text"><p>well since I wrote this we actually kinda switched to MTL style stubbing, but its not a pure one or the other.</p></div></div></div><div class="comment"><a class="avatar"><img src="https://www.gravatar.com/avatar/45175015b9eb3dd3f6c740b3fe920fed"></a><div class="content"><a class="author">Joel McCracken</a><div class="metadata"><a href="#223687217" name="223687217"><div>2021-01-22 19:29:24</div></a></div><div class="text"><p>and I am happy with this.</p></div></div></div><div class="comment"><a class="avatar"><img src="https://www.gravatar.com/avatar/ab9eda4f7b8c088d2b98539634c62149"></a><div class="content"><a class="author">HateUsernames007</a><div class="metadata"><a href="#223752892" name="223752892"><div>2021-01-23 14:44:37</div></a></div><div class="text"><p><span class="user-mention" data-user-id="282115">@tristanC</span> There is a good tutorial that explains the workings quite well <a href="https://archive.vn/wip/fWVFR">https://archive.vn/wip/fWVFR</a> . Yes it does require many extensions that you need to be familiar with, but with a experienced programmer designing the structure I think a novice would be able to jump in and and changes even if they do not understand all of it. Lastly, I do like how it uses constraints so that the code is far more modular and not dependent on the central Handle type, are you able to easily swap handles for tests or sharing between apps?</p></div></div></div><div class="comment"><a class="avatar"><img src="https://www.gravatar.com/avatar/ab9eda4f7b8c088d2b98539634c62149"></a><div class="content"><a class="author">HateUsernames007</a><div class="metadata"><a href="#223752973" name="223752973"><div>2021-01-23 14:46:41</div></a></div><div class="text"><p><span class="user-mention" data-user-id="252949">@Joel McCracken</span> so you are still using the handle but using  MTL constraints for your function types?</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/24b62e7b62bbbc0f4f0617b5ccd66e6f8fe784f6?version=2"></a><div class="content"><a class="author">tristanC</a><div class="metadata"><a href="#223754862" name="223754862"><div>2021-01-23 15:28:30</div></a></div><div class="text"><p><span class="user-mention" data-user-id="268686">@HateUsernames007</span> thank you for the tutorial, effect systems like polysemy do look nice, but as you said, it requires experience... With the handle pattern, i'm passing the dependency explicitly and it is quite simple to create mock in tests.</p></div></div></div><div class="comment"><a class="avatar"><img src="https://www.gravatar.com/avatar/ab9eda4f7b8c088d2b98539634c62149"></a><div class="content"><a class="author">HateUsernames007</a><div class="metadata"><a href="#223755134" name="223755134"><div>2021-01-23 15:34:11</div></a></div><div class="text"><p>Too many options in life. Thanks for the explanations. I'll look into handles more</p></div></div></div><div class="comment"><a class="avatar"><img src="https://www.gravatar.com/avatar/45175015b9eb3dd3f6c740b3fe920fed"></a><div class="content"><a class="author">Joel McCracken</a><div class="metadata"><a href="#223757508" name="223757508"><div>2021-01-23 16:26:43</div></a></div><div class="text"><p>We still have the handle pattern in part of the application, but now when we need to "stub" I/O we are reaching for MTL instead, which lets us keep the signatures smaller and more focused</p></div></div></div><div class="comment"><a class="avatar"><img src="https://www.gravatar.com/avatar/45175015b9eb3dd3f6c740b3fe920fed"></a><div class="content"><a class="author">Joel McCracken</a><div class="metadata"><a href="#223758017" name="223758017"><div>2021-01-23 16:37:42</div></a></div><div class="text"><p>Are you trying to come up with something to use for your own project?</p></div></div></div><div class="comment"><a class="avatar"><img src="https://www.gravatar.com/avatar/d5f51e76392d18898a66faf360be0416"></a><div class="content"><a class="author">Daniel Díaz Carrete</a><div class="metadata"><a href="#223780958" name="223780958"><div>2021-01-23 22:13:40</div></a></div><div class="text"><p>fwiw, I've recently released two packages "dep-t" and "dep-t-advice" for working with the ReaderT / record-of-functions / handle pattern <a href="http://hackage.haskell.org/package/dep-t">http://hackage.haskell.org/package/dep-t</a> <a href="http://hackage.haskell.org/package/dep-t-advice">http://hackage.haskell.org/package/dep-t-advice</a></p></div></div></div></div></div><div class="ui vertical footer segment"><a href="https://github.com/srid/zulip-archive">Powered by Haskell</a> | Questions? Contact <a href="https://www.srid.ca">srid</a></div></div></body></html>