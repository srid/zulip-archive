<html lang="en"><head><meta content="text/html; charset=utf-8" http-equiv="Content-Type"><meta content="width=device-width, initial-scale=1" name="viewport"><meta content="Hello, I recently discovered the handle pattern and it looks too good to be true :) I first tried the mtl style approach with the ReaderT pattern but I find it too difficult to implement custom instances for testing. With the Handle pattern it seems simple to create a new handle with pure functions " name="description"><link href="https://funprog.srid.ca/haskell/the-handle-pattern.html" rel="canonical"><meta property="og:title" content="The Handle Pattern - Haskell"><meta property="og:site_name" content="Functional Programming Zulip Archive"><meta property="og:type" content="article"><meta property="og:article:section" content="Haskell"><meta property="og:article:modified_time" content="2020-09-22T13:43:48Z"><meta property="og:article:published_time" content="2020-09-21T20:24:01Z"><meta property="og:image" content="https://secure.gravatar.com/avatar/49728c9821ae019b34ffedde4f758018?d=identicon&amp;version=1"><title>The Handle Pattern - Haskell</title><style type="text/css">
div#thesite
{
  font-family   : "Open Sans", sans-serif;
  font-size     : 1em !important;
  margin-top    : 1em;
  margin-bottom : 1em;
}

div#thesite h1
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite h2
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite h3
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite h4
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite h5
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite h6
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite .ui.breadcrumb.rib .section
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite .header
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite .as-header
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite code, pre, tt
{
  font-family : "SFMono-Regular","Menlo","Monaco","Consolas","Liberation Mono","Courier New", monospace;
}

div#thesite .ui.breadcrumb.rib
{
  margin-bottom : 1em;
}



div#thesite .ui.comments.messages .comment .metadata a
{
  color : #808080;
}

div#thesite .ui.comments.messages .comment a.avatar img
{
  height : auto;
}

div#thesite .subtle
{
  color : #808080;
}


div#thesite .messages pre
{
  font-size : 85%;
  overflow  : auto;
  max-width : 100%;
}

div#thesite .messages .message_embed
{
  border-left  : solid 3px #808080;
  padding-left : 0.69999em;
}

div#thesite .messages .message_inline_image img
{
  max-width     : 100%;
  margin-bottom : 1em;
}


/* Generated with Clay, http://fvisser.nl/clay */</style><link href="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.4.1/semantic.min.css" rel="stylesheet"><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/all.min.css" rel="stylesheet"><link href="https://fonts.googleapis.com/css?family=Open+Sans|Oswald&amp;display=swap" rel="stylesheet"><link href="https://fonts.googleapis.com/css?family=Roboto|Open+Sans&amp;display=swap" rel="stylesheet"></head><body><div id="thesite" class="ui text container"><div class="ui violet inverted top attached center aligned segment"><h1 class="ui huge header">The Handle Pattern - Haskell</h1></div><div class="ui attached segment"><div class="ui message"><p>Welcome to the Functional Programming Zulip Chat Archive. You can join the chat <a href="https://funprog.zulipchat.com">here</a>.</p></div><div class="ui breadcrumb rib"><a href="/" class="section">Home</a><i class="right angle icon divider"></i><a href="/haskell/" class="section">#Haskell</a><i class="right angle icon divider"></i><div class="active section">The Handle Pattern</div></div><div class="ui comments messages"><div class="comment"><a class="avatar"><img src="https://secure.gravatar.com/avatar/49728c9821ae019b34ffedde4f758018?d=identicon&amp;version=1"></a><div class="content"><a class="author">tristanC</a><div class="metadata"><a href="#210794900" name="210794900"><div>2020-09-21 20:24:01</div></a></div><div class="text"><p>Hello, I recently discovered the <a href="https://jaspervdj.be/posts/2018-03-08-handle-pattern.html">handle pattern</a> and it looks too good to be true :) I first tried the mtl style approach with the ReaderT pattern but I find it too difficult to implement custom instances for testing. With the Handle pattern it seems simple to create a new handle with pure functions to mock the IOs, without using special extensions or typeclass.</p>
<p>So I am trying this pattern with an application slightly more complicated than i am used to do in Haskell.  I am working on a service to query monitoring alerts, then run custom command and send report to operators over irc... Is this a good design to begin with and would you recommend it?</p></div></div></div><div class="comment"><a class="avatar"><img src="https://secure.gravatar.com/avatar/4ba4faf2fc5818d37c0aed6acb5b69a2?d=identicon&amp;version=1"></a><div class="content"><a class="author">James King</a><div class="metadata"><a href="#210796901" name="210796901"><div>2020-09-21 20:40:36</div></a></div><div class="text"><p>I don't know how you would measure, "good." If it was me I would be satisfied if it allowed me to update my application as it evolved without too much hassle.</p>
<p>If I'm building a web application and I can change the database serialization code without affecting the route-plumbing code then that's good!</p>
<p>If I end up having to structure my application in highly-coupled ways in order to satisfy the architecture... I find that not-so-good.</p></div></div></div><div class="comment"><a class="avatar"><img src="https://secure.gravatar.com/avatar/4ba4faf2fc5818d37c0aed6acb5b69a2?d=identicon&amp;version=1"></a><div class="content"><a class="author">James King</a><div class="metadata"><a href="#210797177" name="210797177"><div>2020-09-21 20:42:47</div></a></div><div class="text"><p>If the Handle Pattern works for you, it's probably a good pattern. :)</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/20a04d823b7c3891d78ca5f6a188ccd0e4fc5e3d?x=x&amp;version=2"></a><div class="content"><a class="author">TheMatten</a><div class="metadata"><a href="#210833921" name="210833921"><div>2020-09-22 07:02:46</div></a></div><div class="text"><p>I would argue that variant of such approach could actually be treated as full-fledged effect system, and that it isn't really that far of existing ones:<br>
Let's have</p>
<div class="codehilite" data-code-language="Haskell"><pre><span></span><code><span class="kr">data</span> <span class="kt">App</span> <span class="n">m</span> <span class="ow">=</span> <span class="kt">App</span>
  <span class="p">{</span> <span class="n">createUser</span> <span class="ow">::</span> <span class="kt">Text</span> <span class="ow">-&gt;</span> <span class="n">m</span> <span class="kt">User</span>
  <span class="p">,</span> <span class="n">getUserMail</span> <span class="ow">::</span> <span class="kt">User</span> <span class="ow">-&gt;</span> <span class="n">m</span> <span class="p">[</span><span class="kt">Mail</span><span class="p">]</span>
  <span class="p">,</span> <span class="n">log</span> <span class="ow">::</span> <span class="kt">DebugLevel</span> <span class="ow">-&gt;</span> <span class="kt">Text</span> <span class="ow">-&gt;</span> <span class="n">m</span> <span class="nb">()</span>
  <span class="p">,</span> <span class="o">..</span>
  <span class="p">}</span>
</code></pre></div>

<p>Just by parametrizing handle over monad, you "recover purity" by abstracting out <code>IO</code> and easily get injection - you can run your app in mocked environment, multiple alternative environemts (e.g. on client and server) or easily modify or swap final monad if it no longer fits your needs. You simply use it like</p>
<div class="codehilite" data-code-language="Haskell"><pre><span></span><code><span class="nf">foo</span> <span class="ow">::</span> <span class="kt">App</span> <span class="n">m</span> <span class="ow">-&gt;</span> <span class="o">..</span> <span class="ow">-&gt;</span> <span class="n">m</span> <span class="kt">Stuff</span>
<span class="nf">foo</span> <span class="n">h</span> <span class="ow">=</span> <span class="kr">do</span>
  <span class="o">..</span>
  <span class="n">user</span> <span class="ow">&lt;-</span> <span class="n">createUser</span> <span class="n">h</span> <span class="s">"Tristan"</span>
  <span class="n">log</span> <span class="n">h</span> <span class="s">"Created new user"</span>
  <span class="o">..</span>
</code></pre></div>

<p>If your app grows in size and responsibilites of specific parts get more concrete, you can split it's fields into subhandles that you can then pass to specific subparts - this way you get more flexible if those subparts need different set of functionality from their monads.</p>
<p>One cherry on top - with <code>RecordDotSyntax</code> we'll be able to write</p>
<div class="codehilite" data-code-language="Haskell"><pre><span></span><code><span class="nf">h</span><span class="o">.</span><span class="n">createUser</span> <span class="s">"Tristan"</span>
</code></pre></div>

<p>And another one - you can use <code>ImplicitParams</code> to recover implicit handle passing:</p>
<div class="codehilite" data-code-language="Haskell"><pre><span></span><code><span class="kr">type</span> <span class="kt">HasApp</span> <span class="n">m</span> <span class="ow">=</span> <span class="o">?</span><span class="n">app</span> <span class="ow">::</span> <span class="kt">App</span> <span class="n">m</span>

<span class="nf">main</span> <span class="ow">=</span> <span class="kr">let</span> <span class="o">?</span><span class="n">app</span> <span class="ow">=</span> <span class="n">stuff</span> <span class="kr">in</span> <span class="o">..</span>

<span class="nf">foo</span> <span class="ow">::</span> <span class="kt">HasApp</span> <span class="n">m</span> <span class="ow">=&gt;</span> <span class="o">..</span> <span class="ow">-&gt;</span> <span class="n">m</span> <span class="kt">Stuff</span>
<span class="nf">foo</span> <span class="ow">=</span> <span class="kr">do</span>
  <span class="o">..</span>
  <span class="n">user</span> <span class="ow">&lt;-</span> <span class="o">?</span><span class="n">app</span><span class="o">.</span><span class="n">createUser</span> <span class="s">"Tristran"</span>
  <span class="o">?</span><span class="n">app</span><span class="o">.</span><span class="n">log</span> <span class="s">"Created new user"</span>
  <span class="o">..</span>

<span class="nf">bar</span> <span class="ow">::</span> <span class="kt">HasApp</span> <span class="n">m</span> <span class="ow">=&gt;</span> <span class="o">..</span> <span class="ow">-&gt;</span> <span class="n">m</span> <span class="kt">OtherStuff</span>
<span class="nf">bar</span> <span class="ow">=</span> <span class="kr">do</span>
  <span class="o">..</span>
  <span class="n">stuff</span> <span class="ow">&lt;-</span> <span class="n">foo</span> <span class="o">..</span>
  <span class="o">..</span>
</code></pre></div>

<p>All of that without traditional "class mess" <span aria-label="smile" class="emoji emoji-1f642" role="img" title="smile">:smile:</span></p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/7334dc60b6aef6a75cd9284126231f13c76926a5?x=x&amp;version=3"></a><div class="content"><a class="author">Torsten Schmits</a><div class="metadata"><a href="#210859835" name="210859835"><div>2020-09-22 12:04:05</div></a></div><div class="text"><p>isn't that tagless final?</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/20a04d823b7c3891d78ca5f6a188ccd0e4fc5e3d?x=x&amp;version=2"></a><div class="content"><a class="author">TheMatten</a><div class="metadata"><a href="#210861486" name="210861486"><div>2020-09-22 12:21:31</div></a></div><div class="text"><p>Well, thing is, in Haskell, all "ad-hoc polymorphism" is some sort of "tagless final" at the end <span aria-label="big smile" class="emoji emoji-1f604" role="img" title="big smile">:big_smile:</span></p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/7334dc60b6aef6a75cd9284126231f13c76926a5?x=x&amp;version=3"></a><div class="content"><a class="author">Torsten Schmits</a><div class="metadata"><a href="#210861512" name="210861512"><div>2020-09-22 12:21:51</div></a></div><div class="text"><p>right <span aria-label="smile" class="emoji emoji-1f642" role="img" title="smile">:smile:</span></p></div></div></div><div class="comment"><a class="avatar"><img src="https://secure.gravatar.com/avatar/49728c9821ae019b34ffedde4f758018?d=identicon&amp;version=1"></a><div class="content"><a class="author">tristanC</a><div class="metadata"><a href="#210867117" name="210867117"><div>2020-09-22 13:09:18</div></a></div><div class="text"><p>Thank you very much for the insightful comments. If I understand correctly, handles are not as fine grained as other effect system, but designing my application with handles works for me so far, and most importantly, it is easy to explain. I also like the consistency of module that exports a common <code>Config</code>, <code>Handle</code> and <code>withHandle</code> api.</p>
<p>Parametrizing the handle over monad looks like a great improvement, thank you for the snippets <span class="user-mention" data-user-id="225127">@TheMatten</span> ! It's also nice to see how <code>ImplicitParams</code> can be used, though I rather avoid using extensions so that i don't have to explain them :-)</p></div></div></div><div class="comment"><a class="avatar"><img src="https://secure.gravatar.com/avatar/45175015b9eb3dd3f6c740b3fe920fed?d=identicon&amp;version=1"></a><div class="content"><a class="author">Joel McCracken</a><div class="metadata"><a href="#210870956" name="210870956"><div>2020-09-22 13:41:21</div></a></div><div class="text"><p>we're using it. So far i haven't found it to be too annoying</p></div></div></div><div class="comment"><a class="avatar"><img src="https://secure.gravatar.com/avatar/45175015b9eb3dd3f6c740b3fe920fed?d=identicon&amp;version=1"></a><div class="content"><a class="author">Joel McCracken</a><div class="metadata"><a href="#210871284" name="210871284"><div>2020-09-22 13:43:48</div></a></div><div class="text"><p>which is, i think, the kind of what you hope to have from a thing that is a whole-application infrastructure thing. because as soon as you touch it you're going to be fixing other parts of the codebase which have nothing to do with what you're working on, so guaranteed annoying</p></div></div></div></div></div><div class="ui vertical footer segment"><a href="https://github.com/srid/zulip-archive">Powered by Haskell</a> | Questions? Contact <a href="https://www.srid.ca">srid</a></div></div></body></html>