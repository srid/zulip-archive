<html lang="en"><head><meta content="text/html; charset=utf-8" http-equiv="Content-Type"><meta content="width=device-width, initial-scale=1" name="viewport"><meta content="{-# LANGUAGE DeriveFunctor #-}
{-# LANGUAGE TemplateHaskell #-}
{-# OPTIONS_GHC -F -pgmF=record-dot-preprocessor #-}

-- | Simple type-safe I18n.
--
-- Create strings using:
--
--    let s = tt (en &quot;Hello&quot; &gt;&gt; fr &quot;Bonjour&quot;)
--
-- Use them as:
--
--    ttVal FR s
module Ema.I18n where

import Control." name="description"><link href="https://funprog.srid.ca/haskell/poor-mans-type-safe-i18n.html" rel="canonical"><meta property="og:title" content="Poor man&#39;s type-safe I18n - Haskell"><meta property="og:site_name" content="Functional Programming Zulip Archive"><meta property="og:type" content="article"><meta property="og:article:section" content="Haskell"><meta property="og:article:modified_time" content="2021-04-19T15:17:33Z"><meta property="og:article:published_time" content="2021-03-31T20:50:56Z"><meta property="og:image" content="https://zulip-avatars.s3.amazonaws.com/13896/4429aa8b689608f24a4ad712843ce29862e330d2?x=x&amp;version=2"><title>Poor man&#39;s type-safe I18n - Haskell</title><style type="text/css">
div#thesite
{
  font-family   : "Open Sans", sans-serif;
  font-size     : 1em !important;
  margin-top    : 1em;
  margin-bottom : 1em;
}

div#thesite h1
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite h2
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite h3
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite h4
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite h5
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite h6
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite .ui.breadcrumb.rib .section
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite .header
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite .as-header
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite code, pre, tt
{
  font-family : "SFMono-Regular","Menlo","Monaco","Consolas","Liberation Mono","Courier New", monospace;
}

div#thesite .ui.breadcrumb.rib
{
  margin-bottom : 1em;
}



div#thesite .ui.comments.messages .comment .metadata a
{
  color : #808080;
}

div#thesite .ui.comments.messages .comment a.avatar img
{
  height : auto;
}

div#thesite .subtle
{
  color : #808080;
}


div#thesite .messages pre
{
  font-size : 85%;
  overflow  : auto;
  max-width : 100%;
}

div#thesite .messages .message_embed
{
  border-left  : solid 3px #808080;
  padding-left : 0.69999em;
}

div#thesite .messages .message_inline_image img
{
  max-width     : 100%;
  margin-bottom : 1em;
}


/* Generated with Clay, http://fvisser.nl/clay */</style><link href="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.4.1/semantic.min.css" rel="stylesheet"><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/all.min.css" rel="stylesheet"><link href="https://fonts.googleapis.com/css?family=Open+Sans|Oswald&amp;display=swap" rel="stylesheet"><link href="https://fonts.googleapis.com/css?family=Roboto|Open+Sans&amp;display=swap" rel="stylesheet"></head><body><div id="thesite" class="ui text container"><div class="ui violet inverted top attached center aligned segment"><h1 class="ui huge header">Poor man&#39;s type-safe I18n - Haskell</h1></div><div class="ui attached segment"><div class="ui message"><p>Welcome to the Functional Programming Zulip Chat Archive. You can join the chat <a href="https://funprog.zulipchat.com">here</a>.</p></div><div class="ui breadcrumb rib"><a href="/" class="section">Home</a><i class="right angle icon divider"></i><a href="/haskell/" class="section">#Haskell</a><i class="right angle icon divider"></i><div class="active section">Poor man&#39;s type-safe I18n</div></div><div class="ui comments messages"><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/4429aa8b689608f24a4ad712843ce29862e330d2?x=x&amp;version=2"></a><div class="content"><a class="author">Sridhar Ratnakumar</a><div class="metadata"><a href="#232663060" name="232663060"><div>2021-03-31 20:50:56</div></a></div><div class="text"><div class="codehilite" data-code-language="Haskell"><pre><span></span><code><span class="cm">{-# LANGUAGE DeriveFunctor #-}</span>
<span class="cm">{-# LANGUAGE TemplateHaskell #-}</span>
<span class="cm">{-# OPTIONS_GHC -F -pgmF=record-dot-preprocessor #-}</span>

<span class="c1">-- | Simple type-safe I18n.</span>
<span class="c1">--</span>
<span class="c1">-- Create strings using:</span>
<span class="c1">--</span>
<span class="c1">--    let s = tt (en "Hello" &gt;&gt; fr "Bonjour")</span>
<span class="c1">--</span>
<span class="c1">-- Use them as:</span>
<span class="c1">--</span>
<span class="c1">--    ttVal FR s</span>
<span class="kr">module</span> <span class="nn">Ema.I18n</span> <span class="kr">where</span>

<span class="kr">import</span> <span class="nn">Control.Monad.Free</span>
<span class="kr">import</span> <span class="nn">Control.Monad.Free.TH</span>
<span class="kr">import</span> <span class="nn">Data.Default</span>
<span class="kr">import</span> <span class="k">qualified</span> <span class="nn">Data.Map.Strict</span> <span class="k">as</span> <span class="n">Map</span>

<span class="kr">data</span> <span class="kt">Lang</span>
  <span class="ow">=</span> <span class="kt">FR</span>
  <span class="o">|</span> <span class="kt">EN</span>
  <span class="kr">deriving</span> <span class="p">(</span><span class="kt">Eq</span><span class="p">,</span> <span class="kt">Show</span><span class="p">,</span> <span class="kt">Ord</span><span class="p">,</span> <span class="kt">Enum</span><span class="p">,</span> <span class="kt">Bounded</span><span class="p">)</span>

<span class="c1">-- | The default language must always be specified. Other languages are optional.</span>
<span class="kr">instance</span> <span class="kt">Default</span> <span class="kt">Lang</span> <span class="kr">where</span>
  <span class="n">def</span> <span class="ow">=</span> <span class="kt">EN</span>

<span class="kr">data</span> <span class="kt">TranslatedText</span> <span class="ow">=</span> <span class="kt">TranslatedText</span>
  <span class="p">{</span> <span class="n">default_</span> <span class="ow">::</span> <span class="kt">Text</span><span class="p">,</span>
    <span class="n">others</span> <span class="ow">::</span> <span class="kt">Map</span> <span class="kt">Lang</span> <span class="kt">Text</span>
  <span class="p">}</span>

<span class="nf">ttVal</span> <span class="ow">::</span> <span class="kt">IsString</span> <span class="n">a</span> <span class="ow">=&gt;</span> <span class="kt">Lang</span> <span class="ow">-&gt;</span> <span class="kt">TranslatedText</span> <span class="ow">-&gt;</span> <span class="n">a</span>
<span class="nf">ttVal</span> <span class="n">l</span> <span class="ow">=</span>
  <span class="n">fromString</span> <span class="o">.</span> <span class="n">toString</span> <span class="o">.</span> <span class="n">getTranslatedText</span>
  <span class="kr">where</span>
    <span class="n">getTranslatedText</span> <span class="ow">::</span> <span class="kt">TranslatedText</span> <span class="ow">-&gt;</span> <span class="kt">Text</span>
    <span class="n">getTranslatedText</span> <span class="n">tt</span> <span class="ow">=</span>
      <span class="n">fromMaybe</span> <span class="n">tt</span><span class="o">.</span><span class="n">default_</span> <span class="o">$</span> <span class="kr">do</span>
        <span class="n">guard</span> <span class="o">$</span> <span class="n">l</span> <span class="o">/=</span> <span class="n">def</span>
        <span class="kt">Map</span><span class="o">.</span><span class="n">lookup</span> <span class="n">l</span> <span class="n">tt</span><span class="o">.</span><span class="n">others</span>

<span class="c1">-- | Free monad interpreter to build a map of translations whilst ensuring that</span>
<span class="c1">-- the default language is always specified. use `tt` to run the interpreter.</span>
<span class="kr">data</span> <span class="kt">TT</span> <span class="n">a</span>
  <span class="ow">=</span> <span class="kt">Ecrit</span> <span class="kt">Lang</span> <span class="kt">Text</span> <span class="n">a</span>
  <span class="kr">deriving</span> <span class="p">(</span><span class="kt">Functor</span><span class="p">)</span>

<span class="o">$</span><span class="p">(</span><span class="n">makeFree</span> <span class="kt">''TT</span><span class="p">)</span>

<span class="nf">en</span> <span class="ow">::</span> <span class="kt">MonadFree</span> <span class="kt">TT</span> <span class="n">m</span> <span class="ow">=&gt;</span> <span class="kt">Text</span> <span class="ow">-&gt;</span> <span class="n">m</span> <span class="nb">()</span>
<span class="nf">en</span> <span class="ow">=</span> <span class="n">ecrit</span> <span class="kt">EN</span>

<span class="nf">fr</span> <span class="ow">::</span> <span class="kt">MonadFree</span> <span class="kt">TT</span> <span class="n">m</span> <span class="ow">=&gt;</span> <span class="kt">Text</span> <span class="ow">-&gt;</span> <span class="n">m</span> <span class="nb">()</span>
<span class="nf">fr</span> <span class="ow">=</span> <span class="n">ecrit</span> <span class="kt">FR</span>

<span class="nf">tt</span> <span class="ow">::</span> <span class="kt">HasCallStack</span> <span class="ow">=&gt;</span> <span class="kt">Free</span> <span class="kt">TT</span> <span class="nb">()</span> <span class="ow">-&gt;</span> <span class="kt">TranslatedText</span>
<span class="nf">tt</span> <span class="n">program</span> <span class="ow">=</span>
  <span class="kr">let</span> <span class="n">m</span> <span class="ow">=</span> <span class="n">snd</span> <span class="o">$</span> <span class="n">flip</span> <span class="n">runState</span> <span class="n">mempty</span> <span class="o">$</span> <span class="n">run</span> <span class="p">`</span><span class="n">iterM</span><span class="p">`</span> <span class="n">program</span>
   <span class="kr">in</span> <span class="kr">case</span> <span class="kt">Map</span><span class="o">.</span><span class="n">lookup</span> <span class="n">def</span> <span class="n">m</span> <span class="kr">of</span>
        <span class="kt">Nothing</span> <span class="ow">-&gt;</span> <span class="ne">error</span> <span class="o">$</span> <span class="s">"You must specify the default language ("</span> <span class="o">&lt;&gt;</span> <span class="n">show</span> <span class="p">(</span><span class="n">def</span> <span class="ow">::</span> <span class="kt">Lang</span><span class="p">)</span> <span class="o">&lt;&gt;</span> <span class="s">")"</span>
        <span class="kt">Just</span> <span class="n">s</span> <span class="ow">-&gt;</span> <span class="kt">TranslatedText</span> <span class="n">s</span> <span class="n">m</span>
  <span class="kr">where</span>
    <span class="n">run</span> <span class="ow">::</span> <span class="n">forall</span> <span class="n">m</span><span class="o">.</span> <span class="kt">MonadState</span> <span class="p">(</span><span class="kt">Map</span> <span class="kt">Lang</span> <span class="kt">Text</span><span class="p">)</span> <span class="n">m</span> <span class="ow">=&gt;</span> <span class="kt">TT</span> <span class="p">(</span><span class="n">m</span> <span class="nb">()</span><span class="p">)</span> <span class="ow">-&gt;</span> <span class="n">m</span> <span class="nb">()</span>
    <span class="n">run</span> <span class="p">(</span><span class="kt">Ecrit</span> <span class="n">lang</span> <span class="n">s</span> <span class="n">next</span><span class="p">)</span> <span class="ow">=</span> <span class="kr">do</span>
      <span class="n">modify</span> <span class="p">(</span><span class="kt">Map</span><span class="o">.</span><span class="n">insert</span> <span class="n">lang</span> <span class="n">s</span><span class="p">)</span>
      <span class="n">next</span>
</code></pre></div></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/4429aa8b689608f24a4ad712843ce29862e330d2?x=x&amp;version=2"></a><div class="content"><a class="author">Sridhar Ratnakumar</a><div class="metadata"><a href="#232663090" name="232663090"><div>2021-03-31 20:51:14</div></a></div><div class="text"><p>Uses free monad to provide a compact syntax for creating strings with translations.</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/4429aa8b689608f24a4ad712843ce29862e330d2?x=x&amp;version=2"></a><div class="content"><a class="author">Sridhar Ratnakumar</a><div class="metadata"><a href="#232663101" name="232663101"><div>2021-03-31 20:51:21</div></a></div><div class="text"><p>I wonder ... if it can be made better in someway?</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/67dba8dccee74946586f0fa81945a7ce22dc273b?x=x&amp;version=2"></a><div class="content"><a class="author">Mats Rauhala</a><div class="metadata"><a href="#235193426" name="235193426"><div>2021-04-19 14:52:22</div></a></div><div class="text"><p>That's a neat idea, but real I18n systems do a lot more than just replace a constant string with another. Like how to handle plurals: <a href="https://www.gnu.org/software/gettext/manual/html_node/Plural-forms.html">https://www.gnu.org/software/gettext/manual/html_node/Plural-forms.html</a></p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/67dba8dccee74946586f0fa81945a7ce22dc273b?x=x&amp;version=2"></a><div class="content"><a class="author">Mats Rauhala</a><div class="metadata"><a href="#235193891" name="235193891"><div>2021-04-19 14:55:26</div></a></div><div class="text"><p>Though, since it is a free monad, one might be able to add more features to it, without losing too much usability.</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/67dba8dccee74946586f0fa81945a7ce22dc273b?x=x&amp;version=2"></a><div class="content"><a class="author">Mats Rauhala</a><div class="metadata"><a href="#235194022" name="235194022"><div>2021-04-19 14:56:13</div></a></div><div class="text"><p>Instead of using a Text, use some kind of ast?</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/67dba8dccee74946586f0fa81945a7ce22dc273b?x=x&amp;version=2"></a><div class="content"><a class="author">Mats Rauhala</a><div class="metadata"><a href="#235198201" name="235198201"><div>2021-04-19 15:15:00</div></a></div><div class="text"><p>Also, instead of evaluating the final string on each call site, it would be nice to do it once when you're unwrapping your monad stack</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/67dba8dccee74946586f0fa81945a7ce22dc273b?x=x&amp;version=2"></a><div class="content"><a class="author">Mats Rauhala</a><div class="metadata"><a href="#235198779" name="235198779"><div>2021-04-19 15:17:33</div></a></div><div class="text"><p>Maybe, instead of having the translations to be monads, maybe have it be the interpreter for your ast, where the realized interpreter is chosen by the locale and provided by your monad stack</p></div></div></div></div></div><div class="ui vertical footer segment"><a href="https://github.com/srid/zulip-archive">Powered by Haskell</a> | Questions? Contact <a href="https://www.srid.ca">srid</a></div></div></body></html>