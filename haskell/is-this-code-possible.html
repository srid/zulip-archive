<html lang="en"><head><meta content="text/html; charset=utf-8" http-equiv="Content-Type"><meta content="width=device-width, initial-scale=1" name="viewport"><meta content="Is there anyway to get the isAuthorized&#39; function to work?
import           Data.Kind                      ( Constraint
                                                , Type
                                                )
import           Data.Proxy                     ( Proxy(..) )

class IsAuth" name="description"><link href="https://funprog.srid.ca/haskell/is-this-code-possible.html" rel="canonical"><meta property="og:title" content="Is this code possible? - Haskell"><meta property="og:site_name" content="Functional Programming Zulip Archive"><meta property="og:type" content="article"><meta property="og:article:section" content="Haskell"><meta property="og:article:modified_time" content="2019-12-29T18:57:42Z"><meta property="og:article:published_time" content="2019-12-29T07:40:22Z"><title>Is this code possible? - Haskell</title><style type="text/css">
div#thesite
{
  font-family   : "Open Sans", sans-serif;
  font-size     : 1em !important;
  margin-top    : 1em;
  margin-bottom : 1em;
}

div#thesite h1
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite h2
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite h3
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite h4
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite h5
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite h6
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite .ui.breadcrumb.rib .section
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite .header
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite .as-header
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite code, pre, tt
{
  font-family : "SFMono-Regular","Menlo","Monaco","Consolas","Liberation Mono","Courier New", monospace;
}

div#thesite .ui.breadcrumb.rib
{
  margin-bottom : 1em;
}



div#thesite .ui.comments.messages .comment .metadata a
{
  color : #808080;
}

div#thesite .ui.comments.messages .comment a.avatar img
{
  height : auto;
}

div#thesite .subtle
{
  color : #808080;
}


div#thesite .messages pre
{
  font-size : 85%;
  overflow  : auto;
  max-width : 100%;
}

div#thesite .messages .message_embed
{
  border-left  : solid 3px #808080;
  padding-left : 0.69999em;
}

div#thesite .messages .message_inline_image img
{
  max-width     : 100%;
  margin-bottom : 1em;
}


/* Generated with Clay, http://fvisser.nl/clay */</style><link href="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.4.1/semantic.min.css" rel="stylesheet"><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/all.min.css" rel="stylesheet"><link href="https://fonts.googleapis.com/css?family=Open+Sans|Oswald&amp;display=swap" rel="stylesheet"><link href="https://fonts.googleapis.com/css?family=Roboto|Open+Sans&amp;display=swap" rel="stylesheet"></head><body><div id="thesite" class="ui text container"><div class="ui violet inverted top attached center aligned segment"><h1 class="ui huge header">Is this code possible? - Haskell</h1></div><div class="ui attached segment"><div class="ui message"><p>Welcome to the Functional Programming Zulip Chat Archive. You can join the chat <a href="https://funprog.zulipchat.com">here</a>.</p></div><div class="ui breadcrumb rib"><a href="/" class="section">Home</a><i class="right angle icon divider"></i><a href="/haskell/" class="section">#Haskell</a><i class="right angle icon divider"></i><div class="active section">Is this code possible?</div></div><div class="ui comments messages"><div class="comment"><a class="avatar"><img src="https://www.gravatar.com/avatar/09ff20ae4a109949b14275d9c011f83c"></a><div class="content"><a class="author">Disco Dave</a><div class="metadata"><a href="#184410165" name="184410165"><div>2019-12-29 07:40:22</div></a></div><div class="text"><p>Is there anyway to get the isAuthorized' function to work?</p>
<div class="codehilite"><pre><span></span><span class="kr">import</span>           <span class="nn">Data.Kind</span>                      <span class="p">(</span> <span class="kt">Constraint</span>
                                                <span class="p">,</span> <span class="kt">Type</span>
                                                <span class="p">)</span>
<span class="kr">import</span>           <span class="nn">Data.Proxy</span>                     <span class="p">(</span> <span class="kt">Proxy</span><span class="p">(</span><span class="o">..</span><span class="p">)</span> <span class="p">)</span>

<span class="kr">class</span> <span class="kt">IsAuthorized</span> <span class="n">claim</span> <span class="n">user</span> <span class="kr">where</span>
  <span class="n">isAuthorized</span> <span class="ow">::</span> <span class="kt">Proxy</span> <span class="n">claim</span> <span class="ow">-&gt;</span> <span class="n">user</span> <span class="ow">-&gt;</span> <span class="kt">Bool</span>

<span class="kr">data</span> <span class="kt">CombineLogic</span> <span class="ow">=</span> <span class="kt">And</span> <span class="o">|</span> <span class="kt">Or</span>

<span class="kr">data</span> <span class="kt">Authorize&#39;</span> <span class="p">(</span><span class="n">combineLogic</span> <span class="ow">::</span> <span class="kt">CombineLogic</span><span class="p">)</span> <span class="p">(</span><span class="n">claims</span> <span class="ow">::</span> <span class="p">[</span><span class="kt">Type</span><span class="p">])</span> <span class="p">(</span><span class="n">user</span> <span class="ow">::</span> <span class="kt">Type</span><span class="p">)</span>

<span class="kr">type</span> <span class="kt">Authorize</span> <span class="p">(</span><span class="n">claim</span> <span class="ow">::</span> <span class="kt">Type</span><span class="p">)</span> <span class="p">(</span><span class="n">user</span> <span class="ow">::</span> <span class="kt">Type</span><span class="p">)</span> <span class="ow">=</span> <span class="kt">Authorize&#39;</span> <span class="kt">&#39;And</span> <span class="kt">&#39;[claim]</span> <span class="n">user</span>
<span class="kr">type</span> <span class="kt">AuthorizeAll</span> <span class="p">(</span><span class="n">claims</span> <span class="ow">::</span> <span class="p">[</span><span class="kt">Type</span><span class="p">])</span> <span class="p">(</span><span class="n">user</span> <span class="ow">::</span> <span class="kt">Type</span><span class="p">)</span> <span class="ow">=</span> <span class="kt">Authorize&#39;</span> <span class="kt">&#39;And</span> <span class="n">claims</span> <span class="n">user</span>
<span class="kr">type</span> <span class="kt">AuthorizeAny</span> <span class="p">(</span><span class="n">claims</span> <span class="ow">::</span> <span class="p">[</span><span class="kt">Type</span><span class="p">])</span> <span class="p">(</span><span class="n">user</span> <span class="ow">::</span> <span class="kt">Type</span><span class="p">)</span> <span class="ow">=</span> <span class="kt">Authorize&#39;</span> <span class="kt">&#39;Or</span> <span class="n">claims</span> <span class="n">user</span>

<span class="kr">type</span> <span class="kr">family</span> <span class="kt">IsAuthorizedConstraints</span> <span class="p">(</span><span class="n">claims</span> <span class="ow">::</span> <span class="p">[</span><span class="n">a</span><span class="p">])</span> <span class="p">(</span><span class="n">user</span> <span class="ow">::</span> <span class="kt">Type</span><span class="p">)</span> <span class="ow">::</span> <span class="kt">Constraint</span> <span class="kr">where</span>
  <span class="kt">IsAuthorizedConstraints</span> <span class="kt">&#39;[]</span> <span class="kr">_</span> <span class="ow">=</span> <span class="nb">()</span>
  <span class="kt">IsAuthorizedConstraints</span> <span class="p">(</span><span class="n">claim</span> <span class="sc">&#39;</span><span class="err">: claims) user =</span>
    <span class="p">(</span><span class="kt">IsAuthorized</span> <span class="n">claim</span> <span class="n">user</span><span class="p">,</span> <span class="kt">IsAuthorizedConstraints</span> <span class="n">claims</span> <span class="n">user</span><span class="p">)</span>

<span class="kr">type</span> <span class="kr">family</span> <span class="kt">IsNonEmpty</span> <span class="p">(</span><span class="n">xs</span> <span class="ow">::</span> <span class="p">[</span><span class="n">a</span><span class="p">])</span> <span class="ow">::</span> <span class="kt">Bool</span> <span class="kr">where</span>
  <span class="kt">IsNonEmpty</span> <span class="kt">&#39;[]</span> <span class="ow">=</span> <span class="kt">&#39;False</span>
  <span class="kt">IsNonEmpty</span> <span class="kr">_</span>   <span class="ow">=</span> <span class="kt">&#39;True</span>

<span class="kr">type</span> <span class="kr">family</span> <span class="kt">Head</span> <span class="p">(</span><span class="n">xs</span> <span class="ow">::</span> <span class="p">[</span><span class="n">a</span><span class="p">])</span> <span class="ow">::</span> <span class="kt">Maybe</span> <span class="n">a</span> <span class="kr">where</span>
  <span class="kt">Head</span> <span class="kt">&#39;[]</span>       <span class="ow">=</span> <span class="kt">&#39;Nothing</span>
  <span class="kt">Head</span> <span class="p">(</span><span class="n">a</span> <span class="sc">&#39;</span><span class="err">: _)  =</span><span class="sc"> &#39;</span><span class="kt">Just</span> <span class="n">a</span>

<span class="kr">type</span> <span class="kr">family</span> <span class="kt">Tail</span> <span class="p">(</span><span class="n">xs</span> <span class="ow">::</span> <span class="p">[</span><span class="n">a</span><span class="p">])</span> <span class="ow">::</span> <span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="kr">where</span>
  <span class="kt">Tail</span> <span class="kt">&#39;[]</span>        <span class="ow">=</span> <span class="kt">&#39;[]</span>
  <span class="kt">Tail</span> <span class="p">(</span><span class="kr">_</span> <span class="sc">&#39;</span><span class="err">: xs)  = xs</span>

<span class="kr">data</span> <span class="kt">SCombineLogic</span> <span class="p">(</span><span class="n">c</span> <span class="ow">::</span> <span class="kt">CombineLogic</span><span class="p">)</span> <span class="kr">where</span>
  <span class="kt">SOr</span> <span class="ow">::</span> <span class="kt">SCombineLogic</span> <span class="kt">&#39;Or</span>
  <span class="kt">SAnd</span> <span class="ow">::</span> <span class="kt">SCombineLogic</span> <span class="kt">&#39;And</span>

<span class="kr">class</span> <span class="kt">GetCombineLogic</span> <span class="p">(</span><span class="n">c</span> <span class="ow">::</span> <span class="kt">CombineLogic</span><span class="p">)</span> <span class="kr">where</span>
  <span class="n">getCombineLogic</span> <span class="ow">::</span> <span class="kt">SCombineLogic</span> <span class="n">c</span>
<span class="kr">instance</span> <span class="kt">GetCombineLogic</span> <span class="kt">&#39;Or</span> <span class="kr">where</span>
  <span class="n">getCombineLogic</span> <span class="ow">=</span> <span class="kt">SOr</span>
<span class="kr">instance</span> <span class="kt">GetCombineLogic</span> <span class="kt">&#39;And</span> <span class="kr">where</span>
  <span class="n">getCombineLogic</span> <span class="ow">=</span> <span class="kt">SAnd</span>

<span class="kr">data</span> <span class="kt">SMaybe</span> <span class="p">(</span><span class="n">m</span> <span class="ow">::</span> <span class="kt">Maybe</span> <span class="n">a</span><span class="p">)</span> <span class="kr">where</span>
  <span class="kt">SNothing</span> <span class="ow">::</span> <span class="kt">SMaybe</span> <span class="kt">&#39;Nothing</span>
  <span class="kt">SJust</span> <span class="ow">::</span> <span class="kt">Proxy</span> <span class="n">a</span> <span class="ow">-&gt;</span> <span class="kt">SMaybe</span> <span class="p">(</span><span class="kt">&#39;Just</span> <span class="n">a</span><span class="p">)</span>

<span class="kr">class</span> <span class="kt">GetMaybe</span> <span class="p">(</span><span class="n">m</span> <span class="ow">::</span> <span class="kt">Maybe</span> <span class="kt">Type</span><span class="p">)</span> <span class="kr">where</span>
  <span class="n">getMaybe</span> <span class="ow">::</span> <span class="kt">SMaybe</span> <span class="n">m</span>
<span class="kr">instance</span> <span class="kt">GetMaybe</span> <span class="kt">&#39;Nothing</span> <span class="kr">where</span>
  <span class="n">getMaybe</span> <span class="ow">=</span> <span class="kt">SNothing</span>
<span class="kr">instance</span> <span class="kt">GetMaybe</span> <span class="p">(</span><span class="kt">&#39;Just</span> <span class="n">a</span><span class="p">)</span> <span class="kr">where</span>
  <span class="n">getMaybe</span> <span class="ow">=</span> <span class="kt">SJust</span> <span class="p">(</span><span class="kt">Proxy</span> <span class="o">@</span><span class="n">a</span><span class="p">)</span>


<span class="nf">combineLogic</span>
  <span class="ow">::</span> <span class="n">forall</span> <span class="n">combineLogic</span>
   <span class="o">.</span> <span class="kt">GetCombineLogic</span> <span class="n">combineLogic</span>
  <span class="ow">=&gt;</span> <span class="kt">Proxy</span> <span class="n">combineLogic</span>
  <span class="ow">-&gt;</span> <span class="p">(</span><span class="kt">Bool</span> <span class="ow">-&gt;</span> <span class="kt">Bool</span> <span class="ow">-&gt;</span> <span class="kt">Bool</span><span class="p">,</span> <span class="kt">Bool</span><span class="p">)</span>
<span class="nf">combineLogic</span> <span class="kr">_</span> <span class="ow">=</span> <span class="kr">case</span> <span class="n">getCombineLogic</span> <span class="o">@</span><span class="n">combineLogic</span> <span class="kr">of</span>
  <span class="kt">SOr</span>  <span class="ow">-&gt;</span> <span class="p">((</span><span class="o">||</span><span class="p">),</span> <span class="kt">False</span><span class="p">)</span>
  <span class="kt">SAnd</span> <span class="ow">-&gt;</span> <span class="p">((</span><span class="o">&amp;&amp;</span><span class="p">),</span> <span class="kt">True</span><span class="p">)</span>

<span class="nf">isAuthorized&#39;</span>
  <span class="ow">::</span> <span class="n">forall</span> <span class="n">claims</span> <span class="n">user</span> <span class="n">cl</span> <span class="n">a</span>
   <span class="o">.</span> <span class="p">(</span> <span class="kt">IsAuthorizedConstraints</span> <span class="n">claims</span> <span class="n">user</span>
     <span class="p">,</span> <span class="kt">GetCombineLogic</span> <span class="n">cl</span>
     <span class="p">,</span> <span class="kt">GetMaybe</span> <span class="p">(</span><span class="kt">Head</span> <span class="n">claims</span><span class="p">)</span>
     <span class="p">)</span>
  <span class="ow">=&gt;</span> <span class="kt">Proxy</span> <span class="p">(</span><span class="kt">Authorize&#39;</span> <span class="n">cl</span> <span class="n">claims</span> <span class="n">user</span><span class="p">)</span>
  <span class="ow">-&gt;</span> <span class="n">user</span>
  <span class="ow">-&gt;</span> <span class="kt">Bool</span>
<span class="nf">isAuthorized&#39;</span> <span class="kr">_</span> <span class="n">user</span> <span class="ow">=</span>
  <span class="kr">let</span> <span class="p">(</span><span class="n">combine</span><span class="p">,</span> <span class="n">def</span><span class="p">)</span> <span class="ow">=</span> <span class="n">combineLogic</span> <span class="p">(</span><span class="kt">Proxy</span> <span class="o">@</span><span class="n">cl</span><span class="p">)</span>
  <span class="kr">in</span> <span class="kr">case</span> <span class="n">getMaybe</span> <span class="o">@</span><span class="p">(</span><span class="kt">Head</span> <span class="n">claims</span><span class="p">)</span> <span class="kr">of</span>
    <span class="kt">SNothing</span> <span class="ow">-&gt;</span> <span class="n">def</span>
    <span class="kt">SJust</span> <span class="n">claim</span> <span class="ow">-&gt;</span> <span class="n">isAuthorized</span> <span class="n">claim</span> <span class="n">user</span> <span class="p">`</span><span class="n">combine</span><span class="p">`</span> <span class="n">isAuthorized&#39;</span> <span class="n">nextClaims</span> <span class="n">user</span>
      <span class="kr">where</span> <span class="n">nextClaims</span> <span class="ow">=</span> <span class="kt">Proxy</span> <span class="o">@</span><span class="p">(</span><span class="kt">Authorize&#39;</span> <span class="n">cl</span> <span class="p">(</span><span class="kt">Tail</span> <span class="n">claims</span><span class="p">)</span> <span class="n">user</span><span class="p">)</span>




<span class="kr">newtype</span> <span class="kt">User</span> <span class="ow">=</span> <span class="kt">User</span> <span class="p">{</span> <span class="n">fromUser</span> <span class="ow">::</span> <span class="kt">String</span> <span class="p">}</span>

<span class="kr">instance</span> <span class="kt">IsAuthorized</span> <span class="kt">IsAdmin</span> <span class="kt">User</span> <span class="kr">where</span>
  <span class="n">isAuthorized</span> <span class="kr">_</span> <span class="kr">_</span> <span class="ow">=</span> <span class="kt">True</span>
<span class="kr">instance</span> <span class="kt">IsAuthorized</span> <span class="kt">IsPremium</span> <span class="kt">User</span> <span class="kr">where</span>
  <span class="n">isAuthorized</span> <span class="kr">_</span> <span class="kr">_</span> <span class="ow">=</span> <span class="kt">False</span>

<span class="kr">data</span> <span class="kt">IsAdmin</span>
<span class="kr">data</span> <span class="kt">IsPremium</span>

<span class="kr">type</span> <span class="kt">Claims</span> <span class="ow">=</span> <span class="kt">AuthorizeAll</span> <span class="kt">&#39;[IsPremium, IsAdmin]</span> <span class="kt">User</span>

<span class="kr">_</span> <span class="ow">=</span> <span class="n">isAuthorized&#39;</span> <span class="p">(</span><span class="kt">Proxy</span> <span class="o">@</span><span class="kt">Claims</span><span class="p">)</span> <span class="p">(</span><span class="kt">User</span> <span class="s">&quot;john.doe&quot;</span><span class="p">)</span>
</pre></div></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/89529ef093c72e16a5ce3ac00d88f354ccc08cf9?x=x&amp;version=2"></a><div class="content"><a class="author">Lysxia</a><div class="metadata"><a href="#184416057" name="184416057"><div>2019-12-29 10:59:46</div></a></div><div class="text"><p>What is the error message? That's a pretty big piece of code for one to assimilate without context.</p></div></div></div><div class="comment"><a class="avatar"><img src="https://www.gravatar.com/avatar/09ff20ae4a109949b14275d9c011f83c"></a><div class="content"><a class="author">Disco Dave</a><div class="metadata"><a href="#184426050" name="184426050"><div>2019-12-29 15:54:48</div></a></div><div class="text"><p>Lol, yeah. Sorry. Wasn't sure the best way to ask. </p>
<div class="codehilite"><pre><span></span>/home/disco/Documents/code/haskell/servant-auth-playground/src/Authorization.hs:81:20: error:
    • Could not deduce (IsAuthorized a1 user)
        arising from a use of ‘isAuthorized’
      from the context: (IsAuthorizedConstraints claims user,
                         GetCombineLogic cl, GetMaybe (Head claims))
        bound by the type signature for:
                   isAuthorized&#39; :: forall k (claims :: [*]) user (cl :: CombineLogic) (a :: k).
                                    (IsAuthorizedConstraints claims user, GetCombineLogic cl,
                                     GetMaybe (Head claims)) =&gt;
                                    Proxy (Authorize&#39; cl claims user) -&gt; user -&gt; Bool
        at src/Authorization.hs:(68,1)-(76,9)
      or from: Head claims ~ &#39;Just a1
        bound by a pattern with constructor:
                   SJust :: forall a1 (a2 :: a1). Proxy a2 -&gt; SMaybe (&#39;Just a2),
                 in a case alternative
        at src/Authorization.hs:81:5-15
    • In the first argument of ‘combine’, namely
        ‘isAuthorized claim user’
      In the expression:
        isAuthorized claim user `combine` isAuthorized&#39; nextClaims user
      In a case alternative:
          SJust claim
            -&gt; isAuthorized claim user `combine` isAuthorized&#39; nextClaims user
            where
                nextClaims = Proxy @(Authorize&#39; cl (Tail claims) user)
   |
81 |     SJust claim -&gt; isAuthorized claim user `combine` isAuthorized&#39; nextClaims user
   |                    ^^^^^^^^^^^^^^^^^^^^^^^

/home/disco/Documents/code/haskell/servant-auth-playground/src/Authorization.hs:81:54: error:
    • Could not deduce: IsAuthorizedConstraints (Tail claims) user
        arising from a use of ‘isAuthorized&#39;’
      from the context: (IsAuthorizedConstraints claims user,
                         GetCombineLogic cl, GetMaybe (Head claims))
        bound by the type signature for:
                   isAuthorized&#39; :: forall k (claims :: [*]) user (cl :: CombineLogic) (a :: k).
                                    (IsAuthorizedConstraints claims user, GetCombineLogic cl,
                                     GetMaybe (Head claims)) =&gt;
                                    Proxy (Authorize&#39; cl claims user) -&gt; user -&gt; Bool
        at src/Authorization.hs:(68,1)-(76,9)
      or from: Head claims ~ &#39;Just a1
        bound by a pattern with constructor:
                   SJust :: forall a1 (a2 :: a1). Proxy a2 -&gt; SMaybe (&#39;Just a2),
                 in a case alternative
        at src/Authorization.hs:81:5-15
    • In the second argument of ‘combine’, namely
        ‘isAuthorized&#39; nextClaims user’
      In the expression:
        isAuthorized claim user `combine` isAuthorized&#39; nextClaims user
      In a case alternative:
          SJust claim
            -&gt; isAuthorized claim user `combine` isAuthorized&#39; nextClaims user
            where
                nextClaims = Proxy @(Authorize&#39; cl (Tail claims) user)
    • Relevant bindings include
        nextClaims :: Proxy (Authorize&#39; cl (Tail claims) user)
          (bound at src/Authorization.hs:82:13)
        user :: user (bound at src/Authorization.hs:77:17)
        isAuthorized&#39; :: Proxy (Authorize&#39; cl claims user) -&gt; user -&gt; Bool
          (bound at src/Authorization.hs:77:1)
   |
81 |     SJust claim -&gt; isAuthorized claim user `combine` isAuthorized&#39; nextClaims user
   |                                                      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

/home/disco/Documents/code/haskell/servant-auth-playground/src/Authorization.hs:81:54: error:
    • Could not deduce (GetMaybe (Head (Tail claims)))
        arising from a use of ‘isAuthorized&#39;’
      from the context: (IsAuthorizedConstraints claims user,
                         GetCombineLogic cl, GetMaybe (Head claims))
        bound by the type signature for:
                   isAuthorized&#39; :: forall k (claims :: [*]) user (cl :: CombineLogic) (a :: k).
                                    (IsAuthorizedConstraints claims user, GetCombineLogic cl,
                                     GetMaybe (Head claims)) =&gt;
                                    Proxy (Authorize&#39; cl claims user) -&gt; user -&gt; Bool
        at src/Authorization.hs:(68,1)-(76,9)
      or from: Head claims ~ &#39;Just a1
        bound by a pattern with constructor:
                   SJust :: forall a1 (a2 :: a1). Proxy a2 -&gt; SMaybe (&#39;Just a2),
                 in a case alternative
        at src/Authorization.hs:81:5-15
    • In the second argument of ‘combine’, namely
        ‘isAuthorized&#39; nextClaims user’
      In the expression:
        isAuthorized claim user `combine` isAuthorized&#39; nextClaims user
      In a case alternative:
          SJust claim
            -&gt; isAuthorized claim user `combine` isAuthorized&#39; nextClaims user
            where
                nextClaims = Proxy @(Authorize&#39; cl (Tail claims) user)
   |
81 |     SJust claim -&gt; isAuthorized claim user `combine` isAuthorized&#39; nextClaims user
   |                                                      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
</pre></div></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/89529ef093c72e16a5ce3ac00d88f354ccc08cf9?x=x&amp;version=2"></a><div class="content"><a class="author">Lysxia</a><div class="metadata"><a href="#184430982" name="184430982"><div>2019-12-29 18:15:10</div></a></div><div class="text"><p>From <code>Head claims = 'Just claim</code> GHC won't infer that <code>claims = claim ': _</code></p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/89529ef093c72e16a5ce3ac00d88f354ccc08cf9?x=x&amp;version=2"></a><div class="content"><a class="author">Lysxia</a><div class="metadata"><a href="#184431194" name="184431194"><div>2019-12-29 18:21:15</div></a></div><div class="text"><p>Instead of a <code>GetMaybe</code> class, start by passing the GADT explicitly. And instead of <code>SMaybe</code>, which will only give you one element <code>Head claims</code>, you need a type witness for the whole list <code>claims</code>.</p>
<div class="codehilite"><pre><span></span><span class="kr">data</span> <span class="kt">TList</span> <span class="ow">::</span> <span class="p">[</span><span class="kt">Type</span><span class="p">]</span> <span class="ow">-&gt;</span> <span class="kt">Type</span> <span class="kr">where</span>
  <span class="kt">TNil</span> <span class="ow">::</span> <span class="kt">TList</span> <span class="kt">&#39;[]</span>
  <span class="kt">TCons</span> <span class="ow">::</span> <span class="kt">TList</span> <span class="n">xs</span> <span class="ow">-&gt;</span> <span class="kt">TList</span> <span class="p">(</span><span class="n">x</span> <span class="sc">&#39;</span><span class="err">: xs)</span>

<span class="nf">isAuthorized&#39;</span> <span class="ow">::</span> <span class="o">...</span>
   <span class="ow">=&gt;</span> <span class="kt">TList</span> <span class="n">claims</span>
   <span class="ow">-&gt;</span> <span class="o">...</span>
</pre></div></div></div></div><div class="comment"><a class="avatar"><img src="https://www.gravatar.com/avatar/09ff20ae4a109949b14275d9c011f83c"></a><div class="content"><a class="author">Disco Dave</a><div class="metadata"><a href="#184432004" name="184432004"><div>2019-12-29 18:46:29</div></a></div><div class="text"><p>What about this? I think this is simpler.</p>
<div class="codehilite"><pre><span></span><span class="kr">module</span> <span class="nn">Authorization</span>
  <span class="p">(</span> <span class="kt">IsAuthorized</span><span class="p">(</span><span class="o">..</span><span class="p">)</span>
  <span class="p">,</span> <span class="kt">Authorize</span>
  <span class="p">,</span> <span class="kt">AuthorizeAll</span>
  <span class="p">,</span> <span class="kt">AuthorizeAny</span>
  <span class="p">)</span>
<span class="kr">where</span>

<span class="kr">import</span>           <span class="nn">Data.Kind</span>                      <span class="p">(</span> <span class="kt">Type</span> <span class="p">)</span>
<span class="kr">import</span>           <span class="nn">Data.Proxy</span>                     <span class="p">(</span> <span class="kt">Proxy</span><span class="p">(</span><span class="o">..</span><span class="p">)</span> <span class="p">)</span>


<span class="kr">class</span> <span class="kt">IsAuthorized</span> <span class="n">claim</span> <span class="n">user</span> <span class="kr">where</span>
  <span class="n">isAuthorized</span> <span class="ow">::</span> <span class="kt">Proxy</span> <span class="n">claim</span> <span class="ow">-&gt;</span> <span class="n">user</span> <span class="ow">-&gt;</span> <span class="kt">Bool</span>

<span class="kr">instance</span> <span class="kt">IsAuthorizedMany</span> <span class="p">(</span><span class="kt">Authorize&#39;</span> <span class="n">cl</span> <span class="n">claims</span> <span class="n">user</span><span class="p">)</span> <span class="n">user</span> <span class="ow">=&gt;</span> <span class="kt">IsAuthorized</span> <span class="p">(</span><span class="kt">Authorize&#39;</span> <span class="n">cl</span> <span class="n">claims</span> <span class="n">user</span><span class="p">)</span> <span class="n">user</span> <span class="kr">where</span>
  <span class="n">isAuthorized</span> <span class="ow">=</span> <span class="n">isAuthorizedMany</span>

<span class="kr">data</span> <span class="kt">CombineLogic</span> <span class="ow">=</span> <span class="kt">And</span> <span class="o">|</span> <span class="kt">Or</span>

<span class="kr">data</span> <span class="kt">Authorize&#39;</span> <span class="p">(</span><span class="n">combineLogic</span> <span class="ow">::</span> <span class="kt">CombineLogic</span><span class="p">)</span> <span class="p">(</span><span class="n">claims</span> <span class="ow">::</span> <span class="p">[</span><span class="kt">Type</span><span class="p">])</span> <span class="p">(</span><span class="n">user</span> <span class="ow">::</span> <span class="kt">Type</span><span class="p">)</span>

<span class="kr">type</span> <span class="kt">Authorize</span> <span class="p">(</span><span class="n">claim</span> <span class="ow">::</span> <span class="kt">Type</span><span class="p">)</span> <span class="p">(</span><span class="n">user</span> <span class="ow">::</span> <span class="kt">Type</span><span class="p">)</span> <span class="ow">=</span> <span class="kt">Authorize&#39;</span> <span class="kt">&#39;And</span> <span class="kt">&#39;[claim]</span> <span class="n">user</span>
<span class="kr">type</span> <span class="kt">AuthorizeAll</span> <span class="p">(</span><span class="n">claims</span> <span class="ow">::</span> <span class="p">[</span><span class="kt">Type</span><span class="p">])</span> <span class="p">(</span><span class="n">user</span> <span class="ow">::</span> <span class="kt">Type</span><span class="p">)</span> <span class="ow">=</span> <span class="kt">Authorize&#39;</span> <span class="kt">&#39;And</span> <span class="n">claims</span> <span class="n">user</span>
<span class="kr">type</span> <span class="kt">AuthorizeAny</span> <span class="p">(</span><span class="n">claims</span> <span class="ow">::</span> <span class="p">[</span><span class="kt">Type</span><span class="p">])</span> <span class="p">(</span><span class="n">user</span> <span class="ow">::</span> <span class="kt">Type</span><span class="p">)</span> <span class="ow">=</span> <span class="kt">Authorize&#39;</span> <span class="kt">&#39;Or</span> <span class="n">claims</span> <span class="n">user</span>

<span class="kr">class</span> <span class="kt">IsAuthorizedMany</span> <span class="n">claims</span> <span class="n">user</span> <span class="kr">where</span>
  <span class="n">isAuthorizedMany</span> <span class="ow">::</span> <span class="kt">Proxy</span> <span class="n">claims</span> <span class="ow">-&gt;</span> <span class="n">user</span> <span class="ow">-&gt;</span> <span class="kt">Bool</span>

<span class="kr">instance</span> <span class="kt">IsAuthorizedMany</span> <span class="p">(</span><span class="kt">Authorize&#39;</span> <span class="kt">&#39;And</span> <span class="kt">&#39;[]</span> <span class="n">_user</span><span class="p">)</span> <span class="n">_user</span> <span class="kr">where</span>
  <span class="n">isAuthorizedMany</span> <span class="kr">_</span> <span class="kr">_</span> <span class="ow">=</span> <span class="kt">True</span>

<span class="kr">instance</span> <span class="p">(</span><span class="kt">IsAuthorized</span> <span class="n">claim</span> <span class="n">user</span>
         <span class="p">,</span> <span class="kt">IsAuthorizedMany</span> <span class="p">(</span><span class="kt">Authorize&#39;</span> <span class="kt">&#39;And</span> <span class="n">claims</span> <span class="n">user</span><span class="p">)</span> <span class="n">user</span>
         <span class="p">)</span>
      <span class="ow">=&gt;</span> <span class="kt">IsAuthorizedMany</span> <span class="p">(</span><span class="kt">Authorize&#39;</span> <span class="kt">&#39;And</span> <span class="p">(</span><span class="n">claim</span> <span class="sc">&#39;</span><span class="err">: claims) user) user where</span>
  <span class="n">isAuthorizedMany</span> <span class="kr">_</span> <span class="n">user</span> <span class="ow">=</span>
    <span class="n">isAuthorized</span> <span class="p">(</span><span class="kt">Proxy</span> <span class="o">@</span><span class="n">claim</span><span class="p">)</span> <span class="n">user</span>
      <span class="o">&amp;&amp;</span> <span class="n">isAuthorizedMany</span> <span class="p">(</span><span class="kt">Proxy</span> <span class="o">@</span><span class="p">(</span><span class="kt">Authorize&#39;</span> <span class="kt">&#39;And</span> <span class="n">claims</span> <span class="n">user</span><span class="p">))</span> <span class="n">user</span>

<span class="kr">instance</span> <span class="kt">IsAuthorizedMany</span> <span class="p">(</span><span class="kt">Authorize&#39;</span> <span class="kt">&#39;Or</span> <span class="kt">&#39;[]</span> <span class="n">_user</span><span class="p">)</span> <span class="n">_user</span> <span class="kr">where</span>
  <span class="n">isAuthorizedMany</span> <span class="kr">_</span> <span class="kr">_</span> <span class="ow">=</span> <span class="kt">False</span>

<span class="kr">instance</span> <span class="p">(</span><span class="kt">IsAuthorized</span> <span class="n">claim</span> <span class="n">user</span>
         <span class="p">,</span> <span class="kt">IsAuthorizedMany</span> <span class="p">(</span><span class="kt">Authorize&#39;</span> <span class="kt">&#39;Or</span> <span class="n">claims</span> <span class="n">user</span><span class="p">)</span> <span class="n">user</span>
         <span class="p">)</span>
      <span class="ow">=&gt;</span> <span class="kt">IsAuthorizedMany</span> <span class="p">(</span><span class="kt">Authorize&#39;</span> <span class="kt">&#39;Or</span> <span class="p">(</span><span class="n">claim</span> <span class="sc">&#39;</span><span class="err">: claims) user) user where</span>
  <span class="n">isAuthorizedMany</span> <span class="kr">_</span> <span class="n">user</span> <span class="ow">=</span>
    <span class="n">isAuthorized</span> <span class="p">(</span><span class="kt">Proxy</span> <span class="o">@</span><span class="n">claim</span><span class="p">)</span> <span class="n">user</span>
      <span class="o">||</span> <span class="n">isAuthorizedMany</span> <span class="p">(</span><span class="kt">Proxy</span> <span class="o">@</span><span class="p">(</span><span class="kt">Authorize&#39;</span> <span class="kt">&#39;Or</span> <span class="n">claims</span> <span class="n">user</span><span class="p">))</span> <span class="n">user</span>
</pre></div></div></div></div><div class="comment"><a class="avatar"><img src="https://www.gravatar.com/avatar/09ff20ae4a109949b14275d9c011f83c"></a><div class="content"><a class="author">Disco Dave</a><div class="metadata"><a href="#184432014" name="184432014"><div>2019-12-29 18:47:04</div></a></div><div class="text"><p>Also Zulip's haskell highlighting is confused XD</p></div></div></div><div class="comment"><a class="avatar"><img src="https://www.gravatar.com/avatar/09ff20ae4a109949b14275d9c011f83c"></a><div class="content"><a class="author">Disco Dave</a><div class="metadata"><a href="#184432088" name="184432088"><div>2019-12-29 18:49:15</div></a></div><div class="text"><p>And this seems to magically work. At least with this simple example.</p>
<div class="codehilite"><pre><span></span><span class="kr">data</span> <span class="kt">IsAdmin</span>
<span class="kr">data</span> <span class="kt">IsPremium</span>

<span class="kr">newtype</span> <span class="kt">FakeUser</span> <span class="ow">=</span> <span class="kt">FakeUser</span> <span class="p">{</span> <span class="n">fromUser</span> <span class="ow">::</span> <span class="kt">String</span> <span class="p">}</span>

<span class="kr">instance</span> <span class="kt">IsAuthorized</span> <span class="kt">IsAdmin</span> <span class="kt">FakeUser</span> <span class="kr">where</span>
  <span class="n">isAuthorized</span> <span class="kr">_</span> <span class="kr">_</span> <span class="ow">=</span> <span class="kt">True</span>
<span class="kr">instance</span> <span class="kt">IsAuthorized</span> <span class="kt">IsPremium</span> <span class="kt">FakeUser</span> <span class="kr">where</span>
  <span class="n">isAuthorized</span> <span class="kr">_</span> <span class="kr">_</span> <span class="ow">=</span> <span class="kt">False</span>

<span class="kr">type</span> <span class="kt">MyClaims</span> <span class="ow">=</span> <span class="kt">AuthorizeAll</span> <span class="kt">&#39;[IsPremium, IsAdmin]</span> <span class="kt">FakeUser</span>

<span class="nf">shouldBeFalse</span> <span class="ow">=</span> <span class="n">isAuthorized</span> <span class="p">(</span><span class="kt">Proxy</span> <span class="o">@</span><span class="p">(</span><span class="kt">AuthorizeAll</span> <span class="kt">&#39;[IsPremium, IsAdmin]</span> <span class="kt">FakeUser</span><span class="p">))</span> <span class="p">(</span><span class="kt">FakeUser</span> <span class="s">&quot;john.doe&quot;</span><span class="p">)</span>
<span class="nf">shouldBeTrue</span> <span class="ow">=</span> <span class="n">isAuthorized</span> <span class="p">(</span><span class="kt">Proxy</span> <span class="o">@</span><span class="p">(</span><span class="kt">AuthorizeAny</span> <span class="kt">&#39;[IsPremium, IsAdmin]</span> <span class="kt">FakeUser</span><span class="p">))</span> <span class="p">(</span><span class="kt">FakeUser</span> <span class="s">&quot;john.doe&quot;</span><span class="p">)</span>
</pre></div></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/89529ef093c72e16a5ce3ac00d88f354ccc08cf9?x=x&amp;version=2"></a><div class="content"><a class="author">Lysxia</a><div class="metadata"><a href="#184432097" name="184432097"><div>2019-12-29 18:49:50</div></a></div><div class="text"><blockquote>
<p>Also Zulip's haskell highlighting is confused XD</p>
</blockquote>
<p>(I just made a PR to pygments to fix it)</p></div></div></div><div class="comment"><a class="avatar"><img src="https://www.gravatar.com/avatar/09ff20ae4a109949b14275d9c011f83c"></a><div class="content"><a class="author">Disco Dave</a><div class="metadata"><a href="#184432153" name="184432153"><div>2019-12-29 18:50:45</div></a></div><div class="text"><p>Oh wow that's awesome :D</p></div></div></div><div class="comment"><a class="avatar"><img src="https://www.gravatar.com/avatar/09ff20ae4a109949b14275d9c011f83c"></a><div class="content"><a class="author">Disco Dave</a><div class="metadata"><a href="#184432225" name="184432225"><div>2019-12-29 18:52:46</div></a></div><div class="text"><p>The only weird part about this is that AuthorizeAny with an empty list is False and AuthorizeAll with an empty list is True</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/89529ef093c72e16a5ce3ac00d88f354ccc08cf9?x=x&amp;version=2"></a><div class="content"><a class="author">Lysxia</a><div class="metadata"><a href="#184432290" name="184432290"><div>2019-12-29 18:54:57</div></a></div><div class="text"><p>Weird but monoidal.</p></div></div></div><div class="comment"><a class="avatar"><img src="https://www.gravatar.com/avatar/09ff20ae4a109949b14275d9c011f83c"></a><div class="content"><a class="author">Disco Dave</a><div class="metadata"><a href="#184432376" name="184432376"><div>2019-12-29 18:57:42</div></a></div><div class="text"><p>The intention is to use this as a servant combinator. So I think I could just write my HasServer instance to required the claims list as non empty.</p></div></div></div></div></div><div class="ui vertical footer segment"><a href="https://github.com/srid/zulip-archive">Powered by Haskell</a> | Questions? Contact <a href="https://www.srid.ca">srid</a></div></div></body></html>