<html lang="en"><head><meta content="text/html; charset=utf-8" http-equiv="Content-Type"><meta content="width=device-width, initial-scale=1" name="viewport"><meta content="@Sandy Maguire Is there anything you would change about your approach on polysemy now?" name="description"><link href="https://funprog.srid.ca/haskell/work-on-effect-systems.html" rel="canonical"><meta property="og:title" content="Work on effect systems - Haskell"><meta property="og:site_name" content="Functional Programming Zulip Archive"><meta property="og:type" content="article"><meta property="og:article:section" content="Haskell"><meta property="og:article:modified_time" content="2020-01-31T09:51:50Z"><meta property="og:article:published_time" content="2020-01-23T18:12:55Z"><meta property="og:image" content="https://zulip-avatars.s3.amazonaws.com/13896/20a04d823b7c3891d78ca5f6a188ccd0e4fc5e3d?version=2"><title>Work on effect systems - Haskell</title><style type="text/css">
div#thesite
{
  font-family   : "Open Sans", sans-serif;
  font-size     : 1em !important;
  margin-top    : 1em;
  margin-bottom : 1em;
}

div#thesite h1
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite h2
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite h3
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite h4
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite h5
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite h6
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite .ui.breadcrumb.rib .section
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite .header
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite .as-header
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite code, pre, tt
{
  font-family : "SFMono-Regular","Menlo","Monaco","Consolas","Liberation Mono","Courier New", monospace;
}

div#thesite .ui.breadcrumb.rib
{
  margin-bottom : 1em;
}



div#thesite .ui.comments.messages .comment .metadata a
{
  color : #808080;
}

div#thesite .ui.comments.messages .comment a.avatar img
{
  height : auto;
}

div#thesite .subtle
{
  color : #808080;
}


div#thesite .messages pre
{
  font-size : 85%;
  overflow  : auto;
  max-width : 100%;
}

div#thesite .messages .message_embed
{
  border-left  : solid 3px #808080;
  padding-left : 0.69999em;
}

div#thesite .messages .message_inline_image img
{
  max-width     : 100%;
  margin-bottom : 1em;
}


/* Generated with Clay, http://fvisser.nl/clay */</style><link href="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.4.1/semantic.min.css" rel="stylesheet"><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/all.min.css" rel="stylesheet"><link href="https://fonts.googleapis.com/css?family=Open+Sans|Oswald&amp;display=swap" rel="stylesheet"><link href="https://fonts.googleapis.com/css?family=Roboto|Open+Sans&amp;display=swap" rel="stylesheet"></head><body><div id="thesite" class="ui text container"><div class="ui violet inverted top attached center aligned segment"><h1 class="ui huge header">Work on effect systems - Haskell</h1></div><div class="ui attached segment"><div class="ui message"><p>Welcome to the Functional Programming Zulip Chat Archive. You can join the chat <a href="https://funprog.zulipchat.com">here</a>.</p></div><div class="ui breadcrumb rib"><a href="/" class="section">Home</a><i class="right angle icon divider"></i><a href="/haskell/" class="section">#Haskell</a><i class="right angle icon divider"></i><div class="active section">Work on effect systems</div></div><div class="ui comments messages"><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/20a04d823b7c3891d78ca5f6a188ccd0e4fc5e3d?version=2"></a><div class="content"><a class="author">TheMatten</a><div class="metadata"><a href="#186417618" name="186417618"><div>2020-01-23 18:12:55</div></a></div><div class="text"><p><span class="user-mention" data-user-id="251120">@Sandy Maguire</span> Is there anything you would change about your approach on <code>polysemy</code> now?</p></div></div></div><div class="comment"><a class="avatar"><img src="https://www.gravatar.com/avatar/3d24a4100b3eab34d8ce3059d789c543"></a><div class="content"><a class="author">Sandy Maguire</a><div class="metadata"><a href="#186417675" name="186417675"><div>2020-01-23 18:13:35</div></a></div><div class="text"><p>i think i'd get rid of tactics</p></div></div></div><div class="comment"><a class="avatar"><img src="https://www.gravatar.com/avatar/3d24a4100b3eab34d8ce3059d789c543"></a><div class="content"><a class="author">Sandy Maguire</a><div class="metadata"><a href="#186417703" name="186417703"><div>2020-01-23 18:13:55</div></a></div><div class="text"><p>and then all of those janky Weaving things.... give the variables much better names</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/20a04d823b7c3891d78ca5f6a188ccd0e4fc5e3d?version=2"></a><div class="content"><a class="author">TheMatten</a><div class="metadata"><a href="#186417754" name="186417754"><div>2020-01-23 18:14:05</div></a></div><div class="text"><p>I guess you're not the only one - <code>Weaving</code> seems to be the culprit <span aria-label="big smile" class="emoji emoji-1f604" role="img" title="big smile">:big_smile:</span></p></div></div></div><div class="comment"><a class="avatar"><img src="https://www.gravatar.com/avatar/3d24a4100b3eab34d8ce3059d789c543"></a><div class="content"><a class="author">Sandy Maguire</a><div class="metadata"><a href="#186417793" name="186417793"><div>2020-01-23 18:14:30</div></a></div><div class="text"><p>but more generally i think it's too complicated</p></div></div></div><div class="comment"><a class="avatar"><img src="https://www.gravatar.com/avatar/3d24a4100b3eab34d8ce3059d789c543"></a><div class="content"><a class="author">Sandy Maguire</a><div class="metadata"><a href="#186417813" name="186417813"><div>2020-01-23 18:14:49</div></a></div><div class="text"><p>it's _sorta_ a solution to effects, but not really</p></div></div></div><div class="comment"><a class="avatar"><img src="https://www.gravatar.com/avatar/3d24a4100b3eab34d8ce3059d789c543"></a><div class="content"><a class="author">Sandy Maguire</a><div class="metadata"><a href="#186417851" name="186417851"><div>2020-01-23 18:15:05</div></a></div><div class="text"><p>and the "not really" part adds so many warts  and tons of complexity</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/20a04d823b7c3891d78ca5f6a188ccd0e4fc5e3d?version=2"></a><div class="content"><a class="author">TheMatten</a><div class="metadata"><a href="#186417912" name="186417912"><div>2020-01-23 18:15:39</div></a></div><div class="text"><p>I still wonder whether ability to remove effects from the stack one by one is what we want - I always thought of effect systems as "composable compilers" with one actual output</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/20a04d823b7c3891d78ca5f6a188ccd0e4fc5e3d?version=2"></a><div class="content"><a class="author">TheMatten</a><div class="metadata"><a href="#186417990" name="186417990"><div>2020-01-23 18:16:04</div></a></div><div class="text"><p>Once you don't need that, <code>Weaving</code> disappears it seems</p></div></div></div><div class="comment"><a class="avatar"><img src="https://www.gravatar.com/avatar/3d24a4100b3eab34d8ce3059d789c543"></a><div class="content"><a class="author">Sandy Maguire</a><div class="metadata"><a href="#186418006" name="186418006"><div>2020-01-23 18:16:13</div></a></div><div class="text"><p>cool. i'd love to see that</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/20a04d823b7c3891d78ca5f6a188ccd0e4fc5e3d?version=2"></a><div class="content"><a class="author">TheMatten</a><div class="metadata"><a href="#186418055" name="186418055"><div>2020-01-23 18:16:54</div></a></div><div class="text"><p>It's actually what came up from that experiment I did some time ago: <a href="https://gitlab.com/snippets/1903905" target="_blank" title="https://gitlab.com/snippets/1903905">https://gitlab.com/snippets/1903905</a></p>
<div class="message_embed"><a class="message_embed_image" href="https://gitlab.com/snippets/1903905" style="background-image: url(https://assets.gitlab-static.net/assets/gitlab_logo-7ae504fe4f68fdebb3c2034e36621930cd36ea87924c11ff65dbcb8ed50dca58.png)" target="_blank"></a><div class="data-container"><div class="message_embed_title"><a href="https://gitlab.com/snippets/1903905" target="_blank" title="Effects transformer (or algebraic effects with fixed target monad) ($1903905) · Snippets">Effects transformer (or algebraic effects with fixed target monad) ($1903905) · Snippets</a></div><div class="message_embed_description">GitLab.com</div></div></div></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/20a04d823b7c3891d78ca5f6a188ccd0e4fc5e3d?version=2"></a><div class="content"><a class="author">TheMatten</a><div class="metadata"><a href="#186418217" name="186418217"><div>2020-01-23 18:18:26</div></a></div><div class="text"><p>We had some conversation with  Ollie and he compared it to final-encoding-version of some other lib - maybe I can find it somewhere <span aria-label="big smile" class="emoji emoji-1f604" role="img" title="big smile">:big_smile:</span></p></div></div></div><div class="comment"><a class="avatar"><img src="https://www.gravatar.com/avatar/3d24a4100b3eab34d8ce3059d789c543"></a><div class="content"><a class="author">Sandy Maguire</a><div class="metadata"><a href="#186418232" name="186418232"><div>2020-01-23 18:18:32</div></a></div><div class="text"><p>oh yeah i remember that</p></div></div></div><div class="comment"><a class="avatar"><img src="https://www.gravatar.com/avatar/c03b8d34978563858020eff0d14cc17b"></a><div class="content"><a class="author">Alexis King</a><div class="metadata"><a href="#186418273" name="186418273"><div>2020-01-23 18:18:59</div></a></div><div class="text"><p>I haven’t been following this discussion at all, but: my “boring Haskell” take on effect systems is that I think monad transformers are the single largest barrier to entry to writing useful Haskell code. They are hard to understand for beginners (especially once you bring <code>mtl</code> into the picture), and they have subtleties that even experts don’t follow. It has been my goal for a little while to “close the book” on effects in Haskell, so to speak—I’d love for us to have a solution that we can recommend to people instead of monad transformers, without serious caveats. We’re not there yet, but I think the existing work is useful (and I’m very optimistic about my current approach).</p></div></div></div><div class="comment"><a class="avatar"><img src="https://www.gravatar.com/avatar/3d24a4100b3eab34d8ce3059d789c543"></a><div class="content"><a class="author">Sandy Maguire</a><div class="metadata"><a href="#186418271" name="186418271"><div>2020-01-23 18:18:59</div></a></div><div class="text"><p>it's a hard problem. in the meantime i'm just going to sit here and work on my own little programs</p></div></div></div><div class="comment"><a class="avatar"><img src="https://www.gravatar.com/avatar/c03b8d34978563858020eff0d14cc17b"></a><div class="content"><a class="author">Alexis King</a><div class="metadata"><a href="#186418385" name="186418385"><div>2020-01-23 18:19:54</div></a></div><div class="text"><p><span class="user-mention" data-user-id="251120">@Sandy Maguire</span> You might be interested in some of my recent efforts… I’ve gone in a different direction from when we last talked about it.</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/20a04d823b7c3891d78ca5f6a188ccd0e4fc5e3d?version=2"></a><div class="content"><a class="author">TheMatten</a><div class="metadata"><a href="#186418536" name="186418536"><div>2020-01-23 18:21:14</div></a></div><div class="text"><p><span class="user-mention" data-user-id="251362">@Alexis King</span> I've followed your twitter and <code>eff/delimited-control</code> - you mentioned that this would be probably better with specific language support if I remember right - are there some updates on that?</p></div></div></div><div class="comment"><a class="avatar"><img src="https://www.gravatar.com/avatar/c03b8d34978563858020eff0d14cc17b"></a><div class="content"><a class="author">Alexis King</a><div class="metadata"><a href="#186418769" name="186418769"><div>2020-01-23 18:23:31</div></a></div><div class="text"><p>I think language support would definitely help to make things absolutely ideal, but I’m optimistic about where things have been going. I’ve been restructuring that branch a little in my spare time (though the going has been slow, since I haven’t had very much spare time!) to fix an issue with state and captured continuations, but the core approach works. Most of the difficulty is figuring out how to represent everything as efficiently as possible, but to be honest I’d bet some of what I’m doing is microoptimizations at this point. I just want to get it right!</p></div></div></div><div class="comment"><a class="avatar"><img src="https://www.gravatar.com/avatar/c03b8d34978563858020eff0d14cc17b"></a><div class="content"><a class="author">Alexis King</a><div class="metadata"><a href="#186418871" name="186418871"><div>2020-01-23 18:24:37</div></a></div><div class="text"><p>The current implementation I have is essentially an implementation of a virtual machine that supports delimited control, as an embedded DSL in Haskell. It’s been fun—I don’t get to munge about with low-level things in Haskell very often. :)</p></div></div></div><div class="comment"><a class="avatar"><img src="https://www.gravatar.com/avatar/3d24a4100b3eab34d8ce3059d789c543"></a><div class="content"><a class="author">Sandy Maguire</a><div class="metadata"><a href="#186418968" name="186418968"><div>2020-01-23 18:25:59</div></a></div><div class="text"><p>coooool</p></div></div></div><div class="comment"><a class="avatar"><img src="https://www.gravatar.com/avatar/3d24a4100b3eab34d8ce3059d789c543"></a><div class="content"><a class="author">Sandy Maguire</a><div class="metadata"><a href="#186419037" name="186419037"><div>2020-01-23 18:26:19</div></a></div><div class="text"><p>(fwiw i'm pretty much off of the haskell scene these days)</p></div></div></div><div class="comment"><a class="avatar"><img src="https://www.gravatar.com/avatar/3d24a4100b3eab34d8ce3059d789c543"></a><div class="content"><a class="author">Sandy Maguire</a><div class="metadata"><a href="#186419055" name="186419055"><div>2020-01-23 18:26:32</div></a></div><div class="text"><p>my activity in this channel over the last hour is the most i've been engaged in the community in like two months</p></div></div></div><div class="comment"><a class="avatar"><img src="https://www.gravatar.com/avatar/c03b8d34978563858020eff0d14cc17b"></a><div class="content"><a class="author">Alexis King</a><div class="metadata"><a href="#186419115" name="186419115"><div>2020-01-23 18:27:19</div></a></div><div class="text"><p>Haha, I know what that’s like. I certainly don’t have any expectations of work from you! ;)</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/20a04d823b7c3891d78ca5f6a188ccd0e4fc5e3d?version=2"></a><div class="content"><a class="author">TheMatten</a><div class="metadata"><a href="#186419138" name="186419138"><div>2020-01-23 18:27:31</div></a></div><div class="text"><p>Oh, nice - I'm super excited about what comes out of it. Thanks for your hard work! <span aria-label="slight smile" class="emoji emoji-1f642" role="img" title="slight smile">:slight_smile:</span> <br>
Over at <a class="stream" data-stream-id="216942" href="/#narrow/stream/216942-Polysemy">#Polysemy</a> we're discussing project "roadmap" - it seems like we've settled down on an idea that "we want to replace <code>Weaving</code> at some point" - if <code>eff</code> can provide some better model, it may be interesting to consider it for some bigger version bump in the future <span aria-label="slight smile" class="emoji emoji-1f642" role="img" title="slight smile">:slight_smile:</span></p></div></div></div><div class="comment"><a class="avatar"><img src="https://www.gravatar.com/avatar/c03b8d34978563858020eff0d14cc17b"></a><div class="content"><a class="author">Alexis King</a><div class="metadata"><a href="#186419257" name="186419257"><div>2020-01-23 18:28:26</div></a></div><div class="text"><p>But yes… evaluating performance is challenging because we don’t have very many good benchmarks for this sort of thing, but I am positive for several reasons. I expect performance to be very good, significantly better than the free/freer encodings, albeit not as fast as concrete transformers, especially for microbenchmarks (but quite possibly meaningfully faster than polymorphic mtl code!). And because it’s all based on delimited control, the semantics for scoping operations are a lot nicer than they are in mtl/polysemy/fused-effects, imo. And I think the interface is as nice as polysemy’s, and possibly nicer!</p></div></div></div><div class="comment"><a class="avatar"><img src="https://www.gravatar.com/avatar/c03b8d34978563858020eff0d14cc17b"></a><div class="content"><a class="author">Alexis King</a><div class="metadata"><a href="#186419480" name="186419480"><div>2020-01-23 18:30:21</div></a></div><div class="text"><p>The big downside to the approach is that you can’t really just slam in arbitrary scoped operations that want to live in IO, or in some other monad transformer stack. Algebraic operations are fine, and I’m pretty confident that I can get exceptions/bracketing working and all that good stuff, but it won’t interop nicely with everything else; you’ll have to do manual work to connect the universes.</p></div></div></div><div class="comment"><a class="avatar"><img src="https://www.gravatar.com/avatar/c03b8d34978563858020eff0d14cc17b"></a><div class="content"><a class="author">Alexis King</a><div class="metadata"><a href="#186419667" name="186419667"><div>2020-01-23 18:32:17</div></a></div><div class="text"><p>One of the reasons this has been so much fun to work on is I’m doing all kinds of unsafe nonsense under the covers, but I’m trying to make it all internally type safe as much as possible, even if theoretically I could do it without all that safety and still provide a safe interface. So I’ve been getting to apply various evil tricks. :)</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/20a04d823b7c3891d78ca5f6a188ccd0e4fc5e3d?version=2"></a><div class="content"><a class="author">TheMatten</a><div class="metadata"><a href="#186420087" name="186420087"><div>2020-01-23 18:36:33</div></a></div><div class="text"><p>When it comes to some observations from <code>polysemy</code> 's UX - semantics should be less confusing and there should be easier, syntactically cheap and "safe" way to differentiate different members with same underlying effect (to replace <code>Tagged</code>)</p></div></div></div><div class="comment"><a class="avatar"><img src="https://www.gravatar.com/avatar/c03b8d34978563858020eff0d14cc17b"></a><div class="content"><a class="author">Alexis King</a><div class="metadata"><a href="#186420123" name="186420123"><div>2020-01-23 18:37:15</div></a></div><div class="text"><p>The basic idea is that the virtual machine maintains an explicit stack of “metacontinuation frames,” which is literally a mutable stack (represented as a SmallMutableArray# under the hood), and running a handler pushes a frame onto the stack (which gets popped after the handler returns). This approach gives both really good time complexity <em>and</em> really good constant factors for all the common operations. <code>send</code> just involves a couple pointer lookups and a function call. <code>handle</code> just involves allocating a small bit of memory for the stack frame and writing a pointer to it into the mutable array. Operations that don’t need to muck about with the continuation or just need to <code>abort</code> are basically free. Capturing a continuation is more expensive in the general case, but I think I can provide a fast path for what seems to be the most common cases.</p></div></div></div><div class="comment"><a class="avatar"><img src="https://www.gravatar.com/avatar/c03b8d34978563858020eff0d14cc17b"></a><div class="content"><a class="author">Alexis King</a><div class="metadata"><a href="#186420293" name="186420293"><div>2020-01-23 18:39:28</div></a></div><div class="text"><p>One of the really nice things about this approach is that its performance doesn’t depend on the GHC optimizer at all: it’s just fundamentally fast. This is a little bit of a two-edged sword because it means that GHC <em>can’t</em> optimize away the dispatch completely (GHC has no idea how to see through all this stuff), which looks bad for extremely contrived microbenchmarks, but I think it essentially never matters for real programs.</p></div></div></div><div class="comment"><a class="avatar"><img src="https://www.gravatar.com/avatar/c03b8d34978563858020eff0d14cc17b"></a><div class="content"><a class="author">Alexis King</a><div class="metadata"><a href="#186420460" name="186420460"><div>2020-01-23 18:41:16</div></a></div><div class="text"><p>Theoretically a compiler plugin could add a custom optimization pass to do cleverer specialization, but I’m pretty sure that would be totally overkill. I don’t have numbers yet, but I’m betting this approach will do very well compared to all existing effect systems, including polymorphic mtl code. :)</p></div></div></div><div class="comment"><a class="avatar"><img src="https://www.gravatar.com/avatar/c03b8d34978563858020eff0d14cc17b"></a><div class="content"><a class="author">Alexis King</a><div class="metadata"><a href="#186420654" name="186420654"><div>2020-01-23 18:43:29</div></a></div><div class="text"><p>It turns out that 100% of the implementation subtlety comes from nontrivial cases of continuation capture and restore, which probably isn’t shocking, since that’s the most complicated part. Operations that invoke the continuation immediately (like <code>ask</code>) are trivial, as are operations that just abort (like <code>catch</code>). But operations that capture the continuation, extend it somehow, and then invoke it (like <code>NonDet</code>’s <code>&lt;|&gt;</code>) are the subtle case.</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/20a04d823b7c3891d78ca5f6a188ccd0e4fc5e3d?version=2"></a><div class="content"><a class="author">TheMatten</a><div class="metadata"><a href="#186420774" name="186420774"><div>2020-01-23 18:44:37</div></a></div><div class="text"><p><span class="user-mention" data-user-id="251362">@Alexis King</span> Are there some resources on idea of metacontinuations? I have basic idea about lisp-style continuations, but wasn't able to find that much on the former.<br>
Premise of "free-style" effect systems was that can be optimized out to underlying operations at compile-time - do you think it's not really possible to accomplish this in general, across module boundaries?</p></div></div></div><div class="comment"><a class="avatar"><img src="https://www.gravatar.com/avatar/c03b8d34978563858020eff0d14cc17b"></a><div class="content"><a class="author">Alexis King</a><div class="metadata"><a href="#186421142" name="186421142"><div>2020-01-23 18:48:15</div></a></div><div class="text"><p>I asked Matthew Flatt, the primary developer of the Racket runtime, about pointers for efficiently implementing delimited control. He pointed me to metacontinuations, specifically the explanation in “Final Shift for call/cc: a Direct Implementation of Shift and Reset.” Amusingly, that paper is actually about <em>not</em> using metacontinuations, but the introduction provides the best explanation of what they are that I’ve been able to find in the literature. The paper ignores a lot of subtleties, like adding support for tagged prompts, but the core ideas are all there, and I was able to work up to a more general implementation from that starting point. (My implementation is actually unlike any other implementation of delimited control I know of because it’s tailored in certain ways to an effect system, but the core implementation technique is still metacontinuations.)</p></div></div></div><div class="comment"><a class="avatar"><img src="https://www.gravatar.com/avatar/4ba4faf2fc5818d37c0aed6acb5b69a2"></a><div class="content"><a class="author">James King</a><div class="metadata"><a href="#186421198" name="186421198"><div>2020-01-23 18:49:03</div></a></div><div class="text"><blockquote>
<p>One of the reasons this has been so much fun to work on is I’m doing all kinds of unsafe nonsense under the covers, but I’m trying to make it all internally type safe as much as possible, even if theoretically I could do it without all that safety and still provide a safe interface. So I’ve been getting to apply various evil tricks. :)</p>
</blockquote>
<p>This is why I find type theory is such a good tool for reasoning about computers. There's some work going on over in the Lean VM that is using quotient types over sets to prove that unsafe mutation of memory "under the hood" is safe which can lead to some significant performance improvements.</p></div></div></div><div class="comment"><a class="avatar"><img src="https://www.gravatar.com/avatar/c03b8d34978563858020eff0d14cc17b"></a><div class="content"><a class="author">Alexis King</a><div class="metadata"><a href="#186421557" name="186421557"><div>2020-01-23 18:52:38</div></a></div><div class="text"><blockquote>
<p>Premise of "free-style" effect systems was that can be optimized out to underlying operations at compile-time - do you think it's not really possible to accomplish this in general, across module boundaries?</p>
</blockquote>
<p>I think it really depends on what you mean. The approach I have right now is basically a “free style” approach from the POV of its public interface; it works very much like the <code>polysemy</code> interface does. And that approach has a really fast implementation of dispatch, so under some definition it’s “optimized out to underlying operations.” However, it <em>doesn’t</em> let GHC inline concrete implementations of those operations, which is normally not a big deal, but there are a few cases where it could provide significant speedups, such as introducing a local <code>State</code> effect that could be optimized into a tight loop.</p>
<p>I think specializing effects across module boundaries is hopeless and honestly not worth pursuing. It’s unlikely to get you very much. One of the key points of <code>eff</code>’s new implementation is that <code>&gt;&gt;=</code> <em>always</em> gets specialized, so you don’t need cross-module specialization for that. Specializing effects within a single module is more reasonable, and I think that <em>is</em> possible, but I don’t think it’s possible to do with <code>RULES</code> alone, so I think you’d probably need a compiler plugin (or support in GHC).</p></div></div></div><div class="comment"><a class="avatar"><img src="https://www.gravatar.com/avatar/c03b8d34978563858020eff0d14cc17b"></a><div class="content"><a class="author">Alexis King</a><div class="metadata"><a href="#186421815" name="186421815"><div>2020-01-23 18:55:07</div></a></div><div class="text"><p>One way to think of my implementation is as an aggressively final encoding of the free-style interface. :)</p></div></div></div><div class="comment"><a class="avatar"><img src="https://www.gravatar.com/avatar/c03b8d34978563858020eff0d14cc17b"></a><div class="content"><a class="author">Alexis King</a><div class="metadata"><a href="#186422319" name="186422319"><div>2020-01-23 18:59:10</div></a></div><div class="text"><p>One of the main things that led me towards this implementation path was the realization that there’s just no way to get <code>&gt;&gt;=</code> to specialize with an approach based on polymorphic monad transformers, which really, really bites you in a lot of cases. GHC really wants to be able to see through <code>&gt;&gt;=</code> calls, since if you have a sequence of <code>&gt;&gt;=</code>s that don’t actually do any effectful operations (which happens often when using combinators or writing bits of glue code), GHC will just make those calls disappear.</p>
<p>We <em>really</em> want this, but you can’t get it with <code>mtl</code>-style constraints (which includes <code>fused-effects</code>) because <code>&gt;&gt;=</code> includes part of the implementation of each effect! This sucks incredibly hard, because GHC has to make an unknown call to <code>&gt;&gt;=</code> even if you do something like <code>pure x &gt;&gt;= f</code>, since GHC doesn’t take advantage of laws and doesn’t know what <code>&gt;&gt;=</code> will do. My new implementation takes care to ensure <code>&gt;&gt;=</code> is always inlined, so those patterns have zero cost, and even if you do use effectful operations, you still never have to make an unknown call to <code>&gt;&gt;=</code>.</p></div></div></div><div class="comment"><a class="avatar"><img src="https://www.gravatar.com/avatar/c03b8d34978563858020eff0d14cc17b"></a><div class="content"><a class="author">Alexis King</a><div class="metadata"><a href="#186422594" name="186422594"><div>2020-01-23 19:01:51</div></a></div><div class="text"><p>Something unfortunate about this approach is that it does still require CPSing the program (since it’s ultimately based on a continuation monad, albeit a continuation monad on steroids). That in and of itself isn’t a problem—GHC will still compile it to efficient code, since everything is a tail call by its nature—but it makes writing <code>RULE</code>s much more challenging. <code>RULE</code>s much prefer working on direct-style code.</p></div></div></div><div class="comment"><a class="avatar"><img src="https://www.gravatar.com/avatar/c03b8d34978563858020eff0d14cc17b"></a><div class="content"><a class="author">Alexis King</a><div class="metadata"><a href="#186422649" name="186422649"><div>2020-01-23 19:02:12</div></a></div><div class="text"><p>I haven’t really worried about that yet, though. Performance should be good even without any rewrite rules.</p></div></div></div><div class="comment"><a class="avatar"><img src="https://www.gravatar.com/avatar/4ba4faf2fc5818d37c0aed6acb5b69a2"></a><div class="content"><a class="author">James King</a><div class="metadata"><a href="#186422698" name="186422698"><div>2020-01-23 19:02:54</div></a></div><div class="text"><p>This is really cool, <span class="user-mention" data-user-id="251362">@Alexis King</span> -- thanks for sharing!</p></div></div></div><div class="comment"><a class="avatar"><img src="https://www.gravatar.com/avatar/c03b8d34978563858020eff0d14cc17b"></a><div class="content"><a class="author">Alexis King</a><div class="metadata"><a href="#186422752" name="186422752"><div>2020-01-23 19:03:33</div></a></div><div class="text"><p>Rather off-topic as “Boring Haskell” goes, I’ll admit. :)</p></div></div></div><div class="comment"><a class="avatar"><img src="https://www.gravatar.com/avatar/4ba4faf2fc5818d37c0aed6acb5b69a2"></a><div class="content"><a class="author">James King</a><div class="metadata"><a href="#186422964" name="186422964"><div>2020-01-23 19:05:43</div></a></div><div class="text"><p>All good. I'm going to get the process of archiving these chats out to the web working again.</p></div></div></div><div class="comment"><a class="avatar"><img src="https://www.gravatar.com/avatar/db5b03704c129196a4e9415e55413ce6"></a><div class="content"><a class="author">Ryan</a><div class="metadata"><a href="#186740913" name="186740913"><div>2020-01-28 00:22:01</div></a></div><div class="text"><p>Honestly I've been following your Twitter and the eff work, and I have no idea what any of it means or how it works but it looks absolutely amazing</p></div></div></div><div class="comment"><a class="avatar"><img src="https://www.gravatar.com/avatar/520889f20a2c66a8f4bd5be6f37d2923"></a><div class="content"><a class="author">Asad Saeeduddin</a><div class="metadata"><a href="#186747172" name="186747172"><div>2020-01-28 02:20:00</div></a></div><div class="text"><p>I added a big ole explanation in the README of <a href="https://github.com/masaeedu/monadoptics/" target="_blank" title="https://github.com/masaeedu/monadoptics/">https://github.com/masaeedu/monadoptics/</a> just now, folks interested in effect systems might find some useful ideas in there</p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/masaeedu/monadoptics/" style="background-image: url(https://avatars3.githubusercontent.com/u/3674056?s=400&amp;v=4)" target="_blank"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/masaeedu/monadoptics/" target="_blank" title="masaeedu/monadoptics">masaeedu/monadoptics</a></div><div class="message_embed_description">Profunctor optics for the endofunctor category on Hask - masaeedu/monadoptics</div></div></div></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/20a04d823b7c3891d78ca5f6a188ccd0e4fc5e3d?version=2"></a><div class="content"><a class="author">TheMatten</a><div class="metadata"><a href="#186761656" name="186761656"><div>2020-01-28 08:27:18</div></a></div><div class="text"><p><span class="user-mention" data-user-id="225136">@Asad Saeeduddin</span> in that sense, interpreters are _simply_ type changing optics letting you access your effects? <span aria-label="big smile" class="emoji emoji-1f604" role="img" title="big smile">:big_smile:</span></p></div></div></div><div class="comment"><a class="avatar"><img src="https://www.gravatar.com/avatar/520889f20a2c66a8f4bd5be6f37d2923"></a><div class="content"><a class="author">Asad Saeeduddin</a><div class="metadata"><a href="#186814055" name="186814055"><div>2020-01-28 18:48:33</div></a></div><div class="text"><p><span class="user-mention" data-user-id="225127">@TheMatten</span> I ran out of steam before I got to that point, but it seems like a promising avenue of investigation</p></div></div></div><div class="comment"><a class="avatar"><img src="https://www.gravatar.com/avatar/3d24a4100b3eab34d8ce3059d789c543"></a><div class="content"><a class="author">Sandy Maguire</a><div class="metadata"><a href="#187069336" name="187069336"><div>2020-01-31 09:51:42</div></a></div><div class="text"><p>I did something crazy; mixing 3 layer cake with SYTC for easy mocking. <a href="https://github.com/TheMatten/first-class-instances/pull/1" target="_blank" title="https://github.com/TheMatten/first-class-instances/pull/1">https://github.com/TheMatten/first-class-instances/pull/1</a></p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/TheMatten/first-class-instances/pull/1" style="background-image: url(https://avatars0.githubusercontent.com/u/21198836?s=400&amp;v=4)" target="_blank"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/TheMatten/first-class-instances/pull/1" target="_blank" title="WIP: generate Mockable by isovector · Pull Request #1 · TheMatten/first-class-instances">WIP: generate Mockable by isovector · Pull Request #1 · TheMatten/first-class-instances</a></div><div class="message_embed_description">This thing lifts a class:
class Monad m =&gt; MonadFoo m where
  foo :: m Int
makeMockable &#39;&#39;MonadFoo
into the following:
type instance Inst (MonadFoo m_ar1R) = Dict (MonadFoo m_ar1R)

newt...</div></div></div></div></div></div><div class="comment"><a class="avatar"><img src="https://www.gravatar.com/avatar/3d24a4100b3eab34d8ce3059d789c543"></a><div class="content"><a class="author">Sandy Maguire</a><div class="metadata"><a href="#187069341" name="187069341"><div>2020-01-31 09:51:50</div></a></div><div class="text"><p><span class="user-mention" data-user-id="225136">@Asad Saeeduddin</span> you might be interested ^</p></div></div></div></div></div><div class="ui vertical footer segment"><a href="https://github.com/srid/zulip-archive">Powered by Haskell</a> | Questions? Contact <a href="https://www.srid.ca">srid</a></div></div></body></html>