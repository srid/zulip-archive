<html lang="en"><head><meta content="text/html; charset=utf-8" http-equiv="Content-Type"><meta content="width=device-width, initial-scale=1" name="viewport"><meta content="It seems to me that the forall s existential quantifier in runST is the linchpin that enforces sequential reads/writes in the ST monad, but I&#39;d like to hear other people&#39;s take on it. I wrote a blog post about it https://chrismwendt.github.io/blog/2018/03/02/what-if-run-st-did-not-use-existential-qu" name="description"><link href="https://funprog.srid.ca/haskell/runst.html" rel="canonical"><meta property="og:title" content="runST - Haskell"><meta property="og:site_name" content="Functional Programming Zulip Archive"><meta property="og:type" content="article"><meta property="og:article:section" content="Haskell"><meta property="og:article:modified_time" content="2020-05-23T19:55:33Z"><meta property="og:article:published_time" content="2020-05-20T20:32:29Z"><title>runST - Haskell</title><style type="text/css">
div#thesite
{
  font-family   : "Open Sans", sans-serif;
  font-size     : 1em !important;
  margin-top    : 1em;
  margin-bottom : 1em;
}

div#thesite h1
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite h2
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite h3
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite h4
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite h5
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite h6
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite .ui.breadcrumb.rib .section
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite .header
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite .as-header
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite code, pre, tt
{
  font-family : "SFMono-Regular","Menlo","Monaco","Consolas","Liberation Mono","Courier New", monospace;
}

div#thesite .ui.breadcrumb.rib
{
  margin-bottom : 1em;
}



div#thesite .ui.comments.messages .comment .metadata a
{
  color : #808080;
}

div#thesite .ui.comments.messages .comment a.avatar img
{
  height : auto;
}

div#thesite .subtle
{
  color : #808080;
}


div#thesite .messages pre
{
  font-size : 85%;
  overflow  : auto;
  max-width : 100%;
}

div#thesite .messages .message_embed
{
  border-left  : solid 3px #808080;
  padding-left : 0.69999em;
}

div#thesite .messages .message_inline_image img
{
  max-width     : 100%;
  margin-bottom : 1em;
}


/* Generated with Clay, http://fvisser.nl/clay */</style><link href="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.4.1/semantic.min.css" rel="stylesheet"><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/all.min.css" rel="stylesheet"><link href="https://fonts.googleapis.com/css?family=Open+Sans|Oswald&amp;display=swap" rel="stylesheet"><link href="https://fonts.googleapis.com/css?family=Roboto|Open+Sans&amp;display=swap" rel="stylesheet"></head><body><div id="thesite" class="ui text container"><div class="ui violet inverted top attached center aligned segment"><h1 class="ui huge header">runST - Haskell</h1></div><div class="ui attached segment"><div class="ui message"><p>Welcome to the Functional Programming Zulip Chat Archive. You can join the chat <a href="https://funprog.zulipchat.com">here</a>.</p></div><div class="ui breadcrumb rib"><a href="/" class="section">Home</a><i class="right angle icon divider"></i><a href="/haskell/" class="section">#Haskell</a><i class="right angle icon divider"></i><div class="active section">runST</div></div><div class="ui comments messages"><div class="comment"><a class="avatar"><img src="https://www.gravatar.com/avatar/7c6c8647784cae80af5f575103af4c7e"></a><div class="content"><a class="author">Chris Wendt</a><div class="metadata"><a href="#198253553" name="198253553"><div>2020-05-20 20:32:29</div></a></div><div class="text"><p>It seems to me that the <code>forall s</code> existential quantifier in <code>runST</code> is the linchpin that enforces sequential reads/writes in the <code>ST</code> monad, but I'd like to hear other people's take on it. I wrote a blog post about it <a href="https://chrismwendt.github.io/blog/2018/03/02/what-if-run-st-did-not-use-existential-quantification.html">https://chrismwendt.github.io/blog/2018/03/02/what-if-run-st-did-not-use-existential-quantification.html</a> Is this a useful way to view it? Are there any glaring problems with looking at it this way?</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/20a04d823b7c3891d78ca5f6a188ccd0e4fc5e3d?x=x&amp;version=2"></a><div class="content"><a class="author">TheMatten</a><div class="metadata"><a href="#198290433" name="198290433"><div>2020-05-21 06:27:47</div></a></div><div class="text"><p>I would say common explanation is that existential <code>s</code> prohibits you from using one <code>STRef</code> in multiple instances of <code>runST</code> - so you could try to run those <code>ST</code> actions in separate <code>runST</code>s, but you wouldn't have any <code>STRef</code> to pass to them</p></div></div></div><div class="comment"><a class="avatar"><img src="https://www.gravatar.com/avatar/8ef57fb003fa77943fbaa003b17d7f2e"></a><div class="content"><a class="author">Peter Kjeld Andersen</a><div class="metadata"><a href="#198419991" name="198419991"><div>2020-05-22 09:03:24</div></a></div><div class="text"><p>I've been confused by how <code>runST</code> works this week actually. It throws an error when I try this in the repl:</p>
<div class="codehilite"><pre><span></span><code><span class="nf">λ</span><span class="o">&gt;</span> <span class="kt">:</span><span class="kr">type</span> <span class="nf">\</span><span class="n">m</span> <span class="n">k</span> <span class="ow">-&gt;</span> <span class="n">runST</span> <span class="o">$</span> <span class="n">m</span> <span class="o">&gt;&gt;=</span> <span class="n">k</span>
<span class="o">&lt;</span><span class="n">interactive</span><span class="o">&gt;:</span><span class="mi">1</span><span class="kt">:</span><span class="mi">23</span><span class="kt">:</span> <span class="ne">error</span><span class="kt">:</span>
    <span class="err">•</span> <span class="kt">Couldn&#39;t</span> <span class="n">match</span> <span class="n">expected</span> <span class="kr">type</span> <span class="err">‘</span><span class="n">a0</span> <span class="ow">-&gt;</span> <span class="kt">ST</span> <span class="n">s</span> <span class="n">a</span><span class="err">’</span> <span class="n">with</span> <span class="n">actual</span> <span class="kr">type</span> <span class="err">‘</span><span class="n">p1</span><span class="err">’</span>
        <span class="n">because</span> <span class="kr">type</span> <span class="n">variable</span> <span class="err">‘</span><span class="n">s</span><span class="err">’</span> <span class="n">would</span> <span class="n">escape</span> <span class="n">its</span> <span class="n">scope</span>
</code></pre></div>


<p>And if I feed it a function (say <code>initMV</code>) for that <code>m</code> that returns <code>ST s (MV.MVector s SomeUnboxType)</code>, it still  complains:</p>
<div class="codehilite"><pre><span></span><code><span class="nf">λ</span><span class="o">&gt;</span> <span class="kt">:</span><span class="kr">type</span> <span class="nf">\</span><span class="n">k</span> <span class="ow">-&gt;</span> <span class="n">runST</span> <span class="o">$</span> <span class="n">initMV</span> <span class="o">&gt;&gt;=</span> <span class="n">k</span>

<span class="o">&lt;</span><span class="n">interactive</span><span class="o">&gt;:</span><span class="mi">1</span><span class="kt">:</span><span class="mi">60</span><span class="kt">:</span> <span class="ne">error</span><span class="kt">:</span>
    <span class="err">•</span> <span class="kt">Couldn&#39;t</span> <span class="n">match</span> <span class="n">expected</span> <span class="kr">type</span> <span class="err">‘</span><span class="kt">MV</span><span class="o">.</span><span class="kt">MVector</span> <span class="n">s</span> <span class="kt">SomeUnboxType</span> <span class="ow">-&gt;</span> <span class="kt">ST</span> <span class="n">s</span> <span class="n">a</span><span class="err">’</span>
                  <span class="n">with</span> <span class="n">actual</span> <span class="kr">type</span> <span class="err">‘</span><span class="n">p</span><span class="err">’</span>
        <span class="n">because</span> <span class="kr">type</span> <span class="n">variable</span> <span class="err">‘</span><span class="n">s</span><span class="err">’</span> <span class="n">would</span> <span class="n">escape</span> <span class="n">its</span> <span class="n">scope</span>
</code></pre></div>


<p>but if I replace the <code>k</code> with something a simple as <code>V.freeze</code> there are no problems at all:</p>
<div class="codehilite"><pre><span></span><code><span class="nf">λ</span><span class="o">&gt;</span> <span class="kt">:</span><span class="kr">type</span> <span class="n">runST</span> <span class="o">$</span> <span class="n">initMV</span>  <span class="o">&gt;&gt;=</span> <span class="kt">V</span><span class="o">.</span><span class="n">freeze</span>
<span class="nf">runST</span> <span class="o">$</span> <span class="n">initMV</span>  <span class="o">&gt;&gt;=</span> <span class="kt">V</span><span class="o">.</span><span class="n">freeze</span> <span class="ow">::</span> <span class="kt">V</span><span class="o">.</span><span class="kt">Vector</span> <span class="kt">SomeUnboxType</span>
</code></pre></div>


<p>what's GHC struggling with exactly?</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/20a04d823b7c3891d78ca5f6a188ccd0e4fc5e3d?x=x&amp;version=2"></a><div class="content"><a class="author">TheMatten</a><div class="metadata"><a href="#198420848" name="198420848"><div>2020-05-22 09:14:22</div></a></div><div class="text"><p>It may be trying avoid unifying some external variable (I guess it infers <code>k :: p1</code>from lambda) with type that contains existential, because it's not sure whether it could be used outside of proper scope (<code>runST</code>) that way, thus "escaping"? But when you use <code>freeze</code>, it's type is filled in inside of <code>runST</code> call, so it should be fine?</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/20a04d823b7c3891d78ca5f6a188ccd0e4fc5e3d?x=x&amp;version=2"></a><div class="content"><a class="author">TheMatten</a><div class="metadata"><a href="#198420932" name="198420932"><div>2020-05-22 09:15:54</div></a></div><div class="text"><p><code>p1</code> "lives longer" than <code>s</code>, so unifying with it would be bad - try giving <code>k</code> binding as concrete annotation as possible (or use type signature)</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/20a04d823b7c3891d78ca5f6a188ccd0e4fc5e3d?x=x&amp;version=2"></a><div class="content"><a class="author">TheMatten</a><div class="metadata"><a href="#198421035" name="198421035"><div>2020-05-22 09:17:55</div></a></div><div class="text"><p>(That is, something like <code>forall s. something -&gt; ST s somethingElse</code>)</p></div></div></div><div class="comment"><a class="avatar"><img src="https://www.gravatar.com/avatar/8ef57fb003fa77943fbaa003b17d7f2e"></a><div class="content"><a class="author">Peter Kjeld Andersen</a><div class="metadata"><a href="#198431882" name="198431882"><div>2020-05-22 11:42:12</div></a></div><div class="text"><div class="codehilite"><pre><span></span><code><span class="nf">λ</span><span class="o">&gt;</span> <span class="kt">:</span><span class="kr">type</span> <span class="nf">\</span><span class="p">(</span><span class="n">k</span> <span class="ow">::</span> <span class="n">forall</span> <span class="n">s</span><span class="o">.</span> <span class="kt">MV</span><span class="o">.</span><span class="kt">MVector</span> <span class="n">s</span> <span class="kt">SomeUnboxType</span> <span class="ow">-&gt;</span> <span class="kt">ST</span> <span class="n">s</span> <span class="n">somethingElse</span><span class="p">)</span> <span class="ow">-&gt;</span> <span class="n">runST</span> <span class="o">$</span> <span class="n">initMV</span> <span class="o">&gt;&gt;=</span> <span class="n">k</span>
</code></pre></div>


<p>Yeah that works with <code>RankNTypes</code> on.</p>
<p>But at that stage I guess you already know the structure of the types for your function and it's not as useful for getting to that point as <code>λ&gt; :type \mv k -&gt; runST $ mv &gt;&gt;= k</code> would have been if that could have told you some information about the types of <code>mv</code> and <code>k</code>.</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/20a04d823b7c3891d78ca5f6a188ccd0e4fc5e3d?x=x&amp;version=2"></a><div class="content"><a class="author">TheMatten</a><div class="metadata"><a href="#198440042" name="198440042"><div>2020-05-22 13:20:47</div></a></div><div class="text"><p>You could use typed holes instead of bindings:</p>
<div class="codehilite"><pre><span></span><code>λ&gt; :t runST $ _mv &gt;&gt;= _k

&lt;interactive&gt;:1:9: error:
    • Found hole: _mv :: ST s a0
      Where: ‘a0’ is an ambiguous type variable
             ‘s’ is a rigid type variable bound by
               a type expected by the context:
                 forall s. ST s a
               at &lt;interactive&gt;:1:9-18
      Or perhaps ‘_mv’ is mis-spelled, or not in scope
    • In the first argument of ‘(&gt;&gt;=)’, namely ‘_mv’
      In the second argument of ‘($)’, namely ‘_mv &gt;&gt;= _k’
      In the expression: runST $ _mv &gt;&gt;= _k

&lt;interactive&gt;:1:17: error:
    • Found hole: _k :: a0 -&gt; ST s a
      Where: ‘a0’ is an ambiguous type variable
             ‘s’ is a rigid type variable bound by
               a type expected by the context:
                 forall s. ST s a
               at &lt;interactive&gt;:1:9-18
             ‘a’ is a rigid type variable bound by
               the inferred type of it :: a
               at &lt;interactive&gt;:1:1
      Or perhaps ‘_k’ is mis-spelled, or not in scope
    • In the second argument of ‘(&gt;&gt;=)’, namely ‘_k’
      In the second argument of ‘($)’, namely ‘_mv &gt;&gt;= _k’
      In the expression: runST $ _mv &gt;&gt;= _k
    • Valid hole fits include
        fixST :: forall a s. (a -&gt; ST s a) -&gt; ST s a
          with fixST @a @s
          (imported from ‘Control.Monad.ST’
           (and originally defined in ‘base-4.14.0.0:Control.Monad.ST.Imp’))
        return :: forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
          with return @(ST s) @a
          (imported from ‘Prelude’ (and originally defined in ‘GHC.Base’))
        fail :: forall (m :: * -&gt; *) a. MonadFail m =&gt; String -&gt; m a
          with fail @(ST s) @a
          (imported from ‘Prelude’
           (and originally defined in ‘Control.Monad.Fail’))
        pure :: forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
          with pure @(ST s) @a
          (imported from ‘Prelude’ (and originally defined in ‘GHC.Base’))
        id :: forall a. a -&gt; a
          with id @(ST s a)
          (imported from ‘Prelude’ (and originally defined in ‘GHC.Base’))
        head :: forall a. [a] -&gt; a
          with head @(ST s a)
          (imported from ‘Prelude’ (and originally defined in ‘GHC.List’))
        (Some hole fits suppressed; use -fmax-valid-hole-fits=N or -fno-max-valid-hole-fits)
</code></pre></div>


<p>It even tells you what "fits" there</p></div></div></div><div class="comment"><a class="avatar"><img src="https://www.gravatar.com/avatar/7c6c8647784cae80af5f575103af4c7e"></a><div class="content"><a class="author">Chris Wendt</a><div class="metadata"><a href="#198486982" name="198486982"><div>2020-05-22 19:49:24</div></a></div><div class="text"><p>This seems close, but still isn't well-typed "Couldn't match type ‘s’ with ‘s0’":</p>
<div class="codehilite"><pre><span></span><code><span class="nf">x</span> <span class="ow">::</span> <span class="p">(</span><span class="n">forall</span> <span class="n">s</span><span class="o">.</span> <span class="p">(</span><span class="kt">ST</span> <span class="n">s</span> <span class="n">a</span><span class="p">,</span> <span class="n">a</span> <span class="ow">-&gt;</span> <span class="kt">ST</span> <span class="n">s</span> <span class="nb">()</span><span class="p">))</span> <span class="ow">-&gt;</span> <span class="nb">()</span>
<span class="nf">x</span> <span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="ow">=</span> <span class="n">runST</span> <span class="o">$</span> <span class="n">m</span> <span class="o">&gt;&gt;=</span> <span class="n">k</span>
</code></pre></div></div></div></div><div class="comment"><a class="avatar"><img src="https://www.gravatar.com/avatar/7c6c8647784cae80af5f575103af4c7e"></a><div class="content"><a class="author">Chris Wendt</a><div class="metadata"><a href="#198487218" name="198487218"><div>2020-05-22 19:51:14</div></a></div><div class="text"><p>If that were well-typed, I think you could replace <code>a</code> with <code>f s</code> to support passing <code>STRef</code>s from <code>m</code> to <code>k</code>:</p>
<div class="codehilite"><pre><span></span><code><span class="nf">x</span> <span class="ow">::</span> <span class="p">(</span><span class="n">forall</span> <span class="n">s</span><span class="o">.</span> <span class="p">(</span><span class="kt">ST</span> <span class="n">s</span> <span class="p">(</span><span class="n">f</span> <span class="n">s</span><span class="p">),</span> <span class="n">f</span> <span class="n">s</span> <span class="ow">-&gt;</span> <span class="kt">ST</span> <span class="n">s</span> <span class="nb">()</span><span class="p">))</span> <span class="ow">-&gt;</span> <span class="nb">()</span>
<span class="nf">x</span> <span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="ow">=</span> <span class="n">runST</span> <span class="o">$</span> <span class="n">m</span> <span class="o">&gt;&gt;=</span> <span class="n">k</span>
</code></pre></div></div></div></div><div class="comment"><a class="avatar"><img src="https://www.gravatar.com/avatar/7c6c8647784cae80af5f575103af4c7e"></a><div class="content"><a class="author">Chris Wendt</a><div class="metadata"><a href="#198549410" name="198549410"><div>2020-05-23 19:55:33</div></a></div><div class="text"><p><span class="user-mention" data-user-id="256774">@Peter Kjeld Andersen</span> I think I solved it with the help of <span class="user-mention" data-user-id="225127">@TheMatten</span> </p>
<div class="codehilite"><pre><span></span><code><span class="kr">data</span> <span class="kt">F</span> <span class="n">a</span> <span class="n">s</span> <span class="ow">=</span> <span class="kt">F</span> <span class="p">(</span><span class="kt">STRef</span> <span class="n">s</span> <span class="n">a</span><span class="p">)</span>
<span class="nf">unF</span> <span class="p">(</span><span class="kt">F</span> <span class="n">f</span><span class="p">)</span> <span class="ow">=</span> <span class="n">f</span>

<span class="nf">y</span> <span class="ow">::</span> <span class="p">(</span><span class="n">forall</span> <span class="n">s</span><span class="o">.</span> <span class="p">(</span><span class="kt">ST</span> <span class="n">s</span> <span class="p">(</span><span class="n">f</span> <span class="n">s</span><span class="p">),</span> <span class="p">(</span><span class="n">f</span> <span class="n">s</span><span class="p">)</span> <span class="ow">-&gt;</span> <span class="kt">ST</span> <span class="n">s</span> <span class="n">b</span><span class="p">))</span> <span class="ow">-&gt;</span> <span class="n">b</span>
<span class="nf">y</span> <span class="n">t</span> <span class="ow">=</span> <span class="n">runST</span> <span class="o">$</span> <span class="kr">let</span> <span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="ow">=</span> <span class="n">t</span> <span class="kr">in</span> <span class="n">m</span> <span class="o">&gt;&gt;=</span> <span class="n">k</span>

<span class="nf">useit</span> <span class="ow">=</span> <span class="n">y</span> <span class="p">(</span><span class="kt">F</span> <span class="o">&lt;$&gt;</span> <span class="n">newSTRef</span> <span class="sc">&#39;c&#39;</span><span class="p">,</span> <span class="n">readSTRef</span> <span class="o">.</span> <span class="n">unF</span><span class="p">)</span>
</code></pre></div>


<p>Instead of <code>F (STRef s a)</code>, you'd probably use something like <code>Flip p a b</code>, but it seems like this would be extremely cumbersome to use <span aria-label="oh no" class="emoji emoji-1f615" role="img" title="oh no">:oh_no:</span></p></div></div></div></div></div><div class="ui vertical footer segment"><a href="https://github.com/srid/zulip-archive">Powered by Haskell</a> | Questions? Contact <a href="https://www.srid.ca">srid</a></div></div></body></html>