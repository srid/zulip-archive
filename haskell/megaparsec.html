<html lang="en"><head><meta content="text/html; charset=utf-8" http-equiv="Content-Type"><meta content="width=device-width, initial-scale=1" name="viewport"><meta content="Anyone have an example project (with source) that has Megaparsec parsers that preserve comments in their structure? Trying to find a way to avoid doing something like
data ADTPiece
    = ADTPieceX (Either Comment X)
    | ADTPieceY (Either Comment Y)
data ADT = ADT [ADTPiece]



Notice: order is pre" name="description"><link href="https://funprog.srid.ca/haskell/megaparsec.html" rel="canonical"><meta property="og:title" content="Megaparsec - Haskell"><meta property="og:site_name" content="Functional Programming Zulip Archive"><meta property="og:type" content="article"><meta property="og:article:section" content="Haskell"><meta property="og:article:modified_time" content="2020-05-10T18:54:37Z"><meta property="og:article:published_time" content="2020-05-10T00:24:53Z"><meta property="og:image" content="https://secure.gravatar.com/avatar/753f1ed8a3523d8eda77225f71d65cee?d=identicon&amp;version=1"><title>Megaparsec - Haskell</title><style type="text/css">
div#thesite
{
  font-family   : "Open Sans", sans-serif;
  font-size     : 1em !important;
  margin-top    : 1em;
  margin-bottom : 1em;
}

div#thesite h1
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite h2
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite h3
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite h4
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite h5
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite h6
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite .ui.breadcrumb.rib .section
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite .header
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite .as-header
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite code, pre, tt
{
  font-family : "SFMono-Regular","Menlo","Monaco","Consolas","Liberation Mono","Courier New", monospace;
}

div#thesite .ui.breadcrumb.rib
{
  margin-bottom : 1em;
}



div#thesite .ui.comments.messages .comment .metadata a
{
  color : #808080;
}

div#thesite .ui.comments.messages .comment a.avatar img
{
  height : auto;
}

div#thesite .subtle
{
  color : #808080;
}


div#thesite .messages pre
{
  font-size : 85%;
  overflow  : auto;
  max-width : 100%;
}

div#thesite .messages .message_embed
{
  border-left  : solid 3px #808080;
  padding-left : 0.69999em;
}

div#thesite .messages .message_inline_image img
{
  max-width     : 100%;
  margin-bottom : 1em;
}


/* Generated with Clay, http://fvisser.nl/clay */</style><link href="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.4.1/semantic.min.css" rel="stylesheet"><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/all.min.css" rel="stylesheet"><link href="https://fonts.googleapis.com/css?family=Open+Sans|Oswald&amp;display=swap" rel="stylesheet"><link href="https://fonts.googleapis.com/css?family=Roboto|Open+Sans&amp;display=swap" rel="stylesheet"></head><body><div id="thesite" class="ui text container"><div class="ui violet inverted top attached center aligned segment"><h1 class="ui huge header">Megaparsec - Haskell</h1></div><div class="ui attached segment"><div class="ui message"><p>Welcome to the Functional Programming Zulip Chat Archive. You can join the chat <a href="https://funprog.zulipchat.com">here</a>.</p></div><div class="ui breadcrumb rib"><a href="/" class="section">Home</a><i class="right angle icon divider"></i><a href="/haskell/" class="section">#Haskell</a><i class="right angle icon divider"></i><div class="active section">Megaparsec</div></div><div class="ui comments messages"><div class="comment"><a class="avatar"><img src="https://secure.gravatar.com/avatar/753f1ed8a3523d8eda77225f71d65cee?d=identicon&amp;version=1"></a><div class="content"><a class="author">Adam Flott</a><div class="metadata"><a href="#197022726" name="197022726"><div>2020-05-10 00:24:53</div></a></div><div class="text"><p>Anyone have an example project (with source) that has Megaparsec parsers that preserve comments in their structure? Trying to find a way to avoid doing something like</p>
<div class="codehilite"><pre><span></span><code>data ADTPiece
    = ADTPieceX (Either Comment X)
    | ADTPieceY (Either Comment Y)
data ADT = ADT [ADTPiece]
</code></pre></div>


<p>Notice: order is preserved</p></div></div></div><div class="comment"><a class="avatar"><img src="https://secure.gravatar.com/avatar/753f1ed8a3523d8eda77225f71d65cee?d=identicon&amp;version=1"></a><div class="content"><a class="author">Adam Flott</a><div class="metadata"><a href="#197022833" name="197022833"><div>2020-05-10 00:27:19</div></a></div><div class="text"><p>Additionally, if I'm going to use Lexer's <code>lexeme</code> do I attach that to every parser or just from the top level?</p></div></div></div><div class="comment"><a class="avatar"><img src="https://secure.gravatar.com/avatar/0c2b1161102f87a1d710bb391f0d6fd0?d=identicon&amp;version=1"></a><div class="content"><a class="author">Simon Michael</a><div class="metadata"><a href="#197026009" name="197026009"><div>2020-05-10 01:42:09</div></a></div><div class="text"><p>I'm afraid I don't fully understand the question, but here's a real world example that might give ideas: <a href="https://github.com/simonmichael/hledger/blob/master/hledger-lib/Hledger/Data/Types.hs#L352" title="https://github.com/simonmichael/hledger/blob/master/hledger-lib/Hledger/Data/Types.hs#L352">https://github.com/simonmichael/hledger/blob/master/hledger-lib/Hledger/Data/Types.hs#L352</a>, <a href="https://github.com/simonmichael/hledger/blob/master/hledger-lib/Hledger/Read/JournalReader.hs#L686" title="https://github.com/simonmichael/hledger/blob/master/hledger-lib/Hledger/Read/JournalReader.hs#L686">https://github.com/simonmichael/hledger/blob/master/hledger-lib/Hledger/Read/JournalReader.hs#L686</a></p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/simonmichael/hledger/blob/master/hledger-lib/Hledger/Data/Types.hs#L352" style="background-image: url(https://avatars3.githubusercontent.com/u/10144?s=400&amp;v=4)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/simonmichael/hledger/blob/master/hledger-lib/Hledger/Data/Types.hs#L352" title="simonmichael/hledger">simonmichael/hledger</a></div><div class="message_embed_description">easy-to-use command-line/curses/web plaintext accounting tool; a modern and largely compatible Haskell rewrite of Ledger - simonmichael/hledger</div></div></div><div class="message_embed"><a class="message_embed_image" href="https://github.com/simonmichael/hledger/blob/master/hledger-lib/Hledger/Read/JournalReader.hs#L686" style="background-image: url(https://avatars3.githubusercontent.com/u/10144?s=400&amp;v=4)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/simonmichael/hledger/blob/master/hledger-lib/Hledger/Read/JournalReader.hs#L686" title="simonmichael/hledger">simonmichael/hledger</a></div><div class="message_embed_description">easy-to-use command-line/curses/web plaintext accounting tool; a modern and largely compatible Haskell rewrite of Ledger - simonmichael/hledger</div></div></div></div></div></div><div class="comment"><a class="avatar"><img src="https://secure.gravatar.com/avatar/753f1ed8a3523d8eda77225f71d65cee?d=identicon&amp;version=1"></a><div class="content"><a class="author">Adam Flott</a><div class="metadata"><a href="#197028001" name="197028001"><div>2020-05-10 02:36:58</div></a></div><div class="text"><p>Ha! I was just looking at hledger for inspiration....<br>
If my input looks like</p>
<div class="codehilite"><pre><span></span><code># outside comment
some_section {
    # a comment
    var1 = whatever
}
</code></pre></div>


<p>I'm not sure how to encode that... I want an ordered list of things. Eventually I want to fully parse and pretty print the input.</p></div></div></div><div class="comment"><a class="avatar"><img src="https://secure.gravatar.com/avatar/753f1ed8a3523d8eda77225f71d65cee?d=identicon&amp;version=1"></a><div class="content"><a class="author">Adam Flott</a><div class="metadata"><a href="#197028210" name="197028210"><div>2020-05-10 02:41:15</div></a></div><div class="text"><p>If I throw away the comments I have no problem, but instead I'm not sure how to preserve them in a data type. So that printing it <code>a comment</code> comes before <code>var1</code></p></div></div></div><div class="comment"><a class="avatar"><img src="https://secure.gravatar.com/avatar/1114fd8de67671f83d3a3ef7594b1950?d=identicon&amp;version=1"></a><div class="content"><a class="author">Georgi Lyubenov // googleson78</a><div class="metadata"><a href="#197041765" name="197041765"><div>2020-05-10 08:28:06</div></a></div><div class="text"><p><code>ghc</code> seems to take the approach of having a list of found comments along with their locations instead of directly attaching them to the AST:<br>
<a href="http://hackage.haskell.org/package/ghc-lib-parser-8.10.1.20200412/docs/Lexer.html#t:PState" title="http://hackage.haskell.org/package/ghc-lib-parser-8.10.1.20200412/docs/Lexer.html#t:PState">http://hackage.haskell.org/package/ghc-lib-parser-8.10.1.20200412/docs/Lexer.html#t:PState</a></p></div></div></div><div class="comment"><a class="avatar"><img src="https://secure.gravatar.com/avatar/1114fd8de67671f83d3a3ef7594b1950?d=identicon&amp;version=1"></a><div class="content"><a class="author">Georgi Lyubenov // googleson78</a><div class="metadata"><a href="#197042015" name="197042015"><div>2020-05-10 08:33:03</div></a></div><div class="text"><p><code>haskell-src-exts</code> seems to attach <code>[Comment]</code> to parse results via <code>Parseable</code> <br>
<a href="http://hackage.haskell.org/package/haskell-src-exts-1.10.2/docs/Language-Haskell-Exts-Parser.html" title="http://hackage.haskell.org/package/haskell-src-exts-1.10.2/docs/Language-Haskell-Exts-Parser.html">http://hackage.haskell.org/package/haskell-src-exts-1.10.2/docs/Language-Haskell-Exts-Parser.html</a></p></div></div></div><div class="comment"><a class="avatar"><img src="https://secure.gravatar.com/avatar/1114fd8de67671f83d3a3ef7594b1950?d=identicon&amp;version=1"></a><div class="content"><a class="author">Georgi Lyubenov // googleson78</a><div class="metadata"><a href="#197042238" name="197042238"><div>2020-05-10 08:37:40</div></a></div><div class="text"><p>I guess you can go</p>
<div class="codehilite"><pre><span></span><code><span class="kr">data</span> <span class="kt">CommentInfo</span>
<span class="kr">data</span> <span class="kt">Com</span> <span class="n">a</span> <span class="ow">=</span> <span class="kt">Com</span> <span class="n">a</span> <span class="kt">CommentInfo</span>
</code></pre></div>


<p>wrap everything in your ast in a <code>Com</code><br>
tokenise comments into <code>CommentInfo</code>s<br>
and then attach every <code>CommentInfo</code> to the next valid ast object during parsing?</p></div></div></div><div class="comment"><a class="avatar"><img src="https://secure.gravatar.com/avatar/0c2b1161102f87a1d710bb391f0d6fd0?d=identicon&amp;version=1"></a><div class="content"><a class="author">Simon Michael</a><div class="metadata"><a href="#197071960" name="197071960"><div>2020-05-10 18:54:37</div></a></div><div class="text"><p>Adam, here's how I handle a similar need in hledger. You'll see in my Transaction data type the tpreceding_comments field - that's where I'd store your "outside comment" (not yet implemented). And the tcomments field is where I'd store "a comment". The main thing is to design your data type to hold all the parts you care about, with a field for each one. Then you write your parser to parse and save each of those parts. (This is the dumb, obvious, no-lexer way, at least.)</p></div></div></div></div></div><div class="ui vertical footer segment"><a href="https://github.com/srid/zulip-archive">Powered by Haskell</a> | Questions? Contact <a href="https://www.srid.ca">srid</a></div></div></body></html>