<html lang="en"><head><meta content="text/html; charset=utf-8" http-equiv="Content-Type"><meta content="width=device-width, initial-scale=1" name="viewport"><meta content="Hi, I want to extract information out of a document parsed by pandoc and I am questioning my methods. At the moment I am using partial pattern matched in the Maybe monad to extract info, but this is quite tedious. For example  I know the first thing will be a headline 1 with the content of  My last " name="description"><link href="https://funprog.srid.ca/haskell/parsing-pandoc-documents.html" rel="canonical"><meta property="og:title" content="Parsing pandoc documents - Haskell"><meta property="og:site_name" content="Functional Programming Zulip Archive"><meta property="og:type" content="article"><meta property="og:article:section" content="Haskell"><meta property="og:article:modified_time" content="2020-03-06T23:44:46Z"><meta property="og:article:published_time" content="2020-03-06T10:55:27Z"><meta property="og:image" content="https://secure.gravatar.com/avatar/93ea3d19789047de293970e997237325?d=identicon&amp;version=1"><title>Parsing pandoc documents - Haskell</title><style type="text/css">
div#thesite
{
  font-family   : "Open Sans", sans-serif;
  font-size     : 1em !important;
  margin-top    : 1em;
  margin-bottom : 1em;
}

div#thesite h1
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite h2
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite h3
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite h4
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite h5
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite h6
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite .ui.breadcrumb.rib .section
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite .header
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite .as-header
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite code, pre, tt
{
  font-family : "SFMono-Regular","Menlo","Monaco","Consolas","Liberation Mono","Courier New", monospace;
}

div#thesite .ui.breadcrumb.rib
{
  margin-bottom : 1em;
}



div#thesite .ui.comments.messages .comment .metadata a
{
  color : #808080;
}

div#thesite .ui.comments.messages .comment a.avatar img
{
  height : auto;
}

div#thesite .subtle
{
  color : #808080;
}


div#thesite .messages pre
{
  font-size : 85%;
  overflow  : auto;
  max-width : 100%;
}

div#thesite .messages .message_embed
{
  border-left  : solid 3px #808080;
  padding-left : 0.69999em;
}

div#thesite .messages .message_inline_image img
{
  max-width     : 100%;
  margin-bottom : 1em;
}


/* Generated with Clay, http://fvisser.nl/clay */</style><link href="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.4.1/semantic.min.css" rel="stylesheet"><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/all.min.css" rel="stylesheet"><link href="https://fonts.googleapis.com/css?family=Open+Sans|Oswald&amp;display=swap" rel="stylesheet"><link href="https://fonts.googleapis.com/css?family=Roboto|Open+Sans&amp;display=swap" rel="stylesheet"></head><body><div id="thesite" class="ui text container"><div class="ui violet inverted top attached center aligned segment"><h1 class="ui huge header">Parsing pandoc documents - Haskell</h1></div><div class="ui attached segment"><div class="ui message"><p>Welcome to the Functional Programming Zulip Chat Archive. You can join the chat <a href="https://funprog.zulipchat.com">here</a>.</p></div><div class="ui breadcrumb rib"><a href="/" class="section">Home</a><i class="right angle icon divider"></i><a href="/haskell/" class="section">#Haskell</a><i class="right angle icon divider"></i><div class="active section">Parsing pandoc documents</div></div><div class="ui comments messages"><div class="comment"><a class="avatar"><img src="https://secure.gravatar.com/avatar/93ea3d19789047de293970e997237325?d=identicon&amp;version=1"></a><div class="content"><a class="author">Jan van Brügge</a><div class="metadata"><a href="#189881034" name="189881034"><div>2020-03-06 10:55:27</div></a></div><div class="text"><p>Hi, I want to extract information out of a document parsed by pandoc and I am questioning my methods. At the moment I am using partial pattern matched in the Maybe monad to extract info, but this is quite tedious. For example  I know the first thing will be a headline 1 with the content of  <code>My last n months</code> and I want to extract the <code>n</code> as <code>Int</code>.</p>
<p>At the moment, I am doing:</p>
<div class="codehilite"><pre><span></span><span class="nf">parseDoc</span> <span class="ow">::</span> <span class="p">[</span><span class="kt">Block</span><span class="p">]</span> <span class="ow">-&gt;</span> <span class="kt">Maybe</span> <span class="kt">MyData</span>
<span class="nf">parseDoc</span> <span class="n">doc</span> <span class="ow">=</span> <span class="kr">do</span>
  <span class="p">(</span><span class="kt">Header</span> <span class="mi">1</span> <span class="n">x1</span> <span class="kt">:</span> <span class="n">xs1</span><span class="p">)</span> <span class="ow">&lt;-</span> <span class="n">pure</span> <span class="n">doc</span>
  <span class="n">n</span> <span class="ow">&lt;-</span> <span class="n">readMaybe</span> <span class="o">.</span> <span class="n">takeWhile</span> <span class="n">isDigit</span> <span class="o">.</span> <span class="n">unpack</span> <span class="o">=&lt;&lt;</span> <span class="n">stripPrefix</span> <span class="s">&quot;My last &quot;</span> <span class="o">$</span> <span class="n">stringify</span> <span class="n">x1</span>
</pre></div>


<p>Is there a better way?</p></div></div></div><div class="comment"><a class="avatar"><img src="https://secure.gravatar.com/avatar/3d24a4100b3eab34d8ce3059d789c543?d=identicon&amp;version=1"></a><div class="content"><a class="author">Sandy Maguire</a><div class="metadata"><a href="#189881146" name="189881146"><div>2020-03-06 10:57:28</div></a></div><div class="text"><p>SYB</p></div></div></div><div class="comment"><a class="avatar"><img src="https://secure.gravatar.com/avatar/3d24a4100b3eab34d8ce3059d789c543?d=identicon&amp;version=1"></a><div class="content"><a class="author">Sandy Maguire</a><div class="metadata"><a href="#189881227" name="189881227"><div>2020-03-06 10:58:21</div></a></div><div class="text"><p>you can use <code>everywhere (++) $ mkQ [] $ \case Str something -&gt; try to extract your stuff here</code></p></div></div></div><div class="comment"><a class="avatar"><img src="https://secure.gravatar.com/avatar/3d24a4100b3eab34d8ce3059d789c543?d=identicon&amp;version=1"></a><div class="content"><a class="author">Sandy Maguire</a><div class="metadata"><a href="#189881285" name="189881285"><div>2020-03-06 10:59:51</div></a></div><div class="text"><p>or you know, whatever pattern you want to find</p></div></div></div><div class="comment"><a class="avatar"><img src="https://secure.gravatar.com/avatar/93ea3d19789047de293970e997237325?d=identicon&amp;version=1"></a><div class="content"><a class="author">Jan van Brügge</a><div class="metadata"><a href="#189881467" name="189881467"><div>2020-03-06 11:02:57</div></a></div><div class="text"><p>thanks, I will try that</p></div></div></div><div class="comment"><a class="avatar"><img src="https://secure.gravatar.com/avatar/93ea3d19789047de293970e997237325?d=identicon&amp;version=1"></a><div class="content"><a class="author">Jan van Brügge</a><div class="metadata"><a href="#189882277" name="189882277"><div>2020-03-06 11:16:28</div></a></div><div class="text"><p><a href="/user_uploads/13896/bFFVGacBw-p5ED29QfZdvGec/image-9206c6a0-f708-4365-8841-dd3e198a6a52.jpg" target="_blank" title="image-9206c6a0-f708-4365-8841-dd3e198a6a52.jpg">image-9206c6a0-f708-4365-8841-dd3e198a6a52.jpg</a></p>
<div class="message_inline_image"><a href="/user_uploads/13896/bFFVGacBw-p5ED29QfZdvGec/image-9206c6a0-f708-4365-8841-dd3e198a6a52.jpg" target="_blank" title="image-9206c6a0-f708-4365-8841-dd3e198a6a52.jpg"><img src="/user_uploads/13896/bFFVGacBw-p5ED29QfZdvGec/image-9206c6a0-f708-4365-8841-dd3e198a6a52.jpg"></a></div></div></div></div><div class="comment"><a class="avatar"><img src="https://secure.gravatar.com/avatar/3d24a4100b3eab34d8ce3059d789c543?d=identicon&amp;version=1"></a><div class="content"><a class="author">Sandy Maguire</a><div class="metadata"><a href="#189882295" name="189882295"><div>2020-03-06 11:16:50</div></a></div><div class="text"><p>oops sorry</p></div></div></div><div class="comment"><a class="avatar"><img src="https://secure.gravatar.com/avatar/3d24a4100b3eab34d8ce3059d789c543?d=identicon&amp;version=1"></a><div class="content"><a class="author">Sandy Maguire</a><div class="metadata"><a href="#189882297" name="189882297"><div>2020-03-06 11:16:52</div></a></div><div class="text"><p>you want <code>everything</code></p></div></div></div><div class="comment"><a class="avatar"><img src="https://secure.gravatar.com/avatar/3d24a4100b3eab34d8ce3059d789c543?d=identicon&amp;version=1"></a><div class="content"><a class="author">Sandy Maguire</a><div class="metadata"><a href="#189882300" name="189882300"><div>2020-03-06 11:16:55</div></a></div><div class="text"><p>not <code>everywhere</code></p></div></div></div><div class="comment"><a class="avatar"><img src="https://secure.gravatar.com/avatar/3d24a4100b3eab34d8ce3059d789c543?d=identicon&amp;version=1"></a><div class="content"><a class="author">Sandy Maguire</a><div class="metadata"><a href="#189882328" name="189882328"><div>2020-03-06 11:17:03</div></a></div><div class="text"><p>everywhere is a cata</p></div></div></div><div class="comment"><a class="avatar"><img src="https://secure.gravatar.com/avatar/93ea3d19789047de293970e997237325?d=identicon&amp;version=1"></a><div class="content"><a class="author">Jan van Brügge</a><div class="metadata"><a href="#189882339" name="189882339"><div>2020-03-06 11:17:21</div></a></div><div class="text"><p>Is there a good tutorial about this somwhere? The site that is linked everywhere in the docs is down apparently</p></div></div></div><div class="comment"><a class="avatar"><img src="https://secure.gravatar.com/avatar/3d24a4100b3eab34d8ce3059d789c543?d=identicon&amp;version=1"></a><div class="content"><a class="author">Sandy Maguire</a><div class="metadata"><a href="#189882429" name="189882429"><div>2020-03-06 11:18:32</div></a></div><div class="text"><p>ths is the paper: <a href="https://www.microsoft.com/en-us/research/wp-content/uploads/2003/01/hmap.pdf" target="_blank" title="https://www.microsoft.com/en-us/research/wp-content/uploads/2003/01/hmap.pdf">https://www.microsoft.com/en-us/research/wp-content/uploads/2003/01/hmap.pdf</a></p></div></div></div><div class="comment"><a class="avatar"><img src="https://secure.gravatar.com/avatar/3d24a4100b3eab34d8ce3059d789c543?d=identicon&amp;version=1"></a><div class="content"><a class="author">Sandy Maguire</a><div class="metadata"><a href="#189882430" name="189882430"><div>2020-03-06 11:18:35</div></a></div><div class="text"><p>it's been a while since i read it</p></div></div></div><div class="comment"><a class="avatar"><img src="https://secure.gravatar.com/avatar/3d24a4100b3eab34d8ce3059d789c543?d=identicon&amp;version=1"></a><div class="content"><a class="author">Sandy Maguire</a><div class="metadata"><a href="#189882482" name="189882482"><div>2020-03-06 11:19:28</div></a></div><div class="text"><p>at a high level; a <code>Data a</code>  constraint says that you have some sort of run-time representation of <code>a</code></p></div></div></div><div class="comment"><a class="avatar"><img src="https://secure.gravatar.com/avatar/3d24a4100b3eab34d8ce3059d789c543?d=identicon&amp;version=1"></a><div class="content"><a class="author">Sandy Maguire</a><div class="metadata"><a href="#189882487" name="189882487"><div>2020-03-06 11:19:38</div></a></div><div class="text"><p>run-time generic representation*</p></div></div></div><div class="comment"><a class="avatar"><img src="https://secure.gravatar.com/avatar/3d24a4100b3eab34d8ce3059d789c543?d=identicon&amp;version=1"></a><div class="content"><a class="author">Sandy Maguire</a><div class="metadata"><a href="#189882497" name="189882497"><div>2020-03-06 11:19:48</div></a></div><div class="text"><p>(as opposed to GHC.Generics which is at compile time)</p></div></div></div><div class="comment"><a class="avatar"><img src="https://secure.gravatar.com/avatar/3d24a4100b3eab34d8ce3059d789c543?d=identicon&amp;version=1"></a><div class="content"><a class="author">Sandy Maguire</a><div class="metadata"><a href="#189882547" name="189882547"><div>2020-03-06 11:20:13</div></a></div><div class="text"><p><code>everything</code> lets you run a monoidal query over some <code>Data a =&gt; a</code></p></div></div></div><div class="comment"><a class="avatar"><img src="https://secure.gravatar.com/avatar/3d24a4100b3eab34d8ce3059d789c543?d=identicon&amp;version=1"></a><div class="content"><a class="author">Sandy Maguire</a><div class="metadata"><a href="#189882573" name="189882573"><div>2020-03-06 11:20:44</div></a></div><div class="text"><p>you do that with <code>mkQ</code> which takes a default value for if it doesn't match anything, and then give it a lambda specialized at whatever type you want</p></div></div></div><div class="comment"><a class="avatar"><img src="https://secure.gravatar.com/avatar/3d24a4100b3eab34d8ce3059d789c543?d=identicon&amp;version=1"></a><div class="content"><a class="author">Sandy Maguire</a><div class="metadata"><a href="#189882592" name="189882592"><div>2020-03-06 11:21:03</div></a></div><div class="text"><p><code>everything</code> will search through the type for the type your lambda takes, and then run your function, and accumulates the results</p></div></div></div><div class="comment"><a class="avatar"><img src="https://secure.gravatar.com/avatar/3d24a4100b3eab34d8ce3059d789c543?d=identicon&amp;version=1"></a><div class="content"><a class="author">Sandy Maguire</a><div class="metadata"><a href="#189882622" name="189882622"><div>2020-03-06 11:21:42</div></a></div><div class="text"><p>for example, i wrote this just today, which finds all of the <code>UnboundVar</code> nodes inside of an <code>Exp</code>:</p>
<div class="codehilite"><pre><span></span><span class="nf">unboundVars</span> <span class="ow">::</span> <span class="kt">Exp</span> <span class="ow">-&gt;</span> <span class="p">[</span><span class="kt">Name</span><span class="p">]</span>
<span class="nf">unboundVars</span> <span class="ow">=</span> <span class="n">everything</span> <span class="p">(</span><span class="o">++</span><span class="p">)</span> <span class="o">$</span>
  <span class="n">mkQ</span> <span class="kt">[]</span> <span class="o">$</span> <span class="nf">\</span><span class="kr">case</span>
    <span class="kt">UnboundVarE</span> <span class="n">n</span> <span class="ow">-&gt;</span> <span class="p">[</span><span class="n">n</span><span class="p">]</span>
    <span class="kr">_</span> <span class="ow">-&gt;</span> <span class="kt">[]</span>
</pre></div></div></div></div><div class="comment"><a class="avatar"><img src="https://secure.gravatar.com/avatar/3d24a4100b3eab34d8ce3059d789c543?d=identicon&amp;version=1"></a><div class="content"><a class="author">Sandy Maguire</a><div class="metadata"><a href="#189882693" name="189882693"><div>2020-03-06 11:22:39</div></a></div><div class="text"><p>you can also use <code>extQ</code> to glue multiple <code>mkQ</code>s together, eg if you want to simultaneously target different types in your structure</p></div></div></div><div class="comment"><a class="avatar"><img src="https://secure.gravatar.com/avatar/3d24a4100b3eab34d8ce3059d789c543?d=identicon&amp;version=1"></a><div class="content"><a class="author">Sandy Maguire</a><div class="metadata"><a href="#189882722" name="189882722"><div>2020-03-06 11:23:34</div></a></div><div class="text"><p>maybe that helps?</p></div></div></div><div class="comment"><a class="avatar"><img src="https://secure.gravatar.com/avatar/93ea3d19789047de293970e997237325?d=identicon&amp;version=1"></a><div class="content"><a class="author">Jan van Brügge</a><div class="metadata"><a href="#189882784" name="189882784"><div>2020-03-06 11:24:32</div></a></div><div class="text"><p>I will try, thanks Sandy!</p></div></div></div><div class="comment"><a class="avatar"><img src="https://secure.gravatar.com/avatar/93ea3d19789047de293970e997237325?d=identicon&amp;version=1"></a><div class="content"><a class="author">Jan van Brügge</a><div class="metadata"><a href="#189915615" name="189915615"><div>2020-03-06 17:34:31</div></a></div><div class="text"><p>SYB was not really a solution to my problem, because the data is not nested very deep. I finally found something I am reasonable happy with, this disgusting beauty:</p>
<div class="codehilite"><pre><span></span><span class="kr">newtype</span> <span class="kt">ParseM</span> <span class="n">s</span> <span class="n">a</span> <span class="ow">=</span> <span class="kt">MkParseM</span> <span class="p">(</span><span class="kt">State</span> <span class="n">s</span> <span class="p">(</span><span class="kt">Maybe</span> <span class="n">a</span><span class="p">))</span>

<span class="kr">instance</span> <span class="kt">Functor</span> <span class="p">(</span><span class="kt">ParseM</span> <span class="n">s</span><span class="p">)</span> <span class="kr">where</span>
  <span class="n">fmap</span> <span class="n">f</span> <span class="p">(</span><span class="kt">MkParseM</span> <span class="n">x</span><span class="p">)</span> <span class="ow">=</span> <span class="kt">MkParseM</span> <span class="p">(</span><span class="n">fmap</span> <span class="p">(</span><span class="n">fmap</span> <span class="n">f</span><span class="p">)</span> <span class="n">x</span><span class="p">)</span>

<span class="kr">instance</span> <span class="kt">Applicative</span> <span class="p">(</span><span class="kt">ParseM</span> <span class="n">s</span><span class="p">)</span> <span class="kr">where</span>
  <span class="n">pure</span> <span class="n">x</span> <span class="ow">=</span> <span class="kt">MkParseM</span> <span class="o">$</span> <span class="n">pure</span> <span class="o">$</span> <span class="kt">Just</span> <span class="n">x</span>
  <span class="p">(</span><span class="kt">MkParseM</span> <span class="n">x</span><span class="p">)</span> <span class="o">&lt;*&gt;</span> <span class="p">(</span><span class="kt">MkParseM</span> <span class="n">y</span><span class="p">)</span> <span class="ow">=</span> <span class="kt">MkParseM</span> <span class="o">$</span> <span class="n">x</span> <span class="o">&gt;&gt;=</span> <span class="nf">\</span><span class="n">f</span> <span class="ow">-&gt;</span> <span class="n">y</span> <span class="o">&gt;&gt;=</span> <span class="nf">\</span><span class="n">v</span> <span class="ow">-&gt;</span> <span class="n">pure</span> <span class="o">$</span> <span class="n">f</span> <span class="o">&lt;*&gt;</span> <span class="n">v</span>

<span class="kr">instance</span> <span class="kt">Monad</span> <span class="p">(</span><span class="kt">ParseM</span> <span class="n">s</span><span class="p">)</span> <span class="kr">where</span>
  <span class="p">(</span><span class="kt">MkParseM</span> <span class="n">x</span><span class="p">)</span> <span class="o">&gt;&gt;=</span> <span class="n">f</span> <span class="ow">=</span> <span class="kt">MkParseM</span> <span class="o">$</span>
    <span class="n">x</span> <span class="o">&gt;&gt;=</span> <span class="nf">\</span><span class="kr">case</span>
      <span class="kt">Just</span> <span class="n">y</span> <span class="ow">-&gt;</span> <span class="kr">case</span> <span class="p">(</span><span class="n">f</span> <span class="n">y</span><span class="p">)</span> <span class="kr">of</span> <span class="kt">MkParseM</span> <span class="n">r</span> <span class="ow">-&gt;</span> <span class="n">r</span>
      <span class="kt">Nothing</span> <span class="ow">-&gt;</span> <span class="n">pure</span> <span class="kt">Nothing</span>

<span class="kr">instance</span> <span class="kt">MonadFail</span> <span class="p">(</span><span class="kt">ParseM</span> <span class="n">s</span><span class="p">)</span> <span class="kr">where</span>
  <span class="n">fail</span> <span class="kr">_</span> <span class="ow">=</span> <span class="kt">MkParseM</span> <span class="p">(</span><span class="n">pure</span> <span class="kt">Nothing</span><span class="p">)</span>

<span class="nf">embed</span> <span class="ow">::</span> <span class="kt">Maybe</span> <span class="n">a</span> <span class="ow">-&gt;</span> <span class="kt">ParseM</span> <span class="n">s</span> <span class="n">a</span>
<span class="nf">embed</span> <span class="ow">=</span> <span class="kt">MkParseM</span> <span class="o">.</span> <span class="n">pure</span>

<span class="nf">head&#39;</span> <span class="ow">::</span> <span class="kt">ParseM</span> <span class="p">[</span><span class="kt">Block</span><span class="p">]</span> <span class="kt">Block</span>
<span class="nf">head&#39;</span> <span class="ow">=</span> <span class="kt">MkParseM</span> <span class="o">$</span> <span class="kr">do</span>
  <span class="n">doc</span> <span class="ow">&lt;-</span> <span class="n">get</span>
  <span class="kr">case</span> <span class="n">doc</span> <span class="kr">of</span>
    <span class="n">x</span> <span class="kt">:</span> <span class="n">xs</span> <span class="ow">-&gt;</span> <span class="n">put</span> <span class="n">xs</span> <span class="o">*&gt;</span> <span class="n">pure</span> <span class="p">(</span><span class="kt">Just</span> <span class="n">x</span><span class="p">)</span>
    <span class="kr">_</span> <span class="ow">-&gt;</span> <span class="n">pure</span> <span class="kt">Nothing</span>

<span class="nf">runParser</span> <span class="ow">::</span> <span class="kt">ParseM</span> <span class="n">s</span> <span class="n">a</span> <span class="ow">-&gt;</span> <span class="n">s</span> <span class="ow">-&gt;</span> <span class="kt">Maybe</span> <span class="n">a</span>
<span class="nf">runParser</span> <span class="p">(</span><span class="kt">MkParseM</span> <span class="n">x</span><span class="p">)</span> <span class="ow">=</span> <span class="n">evalState</span> <span class="n">x</span>

<span class="nf">parseRetro</span> <span class="ow">::</span> <span class="p">[</span><span class="kt">Block</span><span class="p">]</span> <span class="ow">-&gt;</span> <span class="kt">Maybe</span> <span class="kt">Int</span>
<span class="nf">parseRetro</span> <span class="ow">=</span> <span class="n">runParser</span> <span class="o">$</span> <span class="kr">do</span>
  <span class="kt">Header</span> <span class="mi">1</span> <span class="kr">_</span> <span class="p">(</span><span class="n">stringify</span> <span class="ow">-&gt;</span> <span class="n">h1</span><span class="p">)</span> <span class="ow">&lt;-</span> <span class="n">head&#39;</span>
  <span class="n">n</span> <span class="ow">&lt;-</span> <span class="n">embed</span> <span class="o">$</span> <span class="n">readMaybe</span> <span class="o">.</span> <span class="n">takeWhile</span> <span class="n">isDigit</span> <span class="o">.</span> <span class="n">unpack</span> <span class="o">=&lt;&lt;</span> <span class="n">stripPrefix</span> <span class="s">&quot;My past &quot;</span> <span class="n">h1</span>
  <span class="kr">let</span> <span class="n">past</span> <span class="ow">=</span> <span class="kt">MkPastMonths</span> <span class="n">n</span>
  <span class="n">pure</span> <span class="o">$</span> <span class="n">n</span>
</pre></div></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/20a04d823b7c3891d78ca5f6a188ccd0e4fc5e3d?x=x&amp;version=2"></a><div class="content"><a class="author">TheMatten</a><div class="metadata"><a href="#189917662" name="189917662"><div>2020-03-06 17:56:06</div></a></div><div class="text"><p><span class="user-mention" data-user-id="250737">@Jan van Brügge</span> </p>
<div class="codehilite"><pre><span></span><span class="nf">parseRetro</span> <span class="ow">::</span> <span class="p">[</span><span class="kt">Block</span><span class="p">]</span> <span class="ow">-&gt;</span> <span class="kt">Maybe</span> <span class="kt">Int</span>
<span class="nf">parseRetro</span> <span class="p">(</span><span class="kt">Header</span> <span class="mi">1</span> <span class="kr">_</span> <span class="n">h1&#39;</span> <span class="kt">:</span> <span class="kr">_</span><span class="p">)</span>
  <span class="o">|</span> <span class="p">(</span><span class="n">stringify</span> <span class="ow">-&gt;</span> <span class="n">stripPrefix</span> <span class="s">&quot;My past &quot;</span> <span class="ow">-&gt;</span> <span class="kt">Just</span> <span class="n">h1</span><span class="p">)</span> <span class="ow">&lt;-</span> <span class="n">h1&#39;</span>
  <span class="ow">=</span> <span class="n">fmap</span> <span class="kt">MkPastMonths</span> <span class="o">$</span> <span class="n">readMaybe</span> <span class="o">$</span> <span class="n">takeWhile</span> <span class="n">isDigit</span> <span class="o">$</span> <span class="n">unpack</span> <span class="n">h1</span>
<span class="nf">parseRetro</span> <span class="kr">_</span> <span class="ow">=</span> <span class="kt">Nothing</span>
</pre></div></div></div></div><div class="comment"><a class="avatar"><img src="https://secure.gravatar.com/avatar/93ea3d19789047de293970e997237325?d=identicon&amp;version=1"></a><div class="content"><a class="author">Jan van Brügge</a><div class="metadata"><a href="#189918419" name="189918419"><div>2020-03-06 18:05:09</div></a></div><div class="text"><p><span class="user-mention" data-user-id="225127">@TheMatten</span> this is just the first thing I need to parse, and threading through the remainder of the list would get old very quickly</p></div></div></div><div class="comment"><a class="avatar"><img src="https://secure.gravatar.com/avatar/93ea3d19789047de293970e997237325?d=identicon&amp;version=1"></a><div class="content"><a class="author">Jan van Brügge</a><div class="metadata"><a href="#189918483" name="189918483"><div>2020-03-06 18:05:58</div></a></div><div class="text"><p>with this State wrapper, I can just continue with partial pattern matches until I've exhausted the list</p></div></div></div><div class="comment"><a class="avatar"><img src="https://secure.gravatar.com/avatar/93ea3d19789047de293970e997237325?d=identicon&amp;version=1"></a><div class="content"><a class="author">Jan van Brügge</a><div class="metadata"><a href="#189924869" name="189924869"><div>2020-03-06 19:13:42</div></a></div><div class="text"><p>For example I think this code reads rather nice:</p>
<div class="codehilite"><pre><span></span><span class="nf">parseRetro</span> <span class="ow">::</span> <span class="p">[</span><span class="kt">Block</span><span class="p">]</span> <span class="ow">-&gt;</span> <span class="kt">Maybe</span> <span class="p">[</span><span class="kt">Project</span><span class="p">]</span>
<span class="nf">parseRetro</span> <span class="ow">=</span> <span class="n">runParser</span> <span class="o">$</span> <span class="kr">do</span>
  <span class="kt">Header</span> <span class="mi">1</span> <span class="kr">_</span> <span class="p">(</span><span class="n">stringify</span> <span class="ow">-&gt;</span> <span class="n">h1</span><span class="p">)</span> <span class="ow">&lt;-</span> <span class="n">head&#39;</span>
  <span class="p">(</span><span class="n">n</span> <span class="ow">::</span> <span class="kt">Int</span><span class="p">)</span> <span class="ow">&lt;-</span> <span class="n">embed</span> <span class="o">$</span> <span class="n">readMaybe</span> <span class="o">.</span> <span class="n">takeWhile</span> <span class="n">isDigit</span> <span class="o">.</span> <span class="n">unpack</span> <span class="o">=&lt;&lt;</span> <span class="n">stripPrefix</span> <span class="s">&quot;My past &quot;</span> <span class="n">h1</span>
  <span class="n">projects</span> <span class="ow">&lt;-</span>
    <span class="n">takeWhileM</span>
      <span class="p">(</span> <span class="nf">\</span><span class="kr">case</span>
          <span class="kt">Header</span> <span class="mi">2</span> <span class="kr">_</span> <span class="p">(</span><span class="n">stringify</span> <span class="ow">-&gt;</span> <span class="p">(</span><span class="s">&quot;Project&quot;</span> <span class="p">`</span><span class="n">isPrefixOf</span><span class="p">`)</span> <span class="ow">-&gt;</span> <span class="kt">True</span><span class="p">)</span> <span class="ow">-&gt;</span> <span class="kt">Just</span> <span class="n">parseProject</span>
          <span class="kr">_</span> <span class="ow">-&gt;</span> <span class="kt">Nothing</span>
      <span class="p">)</span>
  <span class="c1">-- let past = MkPastMonths n projects</span>
  <span class="n">pure</span> <span class="n">projects</span>
</pre></div></div></div></div><div class="comment"><a class="avatar"><img src="https://secure.gravatar.com/avatar/93ea3d19789047de293970e997237325?d=identicon&amp;version=1"></a><div class="content"><a class="author">Jan van Brügge</a><div class="metadata"><a href="#189924992" name="189924992"><div>2020-03-06 19:14:52</div></a></div><div class="text"><p>With <code>takeWhileM</code> being:</p>
<div class="codehilite"><pre><span></span><span class="nf">takeWhileM</span> <span class="ow">::</span> <span class="p">(</span><span class="n">a</span> <span class="ow">-&gt;</span> <span class="kt">Maybe</span> <span class="p">(</span><span class="kt">Parser</span> <span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="n">b</span><span class="p">))</span> <span class="ow">-&gt;</span> <span class="kt">Parser</span> <span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="p">[</span><span class="n">b</span><span class="p">]</span>
<span class="nf">takeWhileM</span> <span class="n">f</span> <span class="ow">=</span> <span class="n">get&#39;</span> <span class="o">&gt;&gt;=</span> <span class="nf">\</span><span class="kr">case</span>
  <span class="kt">[]</span> <span class="ow">-&gt;</span> <span class="n">pure</span> <span class="kt">[]</span>
  <span class="p">(</span><span class="n">x</span> <span class="kt">:</span> <span class="n">xs</span><span class="p">)</span> <span class="ow">-&gt;</span> <span class="kr">case</span> <span class="n">f</span> <span class="n">x</span> <span class="kr">of</span>
    <span class="kt">Nothing</span> <span class="ow">-&gt;</span> <span class="n">pure</span> <span class="kt">[]</span>
    <span class="kt">Just</span> <span class="n">p</span> <span class="ow">-&gt;</span> <span class="n">put&#39;</span> <span class="n">xs</span> <span class="o">*&gt;</span> <span class="n">p</span> <span class="o">&gt;&gt;=</span> <span class="nf">\</span><span class="n">b</span> <span class="ow">-&gt;</span> <span class="p">(</span><span class="kt">:</span><span class="p">)</span> <span class="n">b</span> <span class="o">&lt;$&gt;</span> <span class="n">takeWhileM</span> <span class="n">f</span>
</pre></div></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/4429aa8b689608f24a4ad712843ce29862e330d2?x=x&amp;version=2"></a><div class="content"><a class="author">Sridhar Ratnakumar</a><div class="metadata"><a href="#189925042" name="189925042"><div>2020-03-06 19:15:35</div></a></div><div class="text"><p>I only skimmed this topic, but cannot this be solved using <code>Text.Pandoc.Walk</code> (see <code>query</code> and <code>walkM</code>)? </p>
<p>example: <a href="https://github.com/srid/rib/blob/e41eae3/src/Rib/Parser/Pandoc.hs#L102-L109" target="_blank" title="https://github.com/srid/rib/blob/e41eae3/src/Rib/Parser/Pandoc.hs#L102-L109">https://github.com/srid/rib/blob/e41eae3/src/Rib/Parser/Pandoc.hs#L102-L109</a></p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/srid/rib/blob/e41eae3/src/Rib/Parser/Pandoc.hs#L102-L109" style="background-image: url(https://avatars2.githubusercontent.com/u/3998?s=400&amp;v=4)" target="_blank"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/srid/rib/blob/e41eae3/src/Rib/Parser/Pandoc.hs#L102-L109" target="_blank" title="srid/rib">srid/rib</a></div><div class="message_embed_description">Haskell static site generator based on Shake. Contribute to srid/rib development by creating an account on GitHub.</div></div></div></div></div></div><div class="comment"><a class="avatar"><img src="https://secure.gravatar.com/avatar/93ea3d19789047de293970e997237325?d=identicon&amp;version=1"></a><div class="content"><a class="author">Jan van Brügge</a><div class="metadata"><a href="#189925158" name="189925158"><div>2020-03-06 19:16:56</div></a></div><div class="text"><p>The problem is not finding the stuff, but rather pulling the information out of it. AFAICT query can't help me there</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/4429aa8b689608f24a4ad712843ce29862e330d2?x=x&amp;version=2"></a><div class="content"><a class="author">Sridhar Ratnakumar</a><div class="metadata"><a href="#189925209" name="189925209"><div>2020-03-06 19:17:41</div></a></div><div class="text"><p>That example actually pulls the image URL using <code>query</code></p></div></div></div><div class="comment"><a class="avatar"><img src="https://secure.gravatar.com/avatar/520889f20a2c66a8f4bd5be6f37d2923?d=identicon&amp;version=1"></a><div class="content"><a class="author">Asad Saeeduddin</a><div class="metadata"><a href="#189942931" name="189942931"><div>2020-03-06 22:56:51</div></a></div><div class="text"><p><span class="user-mention" data-user-id="250737">@Jan van Brügge</span> I can't exactly reconcile your snippet:</p>
<div class="codehilite"><pre><span></span>parseDoc :: [Block] -&gt; Maybe MyData
parseDoc doc = do
  (Header 1 x1 : xs1) &lt;- pure doc
  n &lt;- readMaybe . takeWhile isDigit . unpack =&lt;&lt; stripPrefix &quot;My last &quot; $ stringify x1
</pre></div>


<p>with the partial maybe matching you're referring to</p></div></div></div><div class="comment"><a class="avatar"><img src="https://secure.gravatar.com/avatar/520889f20a2c66a8f4bd5be6f37d2923?d=identicon&amp;version=1"></a><div class="content"><a class="author">Asad Saeeduddin</a><div class="metadata"><a href="#189945754" name="189945754"><div>2020-03-06 23:43:03</div></a></div><div class="text"><p><span class="user-mention" data-user-id="250737">@Jan van Brügge</span> is something like this what you're looking for:</p>
<div class="codehilite"><pre><span></span>  let
    focus :: Prism&#39; (Maybe (a + String)) String
    focus = _Just . right&#39; . predicate ((&lt; 7) . length)

  print $ re focus `whittle`
    [ Just $ Right $ &quot;Hello!&quot;
    , Nothing
    , Just $ Left $ -1
    , Just $ Right $ &quot;Whoops!&quot;
    ]
  -- &gt; [&quot;Hello!&quot;]
</pre></div></div></div></div><div class="comment"><a class="avatar"><img src="https://secure.gravatar.com/avatar/520889f20a2c66a8f4bd5be6f37d2923?d=identicon&amp;version=1"></a><div class="content"><a class="author">Asad Saeeduddin</a><div class="metadata"><a href="#189945835" name="189945835"><div>2020-03-06 23:44:46</div></a></div><div class="text"><div class="codehilite"><pre><span></span>whittle :: Filterable f =&gt; Coprism s t a b -&gt; f b -&gt; f t
whittle p b = runJoker $ p $ Joker $ b
</pre></div>


<p>There's a trivial <code>Filterable</code> instance for any <code>Alternative</code> + <code>Monad</code> (although whether it's lawful depends on the specific monad and alternative instances)</p></div></div></div></div></div><div class="ui vertical footer segment"><a href="https://github.com/srid/zulip-archive">Powered by Haskell</a> | Questions? Contact <a href="https://www.srid.ca">srid</a></div></div></body></html>