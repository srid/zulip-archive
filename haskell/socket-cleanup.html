<html lang="en"><head><meta content="text/html; charset=utf-8" http-equiv="Content-Type"><meta content="width=device-width, initial-scale=1" name="viewport"><meta content="How do you ensure a socket get closed in the event of an exception while retaining the ability to kill the thread that is waiting for connections on that socket?
I can only think of solutions that provide one or the other, not both:

Using bracket accept close ... to guarantee cleanup masks async ex" name="description"><link href="https://funprog.srid.ca/haskell/socket-cleanup.html" rel="canonical"><meta property="og:title" content="Socket cleanup - Haskell"><meta property="og:site_name" content="Functional Programming Zulip Archive"><meta property="og:type" content="article"><meta property="og:article:section" content="Haskell"><meta property="og:article:modified_time" content="2020-05-16T23:30:08Z"><meta property="og:article:published_time" content="2020-05-16T08:35:23Z"><title>Socket cleanup - Haskell</title><style type="text/css">
div#thesite
{
  font-family   : "Open Sans", sans-serif;
  font-size     : 1em !important;
  margin-top    : 1em;
  margin-bottom : 1em;
}

div#thesite h1
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite h2
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite h3
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite h4
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite h5
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite h6
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite .ui.breadcrumb.rib .section
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite .header
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite .as-header
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite code, pre, tt
{
  font-family : "SFMono-Regular","Menlo","Monaco","Consolas","Liberation Mono","Courier New", monospace;
}

div#thesite .ui.breadcrumb.rib
{
  margin-bottom : 1em;
}



div#thesite .ui.comments.messages .comment .metadata a
{
  color : #808080;
}

div#thesite .ui.comments.messages .comment a.avatar img
{
  height : auto;
}

div#thesite .subtle
{
  color : #808080;
}


div#thesite .messages pre
{
  font-size : 85%;
  overflow  : auto;
  max-width : 100%;
}

div#thesite .messages .message_embed
{
  border-left  : solid 3px #808080;
  padding-left : 0.69999em;
}

div#thesite .messages .message_inline_image img
{
  max-width     : 100%;
  margin-bottom : 1em;
}


/* Generated with Clay, http://fvisser.nl/clay */</style><link href="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.4.1/semantic.min.css" rel="stylesheet"><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/all.min.css" rel="stylesheet"><link href="https://fonts.googleapis.com/css?family=Open+Sans|Oswald&amp;display=swap" rel="stylesheet"><link href="https://fonts.googleapis.com/css?family=Roboto|Open+Sans&amp;display=swap" rel="stylesheet"></head><body><div id="thesite" class="ui text container"><div class="ui violet inverted top attached center aligned segment"><h1 class="ui huge header">Socket cleanup - Haskell</h1></div><div class="ui attached segment"><div class="ui message"><p>Welcome to the Functional Programming Zulip Chat Archive. You can join the chat <a href="https://funprog.zulipchat.com">here</a>.</p></div><div class="ui breadcrumb rib"><a href="/" class="section">Home</a><i class="right angle icon divider"></i><a href="/haskell/" class="section">#Haskell</a><i class="right angle icon divider"></i><div class="active section">Socket cleanup</div></div><div class="ui comments messages"><div class="comment"><a class="avatar"><img src="https://www.gravatar.com/avatar/7c6c8647784cae80af5f575103af4c7e"></a><div class="content"><a class="author">Chris Wendt</a><div class="metadata"><a href="#197784388" name="197784388"><div>2020-05-16 08:35:23</div></a></div><div class="text"><p>How do you ensure a socket get closed in the event of an exception while retaining the ability to kill the thread that is waiting for connections on that socket?</p>
<p>I can only think of solutions that provide one or the other, not both:</p>
<ul>
<li>Using <code>bracket accept close ...</code> to guarantee cleanup masks async exceptions and prevents another thread from killing it</li>
<li>Using <code>conn &lt;- accept; ... finally (close conn)</code> seems liable to leak the <code>conn</code> if an async exception is thrown immediately after the connection was accepted</li>
</ul>
<p>A while back, the websockets library switched from option 2 to 1 <a href="https://github.com/jaspervdj/websockets/commit/a43a16c6fbc0d624db4317cee2dbf8124d047490">https://github.com/jaspervdj/websockets/commit/a43a16c6fbc0d624db4317cee2dbf8124d047490</a> which makes me think there's no way to get both.</p>
<p>It looks like warp also uses option 1 <a href="https://github.com/yesodweb/wai/blob/d57699d6efc155f919b0760806535ac589f8db23/warp/Network/Wai/Handler/Warp/Run.hs#L312">https://github.com/yesodweb/wai/blob/d57699d6efc155f919b0760806535ac589f8db23/warp/Network/Wai/Handler/Warp/Run.hs#L312</a></p>
<p>Is there a "safe" <code>accept</code> that atomically registers a cleanup handler while also allowing async exceptions?</p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/jaspervdj/websockets/commit/a43a16c6fbc0d624db4317cee2dbf8124d047490" style="background-image: url(https://avatars2.githubusercontent.com/u/95501?s=400&amp;v=4)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/jaspervdj/websockets/commit/a43a16c6fbc0d624db4317cee2dbf8124d047490" title="Make sure socket doesn't leak in runServer · jaspervdj/websockets@a43a16c">Make sure socket doesn't leak in runServer · jaspervdj/websockets@a43a16c</a></div><div class="message_embed_description">There is two points where socket may leak: after accepting but
before spawning the worker thread; and after spawning it but before
establishing exception handler via `finally`.

Accept incoming con...</div></div></div><div class="message_embed"><a class="message_embed_image" href="https://github.com/yesodweb/wai/blob/d57699d6efc155f919b0760806535ac589f8db23/warp/Network/Wai/Handler/Warp/Run.hs#L312" style="background-image: url(https://avatars3.githubusercontent.com/u/930379?s=400&amp;v=4)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/yesodweb/wai/blob/d57699d6efc155f919b0760806535ac589f8db23/warp/Network/Wai/Handler/Warp/Run.hs#L312" title="yesodweb/wai">yesodweb/wai</a></div><div class="message_embed_description">Haskell Web Application Interface. Contribute to yesodweb/wai development by creating an account on GitHub.</div></div></div></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/20a04d823b7c3891d78ca5f6a188ccd0e4fc5e3d?version=2"></a><div class="content"><a class="author">TheMatten</a><div class="metadata"><a href="#197787053" name="197787053"><div>2020-05-16 09:39:52</div></a></div><div class="text"><p><span class="user-mention" data-user-id="251283">@chessai</span> do finalizers of <code>ForeignPtr</code>s get called when being interrupted by asynchronous exception?</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/20a04d823b7c3891d78ca5f6a188ccd0e4fc5e3d?version=2"></a><div class="content"><a class="author">TheMatten</a><div class="metadata"><a href="#197789433" name="197789433"><div>2020-05-16 10:38:48</div></a></div><div class="text"><p>To answer my own question, it seems like they're not guaranteed to be called at all: <a href="https://hackage.haskell.org/package/base-4.14.0.0/docs/Foreign-Concurrent.html#v:newForeignPtr">https://hackage.haskell.org/package/base-4.14.0.0/docs/Foreign-Concurrent.html#v:newForeignPtr</a></p></div></div></div><div class="comment"><a class="avatar"><img src="https://www.gravatar.com/avatar/7c6c8647784cae80af5f575103af4c7e"></a><div class="content"><a class="author">Chris Wendt</a><div class="metadata"><a href="#197818167" name="197818167"><div>2020-05-16 22:25:40</div></a></div><div class="text"><p>As an aside, ~4 of us spent 30+ minutes trying to figure out if GHCi can be told to kill all running threads on reload (I was running this server in the context of ghcid), and we pretty much concluded that it's impossible. See <a href="https://stackoverflow.com/questions/24999636/is-there-a-way-to-kill-all-forked-threads-in-a-ghci-session-without-restarting-i">https://stackoverflow.com/questions/24999636/is-there-a-way-to-kill-all-forked-threads-in-a-ghci-session-without-restarting-i</a></p>
<div class="message_embed"><a class="message_embed_image" href="https://stackoverflow.com/questions/24999636/is-there-a-way-to-kill-all-forked-threads-in-a-ghci-session-without-restarting-i" style="background-image: url(https://cdn.sstatic.net/Sites/stackoverflow/Img/apple-touch-icon@2.png?v=73d79a89bded)"></a><div class="data-container"><div class="message_embed_title"><a href="https://stackoverflow.com/questions/24999636/is-there-a-way-to-kill-all-forked-threads-in-a-ghci-session-without-restarting-i" title="Is there a way to kill all forked threads in a GHCi session without restarting it?">Is there a way to kill all forked threads in a GHCi session without restarting it?</a></div><div class="message_embed_description">Based on my previous question I'd like to ask if there's any way to kill all user created threads in a GHCi session?

The reason for this is that when a function exits in GHCi the threads that it s...</div></div></div></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/7334dc60b6aef6a75cd9284126231f13c76926a5?version=4"></a><div class="content"><a class="author">Torsten Schmits</a><div class="metadata"><a href="#197820353" name="197820353"><div>2020-05-16 23:30:08</div></a></div><div class="text"><p>heh, I was wondering the same thing this week, after moving a web server into a separate thread</p></div></div></div></div></div><div class="ui vertical footer segment"><a href="https://github.com/srid/zulip-archive">Powered by Haskell</a> | Questions? Contact <a href="https://www.srid.ca">srid</a></div></div></body></html>