<html lang="en"><head><meta content="text/html; charset=utf-8" http-equiv="Content-Type"><meta content="width=device-width, initial-scale=1" name="viewport"><meta content="I&#39;m running a database migration from MySQL -&gt; Postgresql. I want to retain the ID values so I used Persistent&#39;s insertKey function to set the IDs when inserting records. However, when the application decides to insert a row(during normal operation, not as part of the data migration), it gets an err" name="description"><link href="https://funprog.srid.ca/haskell/persistent-insertkey.html" rel="canonical"><meta property="og:title" content="persistent insertKey - Haskell"><meta property="og:site_name" content="Functional Programming Zulip Archive"><meta property="og:type" content="article"><meta property="og:article:section" content="Haskell"><meta property="og:article:modified_time" content="2019-11-27T17:37:10Z"><meta property="og:article:published_time" content="2019-11-26T17:56:59Z"><title>persistent insertKey - Haskell</title><style type="text/css">
div#thesite
{
  font-family   : "Open Sans", sans-serif;
  font-size     : 1em !important;
  margin-top    : 1em;
  margin-bottom : 1em;
}

div#thesite h1
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite h2
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite h3
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite h4
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite h5
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite h6
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite .ui.breadcrumb.rib .section
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite .header
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite .as-header
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite code, pre, tt
{
  font-family : "SFMono-Regular","Menlo","Monaco","Consolas","Liberation Mono","Courier New", monospace;
}

div#thesite .ui.breadcrumb.rib
{
  margin-bottom : 1em;
}



div#thesite .ui.comments.messages .comment .metadata a
{
  color : #808080;
}

div#thesite .ui.comments.messages .comment a.avatar img
{
  height : auto;
}

div#thesite .subtle
{
  color : #808080;
}


div#thesite .messages pre
{
  font-size : 85%;
  overflow  : auto;
  max-width : 100%;
}

div#thesite .messages .message_embed
{
  border-left  : solid 3px #808080;
  padding-left : 0.69999em;
}

div#thesite .messages .message_inline_image img
{
  max-width     : 100%;
  margin-bottom : 1em;
}


/* Generated with Clay, http://fvisser.nl/clay */</style><link href="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.4.1/semantic.min.css" rel="stylesheet"><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/all.min.css" rel="stylesheet"><link href="https://fonts.googleapis.com/css?family=Open+Sans|Oswald&amp;display=swap" rel="stylesheet"><link href="https://fonts.googleapis.com/css?family=Roboto|Open+Sans&amp;display=swap" rel="stylesheet"></head><body><div id="thesite" class="ui text container"><div class="ui violet inverted top attached center aligned segment"><h1 class="ui huge header">persistent insertKey - Haskell</h1></div><div class="ui attached segment"><div class="ui message"><p>Welcome to the Functional Programming Zulip Chat Archive. You can join the chat <a href="https://funprog.zulipchat.com">here</a>.</p></div><div class="ui breadcrumb rib"><a href="/" class="section">Home</a><i class="right angle icon divider"></i><a href="/haskell/" class="section">#Haskell</a><i class="right angle icon divider"></i><div class="active section">persistent insertKey</div></div><div class="ui comments messages"><div class="comment"><a class="avatar"><img src="https://www.gravatar.com/avatar/51413c298d0dbf10639e259f8af5b837"></a><div class="content"><a class="author">Pavan Rikhi</a><div class="metadata"><a href="#181946741" name="181946741"><div>2019-11-26 17:56:59</div></a></div><div class="text"><p>I'm running a database migration from MySQL -&gt; Postgresql. I want to retain the ID values so I used Persistent's <code>insertKey</code> function to set the IDs when inserting records. However, when the application decides to insert a row(during normal operation, not as part of the data migration), it gets an error since apparently the primary key sequence doesn't get updated when you use <code>insertKey</code>. Is there a simple way to fix this w/ persistent or should I just query the max ID and fix the sequence with some rawsql?</p></div></div></div><div class="comment"><a class="avatar"><img src="https://www.gravatar.com/avatar/51413c298d0dbf10639e259f8af5b837"></a><div class="content"><a class="author">Pavan Rikhi</a><div class="metadata"><a href="#181947585" name="181947585"><div>2019-11-26 18:05:40</div></a></div><div class="text"><p>Related: Can I grab all the <code>EntityDef</code>s for a TH-generated schema? That'll let me just fix every ID sequence instead of having to hardcode the sequence names and manually listing the tables that I use <code>insertKey</code> on...</p></div></div></div><div class="comment"><a class="avatar"><img src="https://www.gravatar.com/avatar/51413c298d0dbf10639e259f8af5b837"></a><div class="content"><a class="author">Pavan Rikhi</a><div class="metadata"><a href="#181964076" name="181964076"><div>2019-11-26 21:07:39</div></a></div><div class="text"><p>Ended up with this:</p>
<div class="codehilite"><pre><span></span><span class="nf">fixIdSequences</span> <span class="ow">::</span> <span class="kt">SqlPersistT</span> <span class="kt">IO</span> <span class="nb">()</span>
<span class="nf">fixIdSequences</span> <span class="ow">=</span> <span class="n">void</span> <span class="o">$</span>
    <span class="n">fixIdSequence</span> <span class="o">@</span><span class="kt">Category</span> <span class="o">&gt;&gt;</span>
    <span class="n">fixIdSequence</span> <span class="o">@</span><span class="kt">Product</span> <span class="o">&gt;&gt;</span>
    <span class="n">fixIdSequence</span> <span class="o">@</span><span class="kt">Page</span> <span class="o">&gt;&gt;</span>
    <span class="n">fixIdSequence</span> <span class="o">@</span><span class="kt">Customer</span> <span class="o">&gt;&gt;</span>
    <span class="n">fixIdSequence</span> <span class="o">@</span><span class="kt">Order</span>
  <span class="kr">where</span>
    <span class="n">fixIdSequence</span> <span class="ow">::</span> <span class="n">forall</span> <span class="n">e</span><span class="o">.</span> <span class="p">(</span><span class="kt">PersistEntity</span> <span class="n">e</span><span class="p">)</span> <span class="ow">=&gt;</span> <span class="kt">SqlPersistT</span> <span class="kt">IO</span> <span class="p">[</span><span class="kt">Single</span> <span class="kt">Int</span><span class="p">]</span>
    <span class="n">fixIdSequence</span> <span class="ow">=</span>
        <span class="kr">let</span>
            <span class="n">table</span> <span class="ow">=</span>
                <span class="n">unDBName</span> <span class="o">$</span> <span class="n">tableDBName</span> <span class="o">@</span><span class="n">e</span> <span class="n">undefined</span>
            <span class="n">key</span> <span class="ow">=</span>
                <span class="n">unDBName</span> <span class="o">$</span> <span class="n">fieldDBName</span> <span class="o">$</span> <span class="n">persistIdField</span> <span class="o">@</span><span class="n">e</span>
        <span class="kr">in</span>
        <span class="n">rawSql</span>
            <span class="p">(</span> <span class="s">&quot;SELECT setval(&quot;</span>
            <span class="o">&lt;&gt;</span> <span class="s">&quot;    pg_get_serial_sequence(?,?), &quot;</span>
            <span class="o">&lt;&gt;</span> <span class="s">&quot;    COALESCE(MAX(&quot;</span> <span class="o">&lt;&gt;</span> <span class="n">key</span> <span class="o">&lt;&gt;</span> <span class="s">&quot;), 1), &quot;</span>
            <span class="o">&lt;&gt;</span> <span class="s">&quot;    MAX(&quot;</span> <span class="o">&lt;&gt;</span> <span class="n">key</span> <span class="o">&lt;&gt;</span> <span class="s">&quot;) IS NOT null) &quot;</span>
            <span class="o">&lt;&gt;</span> <span class="s">&quot;FROM </span><span class="se">\&quot;</span><span class="s">&quot;</span> <span class="o">&lt;&gt;</span> <span class="n">table</span> <span class="o">&lt;&gt;</span> <span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">&quot;</span><span class="p">)</span>
            <span class="p">[</span><span class="kt">PersistText</span> <span class="n">table</span><span class="p">,</span> <span class="kt">PersistText</span> <span class="n">key</span><span class="p">]</span>
</pre></div>


<p>Wasn't sure how to get unquoted strings or double-quoted table names into <code>rawSql</code> <span aria-label="confused" class="emoji emoji-1f615" role="img" title="confused">:confused:</span></p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/ff257a6548bf89508a0a7fb6bc2833ea7aa7bf20?version=3"></a><div class="content"><a class="author">Jack Henahan</a><div class="metadata"><a href="#181965686" name="181965686"><div>2019-11-26 21:24:11</div></a></div><div class="text"><p>Does persistent not have prepared statements? Woof</p></div></div></div><div class="comment"><a class="avatar"><img src="https://www.gravatar.com/avatar/51413c298d0dbf10639e259f8af5b837"></a><div class="content"><a class="author">Pavan Rikhi</a><div class="metadata"><a href="#181965865" name="181965865"><div>2019-11-26 21:27:27</div></a></div><div class="text"><p>Well preparing the statement with <code>PersistText</code> renders <code>key_field</code> as <code>'key_field'</code> &amp; I wasn't sure how to make it be just <code>key_field</code> w/o the single quotes</p></div></div></div><div class="comment"><a class="avatar"><img src="https://www.gravatar.com/avatar/51413c298d0dbf10639e259f8af5b837"></a><div class="content"><a class="author">Pavan Rikhi</a><div class="metadata"><a href="#181965894" name="181965894"><div>2019-11-26 21:27:54</div></a></div><div class="text"><p>And didn't care enough to investigate further.</p></div></div></div><div class="comment"><a class="avatar"><img src="https://www.gravatar.com/avatar/51413c298d0dbf10639e259f8af5b837"></a><div class="content"><a class="author">Pavan Rikhi</a><div class="metadata"><a href="#181966075" name="181966075"><div>2019-11-26 21:28:31</div></a></div><div class="text"><p>And <code>table</code> needs to be rendered as <code>"table"</code> instead of <code>'table'</code></p></div></div></div><div class="comment"><a class="avatar"><img src="https://www.gravatar.com/avatar/51413c298d0dbf10639e259f8af5b837"></a><div class="content"><a class="author">Pavan Rikhi</a><div class="metadata"><a href="#181966141" name="181966141"><div>2019-11-26 21:29:13</div></a></div><div class="text"><p>It works and it's a script that only gets run once so <span aria-label="shrug" class="emoji emoji-1f937" role="img" title="shrug">:shrug:</span></p></div></div></div><div class="comment"><a class="avatar"><img src="https://www.gravatar.com/avatar/4ba4faf2fc5818d37c0aed6acb5b69a2"></a><div class="content"><a class="author">James King</a><div class="metadata"><a href="#182027335" name="182027335"><div>2019-11-27 15:07:20</div></a></div><div class="text"><p>iirc, in postgresql-simple, quoted object names such as tables use <code>??</code> and values use <code>?</code>... maybe persistent uses the same convention?</p></div></div></div><div class="comment"><a class="avatar"><img src="https://www.gravatar.com/avatar/51413c298d0dbf10639e259f8af5b837"></a><div class="content"><a class="author">Pavan Rikhi</a><div class="metadata"><a href="#182041247" name="182041247"><div>2019-11-27 17:36:38</div></a></div><div class="text"><p>Nope, it sees <code>??</code> as two <code>?</code> that are side by side</p></div></div></div><div class="comment"><a class="avatar"><img src="https://www.gravatar.com/avatar/51413c298d0dbf10639e259f8af5b837"></a><div class="content"><a class="author">Pavan Rikhi</a><div class="metadata"><a href="#182041292" name="182041292"><div>2019-11-27 17:37:10</div></a></div><div class="text"><p>It uses <code>??</code> in the field list for <code>SELECT</code> when you want to return an entire entity.</p></div></div></div></div></div><div class="ui vertical footer segment"><a href="https://github.com/srid/zulip-archive">Powered by Haskell</a> | Questions? Contact <a href="https://www.srid.ca">srid</a></div></div></body></html>