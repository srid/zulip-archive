<html lang="en"><head><meta content="text/html; charset=utf-8" http-equiv="Content-Type"><meta content="width=device-width, initial-scale=1" name="viewport"><meta content="What&#39;s the easiest way to make this work
{-# LANGUAGE TypeFamilies, FunctionalDependencies, LambdaCase #-}
module SOP.Sums where

import MyPrelude

import GHC.Generics

import Data.Void

import Optics

type family Sum (xs :: [*]) :: *
  where
  Sum &#39;[] = Void
  Sum (x &#39;: xs) = Either x (Sum xs)

cla" name="description"><link href="https://funprog.srid.ca/haskell/illegal-type-synonym-family-in-instance.html" rel="canonical"><meta property="og:title" content="Illegal type synonym family in instance - Haskell"><meta property="og:site_name" content="Functional Programming Zulip Archive"><meta property="og:type" content="article"><meta property="og:article:section" content="Haskell"><meta property="og:article:modified_time" content="2020-03-02T01:10:46Z"><meta property="og:article:published_time" content="2020-03-02T00:09:32Z"><title>Illegal type synonym family in instance - Haskell</title><style type="text/css">
div#thesite
{
  font-family   : "Open Sans", sans-serif;
  font-size     : 1em !important;
  margin-top    : 1em;
  margin-bottom : 1em;
}

div#thesite h1
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite h2
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite h3
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite h4
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite h5
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite h6
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite .ui.breadcrumb.rib .section
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite .header
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite .as-header
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite code, pre, tt
{
  font-family : "SFMono-Regular","Menlo","Monaco","Consolas","Liberation Mono","Courier New", monospace;
}

div#thesite .ui.breadcrumb.rib
{
  margin-bottom : 1em;
}



div#thesite .ui.comments.messages .comment .metadata a
{
  color : #808080;
}

div#thesite .ui.comments.messages .comment a.avatar img
{
  height : auto;
}

div#thesite .subtle
{
  color : #808080;
}


div#thesite .messages pre
{
  font-size : 85%;
  overflow  : auto;
  max-width : 100%;
}

div#thesite .messages .message_embed
{
  border-left  : solid 3px #808080;
  padding-left : 0.69999em;
}

div#thesite .messages .message_inline_image img
{
  max-width     : 100%;
  margin-bottom : 1em;
}


/* Generated with Clay, http://fvisser.nl/clay */</style><link href="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.4.1/semantic.min.css" rel="stylesheet"><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/all.min.css" rel="stylesheet"><link href="https://fonts.googleapis.com/css?family=Open+Sans|Oswald&amp;display=swap" rel="stylesheet"><link href="https://fonts.googleapis.com/css?family=Roboto|Open+Sans&amp;display=swap" rel="stylesheet"></head><body><div id="thesite" class="ui text container"><div class="ui violet inverted top attached center aligned segment"><h1 class="ui huge header">Illegal type synonym family in instance - Haskell</h1></div><div class="ui attached segment"><div class="ui message"><p>Welcome to the Functional Programming Zulip Chat Archive. You can join the chat <a href="https://funprog.zulipchat.com">here</a>.</p></div><div class="ui breadcrumb rib"><a href="/" class="section">Home</a><i class="right angle icon divider"></i><a href="/haskell/" class="section">#Haskell</a><i class="right angle icon divider"></i><div class="active section">Illegal type synonym family in instance</div></div><div class="ui comments messages"><div class="comment"><a class="avatar"></a><div class="content"><a class="author">Asad Saeeduddin</a><div class="metadata"><a href="#189454218" name="189454218"><div>2020-03-02 00:09:32</div></a></div><div class="text"><p>What's the easiest way to make this work</p>
<div class="codehilite"><pre><span></span>{-# LANGUAGE TypeFamilies, FunctionalDependencies, LambdaCase #-}
module SOP.Sums where

import MyPrelude

import GHC.Generics

import Data.Void

import Optics

type family Sum (xs :: [*]) :: *
  where
  Sum &#39;[] = Void
  Sum (x &#39;: xs) = Either x (Sum xs)

class Coproduct c xs | c -&gt; xs
  where
  asCoproduct :: Iso&#39; c (Sum xs)

instance Coproduct (U1 p) &#39;[()]
  where
  asCoproduct = iso (\U1 -&gt; Left ()) (either (const U1) absurd)

instance Coproduct (K1 i c p) &#39;[c]
  where
  asCoproduct = iso (\(K1 c) -&gt; Left c) (either K1 absurd)

instance (Functor f, Coproduct (f p) xs) =&gt; Coproduct (M1 i c f p) xs
  where
  asCoproduct = iso (\(M1 fp) -&gt; fwd asCoproduct fp) (M1 . bwd asCoproduct)

type family xs ++ ys :: [*]
  where
  &#39;[] ++ xs = xs
  (x &#39;: xs) ++ ys = x &#39;: (xs ++ys)

instance (Coproduct (f p) xs, Coproduct (g p) ys) =&gt; Coproduct ((f :+: g) p) (xs ++ ys)
  where
  asCoproduct = iso (\case { L1 fp -&gt; Left fp; R1 gp -&gt; Right $ fwd asCoproduct gp }) (either L1 (R1 . bwd asCoproduct))
</pre></div></div></div></div><div class="comment"><a class="avatar"></a><div class="content"><a class="author">Asad Saeeduddin</a><div class="metadata"><a href="#189454220" name="189454220"><div>2020-03-02 00:09:49</div></a></div><div class="text"><p>Right now it gives:</p>
<div class="codehilite"><pre><span></span>[typecheck] [E] /mnt/data/depot/git/haskell/repos/co-optics/src/SOP/Sums.hs:38:54: error:
    • Illegal type synonym family application in instance: xs ++ ys
    • In the instance declaration for
        ‘Coproduct ((f :+: g) p) (xs ++ ys)’
</pre></div></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/89529ef093c72e16a5ce3ac00d88f354ccc08cf9?x=x&amp;version=2"></a><div class="content"><a class="author">Lysxia</a><div class="metadata"><a href="#189454300" name="189454300"><div>2020-03-02 00:11:59</div></a></div><div class="text"><p><code>instance (Coproduct (f p) xs, Coproduct (g p) ys, xs ++ ys ~ zs) =&gt; Coproduct ((f :+: g) p) zs</code> perhaps?</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/89529ef093c72e16a5ce3ac00d88f354ccc08cf9?x=x&amp;version=2"></a><div class="content"><a class="author">Lysxia</a><div class="metadata"><a href="#189454405" name="189454405"><div>2020-03-02 00:14:47</div></a></div><div class="text"><p>You will need more constraints to inject <code>Sum xs</code> and <code>Sum ys</code> into <code>Sum (xs ++ ys)</code>.</p></div></div></div><div class="comment"><a class="avatar"></a><div class="content"><a class="author">Asad Saeeduddin</a><div class="metadata"><a href="#189454716" name="189454716"><div>2020-03-02 00:25:46</div></a></div><div class="text"><p>Yeah, I ended up doing the weird hack I resort to in these situations</p></div></div></div><div class="comment"><a class="avatar"></a><div class="content"><a class="author">Asad Saeeduddin</a><div class="metadata"><a href="#189454720" name="189454720"><div>2020-03-02 00:25:50</div></a></div><div class="text"><div class="codehilite"><pre><span></span>class Append (xs :: [*]) (ys :: [*]) (zs :: [*]) | xs ys -&gt; zs
  where
  appendCoproducts :: Proxy xs -&gt; Proxy ys -&gt; Either (Sum xs) (Sum ys) -&gt; Sum zs

instance Append &#39;[] ys ys
  where
  appendCoproducts _ _ = either absurd id

instance Append xs ys zs =&gt; Append (x &#39;: xs) ys (x &#39;: zs)
  where
  appendCoproducts (_ :: Proxy (x &#39;: xs)) (_ :: Proxy ys) = either (either Left (\xs -&gt; Right $ appendCoproducts (Proxy @xs) (Proxy @ys) $ Left xs)) (\ys -&gt; Right $ appendCoproducts (Proxy @xs) (Proxy @ys) (Right ys))

instance (Coproduct (f p) xs, Coproduct (g p) ys, Append xs ys zs) =&gt; Coproduct ((f :+: g) p) zs
  where
  asCoproduct = iso _ _
</pre></div></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/89529ef093c72e16a5ce3ac00d88f354ccc08cf9?x=x&amp;version=2"></a><div class="content"><a class="author">Lysxia</a><div class="metadata"><a href="#189455020" name="189455020"><div>2020-03-02 00:34:45</div></a></div><div class="text"><p>There's usually a compact continuation-passing solution too.</p></div></div></div><div class="comment"><a class="avatar"></a><div class="content"><a class="author">Asad Saeeduddin</a><div class="metadata"><a href="#189455022" name="189455022"><div>2020-03-02 00:34:47</div></a></div><div class="text"><p>Alas, now I've realized I might not have enough information altogether:</p>
<div class="codehilite"><pre><span></span>class Append (xs :: [*]) (ys :: [*]) (zs :: [*]) | xs ys -&gt; zs
  where
  (|||) :: Proxy xs -&gt; Proxy ys -&gt; Either (Sum xs) (Sum ys) -&gt; Sum zs

instance Append &#39;[] ys ys
  where
  _ ||| _ = either absurd id

instance Append xs ys zs =&gt; Append (x &#39;: xs) ys (x &#39;: zs)
  where
  (_ :: Proxy (x &#39;: xs)) ||| (_ :: Proxy ys) = either (either Left (\xs -&gt; Right $ (Proxy @xs ||| Proxy @ys) $ Left xs)) (\ys -&gt; Right $ (Proxy @xs ||| Proxy @ys) (Right ys))

instance (Coproduct (f p) xs, Coproduct (g p) ys, Append xs ys zs) =&gt; Coproduct ((f :+: g) p) zs
  where
  asCoproduct = iso
    (\case { L1 fp  -&gt; (Proxy @xs ||| Proxy @ys) $ Left $ fwd asCoproduct fp; R1 gp -&gt; (Proxy @xs ||| Proxy @ys) $ Right $ fwd asCoproduct gp })
    _
</pre></div></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/89529ef093c72e16a5ce3ac00d88f354ccc08cf9?x=x&amp;version=2"></a><div class="content"><a class="author">Lysxia</a><div class="metadata"><a href="#189455032" name="189455032"><div>2020-03-02 00:35:08</div></a></div><div class="text"><p>What's the error?</p></div></div></div><div class="comment"><a class="avatar"></a><div class="content"><a class="author">Asad Saeeduddin</a><div class="metadata"><a href="#189455044" name="189455044"><div>2020-03-02 00:36:01</div></a></div><div class="text"><p>There's no error, but I've ended up needing to produce <code>Sum zs -&gt; (f :+: g) p</code></p></div></div></div><div class="comment"><a class="avatar"></a><div class="content"><a class="author">Asad Saeeduddin</a><div class="metadata"><a href="#189455085" name="189455085"><div>2020-03-02 00:36:25</div></a></div><div class="text"><p>idk if I can do that without an extra index or something. maybe I'm not thinking about it clearly though</p></div></div></div><div class="comment"><a class="avatar"></a><div class="content"><a class="author">Asad Saeeduddin</a><div class="metadata"><a href="#189455169" name="189455169"><div>2020-03-02 00:39:41</div></a></div><div class="text"><p>What I need is <code>Iso (Either (Sum xs) (Sum ys)) (Sum zs)</code>, right?</p></div></div></div><div class="comment"><a class="avatar"></a><div class="content"><a class="author">Asad Saeeduddin</a><div class="metadata"><a href="#189455174" name="189455174"><div>2020-03-02 00:39:54</div></a></div><div class="text"><p>or can I get away with the unidirectional thing I have now somehow</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/89529ef093c72e16a5ce3ac00d88f354ccc08cf9?x=x&amp;version=2"></a><div class="content"><a class="author">Lysxia</a><div class="metadata"><a href="#189455225" name="189455225"><div>2020-03-02 00:40:51</div></a></div><div class="text"><p>yes you need <code>Append</code> or whatever constraint you end up with to contain an iso</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/89529ef093c72e16a5ce3ac00d88f354ccc08cf9?x=x&amp;version=2"></a><div class="content"><a class="author">Lysxia</a><div class="metadata"><a href="#189455360" name="189455360"><div>2020-03-02 00:45:37</div></a></div><div class="text"><p>The continuation-passing way is to use a ternary class, quantifying over "the rest of the sum". Then you won't need an auxiliary <code>Append</code> constraint for the <code>(:+:)</code> instance.</p>
<div class="codehilite"><pre><span></span><span class="kr">class</span> <span class="kt">Coproduct&#39;</span> <span class="n">c</span> <span class="n">rs</span> <span class="n">xs</span> <span class="kr">where</span>
  <span class="n">asCoproduct&#39;</span> <span class="ow">::</span> <span class="kt">Iso&#39;</span> <span class="p">(</span><span class="kt">Either</span> <span class="n">c</span> <span class="p">(</span><span class="kt">Sum</span> <span class="n">rs</span><span class="p">))</span> <span class="p">(</span><span class="kt">Sum</span> <span class="n">xs</span><span class="p">)</span>
</pre></div></div></div></div><div class="comment"><a class="avatar"></a><div class="content"><a class="author">Asad Saeeduddin</a><div class="metadata"><a href="#189455361" name="189455361"><div>2020-03-02 00:45:42</div></a></div><div class="text"><p><span class="user-mention" data-user-id="251302">@Lysxia</span> You think I can actually implement the cons instance as an iso?</p></div></div></div><div class="comment"><a class="avatar"></a><div class="content"><a class="author">Asad Saeeduddin</a><div class="metadata"><a href="#189455364" name="189455364"><div>2020-03-02 00:45:57</div></a></div><div class="text"><p>without additional type level information I mean</p></div></div></div><div class="comment"><a class="avatar"></a><div class="content"><a class="author">Asad Saeeduddin</a><div class="metadata"><a href="#189455403" name="189455403"><div>2020-03-02 00:46:11</div></a></div><div class="text"><p>I got back up to where I was before, now I need to do the backwards case:</p>
<div class="codehilite"><pre><span></span>class Append (xs :: [*]) (ys :: [*]) (zs :: [*]) | xs ys -&gt; zs
  where
  (|||) :: Proxy xs -&gt; Proxy ys -&gt; Iso&#39; (Either (Sum xs) (Sum ys)) (Sum zs)

instance Append &#39;[] ys ys
  where
  _ ||| _ = iso (either absurd id) Right

instance Append xs ys zs =&gt; Append (x &#39;: xs) ys (x &#39;: zs)
  where
  (_ :: Proxy (x &#39;: xs)) ||| (_ :: Proxy ys) = iso
    (either
      (either Left (Right . fwd (Proxy @xs ||| Proxy @ys) . Left))
      (Right . fwd (Proxy @xs ||| Proxy @ys) . Right))
    _
</pre></div></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/89529ef093c72e16a5ce3ac00d88f354ccc08cf9?x=x&amp;version=2"></a><div class="content"><a class="author">Lysxia</a><div class="metadata"><a href="#189455409" name="189455409"><div>2020-03-02 00:46:57</div></a></div><div class="text"><p>sure that looks feasible</p></div></div></div><div class="comment"><a class="avatar"></a><div class="content"><a class="author">Asad Saeeduddin</a><div class="metadata"><a href="#189455426" name="189455426"><div>2020-03-02 00:47:49</div></a></div><div class="text"><p>weird, it worked out</p></div></div></div><div class="comment"><a class="avatar"></a><div class="content"><a class="author">Asad Saeeduddin</a><div class="metadata"><a href="#189455465" name="189455465"><div>2020-03-02 00:48:04</div></a></div><div class="text"><p>i just filled out the holes, but I don't really get how one direction doesn't destroy some information</p></div></div></div><div class="comment"><a class="avatar"></a><div class="content"><a class="author">Asad Saeeduddin</a><div class="metadata"><a href="#189455469" name="189455469"><div>2020-03-02 00:48:09</div></a></div><div class="text"><p>like, mashing them together</p></div></div></div><div class="comment"><a class="avatar"></a><div class="content"><a class="author">Asad Saeeduddin</a><div class="metadata"><a href="#189455603" name="189455603"><div>2020-03-02 00:53:12</div></a></div><div class="text"><p>whew</p></div></div></div><div class="comment"><a class="avatar"></a><div class="content"><a class="author">Asad Saeeduddin</a><div class="metadata"><a href="#189455606" name="189455606"><div>2020-03-02 00:53:32</div></a></div><div class="text"><p>ok, so it all works, I'll add a note to do it the right way with the CPS approach later</p></div></div></div><div class="comment"><a class="avatar"></a><div class="content"><a class="author">Asad Saeeduddin</a><div class="metadata"><a href="#189455848" name="189455848"><div>2020-03-02 01:01:04</div></a></div><div class="text"><p>conveniently we can link to messages in this thing, so I won't have to ask you five more times <span aria-label="sweat smile" class="emoji emoji-1f605" role="img" title="sweat smile">:sweat_smile:</span></p></div></div></div><div class="comment"><a class="avatar"></a><div class="content"><a class="author">Asad Saeeduddin</a><div class="metadata"><a href="#189456206" name="189456206"><div>2020-03-02 01:10:46</div></a></div><div class="text"><p>Here's the whole thing for anyone who's interested: <a href="https://gist.github.com/masaeedu/f80f47bb1fcf8412dccc3edef1bbd21a" target="_blank" title="https://gist.github.com/masaeedu/f80f47bb1fcf8412dccc3edef1bbd21a">https://gist.github.com/masaeedu/f80f47bb1fcf8412dccc3edef1bbd21a</a></p>
<div class="message_embed"><a class="message_embed_image" href="https://gist.github.com/masaeedu/f80f47bb1fcf8412dccc3edef1bbd21a" style="background-image: url(https://github.githubassets.com/images/modules/gists/gist-og-image.png)" target="_blank"></a><div class="data-container"><div class="message_embed_title"><a href="https://gist.github.com/masaeedu/f80f47bb1fcf8412dccc3edef1bbd21a" target="_blank" title="Generic coproducts">Generic coproducts</a></div><div class="message_embed_description">Generic coproducts. GitHub Gist: instantly share code, notes, and snippets.</div></div></div></div></div></div></div></div><div class="ui vertical footer segment"><a href="https://github.com/srid/zulip-archive">Powered by Haskell</a> | Questions? Contact <a href="https://www.srid.ca">srid</a></div></div></body></html>