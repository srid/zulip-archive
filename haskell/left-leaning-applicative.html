<html lang="en"><head><meta content="text/html; charset=utf-8" http-equiv="Content-Type"><meta content="width=device-width, initial-scale=1" name="viewport"><meta content="Here&#39;s a little puzzle: find an applicative transformer that keeps (&lt;*&gt;) associated to the left. So if you write x &lt;*&gt; (y &lt;*&gt; z) it should simplify to something like ((\f g h -&gt; f (g h)) &lt;$&gt; x &lt;*&gt; y) &lt;*&gt; z (and you can see here that getting the types to line up can get pretty tricky).
For a related " name="description"><link href="https://funprog.srid.ca/haskell/left-leaning-applicative.html" rel="canonical"><meta property="og:title" content="Left-leaning applicative - Haskell"><meta property="og:site_name" content="Functional Programming Zulip Archive"><meta property="og:type" content="article"><meta property="og:article:section" content="Haskell"><meta property="og:article:modified_time" content="2020-04-19T18:12:00Z"><meta property="og:article:published_time" content="2020-04-19T15:18:51Z"><meta property="og:image" content="https://zulip-avatars.s3.amazonaws.com/13896/89529ef093c72e16a5ce3ac00d88f354ccc08cf9?version=2"><title>Left-leaning applicative - Haskell</title><style type="text/css">
div#thesite
{
  font-family   : "Open Sans", sans-serif;
  font-size     : 1em !important;
  margin-top    : 1em;
  margin-bottom : 1em;
}

div#thesite h1
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite h2
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite h3
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite h4
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite h5
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite h6
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite .ui.breadcrumb.rib .section
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite .header
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite .as-header
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite code, pre, tt
{
  font-family : "SFMono-Regular","Menlo","Monaco","Consolas","Liberation Mono","Courier New", monospace;
}

div#thesite .ui.breadcrumb.rib
{
  margin-bottom : 1em;
}



div#thesite .ui.comments.messages .comment .metadata a
{
  color : #808080;
}

div#thesite .ui.comments.messages .comment a.avatar img
{
  height : auto;
}

div#thesite .subtle
{
  color : #808080;
}


div#thesite .messages pre
{
  font-size : 85%;
  overflow  : auto;
  max-width : 100%;
}

div#thesite .messages .message_embed
{
  border-left  : solid 3px #808080;
  padding-left : 0.69999em;
}

div#thesite .messages .message_inline_image img
{
  max-width     : 100%;
  margin-bottom : 1em;
}


/* Generated with Clay, http://fvisser.nl/clay */</style><link href="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.4.1/semantic.min.css" rel="stylesheet"><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/all.min.css" rel="stylesheet"><link href="https://fonts.googleapis.com/css?family=Open+Sans|Oswald&amp;display=swap" rel="stylesheet"><link href="https://fonts.googleapis.com/css?family=Roboto|Open+Sans&amp;display=swap" rel="stylesheet"></head><body><div id="thesite" class="ui text container"><div class="ui violet inverted top attached center aligned segment"><h1 class="ui huge header">Left-leaning applicative - Haskell</h1></div><div class="ui attached segment"><div class="ui message"><p>Welcome to the Functional Programming Zulip Chat Archive. You can join the chat <a href="https://funprog.zulipchat.com">here</a>.</p></div><div class="ui breadcrumb rib"><a href="/" class="section">Home</a><i class="right angle icon divider"></i><a href="/haskell/" class="section">#Haskell</a><i class="right angle icon divider"></i><div class="active section">Left-leaning applicative</div></div><div class="ui comments messages"><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/89529ef093c72e16a5ce3ac00d88f354ccc08cf9?version=2"></a><div class="content"><a class="author">Lysxia</a><div class="metadata"><a href="#194602675" name="194602675"><div>2020-04-19 15:18:51</div></a></div><div class="text"><p>Here's a little puzzle: <strong>find an applicative transformer that keeps <code>(&lt;*&gt;)</code> associated to the left.</strong> So if you write <code>x &lt;*&gt; (y &lt;*&gt; z)</code> it should simplify to something like <code>((\f g h -&gt; f (g h)) &lt;$&gt; x &lt;*&gt; y) &lt;*&gt; z</code> (and you can see here that getting the types to line up can get pretty tricky).</p>
<p>For a related example, the <code>Cont</code> and <code>Codensity</code> monad transformers keep <code>(&gt;&gt;=)</code> associated to the right. (Note that for applicatives, unlike monads, the "left-" and "right-leaning" variants of the problem are symmetrical if you also replace <code>(&lt;*&gt;)</code> with a flipped version.)</p>
<p>One idea is to look for a free applicative, but the three variants in the <em>free</em> library are not ideal. Two are recursive data structures, so that prevents inlining (if not for that, they would probably be okay). The third doesn't reassociate anything. </p>
<p>I have a working solution (and I'd be happy to talk about it), but <strong>is there anything simpler than this?</strong> or is it somehow necessary to reach for (rank 2, order 4)-functions?</p>
<div class="codehilite"><pre><span></span><span class="kr">newtype</span> <span class="kt">DAp</span> <span class="n">f</span> <span class="n">a</span> <span class="ow">=</span> <span class="kt">DAp</span> <span class="p">{</span> <span class="n">unDAp</span> <span class="ow">::</span>
  <span class="n">forall</span> <span class="n">r</span><span class="o">.</span> <span class="p">(</span><span class="n">forall</span> <span class="n">u</span><span class="o">.</span> <span class="p">((</span><span class="n">a</span> <span class="ow">-&gt;</span> <span class="n">r</span><span class="p">)</span> <span class="ow">-&gt;</span> <span class="n">u</span><span class="p">)</span> <span class="ow">-&gt;</span> <span class="n">f</span> <span class="n">u</span><span class="p">)</span> <span class="ow">-&gt;</span> <span class="n">f</span> <span class="n">r</span> <span class="p">}</span>
</pre></div>


<p>Some remarks:</p>
<ul>
<li>I am more specifically interested in the problem using  <code>(&lt;*&gt;)</code> rather than <code>liftA2</code>, but it's also cool to think about the <code>liftA2</code> variant.</li>
<li>It's also important to <em>not</em> freely insert <code>(&lt;$&gt;)</code>.</li>
<li>For those wondering, I need this for generic deriving of <code>Traversable</code> instances that simpify to Core terms identical to what's produced by the <code>DeriveTraversable</code> extension. It's not strictly necessary to do it with a "left-leaning applicative", but I'm posing this as a fun little problem of its own.</li>
</ul></div></div></div><div class="comment"><a class="avatar"><img src="https://www.gravatar.com/avatar/520889f20a2c66a8f4bd5be6f37d2923"></a><div class="content"><a class="author">Asad Saeeduddin</a><div class="metadata"><a href="#194605118" name="194605118"><div>2020-04-19 16:11:47</div></a></div><div class="text"><p><span class="user-mention" data-user-id="251302">@Lysxia</span> Interesting question. I'm not following what it means to have an applicative transformer. How should the output applicative be related to the input applicative? Is it supposed to be the free applicative generated by the input functor?</p></div></div></div><div class="comment"><a class="avatar"><img src="https://www.gravatar.com/avatar/520889f20a2c66a8f4bd5be6f37d2923"></a><div class="content"><a class="author">Asad Saeeduddin</a><div class="metadata"><a href="#194605189" name="194605189"><div>2020-04-19 16:12:36</div></a></div><div class="text"><p>For example what prevents the silly choice of just ignoring the input applicative and constantly producing some arbitrary left associated applicative?</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/89529ef093c72e16a5ce3ac00d88f354ccc08cf9?version=2"></a><div class="content"><a class="author">Lysxia</a><div class="metadata"><a href="#194605241" name="194605241"><div>2020-04-19 16:13:39</div></a></div><div class="text"><p>Good question! I think any solution would probably hide a free applicative somewhere, but it's not necessary to frame the problem in those terms.</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/89529ef093c72e16a5ce3ac00d88f354ccc08cf9?version=2"></a><div class="content"><a class="author">Lysxia</a><div class="metadata"><a href="#194605322" name="194605322"><div>2020-04-19 16:14:57</div></a></div><div class="text"><p>The requirement is that you can wrap any applicative with that transformer, combine stuff in the wrapped applicative, and then unwrap it at the end.</p>
<div class="codehilite"><pre><span></span>toAp :: Applicative f =&gt; f a -&gt; Ap f a
fromAp :: Applicative f =&gt; Ap f a -&gt; f a
</pre></div></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/89529ef093c72e16a5ce3ac00d88f354ccc08cf9?version=2"></a><div class="content"><a class="author">Lysxia</a><div class="metadata"><a href="#194605351" name="194605351"><div>2020-04-19 16:15:31</div></a></div><div class="text"><p><code>fromAp . toAp = id</code> plus some homomorphism laws.</p></div></div></div><div class="comment"><a class="avatar"><img src="https://www.gravatar.com/avatar/520889f20a2c66a8f4bd5be6f37d2923"></a><div class="content"><a class="author">Asad Saeeduddin</a><div class="metadata"><a href="#194605432" name="194605432"><div>2020-04-19 16:16:31</div></a></div><div class="text"><p>I haven't thought about it very carefully but as a random thought, given a notion of forgetful higher order functor that does nothing, those look very much like a counit/unit pair</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/89529ef093c72e16a5ce3ac00d88f354ccc08cf9?version=2"></a><div class="content"><a class="author">Lysxia</a><div class="metadata"><a href="#194605531" name="194605531"><div>2020-04-19 16:18:19</div></a></div><div class="text"><p>Oh, I hadn't thought about it this way! That probably has to do with the fact that free constructions are monads :)</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/89529ef093c72e16a5ce3ac00d88f354ccc08cf9?version=2"></a><div class="content"><a class="author">Lysxia</a><div class="metadata"><a href="#194606017" name="194606017"><div>2020-04-19 16:26:25</div></a></div><div class="text"><p>I can provide some inspection tests if you want to know whether a solution fits the bill</p></div></div></div><div class="comment"><a class="avatar"><img src="https://www.gravatar.com/avatar/520889f20a2c66a8f4bd5be6f37d2923"></a><div class="content"><a class="author">Asad Saeeduddin</a><div class="metadata"><a href="#194606024" name="194606024"><div>2020-04-19 16:26:32</div></a></div><div class="text"><p>yes please</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/2f4316c80f59f157d26cb515ed98026308998f44?version=2"></a><div class="content"><a class="author">Nick Scheel</a><div class="metadata"><a href="#194606027" name="194606027"><div>2020-04-19 16:26:35</div></a></div><div class="text"><p>I’m not following this part:</p>
<blockquote>
<p>Two are recursive data structures, so that prevents inlining.</p>
</blockquote>
<p>How would you build a free applicative without recursive data structures?</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/89529ef093c72e16a5ce3ac00d88f354ccc08cf9?version=2"></a><div class="content"><a class="author">Lysxia</a><div class="metadata"><a href="#194606141" name="194606141"><div>2020-04-19 16:28:29</div></a></div><div class="text"><p>With a final encoding like <a href="https://hackage.haskell.org/package/free-5.1.3/docs/Control-Applicative-Free-Final.html" title="https://hackage.haskell.org/package/free-5.1.3/docs/Control-Applicative-Free-Final.html">https://hackage.haskell.org/package/free-5.1.3/docs/Control-Applicative-Free-Final.html</a></p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/2f4316c80f59f157d26cb515ed98026308998f44?version=2"></a><div class="content"><a class="author">Nick Scheel</a><div class="metadata"><a href="#194606154" name="194606154"><div>2020-04-19 16:29:00</div></a></div><div class="text"><p>Ah</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/2f4316c80f59f157d26cb515ed98026308998f44?version=2"></a><div class="content"><a class="author">Nick Scheel</a><div class="metadata"><a href="#194606172" name="194606172"><div>2020-04-19 16:29:47</div></a></div><div class="text"><p>But that doesn’t allow any inspection</p></div></div></div><div class="comment"><a class="avatar"><img src="https://www.gravatar.com/avatar/520889f20a2c66a8f4bd5be6f37d2923"></a><div class="content"><a class="author">Asad Saeeduddin</a><div class="metadata"><a href="#194606175" name="194606175"><div>2020-04-19 16:29:50</div></a></div><div class="text"><p>I don't have an answer yet, but I do have another question that might be helpful. Can we define a "semigroup transformer" that, given a semigroup, produces another semigroup in which all the appends are left associated?</p></div></div></div><div class="comment"><a class="avatar"><img src="https://www.gravatar.com/avatar/520889f20a2c66a8f4bd5be6f37d2923"></a><div class="content"><a class="author">Asad Saeeduddin</a><div class="metadata"><a href="#194606219" name="194606219"><div>2020-04-19 16:30:07</div></a></div><div class="text"><p>I believe difference lists are relevant to this question</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/89529ef093c72e16a5ce3ac00d88f354ccc08cf9?version=2"></a><div class="content"><a class="author">Lysxia</a><div class="metadata"><a href="#194606226" name="194606226"><div>2020-04-19 16:30:24</div></a></div><div class="text"><p>inspection may be one way to do it, but it is not necessary to solve the problem</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/89529ef093c72e16a5ce3ac00d88f354ccc08cf9?version=2"></a><div class="content"><a class="author">Lysxia</a><div class="metadata"><a href="#194606262" name="194606262"><div>2020-04-19 16:31:21</div></a></div><div class="text"><p><span class="user-mention" data-user-id="225136">@Asad Saeeduddin</span> yeah that's what difference lists do!</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/89529ef093c72e16a5ce3ac00d88f354ccc08cf9?version=2"></a><div class="content"><a class="author">Lysxia</a><div class="metadata"><a href="#194606272" name="194606272"><div>2020-04-19 16:31:45</div></a></div><div class="text"><p>you might need a bit of fiddling for the nonempty requirement</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/89529ef093c72e16a5ce3ac00d88f354ccc08cf9?version=2"></a><div class="content"><a class="author">Lysxia</a><div class="metadata"><a href="#194606304" name="194606304"><div>2020-04-19 16:32:02</div></a></div><div class="text"><p>in fact that's basically how my current solution works</p></div></div></div><div class="comment"><a class="avatar"><img src="https://www.gravatar.com/avatar/520889f20a2c66a8f4bd5be6f37d2923"></a><div class="content"><a class="author">Asad Saeeduddin</a><div class="metadata"><a href="#194606322" name="194606322"><div>2020-04-19 16:32:25</div></a></div><div class="text"><p>I'm just talking about semigroups to break it into more compositions of free things, but we can go straight to the monoid if it helps us not worry about nonempty</p></div></div></div><div class="comment"><a class="avatar"><img src="https://www.gravatar.com/avatar/520889f20a2c66a8f4bd5be6f37d2923"></a><div class="content"><a class="author">Asad Saeeduddin</a><div class="metadata"><a href="#194606429" name="194606429"><div>2020-04-19 16:34:46</div></a></div><div class="text"><p>The basic idea i'm thinking about is that the primary function of an applicative is to cohere a semigroup in its codomain with a transported semigroup from its domain</p></div></div></div><div class="comment"><a class="avatar"><img src="https://www.gravatar.com/avatar/520889f20a2c66a8f4bd5be6f37d2923"></a><div class="content"><a class="author">Asad Saeeduddin</a><div class="metadata"><a href="#194606447" name="194606447"><div>2020-04-19 16:35:20</div></a></div><div class="text"><p>We already have the Cayley trick for reassociating monoids, so maybe we can directly apply that somehow</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/2f4316c80f59f157d26cb515ed98026308998f44?version=2"></a><div class="content"><a class="author">Nick Scheel</a><div class="metadata"><a href="#194606456" name="194606456"><div>2020-04-19 16:35:44</div></a></div><div class="text"><p>This has left and right associative (rescursive) free constructions: <a href="https://arxiv.org/pdf/1403.0749.pdf" title="https://arxiv.org/pdf/1403.0749.pdf">https://arxiv.org/pdf/1403.0749.pdf</a></p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/89529ef093c72e16a5ce3ac00d88f354ccc08cf9?version=2"></a><div class="content"><a class="author">Lysxia</a><div class="metadata"><a href="#194606673" name="194606673"><div>2020-04-19 16:39:30</div></a></div><div class="text"><p>If the solution just falls out of Cayley's theorem that would be great :)</p></div></div></div><div class="comment"><a class="avatar"><img src="https://www.gravatar.com/avatar/520889f20a2c66a8f4bd5be6f37d2923"></a><div class="content"><a class="author">Asad Saeeduddin</a><div class="metadata"><a href="#194606922" name="194606922"><div>2020-04-19 16:43:53</div></a></div><div class="text"><p>Here is the "listy" free monoid encoding of a free applicative:</p>
<div class="codehilite"><pre><span></span>data Day f g a = forall x y. Day ((x, y) -&gt; a) (f x) (g y)
newtype FreeApplicative f a = FA { runFA :: (Identity :+: Day f (FreeApplicative f)) a }
</pre></div>


<p>I wonder if we can do Cayley-fication of monoid objects in arbitrary (closed?) monoidal categories</p></div></div></div><div class="comment"><a class="avatar"><img src="https://www.gravatar.com/avatar/520889f20a2c66a8f4bd5be6f37d2923"></a><div class="content"><a class="author">Asad Saeeduddin</a><div class="metadata"><a href="#194607118" name="194607118"><div>2020-04-19 16:46:55</div></a></div><div class="text"><p>the Day convolution monoidal structure is closed, so I suspect the internal arrow gives us a way to "difference listify" this monoid</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/89529ef093c72e16a5ce3ac00d88f354ccc08cf9?version=2"></a><div class="content"><a class="author">Lysxia</a><div class="metadata"><a href="#194607139" name="194607139"><div>2020-04-19 16:47:41</div></a></div><div class="text"><p>Yeah, "Notions of computation as monoids" probably covers this</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/2f4316c80f59f157d26cb515ed98026308998f44?version=2"></a><div class="content"><a class="author">Nick Scheel</a><div class="metadata"><a href="#194607212" name="194607212"><div>2020-04-19 16:48:49</div></a></div><div class="text"><p>As in <a href="https://pursuit.purescript.org/packages/purescript-day/10.0.1/docs/Data.Functor.Day.Hom#t:Hom" title="https://pursuit.purescript.org/packages/purescript-day/10.0.1/docs/Data.Functor.Day.Hom#t:Hom">https://pursuit.purescript.org/packages/purescript-day/10.0.1/docs/Data.Functor.Day.Hom#t:Hom</a> ? Probably would plug in <code>pure identity</code> for <code>f (a -&gt; r)</code> ...</p></div></div></div><div class="comment"><a class="avatar"><img src="https://www.gravatar.com/avatar/520889f20a2c66a8f4bd5be6f37d2923"></a><div class="content"><a class="author">Asad Saeeduddin</a><div class="metadata"><a href="#194607375" name="194607375"><div>2020-04-19 16:52:24</div></a></div><div class="text"><p><span class="user-mention" data-user-id="251225">@Nicholas Scheel</span> Right. Does the associativity then maybe come down to how composition of that internal hom is defined?</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/2f4316c80f59f157d26cb515ed98026308998f44?version=2"></a><div class="content"><a class="author">Nick Scheel</a><div class="metadata"><a href="#194607447" name="194607447"><div>2020-04-19 16:54:06</div></a></div><div class="text"><p>I think so ...</p></div></div></div><div class="comment"><a class="avatar"><img src="https://www.gravatar.com/avatar/520889f20a2c66a8f4bd5be6f37d2923"></a><div class="content"><a class="author">Asad Saeeduddin</a><div class="metadata"><a href="#194607616" name="194607616"><div>2020-04-19 16:57:48</div></a></div><div class="text"><p>I'm confusing myself at this point, but maybe this does something <span aria-label="sweat smile" class="emoji emoji-1f605" role="img" title="sweat smile">:sweat_smile:</span> </p>
<div class="codehilite"><pre><span></span>data Day f g a = forall x y. Day ((x, y) -&gt; a) (f x) (g y)
newtype FA f a = FA { runFA :: (Identity :+: Day f (FreeApplicative f)) a }
newtype Hom f g a = Hom (forall r. f (a -&gt; r) -&gt; g r)
newtype DFA f a = DFA { runDFA :: Hom (FA f) (FA f) a }
</pre></div></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/89529ef093c72e16a5ce3ac00d88f354ccc08cf9?version=2"></a><div class="content"><a class="author">Lysxia</a><div class="metadata"><a href="#194608372" name="194608372"><div>2020-04-19 17:13:40</div></a></div><div class="text"><p>Those purescript instanes for <code>Hom</code> look really weird because they require <code>Monad</code> and <code>Comonad</code> instances</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/2f4316c80f59f157d26cb515ed98026308998f44?version=2"></a><div class="content"><a class="author">Nick Scheel</a><div class="metadata"><a href="#194608431" name="194608431"><div>2020-04-19 17:14:23</div></a></div><div class="text"><p>Yeah, we're not interested in those.</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/89529ef093c72e16a5ce3ac00d88f354ccc08cf9?version=2"></a><div class="content"><a class="author">Lysxia</a><div class="metadata"><a href="#194608441" name="194608441"><div>2020-04-19 17:14:38</div></a></div><div class="text"><p>I see, that doesn't matter for the Cayley representation (<code>Hom f f</code>)</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/89529ef093c72e16a5ce3ac00d88f354ccc08cf9?version=2"></a><div class="content"><a class="author">Lysxia</a><div class="metadata"><a href="#194608469" name="194608469"><div>2020-04-19 17:15:39</div></a></div><div class="text"><p>Looking at this (p22, section 5.4) <a href="https://arxiv.org/pdf/1406.4823.pdf" title="https://arxiv.org/pdf/1406.4823.pdf">https://arxiv.org/pdf/1406.4823.pdf</a> the <code>Applicative</code> instance inserts some <code>fmap</code>, which is a problem for me.</p></div></div></div><div class="comment"><a class="avatar"><img src="https://www.gravatar.com/avatar/520889f20a2c66a8f4bd5be6f37d2923"></a><div class="content"><a class="author">Asad Saeeduddin</a><div class="metadata"><a href="#194608632" name="194608632"><div>2020-04-19 17:19:35</div></a></div><div class="text"><p>it's probably impossible in Haskell, but I'm wondering if at least conceptually a "flat" encoding like this makes any sense:</p>
<div class="codehilite"><pre><span></span><span class="c1">-- probably actually need a class here</span>
<span class="kr">type</span> <span class="kr">family</span> <span class="kt">NAry</span> <span class="p">(</span><span class="n">xs</span> <span class="ow">::</span> <span class="p">[</span><span class="o">*</span><span class="p">])</span> <span class="p">(</span><span class="n">r</span> <span class="ow">::</span> <span class="o">*</span><span class="p">)</span> <span class="ow">::</span> <span class="o">*</span>
  <span class="kr">where</span>
  <span class="kt">NAry</span> <span class="kt">[]</span> <span class="n">r</span> <span class="ow">=</span> <span class="n">r</span>
  <span class="kt">NAry</span> <span class="p">(</span><span class="n">x</span> <span class="kt">:</span> <span class="n">xs</span><span class="p">)</span> <span class="n">r</span> <span class="ow">=</span> <span class="n">x</span> <span class="ow">-&gt;</span> <span class="kt">NAry</span> <span class="n">xs</span> <span class="n">r</span>

<span class="kr">type</span> <span class="kr">family</span> <span class="kt">ZipWith</span> <span class="p">(</span><span class="n">f</span> <span class="ow">::</span> <span class="n">x</span> <span class="ow">-&gt;</span> <span class="n">y</span> <span class="ow">-&gt;</span> <span class="n">z</span><span class="p">)</span> <span class="p">(</span><span class="n">xs</span> <span class="ow">::</span> <span class="p">[</span><span class="n">x</span><span class="p">])</span> <span class="p">(</span><span class="n">ys</span> <span class="ow">::</span> <span class="p">[</span><span class="n">y</span><span class="p">])</span> <span class="ow">::</span> <span class="p">[</span><span class="n">z</span><span class="p">]</span>
  <span class="kr">where</span>
  <span class="o">...</span>

<span class="kr">data</span> <span class="kt">NDay</span> <span class="p">(</span><span class="n">fs</span> <span class="ow">::</span> <span class="p">[</span><span class="o">*</span> <span class="ow">-&gt;</span> <span class="o">*</span><span class="p">])</span> <span class="n">a</span> <span class="ow">=</span> <span class="n">forall</span> <span class="p">(</span><span class="n">xs</span> <span class="ow">::</span> <span class="p">[</span><span class="o">*</span><span class="p">])</span><span class="o">.</span> <span class="kt">NDay</span> <span class="p">(</span><span class="kt">NAry</span> <span class="n">xs</span> <span class="n">a</span><span class="p">)</span> <span class="p">(</span><span class="kt">HList</span> <span class="p">(</span><span class="kt">ZipWith</span> <span class="kt">Apply</span> <span class="n">fs</span> <span class="n">xs</span><span class="p">))</span>

<span class="kr">data</span> <span class="kt">FreeApplicative</span> <span class="n">f</span> <span class="n">a</span> <span class="ow">=</span> <span class="n">forall</span> <span class="p">(</span><span class="n">fs</span> <span class="ow">::</span> <span class="p">[</span><span class="o">*</span> <span class="ow">-&gt;</span> <span class="o">*</span><span class="p">])</span><span class="o">.</span> <span class="kt">All</span> <span class="p">(</span><span class="o">~</span> <span class="n">f</span><span class="p">)</span> <span class="n">fs</span> <span class="ow">=&gt;</span> <span class="kt">FreeApplicative</span> <span class="p">(</span><span class="kt">NDay</span> <span class="n">fs</span> <span class="n">a</span><span class="p">)</span>
</pre></div></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/2f4316c80f59f157d26cb515ed98026308998f44?version=2"></a><div class="content"><a class="author">Nick Scheel</a><div class="metadata"><a href="#194608705" name="194608705"><div>2020-04-19 17:21:18</div></a></div><div class="text"><p>Here's what I have so far:</p>
<div class="codehilite"><pre><span></span><span class="kr">data</span> <span class="kt">Cayley</span> <span class="n">f</span> <span class="n">a</span> <span class="ow">=</span> <span class="kt">Cayley</span> <span class="p">(</span><span class="n">forall</span> <span class="n">r</span><span class="o">.</span> <span class="n">f</span> <span class="p">(</span><span class="n">a</span> <span class="ow">-&gt;</span> <span class="n">r</span><span class="p">)</span> <span class="ow">-&gt;</span> <span class="n">f</span> <span class="n">r</span><span class="p">)</span>
<span class="nf">fromCayley</span> <span class="ow">::</span> <span class="n">forall</span> <span class="n">f</span><span class="o">.</span> <span class="kt">Applicative</span> <span class="n">f</span> <span class="ow">=&gt;</span> <span class="kt">Cayley</span> <span class="n">f</span> <span class="o">~&gt;</span> <span class="n">f</span>
<span class="nf">fromCayley</span> <span class="p">(</span><span class="kt">Cayley</span> <span class="n">f</span><span class="p">)</span> <span class="ow">=</span> <span class="n">f</span> <span class="p">(</span><span class="n">pure</span> <span class="n">identity</span><span class="p">)</span>
<span class="nf">toCayley</span> <span class="ow">::</span> <span class="n">forall</span> <span class="n">f</span><span class="o">.</span> <span class="kt">Applicative</span> <span class="n">f</span> <span class="ow">=&gt;</span> <span class="n">f</span> <span class="o">~&gt;</span> <span class="kt">Cayley</span> <span class="n">f</span>
<span class="nf">toCayley</span> <span class="n">fa</span> <span class="ow">=</span> <span class="kt">Cayley</span> <span class="p">(</span><span class="nf">\</span><span class="n">far</span> <span class="ow">-&gt;</span> <span class="p">(</span><span class="nf">\</span><span class="n">a</span> <span class="n">ar</span> <span class="ow">-&gt;</span> <span class="n">ar</span> <span class="n">a</span><span class="p">)</span> <span class="o">&lt;$&gt;</span> <span class="n">fa</span> <span class="o">&lt;*&gt;</span> <span class="n">far</span><span class="p">)</span>
<span class="nf">pureCayley</span> <span class="ow">::</span> <span class="n">forall</span> <span class="n">f</span> <span class="n">a</span><span class="o">.</span> <span class="kt">Applicative</span> <span class="n">f</span> <span class="ow">=&gt;</span> <span class="n">a</span> <span class="ow">-&gt;</span> <span class="kt">Cayley</span> <span class="n">f</span> <span class="n">a</span>
<span class="nf">pureCayley</span> <span class="n">a</span> <span class="ow">=</span> <span class="kt">Cayley</span> <span class="p">(</span><span class="nf">\</span><span class="n">far</span> <span class="ow">-&gt;</span> <span class="p">(</span><span class="nf">\</span><span class="n">ar</span> <span class="ow">-&gt;</span> <span class="n">ar</span> <span class="n">a</span><span class="p">)</span> <span class="o">&lt;$&gt;</span> <span class="n">far</span><span class="p">)</span>
<span class="nf">applyCayley</span> <span class="ow">::</span> <span class="n">forall</span> <span class="n">f</span> <span class="n">a</span> <span class="n">b</span><span class="o">.</span> <span class="kt">Applicative</span> <span class="n">f</span> <span class="ow">=&gt;</span>
  <span class="kt">Cayley</span> <span class="n">f</span> <span class="p">(</span><span class="n">a</span> <span class="ow">-&gt;</span> <span class="n">b</span><span class="p">)</span> <span class="ow">-&gt;</span> <span class="kt">Cayley</span> <span class="n">f</span> <span class="n">a</span> <span class="ow">-&gt;</span> <span class="kt">Cayley</span> <span class="n">f</span> <span class="n">b</span>
<span class="nf">applyCayley</span> <span class="p">(</span><span class="kt">Cayley</span> <span class="n">f</span><span class="p">)</span> <span class="p">(</span><span class="kt">Cayley</span> <span class="n">g</span><span class="p">)</span> <span class="ow">=</span> <span class="kt">Cayley</span> <span class="nf">\</span><span class="n">h</span> <span class="ow">-&gt;</span>
  <span class="c1">-- f :: f ((a -&gt; b) -&gt; r) -&gt; f r -- takes a, gives b</span>
  <span class="c1">-- g :: f (a -&gt; r) -&gt; f r -- gives a</span>
  <span class="c1">-- h :: f (b -&gt; r) -- takes b</span>
  <span class="c1">-- map (\br a ab -&gt; br (ab a)) h :: f (a -&gt; (a -&gt; b) -&gt; r)</span>
  <span class="c1">-- g :: f (a -&gt; (a -&gt; b) -&gt; r) -&gt; f ((a -&gt; b) -&gt; r)</span>
  <span class="c1">-- f . g :: f (a -&gt; (a -&gt; b) -&gt; r) -&gt; f r</span>
  <span class="c1">-- f . g $ h :: f r</span>
  <span class="n">f</span> <span class="p">(</span><span class="n">g</span> <span class="p">((</span><span class="nf">\</span><span class="n">br</span> <span class="n">a</span> <span class="n">ab</span> <span class="ow">-&gt;</span> <span class="n">br</span> <span class="p">(</span><span class="n">ab</span> <span class="n">a</span><span class="p">))</span> <span class="o">&lt;$&gt;</span> <span class="n">h</span><span class="p">))</span>
</pre></div>


<p>Why is the extra fmap a problem? I think it might be unavoidable …</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/89529ef093c72e16a5ce3ac00d88f354ccc08cf9?version=2"></a><div class="content"><a class="author">Lysxia</a><div class="metadata"><a href="#194608751" name="194608751"><div>2020-04-19 17:22:07</div></a></div><div class="text"><p>It's not unavoidable, as I said I already have a working solution, I'm looking for a simpler version, or, as I think we're doing now, getting it out of a more general construction.</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/2f4316c80f59f157d26cb515ed98026308998f44?version=2"></a><div class="content"><a class="author">Nick Scheel</a><div class="metadata"><a href="#194608753" name="194608753"><div>2020-04-19 17:22:14</div></a></div><div class="text"><p>Note: I haven't figured out which way this associates!</p></div></div></div><div class="comment"><a class="avatar"><img src="https://www.gravatar.com/avatar/520889f20a2c66a8f4bd5be6f37d2923"></a><div class="content"><a class="author">Asad Saeeduddin</a><div class="metadata"><a href="#194608783" name="194608783"><div>2020-04-19 17:23:57</div></a></div><div class="text"><p>I think the HList version would have no fmaps</p></div></div></div><div class="comment"><a class="avatar"><img src="https://www.gravatar.com/avatar/520889f20a2c66a8f4bd5be6f37d2923"></a><div class="content"><a class="author">Asad Saeeduddin</a><div class="metadata"><a href="#194608822" name="194608822"><div>2020-04-19 17:24:17</div></a></div><div class="text"><p>or at least no fmaps in the functor in question</p></div></div></div><div class="comment"><a class="avatar"><img src="https://www.gravatar.com/avatar/520889f20a2c66a8f4bd5be6f37d2923"></a><div class="content"><a class="author">Asad Saeeduddin</a><div class="metadata"><a href="#194608829" name="194608829"><div>2020-04-19 17:24:55</div></a></div><div class="text"><p>I'm going to give it a shot in Agda</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/2f4316c80f59f157d26cb515ed98026308998f44?version=2"></a><div class="content"><a class="author">Nick Scheel</a><div class="metadata"><a href="#194608924" name="194608924"><div>2020-04-19 17:27:17</div></a></div><div class="text"><p>Oh, I see, you just deferred the <code>fmap</code> in your version. I guess it's otherwise equivalent to mine.</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/89529ef093c72e16a5ce3ac00d88f354ccc08cf9?version=2"></a><div class="content"><a class="author">Lysxia</a><div class="metadata"><a href="#194608973" name="194608973"><div>2020-04-19 17:28:22</div></a></div><div class="text"><p><code>fmap</code> generally has a runtime cost, and it gets in the way of inspection testing. Ensuring that the Core that GHC spits out is the same as a hand-tuned program  gives very strong performance guarantees.</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/2f4316c80f59f157d26cb515ed98026308998f44?version=2"></a><div class="content"><a class="author">Nick Scheel</a><div class="metadata"><a href="#194608975" name="194608975"><div>2020-04-19 17:28:26</div></a></div><div class="text"><p>Is that Yoneda? <code>forall u. ((a -&gt; r) -&gt; u) -&gt; f u ~ f (a -&gt; r)</code></p></div></div></div><div class="comment"><a class="avatar"><img src="https://www.gravatar.com/avatar/520889f20a2c66a8f4bd5be6f37d2923"></a><div class="content"><a class="author">Asad Saeeduddin</a><div class="metadata"><a href="#194608983" name="194608983"><div>2020-04-19 17:28:52</div></a></div><div class="text"><p>yup</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/2f4316c80f59f157d26cb515ed98026308998f44?version=2"></a><div class="content"><a class="author">Nick Scheel</a><div class="metadata"><a href="#194609002" name="194609002"><div>2020-04-19 17:29:49</div></a></div><div class="text"><p>So Yoneda Cayley … probably the most general construction there is <span aria-label="shrug" class="emoji emoji-1f937" role="img" title="shrug">:shrug:</span></p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/89529ef093c72e16a5ce3ac00d88f354ccc08cf9?version=2"></a><div class="content"><a class="author">Lysxia</a><div class="metadata"><a href="#194609005" name="194609005"><div>2020-04-19 17:29:57</div></a></div><div class="text"><p><span class="user-mention" data-user-id="225136">@Asad Saeeduddin</span> that would work yeah, just <code>HList</code> is another recursive structure.</p></div></div></div><div class="comment"><a class="avatar"><img src="https://www.gravatar.com/avatar/520889f20a2c66a8f4bd5be6f37d2923"></a><div class="content"><a class="author">Asad Saeeduddin</a><div class="metadata"><a href="#194609050" name="194609050"><div>2020-04-19 17:30:22</div></a></div><div class="text"><p><span class="user-mention" data-user-id="251302">@Lysxia</span> It doesn't have to be. With dependent products, you can represent it as a function I think</p></div></div></div><div class="comment"><a class="avatar"><img src="https://www.gravatar.com/avatar/520889f20a2c66a8f4bd5be6f37d2923"></a><div class="content"><a class="author">Asad Saeeduddin</a><div class="metadata"><a href="#194609064" name="194609064"><div>2020-04-19 17:30:57</div></a></div><div class="text"><p>also the recursion can be in either direction if you do write it as a recursive datatype</p></div></div></div><div class="comment"><a class="avatar"><img src="https://www.gravatar.com/avatar/520889f20a2c66a8f4bd5be6f37d2923"></a><div class="content"><a class="author">Asad Saeeduddin</a><div class="metadata"><a href="#194609082" name="194609082"><div>2020-04-19 17:31:27</div></a></div><div class="text"><p>or even be "branching" instead of completely leaning in one direction for whatever reason if you expend enough effort</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/2f4316c80f59f157d26cb515ed98026308998f44?version=2"></a><div class="content"><a class="author">Nick Scheel</a><div class="metadata"><a href="#194609165" name="194609165"><div>2020-04-19 17:33:55</div></a></div><div class="text"><p>fwiw I have some Dhall code to generate traversable instances <span aria-label="wink" class="emoji emoji-1f609" role="img" title="wink">:wink:</span> <a href="https://github.com/MonoidMusician/dhall-purescript/blob/master/src/Dhall/Core/AST/Types/gen.dhall#L581" title="https://github.com/MonoidMusician/dhall-purescript/blob/master/src/Dhall/Core/AST/Types/gen.dhall#L581">https://github.com/MonoidMusician/dhall-purescript/blob/master/src/Dhall/Core/AST/Types/gen.dhall#L581</a></p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/MonoidMusician/dhall-purescript/blob/master/src/Dhall/Core/AST/Types/gen.dhall#L581" style="background-image: url(https://avatars3.githubusercontent.com/u/11701520?s=400&amp;v=4)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/MonoidMusician/dhall-purescript/blob/master/src/Dhall/Core/AST/Types/gen.dhall#L581" title="MonoidMusician/dhall-purescript">MonoidMusician/dhall-purescript</a></div><div class="message_embed_description">Dhall implementation and structural editor in PureScript - MonoidMusician/dhall-purescript</div></div></div></div></div></div><div class="comment"><a class="avatar"><img src="https://www.gravatar.com/avatar/520889f20a2c66a8f4bd5be6f37d2923"></a><div class="content"><a class="author">Asad Saeeduddin</a><div class="metadata"><a href="#194609582" name="194609582"><div>2020-04-19 17:44:06</div></a></div><div class="text"><p><span class="user-mention" data-user-id="251302">@Lysxia</span> Isn't it possible even in Haskell for application of an nary function to an hlist to be completely inlined when the type level list is known?</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/89529ef093c72e16a5ce3ac00d88f354ccc08cf9?version=2"></a><div class="content"><a class="author">Lysxia</a><div class="metadata"><a href="#194609603" name="194609603"><div>2020-04-19 17:45:54</div></a></div><div class="text"><p>If you write a recursive function it just won't be inlined.</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/89529ef093c72e16a5ce3ac00d88f354ccc08cf9?version=2"></a><div class="content"><a class="author">Lysxia</a><div class="metadata"><a href="#194609748" name="194609748"><div>2020-04-19 17:48:19</div></a></div><div class="text"><p>There are some tricks with typeclasses to get things to unfold (by somehow not having value-level recursion). I think if you do that, it will simplify the <code>HList</code> away to some Church encoding or other lambda-calculus-based encoding.</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/89529ef093c72e16a5ce3ac00d88f354ccc08cf9?version=2"></a><div class="content"><a class="author">Lysxia</a><div class="metadata"><a href="#194610027" name="194610027"><div>2020-04-19 17:54:45</div></a></div><div class="text"><p>There's an example of "unfolding recursive functions" at the very end of this post (<code>class Sum</code>): <a href="https://mpickering.github.io/posts/2017-03-20-inlining-and-specialisation.html" title="https://mpickering.github.io/posts/2017-03-20-inlining-and-specialisation.html">https://mpickering.github.io/posts/2017-03-20-inlining-and-specialisation.html</a></p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/89529ef093c72e16a5ce3ac00d88f354ccc08cf9?version=2"></a><div class="content"><a class="author">Lysxia</a><div class="metadata"><a href="#194610738" name="194610738"><div>2020-04-19 18:12:00</div></a></div><div class="text"><p>There's a lot more we can keep discussing about here, but thanks <span class="user-mention" data-user-id="225136">@Asad Saeeduddin</span> and <span class="user-mention" data-user-id="251225">@Nicholas Scheel</span> for putting me on the track of Cayley+Yoneda!</p></div></div></div></div></div><div class="ui vertical footer segment"><a href="https://github.com/srid/zulip-archive">Powered by Haskell</a> | Questions? Contact <a href="https://www.srid.ca">srid</a></div></div></body></html>