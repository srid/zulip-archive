<html lang="en"><head><meta content="text/html; charset=utf-8" http-equiv="Content-Type"><meta content="width=device-width, initial-scale=1" name="viewport"><meta content="Thought I&#39;d dedicate a topic for it. 
https://github.com/srid/ema is a static site generator that does more than that; I pretty much use it as a light weight web framework for writing static-site&#39;ish apps, like rendering my .org files as a nice online diary. So far, the main feature that has been pe" name="description"><link href="https://funprog.srid.ca/haskell/ema-static-site-generator-progress.html" rel="canonical"><meta property="og:title" content="Ema static site generator progress - Haskell"><meta property="og:site_name" content="Functional Programming Zulip Archive"><meta property="og:type" content="article"><meta property="og:article:section" content="Haskell"><meta property="og:article:modified_time" content="2021-04-27T19:22:47Z"><meta property="og:article:published_time" content="2021-04-23T17:35:22Z"><meta property="og:image" content="https://zulip-avatars.s3.amazonaws.com/13896/4429aa8b689608f24a4ad712843ce29862e330d2?x=x&amp;version=2"><title>Ema static site generator progress - Haskell</title><style type="text/css">
div#thesite
{
  font-family   : "Open Sans", sans-serif;
  font-size     : 1em !important;
  margin-top    : 1em;
  margin-bottom : 1em;
}

div#thesite h1
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite h2
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite h3
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite h4
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite h5
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite h6
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite .ui.breadcrumb.rib .section
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite .header
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite .as-header
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite code, pre, tt
{
  font-family : "SFMono-Regular","Menlo","Monaco","Consolas","Liberation Mono","Courier New", monospace;
}

div#thesite .ui.breadcrumb.rib
{
  margin-bottom : 1em;
}



div#thesite .ui.comments.messages .comment .metadata a
{
  color : #808080;
}

div#thesite .ui.comments.messages .comment a.avatar img
{
  height : auto;
}

div#thesite .subtle
{
  color : #808080;
}


div#thesite .messages pre
{
  font-size : 85%;
  overflow  : auto;
  max-width : 100%;
}

div#thesite .messages .message_embed
{
  border-left  : solid 3px #808080;
  padding-left : 0.69999em;
}

div#thesite .messages .message_inline_image img
{
  max-width     : 100%;
  margin-bottom : 1em;
}


/* Generated with Clay, http://fvisser.nl/clay */</style><link href="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.4.1/semantic.min.css" rel="stylesheet"><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/all.min.css" rel="stylesheet"><link href="https://fonts.googleapis.com/css?family=Open+Sans|Oswald&amp;display=swap" rel="stylesheet"><link href="https://fonts.googleapis.com/css?family=Roboto|Open+Sans&amp;display=swap" rel="stylesheet"></head><body><div id="thesite" class="ui text container"><div class="ui violet inverted top attached center aligned segment"><h1 class="ui huge header">Ema static site generator progress - Haskell</h1></div><div class="ui attached segment"><div class="ui message"><p>Welcome to the Functional Programming Zulip Chat Archive. You can join the chat <a href="https://funprog.zulipchat.com">here</a>.</p></div><div class="ui breadcrumb rib"><a href="/" class="section">Home</a><i class="right angle icon divider"></i><a href="/haskell/" class="section">#Haskell</a><i class="right angle icon divider"></i><div class="active section">Ema static site generator progress</div></div><div class="ui comments messages"><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/4429aa8b689608f24a4ad712843ce29862e330d2?x=x&amp;version=2"></a><div class="content"><a class="author">Sridhar Ratnakumar</a><div class="metadata"><a href="#235879558" name="235879558"><div>2021-04-23 17:35:22</div></a></div><div class="text"><p>Thought I'd dedicate a topic for it. </p>
<p><a href="https://github.com/srid/ema">https://github.com/srid/ema</a> is a static site generator that does more than that; I pretty much use it as a light weight web framework for writing static-site'ish apps, like rendering my .org files as a nice online diary. So far, the main feature that has been perfected is the <em>hot reload</em> feature. </p>
<p>When you develop ema sites, and when you change either .html, .hs code (DSL included), or the .md or whatever files your site uses as a source, the web browser will instantly reload. And it won't do a 'refresh' - nor will there be a setInnerHTML (which is slow), but the DOM is actually patched (so it is damn fast) based on what Ema sends the browser.</p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/srid/ema" style="background-image: url(https://opengraph.githubassets.com/491d0f3826b2bfe2e3570b9ee8789960dc10286509bdc0c0820de756fadeffe8/srid/ema)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/srid/ema" title="srid/ema">srid/ema</a></div><div class="message_embed_description">WIP: Static site generator that is change-aware. Contribute to srid/ema development by creating an account on GitHub.</div></div></div></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/4429aa8b689608f24a4ad712843ce29862e330d2?x=x&amp;version=2"></a><div class="content"><a class="author">Sridhar Ratnakumar</a><div class="metadata"><a href="#235879789" name="235879789"><div>2021-04-23 17:36:46</div></a></div><div class="text"><p>I'm currently working on a documentation site for ema based on the principles laid out by <a href="https://diataxis.fr/">https://diataxis.fr/</a> (PR open as draft).</p>
<p>As part of it -- and since hot reload for data (not only code) requires that you monitor your data (which in our case are markdown files) for changes -- I decided to pull out the fsnotify code (used by <a href="https://github.com/srid/orgself">https://github.com/srid/orgself</a> - an ema site) and re-use it for the documentation site. But for DRY, I made it a helper module <code>Ema.Helper.FileSystem</code>.</p>
<p>Using that, the main entry point of the documentation site looks like this:</p>
<div class="codehilite" data-code-language="Haskell"><pre><span></span><code><span class="nf">main</span> <span class="ow">::</span> <span class="kt">IO</span> <span class="nb">()</span>
<span class="nf">main</span> <span class="ow">=</span> <span class="kr">do</span>
  <span class="n">mainWith</span> <span class="s">"docs"</span>

<span class="nf">mainWith</span> <span class="ow">::</span> <span class="kt">FilePath</span> <span class="ow">-&gt;</span> <span class="kt">IO</span> <span class="nb">()</span>
<span class="nf">mainWith</span> <span class="n">folder</span> <span class="ow">=</span> <span class="kr">do</span>
  <span class="n">runEma</span> <span class="n">render</span> <span class="o">$</span> <span class="nf">\</span><span class="n">model</span> <span class="ow">-&gt;</span> <span class="kr">do</span>
    <span class="kt">LVar</span><span class="o">.</span><span class="n">set</span> <span class="n">model</span> <span class="o">=&lt;&lt;</span> <span class="kr">do</span>
      <span class="n">putStrLn</span> <span class="o">$</span> <span class="s">"Loading .md files from "</span> <span class="o">&lt;&gt;</span> <span class="n">folder</span>
      <span class="n">mdFiles</span> <span class="ow">&lt;-</span> <span class="kt">FileSystem</span><span class="o">.</span><span class="n">filesMatching</span> <span class="n">folder</span> <span class="p">[</span><span class="s">"**/*.md"</span><span class="p">]</span>
      <span class="n">forM</span> <span class="n">mdFiles</span> <span class="n">readSource</span>
        <span class="o">&lt;&amp;&gt;</span> <span class="kt">Tagged</span> <span class="o">.</span> <span class="kt">Map</span><span class="o">.</span><span class="n">fromList</span> <span class="o">.</span> <span class="n">catMaybes</span>
    <span class="kt">FileSystem</span><span class="o">.</span><span class="n">onChange</span> <span class="n">folder</span> <span class="o">$</span> <span class="nf">\</span><span class="n">fp</span> <span class="ow">-&gt;</span> <span class="nf">\</span><span class="kr">case</span>
      <span class="kt">FileSystem</span><span class="o">.</span><span class="kt">Update</span> <span class="ow">-&gt;</span>
        <span class="n">whenJustM</span> <span class="p">(</span><span class="n">readSource</span> <span class="n">fp</span><span class="p">)</span> <span class="o">$</span> <span class="nf">\</span><span class="p">(</span><span class="n">spath</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span> <span class="ow">-&gt;</span> <span class="kr">do</span>
          <span class="n">putStrLn</span> <span class="o">$</span> <span class="s">"Update: "</span> <span class="o">&lt;&gt;</span> <span class="n">show</span> <span class="n">spath</span>
          <span class="kt">LVar</span><span class="o">.</span><span class="n">modify</span> <span class="n">model</span> <span class="o">$</span> <span class="kt">Tagged</span> <span class="o">.</span> <span class="kt">Map</span><span class="o">.</span><span class="n">insert</span> <span class="n">spath</span> <span class="n">s</span> <span class="o">.</span> <span class="n">untag</span>
      <span class="kt">FileSystem</span><span class="o">.</span><span class="kt">Delete</span> <span class="ow">-&gt;</span>
        <span class="n">whenJust</span> <span class="p">(</span><span class="n">mkSourcePath</span> <span class="n">fp</span><span class="p">)</span> <span class="o">$</span> <span class="nf">\</span><span class="n">spath</span> <span class="ow">-&gt;</span> <span class="kr">do</span>
          <span class="n">putStrLn</span> <span class="o">$</span> <span class="s">"Delete: "</span> <span class="o">&lt;&gt;</span> <span class="n">show</span> <span class="n">spath</span>
          <span class="kt">LVar</span><span class="o">.</span><span class="n">modify</span> <span class="n">model</span> <span class="o">$</span> <span class="kt">Tagged</span> <span class="o">.</span> <span class="kt">Map</span><span class="o">.</span><span class="n">delete</span> <span class="n">spath</span> <span class="o">.</span> <span class="n">untag</span>
</code></pre></div>
<div class="message_embed"><a class="message_embed_image" href="https://diataxis.fr/" style="background-image: url(https://diataxis.fr/_images/overview.png)"></a><div class="data-container"><div class="message_embed_title"><a href="https://diataxis.fr/" title="Home - Diátaxis">Home - Diátaxis</a></div><div class="message_embed_description">The Diátaxis framework solves the problem of structure in technical documentation, making it easier to create, maintain and use.</div></div></div><div class="message_embed"><a class="message_embed_image" href="https://github.com/srid/orgself" style="background-image: url(https://opengraph.githubassets.com/f77d0b2a3674cd0e566db1f05e3f983ad5bde337a9a5b4f1c55ff2ba9a24d5ac/srid/orgself)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/srid/orgself" title="srid/orgself">srid/orgself</a></div><div class="message_embed_description">Create beautiful journal website with self-tracking. Using org-mode. - srid/orgself</div></div></div></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/4429aa8b689608f24a4ad712843ce29862e330d2?x=x&amp;version=2"></a><div class="content"><a class="author">Sridhar Ratnakumar</a><div class="metadata"><a href="#235881208" name="235881208"><div>2021-04-23 17:45:48</div></a></div><div class="text"><p>Note that <code>Data.LVar</code> thing will be published to Hackage, and this is what I was talking about in an earlier topic: <a href="#narrow/stream/201385-Haskell/topic/TVar.20with.20change.20notification">https://funprog.zulipchat.com/#narrow/stream/201385-Haskell/topic/TVar.20with.20change.20notification</a></p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/4429aa8b689608f24a4ad712843ce29862e330d2?x=x&amp;version=2"></a><div class="content"><a class="author">Sridhar Ratnakumar</a><div class="metadata"><a href="#235881320" name="235881320"><div>2021-04-23 17:46:29</div></a></div><div class="text"><p>(the LVar in conjunction with Ema's websocket machinary is how when you edit a .md file in VSCode, it propagates instantly to the browser view)</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/4429aa8b689608f24a4ad712843ce29862e330d2?x=x&amp;version=2"></a><div class="content"><a class="author">Sridhar Ratnakumar</a><div class="metadata"><a href="#235977137" name="235977137"><div>2021-04-24 15:04:50</div></a></div><div class="text"><h3>marketing messaging?</h3>
<p>the dev experience should compare to that of <a href="https://kit.svelte.dev">https://kit.svelte.dev</a> ... ema does support SSE (sever-side rendering)! SvelteKit is nice for writing static sites, but JS sucks - this is where ema comes in: get the SvelteKit like experience, but use Haskell instead of JS. </p>
<p>There is one catch; if you want client-side JS behaviour, you'll still have to write "low-level" JS ... but perhaps that can be addressed using either PureScript or Tweag's Asterius (depending on the trade-offs). That's for Ema's roadmap</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/4429aa8b689608f24a4ad712843ce29862e330d2?x=x&amp;version=2"></a><div class="content"><a class="author">Sridhar Ratnakumar</a><div class="metadata"><a href="#236080884" name="236080884"><div>2021-04-25 17:33:05</div></a></div><div class="text"><h3>type class</h3>
<p>i've a history of abusing typeclasses, but this time hopefully I didn't overcomplicate it (for the static site generation case) because I find it to be the minimum necessary (and cannot be achieved more simply in other means; unless someone can demonstrate otherwise),</p>
<div class="codehilite" data-code-language="Haskell"><pre><span></span><code><span class="kr">class</span> <span class="kt">Ema</span> <span class="kt">MyModel</span> <span class="kt">Route</span> <span class="kr">where</span>
  <span class="c1">-- Convert our route to browser URL, represented as a list of slugs</span>
  <span class="n">encodeRoute</span> <span class="ow">=</span> <span class="nf">\</span><span class="kr">case</span>
    <span class="kt">Index</span> <span class="ow">-&gt;</span> <span class="kt">[]</span>  <span class="c1">-- An empty slug represents the index route: index.html</span>
    <span class="kt">About</span> <span class="ow">-&gt;</span> <span class="p">[</span><span class="s">"about"</span><span class="p">]</span>
  <span class="c1">-- Convert back the browser URL, represented as a list of slugs, to our route</span>
  <span class="n">decodeRoute</span> <span class="ow">=</span> <span class="nf">\</span><span class="kr">case</span>
    <span class="kt">[]</span> <span class="ow">-&gt;</span> <span class="kt">Just</span> <span class="kt">Index</span>
    <span class="p">[</span><span class="s">"about"</span><span class="p">]</span> <span class="ow">-&gt;</span> <span class="kt">Just</span> <span class="kt">About</span>
    <span class="kr">_</span> <span class="ow">-&gt;</span> <span class="kt">Nothing</span>
  <span class="c1">-- The third method is used during static site generation.</span>
  <span class="c1">-- This tells Ema which routes to generate .html files for.</span>
  <span class="n">staticRoutes</span> <span class="n">model</span> <span class="ow">=</span>
    <span class="p">[</span><span class="kt">Index</span><span class="p">,</span> <span class="kt">About</span><span class="p">]</span>
  <span class="c1">-- The fourth method is optional; if you have static assets to serve, specify</span>
  <span class="c1">-- them here. Paths are relative to current working directory.</span>
  <span class="n">staticAssets</span> <span class="kt">Proxy</span> <span class="ow">=</span>
    <span class="p">[</span><span class="s">"css"</span><span class="p">,</span> <span class="s">"images"</span><span class="p">,</span> <span class="s">"favicon.ico"</span><span class="p">,</span> <span class="s">"resume.pdf"</span><span class="p">]</span>
</code></pre></div></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/4429aa8b689608f24a4ad712843ce29862e330d2?x=x&amp;version=2"></a><div class="content"><a class="author">Sridhar Ratnakumar</a><div class="metadata"><a href="#236080927" name="236080927"><div>2021-04-25 17:33:48</div></a></div><div class="text"><p>The class itself,</p>
<div class="codehilite" data-code-language="Haskell"><pre><span></span><code><span class="c1">-- | Enrich a model to work with Ema</span>
<span class="kr">class</span> <span class="kt">Ema</span> <span class="n">model</span> <span class="n">route</span> <span class="o">|</span> <span class="n">route</span> <span class="ow">-&gt;</span> <span class="n">model</span> <span class="kr">where</span>
  <span class="c1">-- How to convert URLs to/from routes</span>
  <span class="n">encodeRoute</span> <span class="ow">::</span> <span class="n">route</span> <span class="ow">-&gt;</span> <span class="p">[</span><span class="kt">Slug</span><span class="p">]</span>
  <span class="n">decodeRoute</span> <span class="ow">::</span> <span class="p">[</span><span class="kt">Slug</span><span class="p">]</span> <span class="ow">-&gt;</span> <span class="kt">Maybe</span> <span class="n">route</span>

  <span class="c1">-- | Routes to use when generating the static site</span>
  <span class="c1">--</span>
  <span class="c1">-- This is never used by the dev server.</span>
  <span class="n">staticRoutes</span> <span class="ow">::</span> <span class="n">model</span> <span class="ow">-&gt;</span> <span class="p">[</span><span class="n">route</span><span class="p">]</span>

  <span class="c1">-- | List of (top-level) filepaths to serve as static assets</span>
  <span class="c1">--</span>
  <span class="c1">-- These will be copied over as-is during static site generation</span>
  <span class="n">staticAssets</span> <span class="ow">::</span> <span class="kt">Proxy</span> <span class="n">route</span> <span class="ow">-&gt;</span> <span class="p">[</span><span class="kt">FilePath</span><span class="p">]</span>
  <span class="n">staticAssets</span> <span class="kt">Proxy</span> <span class="ow">=</span> <span class="n">mempty</span>
</code></pre></div></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/20a04d823b7c3891d78ca5f6a188ccd0e4fc5e3d?x=x&amp;version=2"></a><div class="content"><a class="author">TheMatten</a><div class="metadata"><a href="#236081665" name="236081665"><div>2021-04-25 17:45:07</div></a></div><div class="text"><p>"type class" ~ "implicitly resolved record" - maybe it would make sense to pass in <code>data Ema model route = Ema{..}</code> instead?</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/20a04d823b7c3891d78ca5f6a188ccd0e4fc5e3d?x=x&amp;version=2"></a><div class="content"><a class="author">TheMatten</a><div class="metadata"><a href="#236081718" name="236081718"><div>2021-04-25 17:46:02</div></a></div><div class="text"><p>That way, user wouldn't be restricted to single implementation for given <code>model</code> and <code>route</code></p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/4429aa8b689608f24a4ad712843ce29862e330d2?x=x&amp;version=2"></a><div class="content"><a class="author">Sridhar Ratnakumar</a><div class="metadata"><a href="#236081827" name="236081827"><div>2021-04-25 17:47:14</div></a></div><div class="text"><p>An <code>Ema{..}</code> record with four fields of functions types? </p>
<blockquote>
<p>TheMatten: That way, user wouldn't be restricted to single implementation for given <code>model</code> and <code>route</code></p>
</blockquote>
<p>Would you say that's the <em>only</em> downside of using type-classes here (also, what use cases exist for someone to create multiple implementations for a given model/route?) ... or are there others?</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/20a04d823b7c3891d78ca5f6a188ccd0e4fc5e3d?x=x&amp;version=2"></a><div class="content"><a class="author">TheMatten</a><div class="metadata"><a href="#236082147" name="236082147"><div>2021-04-25 17:52:04</div></a></div><div class="text"><p>Yeah<br>
One more downside is limited "derivability" - it's easier to write function modifying record, than it is to parameterize deriving mechanism by wanted modifications to default implementation</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/4429aa8b689608f24a4ad712843ce29862e330d2?x=x&amp;version=2"></a><div class="content"><a class="author">Sridhar Ratnakumar</a><div class="metadata"><a href="#236082327" name="236082327"><div>2021-04-25 17:55:15</div></a></div><div class="text"><p>One problem with the record approach is that you now have to carry the record value all over the code base, or implement a ReaderT over IO.</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/4429aa8b689608f24a4ad712843ce29862e330d2?x=x&amp;version=2"></a><div class="content"><a class="author">Sridhar Ratnakumar</a><div class="metadata"><a href="#236082403" name="236082403"><div>2021-04-25 17:56:22</div></a></div><div class="text"><p>Type class here seems more ergonomic to me; are there practical use cases where they start to become a pain in this case (static site generation)?</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/20a04d823b7c3891d78ca5f6a188ccd0e4fc5e3d?x=x&amp;version=2"></a><div class="content"><a class="author">TheMatten</a><div class="metadata"><a href="#236082532" name="236082532"><div>2021-04-25 17:59:21</div></a></div><div class="text"><p>Does user usually need to use <code>Ema</code> constraint directly, or is it simply used by the implementation?</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/4429aa8b689608f24a4ad712843ce29862e330d2?x=x&amp;version=2"></a><div class="content"><a class="author">Sridhar Ratnakumar</a><div class="metadata"><a href="#236082750" name="236082750"><div>2021-04-25 18:02:09</div></a></div><div class="text"><p>The constraint is utilized by the library (Ema), and not in the user code. The user code simplify defines the instances, and forgets about it.</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/4429aa8b689608f24a4ad712843ce29862e330d2?x=x&amp;version=2"></a><div class="content"><a class="author">Sridhar Ratnakumar</a><div class="metadata"><a href="#236082830" name="236082830"><div>2021-04-25 18:03:28</div></a></div><div class="text"><p>This is the simplest 70-line example; let's use that as a reference: <a href="https://github.com/srid/ema/blob/b80a9327a6917cb8f7b10e3f7055d8e0a191aa72/src/Ema/Example/Ex02_Clock.hs">https://github.com/srid/ema/blob/b80a9327a6917cb8f7b10e3f7055d8e0a191aa72/src/Ema/Example/Ex02_Clock.hs</a></p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/srid/ema/blob/b80a9327a6917cb8f7b10e3f7055d8e0a191aa72/src/Ema/Example/Ex02_Clock.hs" style="background-image: url(https://opengraph.githubassets.com/f8a20bae08f8b0931d90a98855b99452f21618b96f3307cd2671fe06d8eef2aa/srid/ema)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/srid/ema/blob/b80a9327a6917cb8f7b10e3f7055d8e0a191aa72/src/Ema/Example/Ex02_Clock.hs" title="srid/ema">srid/ema</a></div><div class="message_embed_description">WIP: Static site generator that is change-aware. Contribute to srid/ema development by creating an account on GitHub.</div></div></div></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/4429aa8b689608f24a4ad712843ce29862e330d2?x=x&amp;version=2"></a><div class="content"><a class="author">Sridhar Ratnakumar</a><div class="metadata"><a href="#236082898" name="236082898"><div>2021-04-25 18:04:16</div></a></div><div class="text"><p>Notice line 68. the use of <code>routeUrl</code> which the user calls to get the URL for the route</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/4429aa8b689608f24a4ad712843ce29862e330d2?x=x&amp;version=2"></a><div class="content"><a class="author">Sridhar Ratnakumar</a><div class="metadata"><a href="#236082907" name="236082907"><div>2021-04-25 18:04:33</div></a></div><div class="text"><p>This function, defined in Ema library, uses the constraint:</p>
<div class="codehilite" data-code-language="Haskell"><pre><span></span><code><span class="nf">routeUrl</span> <span class="ow">::</span> <span class="n">forall</span> <span class="n">a</span> <span class="n">r</span><span class="o">.</span> <span class="kt">Ema</span> <span class="n">a</span> <span class="n">r</span> <span class="ow">=&gt;</span> <span class="n">r</span> <span class="ow">-&gt;</span> <span class="kt">Text</span>
</code></pre></div></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/20a04d823b7c3891d78ca5f6a188ccd0e4fc5e3d?x=x&amp;version=2"></a><div class="content"><a class="author">TheMatten</a><div class="metadata"><a href="#236082913" name="236082913"><div>2021-04-25 18:04:42</div></a></div><div class="text"><p>Ah - so if it's simply an internal problem, and you don't like <code>Reader</code>, there're alternatives like <code>ImplicitParams</code></p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/4429aa8b689608f24a4ad712843ce29862e330d2?x=x&amp;version=2"></a><div class="content"><a class="author">Sridhar Ratnakumar</a><div class="metadata"><a href="#236082919" name="236082919"><div>2021-04-25 18:04:58</div></a></div><div class="text"><p>If we were to use a record, then the user would have to thread-in the record to <code>routeUrl</code> ... or be made aware of Reader</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/4429aa8b689608f24a4ad712843ce29862e330d2?x=x&amp;version=2"></a><div class="content"><a class="author">Sridhar Ratnakumar</a><div class="metadata"><a href="#236082982" name="236082982"><div>2021-04-25 18:06:03</div></a></div><div class="text"><p>I mean look at the view function right now that user has to write:</p>
<div class="codehilite" data-code-language="Haskell"><pre><span></span><code><span class="nf">render</span> <span class="ow">::</span> <span class="kt">Ema</span><span class="o">.</span><span class="kt">CLI</span><span class="o">.</span><span class="kt">Action</span> <span class="ow">-&gt;</span> <span class="n">model</span> <span class="ow">-&gt;</span> <span class="n">route</span> <span class="ow">-&gt;</span> <span class="kt">LByteString</span>
</code></pre></div>
<p>If you add a Reader in there, just to be able to get URL to a route - isn't that an overkill, and extra overhead for the user to deal with?</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/20a04d823b7c3891d78ca5f6a188ccd0e4fc5e3d?x=x&amp;version=2"></a><div class="content"><a class="author">TheMatten</a><div class="metadata"><a href="#236083076" name="236083076"><div>2021-04-25 18:07:54</div></a></div><div class="text"><p>Yeah, you're switching from static to dynamic resolution that way<br>
In that case, you have to decide whether you want to give up on first-class <code>Ema</code> implementations or sligthly complicate things by doing something like <code>type Ema model route = ?emaImpl :: EmaImpl model route</code></p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/20a04d823b7c3891d78ca5f6a188ccd0e4fc5e3d?x=x&amp;version=2"></a><div class="content"><a class="author">TheMatten</a><div class="metadata"><a href="#236083185" name="236083185"><div>2021-04-25 18:09:17</div></a></div><div class="text"><p>I guess class would be reasonable then, as long as required global uniqueness isn't something users will often run into</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/4429aa8b689608f24a4ad712843ce29862e330d2?x=x&amp;version=2"></a><div class="content"><a class="author">Sridhar Ratnakumar</a><div class="metadata"><a href="#236083191" name="236083191"><div>2021-04-25 18:09:34</div></a></div><div class="text"><p>I'm not familiar with ImplicitParams; how would this look like from user point of view (when they are writing the <code>render</code> function)?</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/4429aa8b689608f24a4ad712843ce29862e330d2?x=x&amp;version=2"></a><div class="content"><a class="author">Sridhar Ratnakumar</a><div class="metadata"><a href="#236083270" name="236083270"><div>2021-04-25 18:10:48</div></a></div><div class="text"><blockquote>
<p>required global uniqueness isn't something users will often run into</p>
</blockquote>
<p>This is what I'm wondering. Right now, each of your <code>route</code> maps to one implementation. But you can have multiple implementations for the given <code>model</code> (eg: markdown files) due to fundep. Are there any practical use cases where the user would want two or more site implementation for a given <code>route</code> type? What does that look like, in practice?</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/20a04d823b7c3891d78ca5f6a188ccd0e4fc5e3d?x=x&amp;version=2"></a><div class="content"><a class="author">TheMatten</a><div class="metadata"><a href="#236083346" name="236083346"><div>2021-04-25 18:12:31</div></a></div><div class="text"><p>Nothing would change - <code>ImplicitParams</code> would simply let you introduce user-supplied record into scope as an constraint and users wouldn't even need to enable it themselves<br>
There's no global uniqueness for <code>ImplicitParams</code>, which is technically what you want - at the same time, it means that you could technically swap implementation for some scope, and abuse of that may create confusing situations</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/20a04d823b7c3891d78ca5f6a188ccd0e4fc5e3d?x=x&amp;version=2"></a><div class="content"><a class="author">TheMatten</a><div class="metadata"><a href="#236083366" name="236083366"><div>2021-04-25 18:13:15</div></a></div><div class="text"><p>As far as implementation goes, you would add <code>?emaImpl</code> as an argument to selectors of your record</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/20a04d823b7c3891d78ca5f6a188ccd0e4fc5e3d?x=x&amp;version=2"></a><div class="content"><a class="author">TheMatten</a><div class="metadata"><a href="#236083431" name="236083431"><div>2021-04-25 18:14:30</div></a></div><div class="text"><blockquote>
<p>This is what I'm wondering. Right now, each of your route maps to one implementation. But you can have multiple implementations for the given model (eg: markdown files) due to fundep. Are there any practical use cases where the user would want two or more site implementation for a given route type? What does that look like, in practice?</p>
</blockquote>
<p>Well, I imagine they may want to start with some pre-populated record that handles some stuff for them</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/20a04d823b7c3891d78ca5f6a188ccd0e4fc5e3d?x=x&amp;version=2"></a><div class="content"><a class="author">TheMatten</a><div class="metadata"><a href="#236083447" name="236083447"><div>2021-04-25 18:15:00</div></a></div><div class="text"><p>Like "neuron model" or "org model", which could be extended for specific needs</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/4429aa8b689608f24a4ad712843ce29862e330d2?x=x&amp;version=2"></a><div class="content"><a class="author">Sridhar Ratnakumar</a><div class="metadata"><a href="#236083564" name="236083564"><div>2021-04-25 18:16:39</div></a></div><div class="text"><p>An example of extending <code>Ema MarkdownNotes NeuronRoute</code> record?</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/4429aa8b689608f24a4ad712843ce29862e330d2?x=x&amp;version=2"></a><div class="content"><a class="author">Sridhar Ratnakumar</a><div class="metadata"><a href="#236083590" name="236083590"><div>2021-04-25 18:17:25</div></a></div><div class="text"><p>I'm reminded of XMonad using records too. So may be composability is something I'm overlooking here. But I'm trying to figure out how composability specifically comes into play for static site generation.</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/20a04d823b7c3891d78ca5f6a188ccd0e4fc5e3d?x=x&amp;version=2"></a><div class="content"><a class="author">TheMatten</a><div class="metadata"><a href="#236083740" name="236083740"><div>2021-04-25 18:20:09</div></a></div><div class="text"><p>E.g. I may want to implement aliases for routes<br>
"composability model and route handling building blocks" - classes won't let you manipulate implementations of instances easily</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/20a04d823b7c3891d78ca5f6a188ccd0e4fc5e3d?x=x&amp;version=2"></a><div class="content"><a class="author">TheMatten</a><div class="metadata"><a href="#236083767" name="236083767"><div>2021-04-25 18:20:45</div></a></div><div class="text"><p>Though I imagine examples where <code>model</code> and <code>route</code> would be extensible types by themselves - e.g. parameterized by some user-defined type</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/20a04d823b7c3891d78ca5f6a188ccd0e4fc5e3d?x=x&amp;version=2"></a><div class="content"><a class="author">TheMatten</a><div class="metadata"><a href="#236083797" name="236083797"><div>2021-04-25 18:21:03</div></a></div><div class="text"><p>(BTW, short introduction to <code>ImplicitParams</code> - <code>?a :: B</code> constraint means "implicit parameter <code>?a</code> of type <code>B</code> in scope" and can be introduced by <code>let ?a = .. in ..</code>)</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/4429aa8b689608f24a4ad712843ce29862e330d2?x=x&amp;version=2"></a><div class="content"><a class="author">Sridhar Ratnakumar</a><div class="metadata"><a href="#236083887" name="236083887"><div>2021-04-25 18:22:29</div></a></div><div class="text"><p>Aliases are a good example. So if somebody extends neuron v3 written in Ema as, <code>import Neuron (Model, Route)</code> -- they want to implement custom aliases on top of what the neuron ema site generates. What's the approach here? Assuming a) typeclass, b) records. What would the implementation look like ....</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/4429aa8b689608f24a4ad712843ce29862e330d2?x=x&amp;version=2"></a><div class="content"><a class="author">Sridhar Ratnakumar</a><div class="metadata"><a href="#236084018" name="236084018"><div>2021-04-25 18:25:22</div></a></div><div class="text"><p>In the record case, I imagine them wrapping the route encoding functions, eg: </p>
<div class="codehilite" data-code-language="Haskell"><pre><span></span><code><span class="kr">type</span> <span class="kt">RouteWithAliases</span> <span class="ow">=</span> <span class="kt">Either</span> <span class="kt">Route</span> <span class="kt">Alias</span>
<span class="nf">myEma</span> <span class="ow">=</span> <span class="n">neuronEma</span> <span class="p">{</span> <span class="n">decodeRoute</span> <span class="ow">=</span> <span class="n">decodeAlias</span> <span class="p">(</span><span class="kt">Neuron</span><span class="o">.</span><span class="n">decodeRoute</span> <span class="n">neuronEma</span><span class="p">)</span> <span class="o">..</span><span class="p">}</span>
<span class="o">...</span>
</code></pre></div>
<p>Well, I don't know ... record composition looks complicated?</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/4429aa8b689608f24a4ad712843ce29862e330d2?x=x&amp;version=2"></a><div class="content"><a class="author">Sridhar Ratnakumar</a><div class="metadata"><a href="#236084195" name="236084195"><div>2021-04-25 18:28:24</div></a></div><div class="text"><p>in type-class case,</p>
<div class="codehilite" data-code-language="Haskell"><pre><span></span><code><span class="kr">data</span> <span class="kt">AliasableRoute</span> <span class="n">r</span> <span class="ow">=</span> <span class="kt">AliasableRoute</span> <span class="p">(</span><span class="kt">Map</span> <span class="kt">Text</span> <span class="n">r</span><span class="p">)</span> <span class="n">r</span>

<span class="nf">lookupAlias</span> <span class="ow">::</span> <span class="o">...</span>

<span class="kr">instance</span> <span class="kt">Ema</span> <span class="n">model</span> <span class="n">r</span> <span class="ow">=&gt;</span> <span class="kt">Ema</span> <span class="n">model</span> <span class="p">(</span><span class="kt">AliasableRoute</span> <span class="n">r</span><span class="p">)</span> <span class="kr">where</span>
  <span class="n">decodeRoute</span> <span class="n">slugs</span> <span class="ow">=</span>
    <span class="kr">case</span> <span class="n">lookupAlias</span> <span class="n">r</span> <span class="kr">of</span>
        <span class="kt">Just</span> <span class="n">route</span> <span class="ow">-&gt;</span> <span class="kt">Just</span> <span class="n">route</span>
        <span class="kt">Nothing</span> <span class="ow">-&gt;</span> <span class="n">decodeRoute</span> <span class="o">@</span><span class="n">model</span> <span class="o">@</span><span class="n">r</span> <span class="n">slugs</span>
  <span class="c1">-- Rest of the functions are delegated</span>
</code></pre></div></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/4429aa8b689608f24a4ad712843ce29862e330d2?x=x&amp;version=2"></a><div class="content"><a class="author">Sridhar Ratnakumar</a><div class="metadata"><a href="#236084287" name="236084287"><div>2021-04-25 18:30:25</div></a></div><div class="text"><p>Oh, also the render function has to handle the alias route. By generating a .html stub that simply redirects to target route.</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/20a04d823b7c3891d78ca5f6a188ccd0e4fc5e3d?x=x&amp;version=2"></a><div class="content"><a class="author">TheMatten</a><div class="metadata"><a href="#236084382" name="236084382"><div>2021-04-25 18:32:20</div></a></div><div class="text"><p>Well, with classes, you'll have to wrap <code>Model</code> and <code>Route</code> in newtypes if you want to implement new instance based on them - plus this instance must be basically defined at compile-time:</p>
<div class="codehilite" data-code-language="Haskell"><pre><span></span><code><span class="kr">newtype</span> <span class="kt">MyModel</span> <span class="ow">=</span> <span class="kt">MyModel</span> <span class="kt">Model</span>
<span class="kr">newtype</span> <span class="kt">MyRoute</span> <span class="ow">=</span> <span class="kt">MyRoute</span> <span class="kt">Route</span>

<span class="kr">instance</span> <span class="kt">Ema</span> <span class="kt">MyModel</span> <span class="kt">MyRoute</span> <span class="kr">where</span>
  <span class="o">..</span>
  <span class="n">decodeRoute</span> <span class="n">r</span> <span class="ow">=</span> <span class="kt">MyModel</span> <span class="o">&lt;$&gt;</span> <span class="n">decodeRoute</span> <span class="kr">case</span> <span class="n">r</span> <span class="kr">of</span>
    <span class="s">"yay"</span> <span class="ow">-&gt;</span> <span class="s">"happy"</span>
    <span class="kr">_</span> <span class="ow">-&gt;</span> <span class="n">r</span>
</code></pre></div>
<p>meanwhile with records, neuron's implementation is as easy to extend as any other value:</p>
<div class="codehilite" data-code-language="Haskell"><pre><span></span><code><span class="nf">myEma</span> <span class="ow">::</span> <span class="kt">IO</span> <span class="p">(</span><span class="kt">Ema</span> <span class="kt">Model</span> <span class="kt">Route</span><span class="p">)</span>
<span class="nf">myEma</span> <span class="ow">=</span> <span class="kr">do</span>
  <span class="n">h</span> <span class="ow">&lt;-</span> <span class="n">getEnv</span> <span class="s">"HAPPINESS_SOURCE"</span>
  <span class="n">pure</span> <span class="n">neuronEma</span><span class="p">{</span>
      <span class="n">decodeRoute</span> <span class="n">r</span> <span class="ow">=</span> <span class="n">decodeRoute</span> <span class="n">neuronEma</span> <span class="kr">if</span> <span class="n">r</span> <span class="o">==</span> <span class="n">h</span> <span class="kr">then</span> <span class="s">"happy"</span> <span class="kr">else</span> <span class="n">r</span>
    <span class="p">}</span>
</code></pre></div></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/4429aa8b689608f24a4ad712843ce29862e330d2?x=x&amp;version=2"></a><div class="content"><a class="author">Sridhar Ratnakumar</a><div class="metadata"><a href="#236084384" name="236084384"><div>2021-04-25 18:32:23</div></a></div><div class="text"><p>I'll have to think about this a bit more.</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/4429aa8b689608f24a4ad712843ce29862e330d2?x=x&amp;version=2"></a><div class="content"><a class="author">Sridhar Ratnakumar</a><div class="metadata"><a href="#236084681" name="236084681"><div>2021-04-25 18:37:43</div></a></div><div class="text"><p>There is another issue here. Remember ema supports hot-reload of model. In general all the "state" used by your static site should be stored in the <code>model</code>. Aliases are part of such a state. Even if you put them in <code>neuron.dhall</code> they get loaded as part of the <code>model</code>.</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/4429aa8b689608f24a4ad712843ce29862e330d2?x=x&amp;version=2"></a><div class="content"><a class="author">Sridhar Ratnakumar</a><div class="metadata"><a href="#236084783" name="236084783"><div>2021-04-25 18:39:28</div></a></div><div class="text"><p>And when you modify <code>neuron.dhall</code> to add/remove an alias, your site updates in real-time.</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/4429aa8b689608f24a4ad712843ce29862e330d2?x=x&amp;version=2"></a><div class="content"><a class="author">Sridhar Ratnakumar</a><div class="metadata"><a href="#236084971" name="236084971"><div>2021-04-25 18:42:30</div></a></div><div class="text"><p>The problem with type-class based route decoding is that ... there is no state available. Route decoding doesn't depend on <code>model</code>, so it won't know anything about aliases. But then ... <code>decodeRoute</code> is used only in dev server. For static site generation, <code>staticRoutes</code> is used which <em>does</em> receive the model as an argument, can enable generation of the stub routes. Basically "dynamic" route decoding is impossible.</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/4429aa8b689608f24a4ad712843ce29862e330d2?x=x&amp;version=2"></a><div class="content"><a class="author">Sridhar Ratnakumar</a><div class="metadata"><a href="#236085053" name="236085053"><div>2021-04-25 18:44:07</div></a></div><div class="text"><p>That does make me wonder ... maybe <code>decodeRoute</code> <em>should</em> take the (current) model as argument. It would be useful to handle 404 early. Like <code>decode /notes/foo.md</code> can fail if "foo.md" is not present in the model.</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/4429aa8b689608f24a4ad712843ce29862e330d2?x=x&amp;version=2"></a><div class="content"><a class="author">Sridhar Ratnakumar</a><div class="metadata"><a href="#236085534" name="236085534"><div>2021-04-25 18:53:48</div></a></div><div class="text"><p>Actually, that breaks the isomorphic guarantee between dev server and static generation. That <code>if r == h ...</code> thingy would work in dev server, without any guarantee of working in static generation.</p>
<p>Having to wrap the route type, while it does seem like extra work, most importantly provides that guarantee actually. Because now your view function is forced to deal with it because Haskell will complain about non-exhaustive pattern matches.</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/4429aa8b689608f24a4ad712843ce29862e330d2?x=x&amp;version=2"></a><div class="content"><a class="author">Sridhar Ratnakumar</a><div class="metadata"><a href="#236085736" name="236085736"><div>2021-04-25 18:57:25</div></a></div><div class="text"><p>The alias extension would then look like this,</p>
<div class="codehilite" data-code-language="Haskell"><pre><span></span><code><span class="kr">data</span> <span class="kt">AliasableRoute</span> <span class="n">r</span>
  <span class="ow">=</span> <span class="kt">Alias</span> <span class="kt">Text</span> <span class="n">r</span>
  <span class="o">|</span> <span class="kt">Normal</span> <span class="n">r</span>

<span class="kr">type</span> <span class="kt">WithAlias</span> <span class="n">model</span> <span class="n">r</span> <span class="ow">=</span> <span class="p">(</span><span class="kt">Map</span> <span class="p">[</span><span class="kt">Slug</span><span class="p">]</span> <span class="kt">Route</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span>

<span class="nf">lookupAlias</span> <span class="ow">::</span> <span class="o">...</span>

<span class="kr">instance</span> <span class="kt">Ema</span> <span class="n">model</span> <span class="n">r</span> <span class="ow">=&gt;</span> <span class="kt">Ema</span> <span class="p">(</span><span class="kt">WithAlias</span> <span class="n">model</span> <span class="n">r</span><span class="p">)</span> <span class="p">(</span><span class="kt">AliasableRoute</span> <span class="n">r</span><span class="p">)</span> <span class="kr">where</span>
  <span class="n">decodeRoute</span> <span class="n">model</span> <span class="n">slugs</span> <span class="ow">=</span>
    <span class="kr">case</span> <span class="n">lookupAlias</span> <span class="p">(</span><span class="n">getAliasTable</span> <span class="n">model</span><span class="p">)</span> <span class="n">slugs</span> <span class="kr">of</span>
        <span class="kt">Just</span> <span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">route</span><span class="p">)</span> <span class="ow">-&gt;</span> <span class="kt">Just</span> <span class="o">$</span> <span class="kt">Alias</span> <span class="n">s</span> <span class="n">route</span>
        <span class="kt">Nothing</span> <span class="ow">-&gt;</span> <span class="n">decodeRoute</span> <span class="o">@</span><span class="n">model</span> <span class="o">@</span><span class="n">r</span> <span class="n">slugs</span>
  <span class="n">staticRoutes</span> <span class="p">(</span><span class="n">aliases</span><span class="p">,</span> <span class="n">model</span><span class="p">)</span> <span class="ow">=</span>
     <span class="n">getAllAlises</span> <span class="n">aliases</span> <span class="o">&lt;&gt;</span> <span class="n">staticRoutes</span> <span class="n">model</span>
  <span class="c1">-- Rest of the functions are delegated</span>
</code></pre></div></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/4429aa8b689608f24a4ad712843ce29862e330d2?x=x&amp;version=2"></a><div class="content"><a class="author">Sridhar Ratnakumar</a><div class="metadata"><a href="#236085801" name="236085801"><div>2021-04-25 18:58:34</div></a></div><div class="text"><p>And your view function will be forced to deal with the new kinds of routes,</p>
<div class="codehilite" data-code-language="Haskell"><pre><span></span><code><span class="nf">render</span> <span class="n">cli</span> <span class="p">(</span><span class="n">aliases</span><span class="p">,</span> <span class="n">model</span><span class="p">)</span> <span class="ow">=</span> <span class="nf">\</span><span class="kr">case</span>
    <span class="kt">Normal</span> <span class="n">r</span> <span class="ow">-&gt;</span> <span class="kt">Neuron</span><span class="o">.</span><span class="n">render</span> <span class="n">cli</span> <span class="n">model</span>
    <span class="kt">Alias</span> <span class="n">alias</span> <span class="n">r</span> <span class="ow">-&gt;</span>
      <span class="s">"&lt;head&gt;&lt;meta redirect..."</span>
</code></pre></div></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/4429aa8b689608f24a4ad712843ce29862e330d2?x=x&amp;version=2"></a><div class="content"><a class="author">Sridhar Ratnakumar</a><div class="metadata"><a href="#236085833" name="236085833"><div>2021-04-25 18:59:44</div></a></div><div class="text"><p>(Just added <code>staticRoutes</code> implementation; and that, in conjunction with view, guarantees that static site generation will create our alias HTMLs)</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/4429aa8b689608f24a4ad712843ce29862e330d2?x=x&amp;version=2"></a><div class="content"><a class="author">Sridhar Ratnakumar</a><div class="metadata"><a href="#236086116" name="236086116"><div>2021-04-25 19:03:34</div></a></div><div class="text"><p>So I think records don't compose well <em>whilst</em> guaranteeing safety. Because "patching" a record value doesn't propagate to all the places where the type is used (like the render function using the route type). Type-classes guarantee type safety here, albeit at the expense of losing some ease of composability. I'm not 100% sure which way to sway, but haven't yet seen compelling evidence to seriously consider records yet.</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/4429aa8b689608f24a4ad712843ce29862e330d2?x=x&amp;version=2"></a><div class="content"><a class="author">Sridhar Ratnakumar</a><div class="metadata"><a href="#236090744" name="236090744"><div>2021-04-25 20:25:52</div></a></div><div class="text"><p><span class="user-mention silent" data-user-id="251311">Sridhar Ratnakumar</span> <a href="#narrow/stream/201385-Haskell/topic/Ema.20static.20site.20generator.20progress/near/236085053">said</a>:</p>
<blockquote>
<p>That does make me wonder ... maybe <code>decodeRoute</code> <em>should</em> take the (current) model as argument. It would be useful to handle 404 early. Like <code>decode /notes/foo.md</code> can fail if "foo.md" is not present in the model.</p>
</blockquote>
<p>Wait, no it is not needed! I have to revert the commit.</p>
<p>decodeRoute and encodeRoute can just remain isomorphisms. Adding a model argument to one of them violates that property. And alias feature can be implemented in the <code>staticRoutes</code> method which does take that argument.</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/4429aa8b689608f24a4ad712843ce29862e330d2?x=x&amp;version=2"></a><div class="content"><a class="author">Sridhar Ratnakumar</a><div class="metadata"><a href="#236090931" name="236090931"><div>2021-04-25 20:29:17</div></a></div><div class="text"><h2>Record vs Type classes - an approach to choose</h2>
<p>In summary, I think we should do the following in order to systematically arrive at a conclusion as to what to choose:</p>
<ul>
<li>Start with Type class design and examples</li>
<li>Create an example that supposedly make records seem advantageous (eg: aliased routes)</li>
<li>Code that example using type classes</li>
<li>Now code that example using records</li>
<li>Compare them both.<ul>
<li>Do they both have same level of type-safety?</li>
<li>What's their API ergonomics?</li>
</ul>
</li>
</ul></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/4429aa8b689608f24a4ad712843ce29862e330d2?x=x&amp;version=2"></a><div class="content"><a class="author">Sridhar Ratnakumar</a><div class="metadata"><a href="#236091107" name="236091107"><div>2021-04-25 20:32:10</div></a></div><div class="text"><h2>Composability of type classes</h2>
<p>Are records really "more" composable than type classes? I'm not sure that's true.</p>
<p>With records, you are simply composing them at the value level. With type classes, you compose them at the _type-level_.</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/4429aa8b689608f24a4ad712843ce29862e330d2?x=x&amp;version=2"></a><div class="content"><a class="author">Sridhar Ratnakumar</a><div class="metadata"><a href="#236113393" name="236113393"><div>2021-04-26 02:51:32</div></a></div><div class="text"><h1>Adding logging</h1>
<p>Played a bit with <code>co-log</code>, but it doesn't work well with functions like <code>withCurrentDirectory</code> (i.e., taking functions as arguments that return IO action; and you want to have logging in those actions), so going back to good ol <code>monad-logger</code> but with <code>monad-logger-extras</code> sugar on top. I also had to pull <code>unliftio</code> as part of it.</p>
<p><a href="https://github.com/srid/ema/pull/17/files">https://github.com/srid/ema/pull/17/files</a></p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/srid/ema/pull/17/files" style="background-image: url(https://avatars.githubusercontent.com/u/3998?s=400&amp;v=4)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/srid/ema/pull/17/files" title="Add logging support by srid · Pull Request #17 · srid/ema">Add logging support by srid · Pull Request #17 · srid/ema</a></div><div class="message_embed_description">
Have a question about this project? Sign up for a free GitHub account to open an issue and contact its maintainers and the community.
  </div></div></div></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/20a04d823b7c3891d78ca5f6a188ccd0e4fc5e3d?x=x&amp;version=2"></a><div class="content"><a class="author">TheMatten</a><div class="metadata"><a href="#236126793" name="236126793"><div>2021-04-26 06:38:51</div></a></div><div class="text"><blockquote>
<p>With records, you are simply composing them at the value level. With type classes, you compose them at the _type-level_.</p>
</blockquote>
<p>Yeah - what I mean is that the latter is harder and can't be done in effectful context</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/4429aa8b689608f24a4ad712843ce29862e330d2?x=x&amp;version=2"></a><div class="content"><a class="author">Sridhar Ratnakumar</a><div class="metadata"><a href="#236188524" name="236188524"><div>2021-04-26 14:59:43</div></a></div><div class="text"><p><span class="user-mention" data-user-id="225127">@TheMatten</span> I like the 'effectful context' descriptor. By which you mean - being able to pull values out of some closure (such as in IO monad) right? </p>
<p>The thing is - with Ema, all such values <em>should</em> be (by Ema's design) part of the <code>model</code>. The alias example is approached in the exact way; by putting <code>Map Text Route</code> in the <code>model</code>. This allows you to use Ema's hot reload easily with these values. Such as when your <code>alias.json</code> file changes, there is nothing special to do (thanks to the <code>LVar</code> in use).</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/4429aa8b689608f24a4ad712843ce29862e330d2?x=x&amp;version=2"></a><div class="content"><a class="author">Sridhar Ratnakumar</a><div class="metadata"><a href="#236189738" name="236189738"><div>2021-04-26 15:03:09</div></a></div><div class="text"><p>It is similar to the <code>state</code> in TEA (The Elm Architecture) or MVU (Model View Update) .</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/4429aa8b689608f24a4ad712843ce29862e330d2?x=x&amp;version=2"></a><div class="content"><a class="author">Sridhar Ratnakumar</a><div class="metadata"><a href="#236189951" name="236189951"><div>2021-04-26 15:03:50</div></a></div><div class="text"><p>Using a diagram from one of the MVU posts, <a href="/user_uploads/13896/fUgoFGgvqSf8xntu37pUaVcH/image.png">image.png</a></p>
<div class="message_inline_image"><a href="/user_uploads/13896/fUgoFGgvqSf8xntu37pUaVcH/image.png" title="image.png"><img src="/user_uploads/13896/fUgoFGgvqSf8xntu37pUaVcH/image.png"></a></div></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/4429aa8b689608f24a4ad712843ce29862e330d2?x=x&amp;version=2"></a><div class="content"><a class="author">Sridhar Ratnakumar</a><div class="metadata"><a href="#236190138" name="236190138"><div>2021-04-26 15:04:19</div></a></div><div class="text"><p>In Ema, we have two circles only -- Model and View. There is no Update, because - these are static sites, with no two-way interactivity.</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/4429aa8b689608f24a4ad712843ce29862e330d2?x=x&amp;version=2"></a><div class="content"><a class="author">Sridhar Ratnakumar</a><div class="metadata"><a href="#236190288" name="236190288"><div>2021-04-26 15:04:59</div></a></div><div class="text"><p>However, due to use of <code>LVar</code> the program can unilaterally (with no client involvement; hence not interactive) modify the <code>model</code> (say, from filesystem changes) - which modifications are propagated to the view when using the dev server, via hot reload.</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/20a04d823b7c3891d78ca5f6a188ccd0e4fc5e3d?x=x&amp;version=2"></a><div class="content"><a class="author">TheMatten</a><div class="metadata"><a href="#236204484" name="236204484"><div>2021-04-26 16:31:44</div></a></div><div class="text"><blockquote>
<p>The thing is - with Ema, all such values should be (by Ema's design) part of the model.</p>
</blockquote>
<p>They are - it's just that the initial configuration of the model can be done at runtime - e.g. when starting the program</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/4429aa8b689608f24a4ad712843ce29862e330d2?x=x&amp;version=2"></a><div class="content"><a class="author">Sridhar Ratnakumar</a><div class="metadata"><a href="#236215069" name="236215069"><div>2021-04-26 17:44:39</div></a></div><div class="text"><p>You can already do that, since <code>runEma</code> takes a <code>LVar model -&gt; IO ()</code> function (inside which you'd <code>set</code> / <code>modify</code> the LVar); and it is also a forever living IO action, to monitor file changes and such (it is run as in a different thread).</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/4429aa8b689608f24a4ad712843ce29862e330d2?x=x&amp;version=2"></a><div class="content"><a class="author">Sridhar Ratnakumar</a><div class="metadata"><a href="#236215089" name="236215089"><div>2021-04-26 17:44:47</div></a></div><div class="text"><h3>LVar published on hackage</h3>
<p><a href="https://hackage.haskell.org/package/lvar-0.1.0.0/docs/Data-LVar.html">https://hackage.haskell.org/package/lvar-0.1.0.0/docs/Data-LVar.html</a></p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/4429aa8b689608f24a4ad712843ce29862e330d2?x=x&amp;version=2"></a><div class="content"><a class="author">Sridhar Ratnakumar</a><div class="metadata"><a href="#236251370" name="236251370"><div>2021-04-26 21:59:41</div></a></div><div class="text"><h3>Template repo is ready!</h3>
<p>Start creating your Ema sites now: <a href="https://github.com/srid/ema-docs">https://github.com/srid/ema-docs</a></p>
<p>Last step before announcement: finish documentation and write blog post.</p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/srid/ema-docs" style="background-image: url(https://opengraph.githubassets.com/f8037d442822614b27c869e1b054b4b5ef75558854f7e11e75be05d53e0abc18/srid/ema-docs)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/srid/ema-docs" title="srid/ema-docs">srid/ema-docs</a></div><div class="message_embed_description">Template repo &amp; documentation for Ema static site generator - srid/ema-docs</div></div></div></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/4429aa8b689608f24a4ad712843ce29862e330d2?x=x&amp;version=2"></a><div class="content"><a class="author">Sridhar Ratnakumar</a><div class="metadata"><a href="#236393970" name="236393970"><div>2021-04-27 19:22:47</div></a></div><div class="text"><h2>Deriving automatically using Generics</h2>
<div class="codehilite" data-code-language="Haskell"><pre><span></span><code><span class="kr">data</span> <span class="kt">Route</span>
  <span class="ow">=</span> <span class="kt">Index</span>
  <span class="o">|</span> <span class="kt">About</span>
  <span class="kr">deriving</span> <span class="p">(</span><span class="kt">Show</span><span class="p">,</span> <span class="kt">Enum</span><span class="p">,</span> <span class="kt">Bounded</span><span class="p">)</span>

<span class="kr">instance</span> <span class="kt">Ema</span> <span class="kt">Model</span> <span class="kt">Route</span> <span class="kr">where</span>
  <span class="n">encodeRoute</span> <span class="ow">=</span> <span class="nf">\</span><span class="kr">case</span>
    <span class="kt">Index</span> <span class="ow">-&gt;</span> <span class="n">mempty</span>
    <span class="kt">About</span> <span class="ow">-&gt;</span> <span class="n">one</span> <span class="s">"about"</span>
  <span class="n">decodeRoute</span> <span class="ow">=</span> <span class="nf">\</span><span class="kr">case</span>
    <span class="kt">[]</span> <span class="ow">-&gt;</span> <span class="kt">Just</span> <span class="kt">Index</span>
    <span class="p">[</span><span class="s">"about"</span><span class="p">]</span> <span class="ow">-&gt;</span> <span class="kt">Just</span> <span class="kt">About</span>
    <span class="kr">_</span> <span class="ow">-&gt;</span> <span class="kt">Nothing</span>
</code></pre></div>
<p>Wouldn't it be cool if the above can be automatically derived using <code>Generic</code>? Should support nested routes too, eg: </p>
<div class="codehilite" data-code-language="Haskell"><pre><span></span><code><span class="kr">data</span> <span class="kt">Route</span>
  <span class="ow">=</span> <span class="kt">Index</span>
  <span class="ow">=</span> <span class="kt">Blog</span> <span class="kt">BlogRoute</span>

<span class="kr">data</span> <span class="kt">BlogRoute</span>
  <span class="ow">=</span> <span class="kt">BlogIndex</span>
  <span class="o">|</span> <span class="kt">BlogPost</span> <span class="kt">Slug</span>
</code></pre></div>
<p>Then <code>deriving instance Ema m Route</code> should automatically create implementation that maps say <code>Blog (BlogPost "foo")</code> to <code>/blog/foo</code> URL and vice-versa.</p></div></div></div></div></div><div class="ui vertical footer segment"><a href="https://github.com/srid/zulip-archive">Powered by Haskell</a> | Questions? Contact <a href="https://www.srid.ca">srid</a></div></div></body></html>