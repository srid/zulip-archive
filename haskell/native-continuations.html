<html lang="en"><head><meta content="text/html; charset=utf-8" http-equiv="Content-Type"><meta content="width=device-width, initial-scale=1" name="viewport"><meta content="I&#39;m currently having fun with @Alexis King&#39;s branch of GHC with delimited continuations: https://gitlab.haskell.org/lexi.lambda/ghc/raw/continuations-bindist-8.11.0.20200211-x86_64-xenial/ghc.tar.xz
main :: IO ()
main = do
  x &lt;- withReturn $ go 0
  print x
 where
  go :: Int -&gt; Return Int Int
  go " name="description"><link href="https://funprog.srid.ca/haskell/native-continuations.html" rel="canonical"><meta property="og:title" content="Native continuations - Haskell"><meta property="og:site_name" content="Functional Programming Zulip Archive"><meta property="og:type" content="article"><meta property="og:article:section" content="Haskell"><meta property="og:article:modified_time" content="2021-01-18T16:21:40Z"><meta property="og:article:published_time" content="2020-02-14T20:54:54Z"><meta property="og:image" content="https://zulip-avatars.s3.amazonaws.com/13896/20a04d823b7c3891d78ca5f6a188ccd0e4fc5e3d?x=x&amp;version=2"><title>Native continuations - Haskell</title><style type="text/css">
div#thesite
{
  font-family   : "Open Sans", sans-serif;
  font-size     : 1em !important;
  margin-top    : 1em;
  margin-bottom : 1em;
}

div#thesite h1
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite h2
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite h3
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite h4
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite h5
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite h6
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite .ui.breadcrumb.rib .section
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite .header
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite .as-header
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite code, pre, tt
{
  font-family : "SFMono-Regular","Menlo","Monaco","Consolas","Liberation Mono","Courier New", monospace;
}

div#thesite .ui.breadcrumb.rib
{
  margin-bottom : 1em;
}



div#thesite .ui.comments.messages .comment .metadata a
{
  color : #808080;
}

div#thesite .ui.comments.messages .comment a.avatar img
{
  height : auto;
}

div#thesite .subtle
{
  color : #808080;
}


div#thesite .messages pre
{
  font-size : 85%;
  overflow  : auto;
  max-width : 100%;
}

div#thesite .messages .message_embed
{
  border-left  : solid 3px #808080;
  padding-left : 0.69999em;
}

div#thesite .messages .message_inline_image img
{
  max-width     : 100%;
  margin-bottom : 1em;
}


/* Generated with Clay, http://fvisser.nl/clay */</style><link href="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.4.1/semantic.min.css" rel="stylesheet"><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/all.min.css" rel="stylesheet"><link href="https://fonts.googleapis.com/css?family=Open+Sans|Oswald&amp;display=swap" rel="stylesheet"><link href="https://fonts.googleapis.com/css?family=Roboto|Open+Sans&amp;display=swap" rel="stylesheet"></head><body><div id="thesite" class="ui text container"><div class="ui violet inverted top attached center aligned segment"><h1 class="ui huge header">Native continuations - Haskell</h1></div><div class="ui attached segment"><div class="ui message"><p>Welcome to the Functional Programming Zulip Chat Archive. You can join the chat <a href="https://funprog.zulipchat.com">here</a>.</p></div><div class="ui breadcrumb rib"><a href="/" class="section">Home</a><i class="right angle icon divider"></i><a href="/haskell/" class="section">#Haskell</a><i class="right angle icon divider"></i><div class="active section">Native continuations</div></div><div class="ui comments messages"><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/20a04d823b7c3891d78ca5f6a188ccd0e4fc5e3d?x=x&amp;version=2"></a><div class="content"><a class="author">TheMatten</a><div class="metadata"><a href="#188245640" name="188245640"><div>2020-02-14 20:54:54</div></a></div><div class="text"><p>I'm currently having fun with <span class="user-mention" data-user-id="251362">@Alexis King</span>'s branch of GHC with delimited continuations: <a href="https://gitlab.haskell.org/lexi.lambda/ghc/raw/continuations-bindist-8.11.0.20200211-x86_64-xenial/ghc.tar.xz" target="_blank" title="https://gitlab.haskell.org/lexi.lambda/ghc/raw/continuations-bindist-8.11.0.20200211-x86_64-xenial/ghc.tar.xz">https://gitlab.haskell.org/lexi.lambda/ghc/raw/continuations-bindist-8.11.0.20200211-x86_64-xenial/ghc.tar.xz</a></p>
<div class="codehilite"><pre><span></span><span class="nf">main</span> <span class="ow">::</span> <span class="kt">IO</span> <span class="nb">()</span>
<span class="nf">main</span> <span class="ow">=</span> <span class="kr">do</span>
  <span class="n">x</span> <span class="ow">&lt;-</span> <span class="n">withReturn</span> <span class="o">$</span> <span class="n">go</span> <span class="mi">0</span>
  <span class="n">print</span> <span class="n">x</span>
 <span class="kr">where</span>
  <span class="n">go</span> <span class="ow">::</span> <span class="kt">Int</span> <span class="ow">-&gt;</span> <span class="kt">Return</span> <span class="kt">Int</span> <span class="kt">Int</span>
  <span class="n">go</span> <span class="n">n</span> <span class="ow">=</span> <span class="kr">do</span>
    <span class="n">when</span> <span class="p">(</span><span class="n">n</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">$</span> <span class="n">return</span> <span class="mi">42</span>
    <span class="n">go</span> <span class="p">(</span><span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

<span class="kr">newtype</span> <span class="kt">Return</span> <span class="n">a</span> <span class="n">b</span> <span class="ow">=</span> <span class="kt">UnsafeReturn</span> <span class="p">{</span> <span class="n">unsafeReturnToIO</span> <span class="ow">::</span> <span class="kt">IO</span> <span class="n">b</span> <span class="p">}</span>
  <span class="kr">deriving</span> <span class="kr">newtype</span> <span class="p">(</span><span class="kt">Functor</span><span class="p">,</span> <span class="kt">Applicative</span><span class="p">,</span> <span class="kt">Monad</span><span class="p">,</span> <span class="kt">MonadIO</span><span class="p">)</span>

<span class="nf">return</span> <span class="ow">::</span> <span class="n">a</span> <span class="ow">-&gt;</span> <span class="kt">Return</span> <span class="n">a</span> <span class="n">b</span>
<span class="nf">return</span> <span class="ow">=</span> <span class="kt">UnsafeReturn</span> <span class="o">.</span> <span class="n">shift</span> <span class="o">.</span> <span class="n">const</span> <span class="o">.</span> <span class="n">pure</span>

<span class="nf">withReturn</span> <span class="ow">::</span> <span class="kt">Return</span> <span class="n">a</span> <span class="n">a</span> <span class="ow">-&gt;</span> <span class="kt">IO</span> <span class="n">a</span>
<span class="nf">withReturn</span> <span class="ow">=</span> <span class="n">reset</span> <span class="o">.</span> <span class="n">unsafeReturnToIO</span>
</pre></div>


<div class="codehilite"><pre><span></span>&gt; main
42
</pre></div></div></div></div><div class="comment"><a class="avatar"><img src="https://www.gravatar.com/avatar/c03b8d34978563858020eff0d14cc17b"></a><div class="content"><a class="author">Alexis King</a><div class="metadata"><a href="#188245895" name="188245895"><div>2020-02-14 20:57:49</div></a></div><div class="text"><p>Wow, someone actually went to the effort of trying it! :)</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/20a04d823b7c3891d78ca5f6a188ccd0e4fc5e3d?x=x&amp;version=2"></a><div class="content"><a class="author">TheMatten</a><div class="metadata"><a href="#188246000" name="188246000"><div>2020-02-14 20:59:09</div></a></div><div class="text"><p>THAT THING IS SO COOL - thank you Alexis! <span aria-label="smiley" class="emoji emoji-1f603" role="img" title="smiley">:smiley:</span></p></div></div></div><div class="comment"><a class="avatar"><img src="https://www.gravatar.com/avatar/c03b8d34978563858020eff0d14cc17b"></a><div class="content"><a class="author">Alexis King</a><div class="metadata"><a href="#188246029" name="188246029"><div>2020-02-14 20:59:35</div></a></div><div class="text"><p>The eff interface is nicer (and actually safe), so you should use that instead of calling the unsafe primops. ;)</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/20a04d823b7c3891d78ca5f6a188ccd0e4fc5e3d?x=x&amp;version=2"></a><div class="content"><a class="author">TheMatten</a><div class="metadata"><a href="#188246192" name="188246192"><div>2020-02-14 21:01:26</div></a></div><div class="text"><p><span aria-label="100" class="emoji emoji-1f4af" role="img" title="100">:100:</span>, I'm just trying this out mostly - I can see why they're unsafe <span aria-label="smiley" class="emoji emoji-1f603" role="img" title="smiley">:smiley:</span> :</p>
<div class="codehilite"><pre><span></span><span class="nf">crazyCoerce</span> <span class="ow">::</span> <span class="n">a</span> <span class="ow">-&gt;</span> <span class="kt">IO</span> <span class="n">b</span>
<span class="nf">crazyCoerce</span> <span class="ow">=</span> <span class="n">reset</span> <span class="o">.</span> <span class="n">shift</span> <span class="o">.</span> <span class="n">const</span> <span class="o">.</span> <span class="n">pure</span>
</pre></div></div></div></div><div class="comment"><a class="avatar"><img src="https://www.gravatar.com/avatar/c03b8d34978563858020eff0d14cc17b"></a><div class="content"><a class="author">Alexis King</a><div class="metadata"><a href="#188246224" name="188246224"><div>2020-02-14 21:02:00</div></a></div><div class="text"><p>Yes, you will smash your stack if you use them incorrectly. :)</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/20a04d823b7c3891d78ca5f6a188ccd0e4fc5e3d?x=x&amp;version=2"></a><div class="content"><a class="author">TheMatten</a><div class="metadata"><a href="#188246383" name="188246383"><div>2020-02-14 21:03:56</div></a></div><div class="text"><p>And forgetting <code>reset</code> has nasty consequences <span aria-label="smiley" class="emoji emoji-1f603" role="img" title="smiley">:smiley:</span><br>
BTW, what machinery does it use internally? Is it related to exceptions stuff?</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/20a04d823b7c3891d78ca5f6a188ccd0e4fc5e3d?x=x&amp;version=2"></a><div class="content"><a class="author">TheMatten</a><div class="metadata"><a href="#188246593" name="188246593"><div>2020-02-14 21:06:00</div></a></div><div class="text"><p>(Oh, and is it safe in <code>ST</code>? <span aria-label="slight smile" class="emoji emoji-1f642" role="img" title="slight smile">:slight_smile:</span> )</p></div></div></div><div class="comment"><a class="avatar"><img src="https://www.gravatar.com/avatar/c03b8d34978563858020eff0d14cc17b"></a><div class="content"><a class="author">Alexis King</a><div class="metadata"><a href="#188246693" name="188246693"><div>2020-02-14 21:07:10</div></a></div><div class="text"><p>It’s all new code: <code>reset#</code> pushes a special kind of stack frame onto the stack, and <code>shift#</code> walks the stack until it finds a reset frame, then copies the upper chunk of the stack into the heap.</p></div></div></div><div class="comment"><a class="avatar"><img src="https://www.gravatar.com/avatar/c03b8d34978563858020eff0d14cc17b"></a><div class="content"><a class="author">Alexis King</a><div class="metadata"><a href="#188246965" name="188246965"><div>2020-02-14 21:08:43</div></a></div><div class="text"><p>The behavior is well-defined in any <em>strict</em> state thread (so strict <code>ST</code> is okay, but not lazy <code>ST</code>), assuming you follow a laundry list of rules.</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/20a04d823b7c3891d78ca5f6a188ccd0e4fc5e3d?x=x&amp;version=2"></a><div class="content"><a class="author">TheMatten</a><div class="metadata"><a href="#188247484" name="188247484"><div>2020-02-14 21:13:48</div></a></div><div class="text"><p>Cool!<br>
Maybe a little bit crazy question, but is it potentially possible to have multiple overlapping <code>reset</code>/<code>shift</code> scopes?</p></div></div></div><div class="comment"><a class="avatar"><img src="https://www.gravatar.com/avatar/c03b8d34978563858020eff0d14cc17b"></a><div class="content"><a class="author">Alexis King</a><div class="metadata"><a href="#188247541" name="188247541"><div>2020-02-14 21:14:09</div></a></div><div class="text"><p>The main rules are:</p>
<ol>
<li>The behavior of <code>shift#</code> is only defined if you pushed <code>reset#</code> frame in the <em>current state thread</em> (so you can’t call <code>reset#</code> in an outer <code>ST</code> computation and then call <code>shift#</code> in a nested <code>runST</code> computation unless you push a new <code>reset#</code> frame in the nested computation, for example).</li>
<li>It is your responsibility to ensure you use <code>shift#</code> with the right type to match the enclosing <code>reset#</code>.</li>
<li>You are never allowed to capture STM stack frames or thunk update frames (which mostly translates to “don’t use <code>shift#</code> inside any STM-related things or inside <code>unsafeInterleaveIO</code>”).</li>
</ol></div></div></div><div class="comment"><a class="avatar"><img src="https://www.gravatar.com/avatar/c03b8d34978563858020eff0d14cc17b"></a><div class="content"><a class="author">Alexis King</a><div class="metadata"><a href="#188247607" name="188247607"><div>2020-02-14 21:15:09</div></a></div><div class="text"><p><span class="user-mention silent" data-user-id="225127">TheMatten</span> <a href="#narrow/stream/201385-Haskell/topic/Native.20continuations/near/188247484" title="#narrow/stream/201385-Haskell/topic/Native.20continuations/near/188247484">said</a>:</p>
<blockquote>
<p>Cool!<br>
Maybe a little bit crazy question, but is it potentially possible to have multiple overlapping <code>reset</code>/<code>shift</code> scopes?</p>
</blockquote>
<p>Not using the primops. <code>eff</code> adds this feature on top by managing a stack of continuation chunks in userspace.</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/20a04d823b7c3891d78ca5f6a188ccd0e4fc5e3d?x=x&amp;version=2"></a><div class="content"><a class="author">TheMatten</a><div class="metadata"><a href="#188247733" name="188247733"><div>2020-02-14 21:16:25</div></a></div><div class="text"><p>Oh, so you <code>reset</code> and find wanted chunk in retrieved datastructure?</p></div></div></div><div class="comment"><a class="avatar"><img src="https://www.gravatar.com/avatar/c03b8d34978563858020eff0d14cc17b"></a><div class="content"><a class="author">Alexis King</a><div class="metadata"><a href="#188247736" name="188247736"><div>2020-02-14 21:16:29</div></a></div><div class="text"><p>Using the primops is very dangerous. There is <strong>no safe way</strong> to use <code>shift#</code> in an arbitrary <code>IO</code> computation because <code>shift#</code> does not run exception handlers while unwinding the stack, so if you have code that uses <code>bracket</code>, it’ll just leak.</p></div></div></div><div class="comment"><a class="avatar"><img src="https://www.gravatar.com/avatar/c03b8d34978563858020eff0d14cc17b"></a><div class="content"><a class="author">Alexis King</a><div class="metadata"><a href="#188247813" name="188247813"><div>2020-02-14 21:17:51</div></a></div><div class="text"><blockquote>
<p>Oh, so you <code>reset</code> and find wanted chunk in retrieved datastructure?</p>
</blockquote>
<p>Effectively yes, but in practice it’s actually much more elaborate for performance reasons. :) There’s a fancy calling convention that all the prompt frames use to handle <code>shift</code> and <code>abort</code> to the right places.</p></div></div></div><div class="comment"><a class="avatar"><img src="https://www.gravatar.com/avatar/45175015b9eb3dd3f6c740b3fe920fed"></a><div class="content"><a class="author">Joel McCracken</a><div class="metadata"><a href="#188250013" name="188250013"><div>2020-02-14 21:45:27</div></a></div><div class="text"><p>ooo i had no idea that someone had done delimited continuations in hs</p></div></div></div><div class="comment"><a class="avatar"><img src="https://www.gravatar.com/avatar/45175015b9eb3dd3f6c740b3fe920fed"></a><div class="content"><a class="author">Joel McCracken</a><div class="metadata"><a href="#188250016" name="188250016"><div>2020-02-14 21:45:29</div></a></div><div class="text"><p>cool</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/20a04d823b7c3891d78ca5f6a188ccd0e4fc5e3d?x=x&amp;version=2"></a><div class="content"><a class="author">TheMatten</a><div class="metadata"><a href="#188250526" name="188250526"><div>2020-02-14 21:51:17</div></a></div><div class="text"><p><span class="user-mention" data-user-id="251362">@Alexis King</span> Thanks, I will keep these in mind - two more questions:</p>
<ul>
<li>Assuming I preserve specified invariants, is this interface meant to be "general" support for continuations, or is it "<code>Eff</code>-specific"?</li>
<li>When it comes to <code>eff</code>, will it be possible to embed/interpret into <code>IO</code>?</li>
</ul></div></div></div><div class="comment"><a class="avatar"><img src="https://www.gravatar.com/avatar/0d11c25a0fa037a73c22c65361fb142a"></a><div class="content"><a class="author">Callan McGill</a><div class="metadata"><a href="#188251045" name="188251045"><div>2020-02-14 21:57:00</div></a></div><div class="text"><p><span class="user-mention" data-user-id="251362">@Alexis King</span> I have been following this work via twitter and the GHC mailing list and just wanted to say that I find it incredibly inspiring and impressive! Thank you for doing it and I can't wait to use and learn from your library!</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/20a04d823b7c3891d78ca5f6a188ccd0e4fc5e3d?x=x&amp;version=2"></a><div class="content"><a class="author">TheMatten</a><div class="metadata"><a href="#188251539" name="188251539"><div>2020-02-14 22:02:15</div></a></div><div class="text"><p>Yeah, referring to <a href="http://www.stephendiehl.com/posts/decade.html" target="_blank" title="http://www.stephendiehl.com/posts/decade.html">http://www.stephendiehl.com/posts/decade.html</a>, <code>eff</code> is really starting to feel like a "next successor to <code>mtl</code>" <span aria-label="slight smile" class="emoji emoji-1f642" role="img" title="slight smile">:slight_smile:</span></p></div></div></div><div class="comment"><a class="avatar"><img src="https://www.gravatar.com/avatar/c03b8d34978563858020eff0d14cc17b"></a><div class="content"><a class="author">Alexis King</a><div class="metadata"><a href="#188251683" name="188251683"><div>2020-02-14 22:04:15</div></a></div><div class="text"><p><span class="user-mention silent" data-user-id="225127">TheMatten</span> <a href="#narrow/stream/201385-Haskell/topic/Native.20continuations/near/188250526" title="#narrow/stream/201385-Haskell/topic/Native.20continuations/near/188250526">said</a>:</p>
<blockquote>
<ul>
<li>Assuming I preserve specified invariants, is this interface meant to be "general" support for continuations, or is it "<code>Eff</code>-specific"?</li>
</ul>
</blockquote>
<p>Philosophically, there’s nothing specific to <code>eff</code> in its design. That said, the design space for continuation implementation is enormous, and it’s possible that a different use case would have motivated a different design. The main variations in different implementations are performance tradeoffs: you can optimize for <em>so many</em> different things. You can optimize for capture, for restore, for frequent continuation use, for infrequent use, and any number of other things. Right now, I’m trying to come up with the simplest possible implementation that is reasonably performant, so that should at least ensure it isn’t overfitted to <code>eff</code>’s needs.</p>
<blockquote>
<ul>
<li>When it comes to <code>eff</code>, will it be possible to embed/interpret into <code>IO</code>?</li>
</ul>
</blockquote>
<p>Yes, this is possible in <code>eff</code> today, though I still need to add support for things like exceptions.</p></div></div></div><div class="comment"><a class="avatar"><img src="https://www.gravatar.com/avatar/c03b8d34978563858020eff0d14cc17b"></a><div class="content"><a class="author">Alexis King</a><div class="metadata"><a href="#188251768" name="188251768"><div>2020-02-14 22:05:14</div></a></div><div class="text"><p><span class="user-mention silent" data-user-id="250931">Callan McGill</span> <a href="#narrow/stream/201385-Haskell/topic/Native.20continuations/near/188251045" title="#narrow/stream/201385-Haskell/topic/Native.20continuations/near/188251045">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="251362">Alexis King</span> I have been following this work via twitter and the GHC mailing list and just wanted to say that I find it incredibly inspiring and impressive! Thank you for doing it and I can't wait to use and learn from your library!</p>
</blockquote>
<p>Thank you! :) I don’t know how long it will take to get the primops to a place where they can be merged into GHC, but I’m excited about how things are shaping up.</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/20a04d823b7c3891d78ca5f6a188ccd0e4fc5e3d?x=x&amp;version=2"></a><div class="content"><a class="author">TheMatten</a><div class="metadata"><a href="#188253069" name="188253069"><div>2020-02-14 22:22:42</div></a></div><div class="text"><p>Inspired by <a href="https://en.wikipedia.org/wiki/Delimited_continuation#Examples" target="_blank" title="https://en.wikipedia.org/wiki/Delimited_continuation#Examples">example of Scheme's continuations on Wiki</a>, I've tried out:</p>
<div class="codehilite"><pre><span></span><span class="nf">lists</span> <span class="ow">::</span> <span class="kt">IO</span> <span class="nb">()</span>
<span class="nf">lists</span> <span class="ow">=</span> <span class="n">print</span> <span class="o">@</span><span class="p">[</span><span class="kt">Int</span><span class="p">]</span> <span class="o">=&lt;&lt;</span> <span class="n">reset</span> <span class="kr">do</span>
  <span class="n">shift</span> <span class="nf">\</span><span class="n">k</span> <span class="ow">-&gt;</span> <span class="p">(</span><span class="mi">1</span> <span class="kt">:</span><span class="p">)</span> <span class="o">&lt;$&gt;</span> <span class="p">(</span><span class="n">k</span> <span class="o">$@</span> <span class="n">pure</span> <span class="nb">()</span><span class="p">)</span>
  <span class="n">shift</span> <span class="nf">\</span><span class="n">k</span> <span class="ow">-&gt;</span> <span class="p">(</span><span class="mi">2</span> <span class="kt">:</span><span class="p">)</span> <span class="o">&lt;$&gt;</span> <span class="p">(</span><span class="n">k</span> <span class="o">$@</span> <span class="n">pure</span> <span class="nb">()</span><span class="p">)</span>
  <span class="n">shift</span> <span class="nf">\</span><span class="n">k</span> <span class="ow">-&gt;</span> <span class="p">(</span><span class="mi">3</span> <span class="kt">:</span><span class="p">)</span> <span class="o">&lt;$&gt;</span> <span class="p">(</span><span class="n">k</span> <span class="o">$@</span> <span class="n">pure</span> <span class="nb">()</span><span class="p">)</span>
  <span class="n">pure</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">]</span>
</pre></div>


<p>This crashes, but</p>
<div class="codehilite"><pre><span></span><span class="nf">lists</span> <span class="ow">::</span> <span class="kt">IO</span> <span class="nb">()</span>
<span class="nf">lists</span> <span class="ow">=</span> <span class="n">print</span> <span class="o">@</span><span class="p">[</span><span class="kt">Int</span><span class="p">]</span> <span class="o">=&lt;&lt;</span> <span class="n">reset</span> <span class="kr">do</span>
  <span class="n">shift</span> <span class="nf">\</span><span class="n">k</span> <span class="ow">-&gt;</span> <span class="p">(</span><span class="mi">1</span> <span class="kt">:</span><span class="p">)</span> <span class="o">&lt;$&gt;</span> <span class="p">(</span><span class="n">k</span> <span class="o">$@</span> <span class="n">pure</span> <span class="nb">()</span><span class="p">)</span>
  <span class="n">reset</span> <span class="kr">do</span>
  <span class="n">shift</span> <span class="nf">\</span><span class="n">k</span> <span class="ow">-&gt;</span> <span class="p">(</span><span class="mi">2</span> <span class="kt">:</span><span class="p">)</span> <span class="o">&lt;$&gt;</span> <span class="p">(</span><span class="n">k</span> <span class="o">$@</span> <span class="n">pure</span> <span class="nb">()</span><span class="p">)</span>
  <span class="n">reset</span> <span class="kr">do</span>
  <span class="n">shift</span> <span class="nf">\</span><span class="n">k</span> <span class="ow">-&gt;</span> <span class="p">(</span><span class="mi">3</span> <span class="kt">:</span><span class="p">)</span> <span class="o">&lt;$&gt;</span> <span class="p">(</span><span class="n">k</span> <span class="o">$@</span> <span class="n">pure</span> <span class="nb">()</span><span class="p">)</span>
  <span class="n">pure</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">]</span>
</pre></div>


<p>returns <code>[1,2,3,4,5]</code> - That is, <code>reset</code> has to be paired with one <code>shift</code> only to work properly?</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/20a04d823b7c3891d78ca5f6a188ccd0e4fc5e3d?x=x&amp;version=2"></a><div class="content"><a class="author">TheMatten</a><div class="metadata"><a href="#188253182" name="188253182"><div>2020-02-14 22:24:40</div></a></div><div class="text"><p>(<code>($@)</code> = <code>applyContinuation</code>)</p></div></div></div><div class="comment"><a class="avatar"><img src="https://www.gravatar.com/avatar/c03b8d34978563858020eff0d14cc17b"></a><div class="content"><a class="author">Alexis King</a><div class="metadata"><a href="#188253528" name="188253528"><div>2020-02-14 22:29:07</div></a></div><div class="text"><p>Yes: my implementation of <code>shift</code> both does <em>not</em> capture the prompt and does <em>not</em> leave the prompt behind. Using the terminology of “A monadic framework for delimited continuations” by Dybvig et al., my implementation uses the <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mrow></mrow><mo lspace="0em" rspace="0em">−</mo></msup><msup><mi mathvariant="script">F</mi><mo lspace="0em" rspace="0em">−</mo></msup></mrow><annotation encoding="application/x-tex"> {}^{-}\mathcal{F}^{-} </annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="base"><span class="strut" style="height:0.771331em;vertical-align:0em;"></span><span class="mord"><span class="mord"></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.771331em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span></span></span></span></span></span></span></span></span><span class="mord"><span class="mord"><span class="mord mathcal" style="margin-right:0.09931em;">F</span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.771331em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span></span></span></span></span></span></span></span></span></span></span></span> semantics.</p></div></div></div><div class="comment"><a class="avatar"><img src="https://www.gravatar.com/avatar/c03b8d34978563858020eff0d14cc17b"></a><div class="content"><a class="author">Alexis King</a><div class="metadata"><a href="#188253676" name="188253676"><div>2020-02-14 22:30:50</div></a></div><div class="text"><p>Strictly speaking, this is not faithful to the semantics of the traditional <code>shift</code> operator, which uses a <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mrow></mrow><mo lspace="0em" rspace="0em">+</mo></msup><msup><mi mathvariant="script">F</mi><mo lspace="0em" rspace="0em">+</mo></msup></mrow><annotation encoding="application/x-tex"> {}^{+}\mathcal{F}^{+} </annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="base"><span class="strut" style="height:0.771331em;vertical-align:0em;"></span><span class="mord"><span class="mord"></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.771331em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">+</span></span></span></span></span></span></span></span></span><span class="mord"><span class="mord"><span class="mord mathcal" style="margin-right:0.09931em;">F</span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.771331em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">+</span></span></span></span></span></span></span></span></span></span></span></span> semantics.</p></div></div></div><div class="comment"><a class="avatar"><img src="https://www.gravatar.com/avatar/c03b8d34978563858020eff0d14cc17b"></a><div class="content"><a class="author">Alexis King</a><div class="metadata"><a href="#188253806" name="188253806"><div>2020-02-14 22:32:56</div></a></div><div class="text"><p>If I were to choose names that are most accurate, the right ones would probably be <code>prompt0</code> and <code>control0</code>, which are presented in “Shift to control” by Chung-chieh Shan and also use the <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mrow></mrow><mo lspace="0em" rspace="0em">−</mo></msup><msup><mi mathvariant="script">F</mi><mo lspace="0em" rspace="0em">−</mo></msup></mrow><annotation encoding="application/x-tex"> {}^{-}\mathcal{F}^{-} </annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="base"><span class="strut" style="height:0.771331em;vertical-align:0em;"></span><span class="mord"><span class="mord"></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.771331em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span></span></span></span></span></span></span></span></span><span class="mord"><span class="mord"><span class="mord mathcal" style="margin-right:0.09931em;">F</span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.771331em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span></span></span></span></span></span></span></span></span></span></span></span> semantics.</p></div></div></div><div class="comment"><a class="avatar"><img src="https://www.gravatar.com/avatar/c03b8d34978563858020eff0d14cc17b"></a><div class="content"><a class="author">Alexis King</a><div class="metadata"><a href="#188253901" name="188253901"><div>2020-02-14 22:34:08</div></a></div><div class="text"><p>The <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mrow></mrow><mo lspace="0em" rspace="0em">−</mo></msup><msup><mi mathvariant="script">F</mi><mo lspace="0em" rspace="0em">−</mo></msup></mrow><annotation encoding="application/x-tex"> {}^{-}\mathcal{F}^{-} </annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="base"><span class="strut" style="height:0.771331em;vertical-align:0em;"></span><span class="mord"><span class="mord"></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.771331em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span></span></span></span></span></span></span></span></span><span class="mord"><span class="mord"><span class="mord mathcal" style="margin-right:0.09931em;">F</span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.771331em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span></span></span></span></span></span></span></span></span></span></span></span> semantics is desirable because you can implement <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mrow></mrow><mo lspace="0em" rspace="0em">+</mo></msup><msup><mi mathvariant="script">F</mi><mo lspace="0em" rspace="0em">−</mo></msup></mrow><annotation encoding="application/x-tex"> {}^{+}\mathcal{F}^{-} </annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="base"><span class="strut" style="height:0.771331em;vertical-align:0em;"></span><span class="mord"><span class="mord"></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.771331em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">+</span></span></span></span></span></span></span></span></span><span class="mord"><span class="mord"><span class="mord mathcal" style="margin-right:0.09931em;">F</span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.771331em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span></span></span></span></span></span></span></span></span></span></span></span>, <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mrow></mrow><mo lspace="0em" rspace="0em">−</mo></msup><msup><mi mathvariant="script">F</mi><mo lspace="0em" rspace="0em">+</mo></msup></mrow><annotation encoding="application/x-tex"> {}^{-}\mathcal{F}^{+} </annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="base"><span class="strut" style="height:0.771331em;vertical-align:0em;"></span><span class="mord"><span class="mord"></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.771331em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span></span></span></span></span></span></span></span></span><span class="mord"><span class="mord"><span class="mord mathcal" style="margin-right:0.09931em;">F</span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.771331em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">+</span></span></span></span></span></span></span></span></span></span></span></span>, and <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mrow></mrow><mo lspace="0em" rspace="0em">+</mo></msup><msup><mi mathvariant="script">F</mi><mo lspace="0em" rspace="0em">+</mo></msup></mrow><annotation encoding="application/x-tex"> {}^{+}\mathcal{F}^{+} </annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="base"><span class="strut" style="height:0.771331em;vertical-align:0em;"></span><span class="mord"><span class="mord"></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.771331em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">+</span></span></span></span></span></span></span></span></span><span class="mord"><span class="mord"><span class="mord mathcal" style="margin-right:0.09931em;">F</span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.771331em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">+</span></span></span></span></span></span></span></span></span></span></span></span> in terms of it, but the inverse is not true, so it’s a good choice for primitives.</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/20a04d823b7c3891d78ca5f6a188ccd0e4fc5e3d?x=x&amp;version=2"></a><div class="content"><a class="author">TheMatten</a><div class="metadata"><a href="#188254266" name="188254266"><div>2020-02-14 22:40:10</div></a></div><div class="text"><p>Models you mention are currently out of my mental reach, but if I understand this right, is the fact that you can use current behaviour to emulate Scheme's one again related to what <code>Eff</code>does with multiple effects?</p></div></div></div><div class="comment"><a class="avatar"><img src="https://www.gravatar.com/avatar/c03b8d34978563858020eff0d14cc17b"></a><div class="content"><a class="author">Alexis King</a><div class="metadata"><a href="#188254431" name="188254431"><div>2020-02-14 22:43:32</div></a></div><div class="text"><p>Yes. A more direct explanation is that if you want to define versions of <code>shift</code> and <code>reset</code> that are completely faithful to their usual Scheme equivalents, you can use this definition of <code>shift'</code> instead of <code>shift</code>:</p>
<div class="codehilite"><pre><span></span><span class="nf">shift&#39;</span> <span class="n">f</span> <span class="ow">=</span> <span class="n">shift</span> <span class="nf">\</span><span class="n">k</span> <span class="ow">-&gt;</span> <span class="n">reset</span> <span class="o">$</span> <span class="n">f</span> <span class="p">(</span><span class="n">reset</span> <span class="o">.</span> <span class="n">k</span><span class="p">)</span>
</pre></div></div></div></div><div class="comment"><a class="avatar"><img src="https://www.gravatar.com/avatar/c03b8d34978563858020eff0d14cc17b"></a><div class="content"><a class="author">Alexis King</a><div class="metadata"><a href="#188254567" name="188254567"><div>2020-02-14 22:45:36</div></a></div><div class="text"><p>That is, the traditional formulation of <code>shift</code> keeps the <code>reset</code> frame in place after aborting via <code>shift</code>, and it also reinstalls a new <code>reset</code> frame whenever the continuation is applied.</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/20a04d823b7c3891d78ca5f6a188ccd0e4fc5e3d?x=x&amp;version=2"></a><div class="content"><a class="author">TheMatten</a><div class="metadata"><a href="#188807035" name="188807035"><div>2020-02-22 08:33:01</div></a></div><div class="text"><p><a href="https://github.com/ghc-proposals/ghc-proposals/pull/313" target="_blank" title="https://github.com/ghc-proposals/ghc-proposals/pull/313">https://github.com/ghc-proposals/ghc-proposals/pull/313</a> <span aria-label="party ball" class="emoji emoji-1f38a" role="img" title="party ball">:party_ball:</span></p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/ghc-proposals/ghc-proposals/pull/313" style="background-image: url(https://avatars0.githubusercontent.com/u/20374637?s=400&amp;v=4)" target="_blank"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/ghc-proposals/ghc-proposals/pull/313" target="_blank" title="Delimited continuation primops by lexi-lambda · Pull Request #313 · ghc-proposals/ghc-proposals">Delimited continuation primops by lexi-lambda · Pull Request #313 · ghc-proposals/ghc-proposals</a></div><div class="message_embed_description">This is a proposal for adding primops for capturing slices of the RTS stack to improve the performance of algebraic effect systems, which require delimited continuations.
Rendered</div></div></div></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/20a04d823b7c3891d78ca5f6a188ccd0e4fc5e3d?x=x&amp;version=2"></a><div class="content"><a class="author">TheMatten</a><div class="metadata"><a href="#223140350" name="223140350"><div>2021-01-18 16:21:24</div></a></div><div class="text"><p>#313 was accepted <span aria-label="tada" class="emoji emoji-1f389" role="img" title="tada">:tada:</span></p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/7334dc60b6aef6a75cd9284126231f13c76926a5?x=x&amp;version=4"></a><div class="content"><a class="author">Torsten Schmits</a><div class="metadata"><a href="#223140375" name="223140375"><div>2021-01-18 16:21:40</div></a></div><div class="text"><p>yorp <span aria-label="clink" class="emoji emoji-1f942" role="img" title="clink">:clink:</span></p></div></div></div></div></div><div class="ui vertical footer segment"><a href="https://github.com/srid/zulip-archive">Powered by Haskell</a> | Questions? Contact <a href="https://www.srid.ca">srid</a></div></div></body></html>