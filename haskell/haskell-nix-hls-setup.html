<html lang="en"><head><meta content="text/html; charset=utf-8" http-equiv="Content-Type"><meta content="width=device-width, initial-scale=1" name="viewport"><meta content="I am trying to figure a development workflow for Haskell packages using nix, emacs, hls, lsp... 
I am struggling with the nix part and esp. setting up a nix-shell following the instructions here: https://input-output-hk.github.io/haskell.nix/tutorials/development/#how-to-get-a-development-shell 
I h" name="description"><link href="https://funprog.srid.ca/haskell/haskell-nix-hls-setup.html" rel="canonical"><meta property="og:title" content="Haskell/nix/HLS setup - Haskell"><meta property="og:site_name" content="Functional Programming Zulip Archive"><meta property="og:type" content="article"><meta property="og:article:section" content="Haskell"><meta property="og:article:modified_time" content="2021-01-20T14:18:34Z"><meta property="og:article:published_time" content="2021-01-20T13:29:25Z"><meta property="og:image" content="https://secure.gravatar.com/avatar/48469162d45686615c6bf0eb4304bf26?d=identicon&amp;version=1"><title>Haskell/nix/HLS setup - Haskell</title><style type="text/css">
div#thesite
{
  font-family   : "Open Sans", sans-serif;
  font-size     : 1em !important;
  margin-top    : 1em;
  margin-bottom : 1em;
}

div#thesite h1
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite h2
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite h3
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite h4
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite h5
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite h6
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite .ui.breadcrumb.rib .section
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite .header
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite .as-header
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite code, pre, tt
{
  font-family : "SFMono-Regular","Menlo","Monaco","Consolas","Liberation Mono","Courier New", monospace;
}

div#thesite .ui.breadcrumb.rib
{
  margin-bottom : 1em;
}



div#thesite .ui.comments.messages .comment .metadata a
{
  color : #808080;
}

div#thesite .ui.comments.messages .comment a.avatar img
{
  height : auto;
}

div#thesite .subtle
{
  color : #808080;
}


div#thesite .messages pre
{
  font-size : 85%;
  overflow  : auto;
  max-width : 100%;
}

div#thesite .messages .message_embed
{
  border-left  : solid 3px #808080;
  padding-left : 0.69999em;
}

div#thesite .messages .message_inline_image img
{
  max-width     : 100%;
  margin-bottom : 1em;
}


/* Generated with Clay, http://fvisser.nl/clay */</style><link href="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.4.1/semantic.min.css" rel="stylesheet"><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/all.min.css" rel="stylesheet"><link href="https://fonts.googleapis.com/css?family=Open+Sans|Oswald&amp;display=swap" rel="stylesheet"><link href="https://fonts.googleapis.com/css?family=Roboto|Open+Sans&amp;display=swap" rel="stylesheet"></head><body><div id="thesite" class="ui text container"><div class="ui violet inverted top attached center aligned segment"><h1 class="ui huge header">Haskell/nix/HLS setup - Haskell</h1></div><div class="ui attached segment"><div class="ui message"><p>Welcome to the Functional Programming Zulip Chat Archive. You can join the chat <a href="https://funprog.zulipchat.com">here</a>.</p></div><div class="ui breadcrumb rib"><a href="/" class="section">Home</a><i class="right angle icon divider"></i><a href="/haskell/" class="section">#Haskell</a><i class="right angle icon divider"></i><div class="active section">Haskell/nix/HLS setup</div></div><div class="ui comments messages"><div class="comment"><a class="avatar"><img src="https://secure.gravatar.com/avatar/48469162d45686615c6bf0eb4304bf26?d=identicon&amp;version=1"></a><div class="content"><a class="author">Arnaud Bailly</a><div class="metadata"><a href="#223371873" name="223371873"><div>2021-01-20 13:29:25</div></a></div><div class="text"><p>I am trying to figure a development workflow for Haskell packages using nix, emacs, hls, lsp... <br>
I am struggling with the nix part and esp. setting up a nix-shell following the instructions here: <a href="https://input-output-hk.github.io/haskell.nix/tutorials/development/#how-to-get-a-development-shell">https://input-output-hk.github.io/haskell.nix/tutorials/development/#how-to-get-a-development-shell</a> <br>
I have hoped from links to links on the internet, trying to form a clear mental picture of how those things interact but I am still pretty confused. What are resources that go beyond code snippets I could tap on?</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/7334dc60b6aef6a75cd9284126231f13c76926a5?x=x&amp;version=4"></a><div class="content"><a class="author">Torsten Schmits</a><div class="metadata"><a href="#223372455" name="223372455"><div>2021-01-20 13:35:43</div></a></div><div class="text"><p>nix is used to install dependencies.<br>
the code in you <code>default.nix</code> or <code>shell.nix</code> is supposed to use the <code>cabal2nix</code> tools to analyze your cabal files and translate it to nix packages.<br>
when you run <code>nix-shell</code>, all haskell packages are placed in the environment so that ghc can find them.</p>
<p>so if you start a shell with <code>nix-shell</code>, you can run, for example, <code>ghcid</code> and all the dependencies are there.<br>
you can use <code>nix-shell --run haskell-language-server-wrapper</code> to run a single command with the full environment, like from your emacs language server config.</p></div></div></div><div class="comment"><a class="avatar"><img src="https://secure.gravatar.com/avatar/48469162d45686615c6bf0eb4304bf26?d=identicon&amp;version=1"></a><div class="content"><a class="author">Arnaud Bailly</a><div class="metadata"><a href="#223373453" name="223373453"><div>2021-01-20 13:44:24</div></a></div><div class="text"><p>Thanks <span class="user-mention" data-user-id="260881">@Torsten Schmits</span>  I know what nix is used for and get the general idea of how to use it, but there's a lot of specific parts and details I don't get, and trying to follow the referenced link I ran into errors which I don't know how to troubleshoot. Hence my search for a detailed walkthrough.</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/7334dc60b6aef6a75cd9284126231f13c76926a5?x=x&amp;version=4"></a><div class="content"><a class="author">Torsten Schmits</a><div class="metadata"><a href="#223373542" name="223373542"><div>2021-01-20 13:45:19</div></a></div><div class="text"><p>can you provide some concrete errors?</p></div></div></div><div class="comment"><a class="avatar"><img src="https://secure.gravatar.com/avatar/48469162d45686615c6bf0eb4304bf26?d=identicon&amp;version=1"></a><div class="content"><a class="author">Arnaud Bailly</a><div class="metadata"><a href="#223373916" name="223373916"><div>2021-01-20 13:48:40</div></a></div><div class="text"><p>Sure. So what I am trying to do is take an existing non-nixified package and add the needed nix bits to 1/ build it with nix and 2/ have all the needed dev tools (HLS, ghcid, hoogle, hlint, ormolu...) set up, in order to 3/ hack happily with emacs.<br>
copy-pasting with minor adaptations the default.nix and shell.nix from <a href="https://input-output-hk.github.io/haskell.nix/tutorials/development">https://input-output-hk.github.io/haskell.nix/tutorials/development</a> tutorial, when I do <code>nix-shell</code> I run into the following error:</p>
<div class="codehilite"><pre><span></span><code>error: attribute &#39;haskell-nix&#39; missing, at /home/curry/hydra-sim/default.nix:15:4
</code></pre></div></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/7334dc60b6aef6a75cd9284126231f13c76926a5?x=x&amp;version=4"></a><div class="content"><a class="author">Torsten Schmits</a><div class="metadata"><a href="#223374444" name="223374444"><div>2021-01-20 13:53:21</div></a></div><div class="text"><p>that means either that the haskell-nix nixpkgs are broken, the tutorial is outdated or your minor adaptations changed something that causes the <code>haskell-nix</code> attribute to be absent. can you post your nix file?</p></div></div></div><div class="comment"><a class="avatar"><img src="https://secure.gravatar.com/avatar/48469162d45686615c6bf0eb4304bf26?d=identicon&amp;version=1"></a><div class="content"><a class="author">Arnaud Bailly</a><div class="metadata"><a href="#223374506" name="223374506"><div>2021-01-20 13:53:58</div></a></div><div class="text"><div class="codehilite"><pre><span></span><code>{ # Fetch the latest haskell.nix and import its default.nix
  haskellNix ? import (builtins.fetchTarball &quot;https://github.com/input-output-hk/haskell.nix/archive/master.tar.gz&quot;) {}

# haskell.nix provides access to the nixpkgs pins which are used by our CI,
# hence you will be more likely to get cache hits when using these.
# But you can also just use your own, e.g. &#39;&lt;nixpkgs&gt;&#39;.
, nixpkgsSrc ? haskellNix.sources.nixpkgs-2003

# haskell.nix provides some arguments to be passed to nixpkgs, including some
# patches and also the haskell.nix functionality itself as an overlay.
, nixpkgsArgs ? haskellNix.nixpkgsArgs

# import nixpkgs with overlays
, pkgs ? import nixpkgsSrc nixpkgsArgs
}: pkgs.haskell-nix.project {
  # &#39;cleanGit&#39; cleans a source directory based on the files known by git
  src = pkgs.haskell-nix.haskellLib.cleanGit {
    name = &quot;hydra-sim&quot;;
    src = ./.;
  };
  # Specify the GHC version to use.
  compiler-nix-name = &quot;ghc884&quot;; # Not required for `stack.yaml` based projects.
}
</code></pre></div></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/7334dc60b6aef6a75cd9284126231f13c76926a5?x=x&amp;version=4"></a><div class="content"><a class="author">Torsten Schmits</a><div class="metadata"><a href="#223374810" name="223374810"><div>2021-01-20 13:56:28</div></a></div><div class="text"><ol>
<li>do you call this file with arguments?</li>
<li>if not, does it work with <code>haskellNix.sources.nixpkgs</code>?</li>
</ol></div></div></div><div class="comment"><a class="avatar"><img src="https://secure.gravatar.com/avatar/48469162d45686615c6bf0eb4304bf26?d=identicon&amp;version=1"></a><div class="content"><a class="author">Arnaud Bailly</a><div class="metadata"><a href="#223375187" name="223375187"><div>2021-01-20 13:59:32</div></a></div><div class="text"><p>I don't even understand the question :-D<br>
What I did was:</p>
<div class="codehilite"><pre><span></span><code>nix-build -A hydra-sim.components.exes.hydra-sim
</code></pre></div>
<p>and I got a compilation failure which is probably a problem with the package I am trying to build and that I can solve.<br>
Then I tried </p>
<div class="codehilite"><pre><span></span><code>nix-shell
</code></pre></div>
<p>and got the error I mentioned.<br>
And now I am trying to run <code>nix-shell -A shellFor</code> without a <code>shell.nix</code> file and it is building a whole slew of packages and taking ages. I miss stack...</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/7334dc60b6aef6a75cd9284126231f13c76926a5?x=x&amp;version=4"></a><div class="content"><a class="author">Torsten Schmits</a><div class="metadata"><a href="#223375346" name="223375346"><div>2021-01-20 14:00:44</div></a></div><div class="text"><p>ah. can you post the <code>shell.nix</code> as well?</p></div></div></div><div class="comment"><a class="avatar"><img src="https://secure.gravatar.com/avatar/48469162d45686615c6bf0eb4304bf26?d=identicon&amp;version=1"></a><div class="content"><a class="author">Arnaud Bailly</a><div class="metadata"><a href="#223375640" name="223375640"><div>2021-01-20 14:02:53</div></a></div><div class="text"><p>Sure, here it is</p>
<div class="codehilite"><pre><span></span><code># shell.nix
{pkgs ? import &lt;nixpkgs&gt; {} }:

let
  hsPkgs = import ./default.nix { inherit pkgs; };
  haskellNix = import (builtins.fetchTarball https://github.com/input-output-hk/haskell.nix/archive/master.tar.gz) {};
in
  hsPkgs.shellFor {
    # Include only the *local* packages of your project.
    packages = ps: with ps; [
      hydra-sim
    ];

    # Builds a Hoogle documentation index of all dependencies,
    # and provides a &quot;hoogle&quot; command to search the index.
#    withHoogle = true;

    # You might want some extra tools in the shell (optional).

    # Some common tools can be added with the `tools` argument
    tools = { cabal = &quot;3.2.0.0&quot;; hlint = &quot;2.2.11&quot;; };
    # See overlays/tools.nix for more details

    # Some you may need to get some other way.
    buildInputs = with pkgs.haskellPackages;
      [ ghcid
        # (haskell-language-server.override { supportedGhcVersions = [ &quot;884&quot; &quot;8102&quot; ]; })
      ];



    # Prevents cabal from choosing alternate plans, so that
    # *all* dependencies are provided by Nix.
    exactDeps = true;
  }
</code></pre></div>
<p>I tried adding stuff for HLS but commented it out for now</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/7334dc60b6aef6a75cd9284126231f13c76926a5?x=x&amp;version=4"></a><div class="content"><a class="author">Torsten Schmits</a><div class="metadata"><a href="#223375970" name="223375970"><div>2021-01-20 14:05:28</div></a></div><div class="text"><div class="codehilite"><pre><span></span><code>{pkgs ? import &lt;nixpkgs&gt; {} }:
</code></pre></div>
<p>the problem is this, which you pass on to <code>default.nix</code>, overriding the default (after the <code>?</code>) there. that replaces the nixpkgs from haskell-nix with the system default.</p>
<p>change it to</p>
<div class="codehilite" data-code-language="Nix"><pre><span></span><code><span class="ss">hsPkgs =</span> <span class="nb">import</span> <span class="o">.</span><span class="l">/default.nix</span> <span class="p">{};</span>
</code></pre></div>
<p>and it should be fine.</p></div></div></div><div class="comment"><a class="avatar"><img src="https://secure.gravatar.com/avatar/48469162d45686615c6bf0eb4304bf26?d=identicon&amp;version=1"></a><div class="content"><a class="author">Arnaud Bailly</a><div class="metadata"><a href="#223376406" name="223376406"><div>2021-01-20 14:09:24</div></a></div><div class="text"><p>I have this line  inside the <code>let</code> block so I assume you meant I should simply remove the declaration? But then when I do that, I got another error:</p>
<div class="codehilite"><pre><span></span><code>error: undefined variable &#39;pkgs&#39; at /home/curry/hydra-sim/shell.nix:23:24
</code></pre></div></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/7334dc60b6aef6a75cd9284126231f13c76926a5?x=x&amp;version=4"></a><div class="content"><a class="author">Torsten Schmits</a><div class="metadata"><a href="#223376677" name="223376677"><div>2021-01-20 14:11:58</div></a></div><div class="text"><p>no, no line to remove. just don't pass <code>pkgs</code> on to the import of <code>default.nix</code>.<br>
and I don't see where you use <code>pkgs</code> in <code>shell.nix:23</code></p></div></div></div><div class="comment"><a class="avatar"><img src="https://secure.gravatar.com/avatar/48469162d45686615c6bf0eb4304bf26?d=identicon&amp;version=1"></a><div class="content"><a class="author">Arnaud Bailly</a><div class="metadata"><a href="#223377321" name="223377321"><div>2021-01-20 14:17:04</div></a></div><div class="text"><p>Ah I see. It's used for <code>buildInputs</code></p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/7334dc60b6aef6a75cd9284126231f13c76926a5?x=x&amp;version=4"></a><div class="content"><a class="author">Torsten Schmits</a><div class="metadata"><a href="#223377474" name="223377474"><div>2021-01-20 14:18:09</div></a></div><div class="text"><p>ah, yes</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/7334dc60b6aef6a75cd9284126231f13c76926a5?x=x&amp;version=4"></a><div class="content"><a class="author">Torsten Schmits</a><div class="metadata"><a href="#223377513" name="223377513"><div>2021-01-20 14:18:34</div></a></div><div class="text"><p>then you would have to use <code>hsPkgs</code> there too</p></div></div></div></div></div><div class="ui vertical footer segment"><a href="https://github.com/srid/zulip-archive">Powered by Haskell</a> | Questions? Contact <a href="https://www.srid.ca">srid</a></div></div></body></html>