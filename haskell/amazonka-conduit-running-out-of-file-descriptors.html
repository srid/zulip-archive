<html lang="en"><head><meta content="text/html; charset=utf-8" http-equiv="Content-Type"><meta content="width=device-width, initial-scale=1" name="viewport"><meta content="I&#39;ve run into a problem with running out of file descriptors. The following snippet is a trimmed down version of what I&#39;m doing:
main :: IO ()
main = do
  awsEnv &lt;- newEnv Discover
  runAWSCond awsEnv $
    sqsSource queueUrl
      .| C.mapC snd
      .| sqsDeleteSink queueUrl
  where
    runAWSCond" name="description"><link href="https://funprog.srid.ca/haskell/amazonka-conduit-running-out-of-file-descriptors.html" rel="canonical"><meta property="og:title" content="Amazonka/Conduit, running out of file descriptors - Haskell"><meta property="og:site_name" content="Functional Programming Zulip Archive"><meta property="og:type" content="article"><meta property="og:article:section" content="Haskell"><meta property="og:article:modified_time" content="2020-11-28T08:24:50Z"><meta property="og:article:published_time" content="2020-11-26T22:17:38Z"><meta property="og:image" content="https://secure.gravatar.com/avatar/ca2e2c3442a73f84394abb35d6236b12?d=identicon&amp;version=1"><title>Amazonka/Conduit, running out of file descriptors - Haskell</title><style type="text/css">
div#thesite
{
  font-family   : "Open Sans", sans-serif;
  font-size     : 1em !important;
  margin-top    : 1em;
  margin-bottom : 1em;
}

div#thesite h1
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite h2
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite h3
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite h4
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite h5
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite h6
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite .ui.breadcrumb.rib .section
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite .header
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite .as-header
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite code, pre, tt
{
  font-family : "SFMono-Regular","Menlo","Monaco","Consolas","Liberation Mono","Courier New", monospace;
}

div#thesite .ui.breadcrumb.rib
{
  margin-bottom : 1em;
}



div#thesite .ui.comments.messages .comment .metadata a
{
  color : #808080;
}

div#thesite .ui.comments.messages .comment a.avatar img
{
  height : auto;
}

div#thesite .subtle
{
  color : #808080;
}


div#thesite .messages pre
{
  font-size : 85%;
  overflow  : auto;
  max-width : 100%;
}

div#thesite .messages .message_embed
{
  border-left  : solid 3px #808080;
  padding-left : 0.69999em;
}

div#thesite .messages .message_inline_image img
{
  max-width     : 100%;
  margin-bottom : 1em;
}


/* Generated with Clay, http://fvisser.nl/clay */</style><link href="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.4.1/semantic.min.css" rel="stylesheet"><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/all.min.css" rel="stylesheet"><link href="https://fonts.googleapis.com/css?family=Open+Sans|Oswald&amp;display=swap" rel="stylesheet"><link href="https://fonts.googleapis.com/css?family=Roboto|Open+Sans&amp;display=swap" rel="stylesheet"></head><body><div id="thesite" class="ui text container"><div class="ui violet inverted top attached center aligned segment"><h1 class="ui huge header">Amazonka/Conduit, running out of file descriptors - Haskell</h1></div><div class="ui attached segment"><div class="ui message"><p>Welcome to the Functional Programming Zulip Chat Archive. You can join the chat <a href="https://funprog.zulipchat.com">here</a>.</p></div><div class="ui breadcrumb rib"><a href="/" class="section">Home</a><i class="right angle icon divider"></i><a href="/haskell/" class="section">#Haskell</a><i class="right angle icon divider"></i><div class="active section">Amazonka/Conduit, running out of file descriptors</div></div><div class="ui comments messages"><div class="comment"><a class="avatar"><img src="https://secure.gravatar.com/avatar/ca2e2c3442a73f84394abb35d6236b12?d=identicon&amp;version=1"></a><div class="content"><a class="author">Magnus Therning</a><div class="metadata"><a href="#218042049" name="218042049"><div>2020-11-26 22:17:38</div></a></div><div class="text"><p>I've run into a problem with running out of file descriptors. The following snippet is a trimmed down version of what I'm doing:</p>
<div class="codehilite"><pre><span></span><code>main :: IO ()
main = do
  awsEnv &lt;- newEnv Discover
  runAWSCond awsEnv $
    sqsSource queueUrl
      .| C.mapC snd
      .| sqsDeleteSink queueUrl
  where
    runAWSCond awsEnv = runResourceT . runAWS awsEnv . within Frankfurt . C.runConduit

sqsSource :: MonadAWS m =&gt; T.Text -&gt; C.ConduitT () (T.Text, T.Text) m ()
sqsSource queueUrl = do
  (_, msgs) &lt;- C.lift $ recvSQS queueUrl
  C.yieldMany msgs
  sqsSource queueUrl

sqsDeleteSink :: MonadAWS m =&gt; T.Text -&gt; C.ConduitT T.Text o m ()
sqsDeleteSink queueUrl = do
  C.await &gt;&gt;= \case
    Nothing -&gt; pure ()
    Just receiptHandle -&gt; do
      void $ C.lift $ delSQS queueUrl receiptHandle
      sqsDeleteSink queueUrl

recvSQS queueUrl = do
  let rm = receiveMessage queueUrl &amp; rmMaxNumberOfMessages ?~ 10
  rmrs &lt;- send rm
  let status = rmrs ^. rmrsResponseStatus
      msgs = rmrs ^. rmrsMessages &amp; traversed %~ extract
  pure (status, catMaybes msgs)
  where
    extract msg = do
      body &lt;- msg ^. mBody
      rh &lt;- msg ^. mReceiptHandle
      pure (body, rh)

delSQS queueUrl receiptHandle = do
  let dm = deleteMessage queueUrl receiptHandle
  send dm
</code></pre></div>
<p>This works fine for a while, but given a queue with enough messages it will fail with something like</p>
<div class="codehilite"><pre><span></span><code>TransportError (HttpExceptionRequest Request {
  host                 = &quot;sqs.eu-central-1.amazonaws.com&quot;
  port                 = 443
  secure               = True
  requestHeaders       = [(&quot;Host&quot;,&quot;sqs.eu-central-1.amazonaws.com&quot;),(&quot;X-Amz-Date&quot;,&quot;20201126T101659Z&quot;),(&quot;X-Amz-Content-SHA256&quot;,&quot;2e4bdf20a857a1416f218b1218670cf019ff53268d0adb34fe06402a62f3271d&quot;),(&quot;Content-Type&quot;,&quot;application/x-www-form-urlencoded; charset=utf-8&quot;),(&quot;Authorization&quot;,&quot;&lt;REDACTED&gt;&quot;)]
  path                 = &quot;/&quot;
  queryString          = &quot;&quot;
  method               = &quot;POST&quot;
  proxy                = Nothing
  rawBody              = False
  redirectCount        = 0
  responseTimeout      = ResponseTimeoutMicro 70000000
  requestVersion       = HTTP/1.1
}
 (ConnectionFailure Network.Socket.getAddrInfo (called with preferred socket type/protocol: AddrInfo {addrFlags = [AI_ADDRCONFIG], addrFamily = AF_UNSPEC, addrSocketType = Stream, addrProtocol = 0, addrAddress = &lt;assumed to be undefined&gt;, addrCanonName = &lt;assumed to be undefined&gt;}, host name: Just &quot;sqs.eu-central-1.amazonaws.com&quot;, service name: Just &quot;443&quot;): does not exist (System error)))
</code></pre></div>
<p>After some detours I found out that it's actually not a network issue, but rather that the process runs out of file descriptors. Using <code>lsof</code> I can see that it doesn't seem to close /any/ sockets at all, instead they get stuck in a <code>CLOSE_WAIT</code> state:</p>
<div class="codehilite"><pre><span></span><code>COMMAND    PID   USER   FD   TYPE DEVICE SIZE/OFF NODE NAME
wd-stats 88674 magnus   23u  IPv4 815196      0t0  TCP ip-192-168-0-9.eu-central-1.compute.internal:60624-&gt;52.119.188.213:https (CLOSE_WAIT)
wd-stats 88674 magnus   24u  IPv4 811362      0t0  TCP ip-192-168-0-9.eu-central-1.compute.internal:43482-&gt;52.119.189.184:https (CLOSE_WAIT)
wd-stats 88674 magnus   25u  IPv4 811386      0t0  TCP ip-192-168-0-9.eu-central-1.compute.internal:60628-&gt;52.119.188.213:https (CLOSE_WAIT)
wd-stats 88674 magnus   26u  IPv4 813527      0t0  TCP ip-192-168-0-9.eu-central-1.compute.internal:43486-&gt;52.119.189.184:https (CLOSE_WAIT)
...
</code></pre></div>
<p>Am I using Amazonka and/or Conduit in a way that results in this? How should I use them?</p>
<p>Or, is it an issue somewhere "below" my code? What can I do address that?</p></div></div></div><div class="comment"><a class="avatar"><img src="https://secure.gravatar.com/avatar/ca2e2c3442a73f84394abb35d6236b12?d=identicon&amp;version=1"></a><div class="content"><a class="author">Magnus Therning</a><div class="metadata"><a href="#218061056" name="218061056"><div>2020-11-27 06:51:27</div></a></div><div class="text"><p>I just remembered that I read something that could be related to this, a blog post about a race condition on Linux. IIRC the author used BPF to instrument the kernel in order to find the cause. Maybe someone here has read the same post?</p></div></div></div><div class="comment"><a class="avatar"><img src="https://secure.gravatar.com/avatar/ca2e2c3442a73f84394abb35d6236b12?d=identicon&amp;version=1"></a><div class="content"><a class="author">Magnus Therning</a><div class="metadata"><a href="#218154335" name="218154335"><div>2020-11-28 08:24:50</div></a></div><div class="text"><p>Another night's sleep and something occurred to me, I actually have some Amazonka/Conduit code that _doesn't_ leak FDs that way. So now there's  the <a href="https://github.com/brendanhay/amazonka/issues/608">PR brendanhay/amazonka#608</a>.</p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/brendanhay/amazonka/issues/608" style="background-image: url(https://avatars0.githubusercontent.com/u/4493?s=400&amp;v=4)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/brendanhay/amazonka/issues/608" title="Sometimes `send` fails to close sockets Â· Issue #608 Â· brendanhay/amazonka">Sometimes `send` fails to close sockets Â· Issue #608 Â· brendanhay/amazonka</a></div><div class="message_embed_description">I&#39;ve run into a problem with running out of file descriptors. I suspect that use of Network.AWS.Response.receiveNull results in the program not closing sockets properly. The following snippet i...</div></div></div></div></div></div></div></div><div class="ui vertical footer segment"><a href="https://github.com/srid/zulip-archive">Powered by Haskell</a></div></div></body></html>