<html lang="en"><head><meta content="text/html; charset=utf-8" http-equiv="Content-Type"><meta content="width=device-width, initial-scale=1" name="viewport"><meta content="I&#39;ve posted this on the nix discourse at https://discourse.nixos.org/t/buildgomodule-with-local-src-inconsistent-vendoring/8641 as well, but sometimes the crowd here is a bit quicker :grinning: 
Based on the post Use buildGoModule with local src I put together the following expression:
  thePkg = bu" name="description"><link href="https://funprog.srid.ca/nix/buildgomodule-and-vendoring.html" rel="canonical"><meta property="og:title" content="buildGoModule and vendoring - Nix"><meta property="og:site_name" content="Functional Programming Zulip Archive"><meta property="og:type" content="article"><meta property="og:article:section" content="Nix"><meta property="og:article:modified_time" content="2020-08-27T05:13:35Z"><meta property="og:article:published_time" content="2020-08-19T12:54:30Z"><meta property="og:image" content="https://secure.gravatar.com/avatar/ca2e2c3442a73f84394abb35d6236b12?d=identicon&amp;version=1"><title>buildGoModule and vendoring - Nix</title><style type="text/css">
div#thesite
{
  font-family   : "Open Sans", sans-serif;
  font-size     : 1em !important;
  margin-top    : 1em;
  margin-bottom : 1em;
}

div#thesite h1
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite h2
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite h3
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite h4
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite h5
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite h6
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite .ui.breadcrumb.rib .section
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite .header
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite .as-header
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite code, pre, tt
{
  font-family : "SFMono-Regular","Menlo","Monaco","Consolas","Liberation Mono","Courier New", monospace;
}

div#thesite .ui.breadcrumb.rib
{
  margin-bottom : 1em;
}



div#thesite .ui.comments.messages .comment .metadata a
{
  color : #808080;
}

div#thesite .ui.comments.messages .comment a.avatar img
{
  height : auto;
}

div#thesite .subtle
{
  color : #808080;
}


div#thesite .messages pre
{
  font-size : 85%;
  overflow  : auto;
  max-width : 100%;
}

div#thesite .messages .message_embed
{
  border-left  : solid 3px #808080;
  padding-left : 0.69999em;
}

div#thesite .messages .message_inline_image img
{
  max-width     : 100%;
  margin-bottom : 1em;
}


/* Generated with Clay, http://fvisser.nl/clay */</style><link href="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.4.1/semantic.min.css" rel="stylesheet"><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/all.min.css" rel="stylesheet"><link href="https://fonts.googleapis.com/css?family=Open+Sans|Oswald&amp;display=swap" rel="stylesheet"><link href="https://fonts.googleapis.com/css?family=Roboto|Open+Sans&amp;display=swap" rel="stylesheet"></head><body><div id="thesite" class="ui text container"><div class="ui violet inverted top attached center aligned segment"><h1 class="ui huge header">buildGoModule and vendoring - Nix</h1></div><div class="ui attached segment"><div class="ui message"><p>Welcome to the Functional Programming Zulip Chat Archive. You can join the chat <a href="https://funprog.zulipchat.com">here</a>.</p></div><div class="ui breadcrumb rib"><a href="/" class="section">Home</a><i class="right angle icon divider"></i><a href="/nix/" class="section">#Nix</a><i class="right angle icon divider"></i><div class="active section">buildGoModule and vendoring</div></div><div class="ui comments messages"><div class="comment"><a class="avatar"><img src="https://secure.gravatar.com/avatar/ca2e2c3442a73f84394abb35d6236b12?d=identicon&amp;version=1"></a><div class="content"><a class="author">Magnus Therning</a><div class="metadata"><a href="#207403201" name="207403201"><div>2020-08-19 12:54:30</div></a></div><div class="text"><p>I've posted this on the nix discourse at <a href="https://discourse.nixos.org/t/buildgomodule-with-local-src-inconsistent-vendoring/8641">https://discourse.nixos.org/t/buildgomodule-with-local-src-inconsistent-vendoring/8641</a> as well, but sometimes the crowd here is a bit quicker <span aria-label="grinning" class="emoji emoji-1f600" role="img" title="grinning">:grinning:</span> </p>
<p>Based on the post <a href="https://discourse.nixos.org/t/use-buildgomodule-with-local-src/6998">Use buildGoModule with local src</a> I put together the following expression:</p>
<div class="codehilite"><pre><span></span><code>  thePkg = buildGoModule {
    pname = &quot;mypkg&quot;;
    version = &quot;0.0.1&quot;;
    src = lib.cleanSource ./.;
    vendorSha256 = sha256:0sjjj9z1dhilhpc8pq4154czrb79z9cm044jvn75kxcjv6v5l2m5;
  };
</code></pre></div>


<p>That worked when I first started out. Then I had no required packages in <code>go.mod</code>, no <code>go.sum</code>, no internal package, just a  <code>cmd/my-tool/main.go</code>, ... yes, it was pretty much a "Hello, World!" package.</p>
<p>Then I added code, a couple of internal packages (in <code>internal/...</code>) and some dependencies to <code>go.mod</code>, which of course resulted in a <code>go.sum</code> file. By now the expression above have stopped working, and I get the following output when I try to build:</p>
<div class="codehilite"><pre><span></span><code>nix-build --attr pkg
these derivations will be built:
  /nix/store/blhlxnn2fvahpvn4ascyi2wcxznj8iiv-mypkg-0.0.1.drv
building &#39;/nix/store/blhlxnn2fvahpvn4ascyi2wcxznj8iiv-mypkg-0.0.1.drv&#39;...
unpacking sources
unpacking source archive /nix/store/24bshfm5i0wpixrr9avigispybwvzr9f-source
source root is source
patching sources
configuring
building
Building subPackage ./cmd/my-tool
go: inconsistent vendoring in /build/source:
        github.com/beevik/etree@v1.1.0: is explicitly required in go.mod, but not marked as explicit in vendor/modules.txt
        github.com/golang-migrate/migrate/v4@v4.12.2: is explicitly required in go.mod, but not marked as explicit in vendor/modules.txt
        github.com/rs/zerolog@v1.19.0: is explicitly required in go.mod, but not marked as explicit in vendor/modules.txt
        github.com/google/uuid@v1.1.1: is explicitly required in go.mod, but not marked as explicit in vendor/modules.txt
        github.com/lib/pq@v1.8.0: is explicitly required in go.mod, but not marked as explicit in vendor/modules.txt

run &#39;go mod vendor&#39; to sync, or use -mod=mod or -mod=readonly to ignore the vendor directory
builder for &#39;/nix/store/blhlxnn2fvahpvn4ascyi2wcxznj8iiv-mypkg-0.0.1.drv&#39; failed with exit code 1
</code></pre></div>


<p>I'm not really sure what I can do about it. Running <code>go mod vendor</code> manually doesn't help (I didn't really expect it to either).</p>
<p>Any help would be much appreciated.</p>
<div class="message_embed"><a class="message_embed_image" href="https://discourse.nixos.org/t/buildgomodule-with-local-src-inconsistent-vendoring/8641" style="background-image: url(https://aws1.discourse-cdn.com/standard14/uploads/nixos1/original/1X/9d278415294337993f871f958d77b080670f494b.png)"></a><div class="data-container"><div class="message_embed_title"><a href="https://discourse.nixos.org/t/buildgomodule-with-local-src-inconsistent-vendoring/8641" title="buildGoModule with local src: inconsistent vendoring">buildGoModule with local src: inconsistent vendoring</a></div><div class="message_embed_description">Based on the post Use buildGoModule with local src I put together the following expression:    thePkg = buildGoModule {     pname = "mypkg";     version = "0.0.1";     src = lib.cleanSource ./.;     vendorSha256 = sha256:0sjjj9z1dhilhpc8pq4154czrb79z9cm044jvn75kxcjv6v5l2m5;   };  That worked when I first started out. Then I had no required packages in go.mod, no go.sum, no internal package, just a  cmd/my-tool/main.go, … yes, it was pretty much a “Hello, World!” package.  Then I added code, a co...</div></div></div><div class="message_embed"><a class="message_embed_image" href="https://discourse.nixos.org/t/use-buildgomodule-with-local-src/6998" style="background-image: url(https://aws1.discourse-cdn.com/standard14/uploads/nixos1/original/1X/9d278415294337993f871f958d77b080670f494b.png)"></a><div class="data-container"><div class="message_embed_title"><a href="https://discourse.nixos.org/t/use-buildgomodule-with-local-src/6998" title="Use buildGoModule with local src">Use buildGoModule with local src</a></div><div class="message_embed_description">This may be an extremely stupid question but all the examples for buildGoModule use fetchFromGitHub. But I just want to do something like in this blog post which is using buildGoPackage. So I wrote the below code  { pkgs ? (import ./nixpkgs.nix ) }:  with pkgs;  buildGoModule rec {   pname = "fbrs-blog";   version = "latest";    modSha256 = lib.fakeSha256;    src = "../go/"; }  which fails with  unpacking source archive ../go/ do not know how to unpack source archive ../go/  I looked at the sour...</div></div></div></div></div></div><div class="comment"><a class="avatar"><img src="https://secure.gravatar.com/avatar/ca2e2c3442a73f84394abb35d6236b12?d=identicon&amp;version=1"></a><div class="content"><a class="author">Magnus Therning</a><div class="metadata"><a href="#208178898" name="208178898"><div>2020-08-27 05:13:35</div></a></div><div class="text"><p>I found out the cause, and also solution to the above issue. Posted it in the the Nix discourse, so if you follow the link above you'll find it.</p></div></div></div></div></div><div class="ui vertical footer segment"><a href="https://github.com/srid/zulip-archive">Powered by Haskell</a></div></div></body></html>