<html lang="en"><head><meta content="text/html; charset=utf-8" http-equiv="Content-Type"><meta content="width=device-width, initial-scale=1" name="viewport"><meta content="(I posted this on the Nix discourse too: https://discourse.nixos.org/t/hiding-a-haskell-package)
I&#39;m the developer of two related Haskell packages, _sandi_ and _omnicodec_.
My rather naïve first attempt to use Nix to build them both is this
with (import &lt;nixpkgs&gt; {});

let
  t = lib.trivial;
  hl = " name="description"><link href="https://funprog.srid.ca/nix/hiding-an-upstream-haskell-package.html" rel="canonical"><meta property="og:title" content="Hiding an upstream Haskell package - Nix"><meta property="og:site_name" content="Functional Programming Zulip Archive"><meta property="og:type" content="article"><meta property="og:article:section" content="Nix"><meta property="og:article:modified_time" content="2019-12-07T10:34:46Z"><meta property="og:article:published_time" content="2019-12-07T09:00:51Z"><title>Hiding an upstream Haskell package - Nix</title><style type="text/css">
div#thesite
{
  font-family   : "Open Sans", sans-serif;
  font-size     : 1em !important;
  margin-top    : 1em;
  margin-bottom : 1em;
}

div#thesite h1
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite h2
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite h3
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite h4
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite h5
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite h6
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite .ui.breadcrumb.rib .section
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite .header
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite .as-header
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite code, pre, tt
{
  font-family : "SFMono-Regular","Menlo","Monaco","Consolas","Liberation Mono","Courier New", monospace;
}

div#thesite .ui.breadcrumb.rib
{
  margin-bottom : 1em;
}



div#thesite .ui.comments.messages .comment .metadata a
{
  color : #808080;
}

div#thesite .ui.comments.messages .comment a.avatar img
{
  height : auto;
}

div#thesite .subtle
{
  color : #808080;
}


div#thesite .messages pre
{
  font-size : 85%;
  overflow  : auto;
  max-width : 100%;
}

div#thesite .messages .message_embed
{
  border-left  : solid 3px #808080;
  padding-left : 0.69999em;
}

div#thesite .messages .message_inline_image img
{
  max-width     : 100%;
  margin-bottom : 1em;
}


/* Generated with Clay, http://fvisser.nl/clay */</style><link href="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.4.1/semantic.min.css" rel="stylesheet"><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/all.min.css" rel="stylesheet"><link href="https://fonts.googleapis.com/css?family=Open+Sans|Oswald&amp;display=swap" rel="stylesheet"><link href="https://fonts.googleapis.com/css?family=Roboto|Open+Sans&amp;display=swap" rel="stylesheet"></head><body><div id="thesite" class="ui text container"><div class="ui violet inverted top attached center aligned segment"><h1 class="ui huge header">Hiding an upstream Haskell package - Nix</h1></div><div class="ui attached segment"><div class="ui message"><p>Welcome to the Functional Programming Zulip Chat Archive. You can join the chat <a href="https://funprog.zulipchat.com">here</a>.</p></div><div class="ui breadcrumb rib"><a href="/" class="section">Home</a><i class="right angle icon divider"></i><a href="/nix/" class="section">#Nix</a><i class="right angle icon divider"></i><div class="active section">Hiding an upstream Haskell package</div></div><div class="ui comments messages"><div class="comment"><a class="avatar"><img src="https://www.gravatar.com/avatar/ca2e2c3442a73f84394abb35d6236b12"></a><div class="content"><a class="author">Magnus Therning</a><div class="metadata"><a href="#182836122" name="182836122"><div>2019-12-07 09:00:51</div></a></div><div class="text"><p>(I posted this on the Nix discourse too: <a href="https://discourse.nixos.org/t/hiding-a-haskell-package" target="_blank" title="https://discourse.nixos.org/t/hiding-a-haskell-package">https://discourse.nixos.org/t/hiding-a-haskell-package</a>)</p>
<p>I'm the developer of two related Haskell packages, _sandi_ and _omnicodec_.</p>
<p>My rather naïve first attempt to use Nix to build them both is this</p>
<div class="codehilite"><pre><span></span>with (import &lt;nixpkgs&gt; {});

let
  t = lib.trivial;
  hl = haskell.lib;

  addBuildTools = (t.flip hl.addBuildTools) [haskellPackages.cabal-install];

  sandiPkg = haskellPackages.developPackage {
    root = ./sandi;

    modifier = (t.flip t.pipe)
      [addBuildTools];
  };

  omnicodecPkg = haskellPackages.developPackage {
    root = ./omnicodec;

    modifier = (t.flip t.pipe)
      [addBuildTools];
  };

in {
  sandi = sandiPkg;
  omnicodec = omnicodecPkg;
}
</pre></div>


<p>It does work, but one thing I noticed is that since _sandi_ is packaged in <code>nixpkgs</code> it's the upstream package that's used rather than the local development version.</p>
<p>How do I go about forcing the build of _omnicodec_ to use the local _sandi_ instead of the one in <code>nixpkgs</code>?</p>
<div class="message_embed"><a class="message_embed_image" href="https://discourse.nixos.org/t/hiding-a-haskell-package" style="background-image: url(https://aws1.discourse-cdn.com/standard14/uploads/nixos1/original/1X/9d278415294337993f871f958d77b080670f494b.png)" target="_blank"></a><div class="data-container"><div class="message_embed_title"><a href="https://discourse.nixos.org/t/hiding-a-haskell-package" target="_blank" title="Hiding a (Haskell) package">Hiding a (Haskell) package</a></div><div class="message_embed_description">I’m the developer of two related Haskell packages, sandi and omnicodec.  My rather naïve first attempt to use Nix to build them both is this  with (import &lt;nixpkgs&gt; {});  let   t = lib.trivial;   hl = haskell.lib;    addBuildTools = (t.flip hl.addBuildTools) [haskellPackages.cabal-install];    sandiPkg = haskellPackages.developPackage {     root = ./sandi;      modifier = (t.flip t.pipe)       [addBuildTools];   };    omnicodecPkg = haskellPackages.developPackage {     root = ./omnicodec;      m...</div></div></div></div></div></div><div class="comment"><a class="avatar"><img src="https://www.gravatar.com/avatar/a3a40b5b547344370d45ad0f805b4d81"></a><div class="content"><a class="author">Ben Kolera</a><div class="metadata"><a href="#182837017" name="182837017"><div>2019-12-07 09:26:28</div></a></div><div class="text"><p>One big note: the <code>import &lt;nixpkgs&gt;</code> is a big red flag. You don't get any reproducibility that way because the build is then dependent on the nix-channel of the machine.</p></div></div></div><div class="comment"><a class="avatar"><img src="https://www.gravatar.com/avatar/a3a40b5b547344370d45ad0f805b4d81"></a><div class="content"><a class="author">Ben Kolera</a><div class="metadata"><a href="#182837026" name="182837026"><div>2019-12-07 09:27:06</div></a></div><div class="text"><p>You could override sandi in the haskell packages that you use to build omnicodec.</p></div></div></div><div class="comment"><a class="avatar"><img src="https://www.gravatar.com/avatar/a3a40b5b547344370d45ad0f805b4d81"></a><div class="content"><a class="author">Ben Kolera</a><div class="metadata"><a href="#182837048" name="182837048"><div>2019-12-07 09:28:00</div></a></div><div class="text"><p>But this kind of hierarchy of nix doesn't scale too well, I find. Especially once you start needing overrides around the place wrt nixpkgs.</p></div></div></div><div class="comment"><a class="avatar"><img src="https://www.gravatar.com/avatar/a3a40b5b547344370d45ad0f805b4d81"></a><div class="content"><a class="author">Ben Kolera</a><div class="metadata"><a href="#182837228" name="182837228"><div>2019-12-07 09:32:52</div></a></div><div class="text"><p>See <a href="https://stackoverflow.com/questions/56414329/how-do-i-override-a-haskell-package-with-a-git-local-package-with-nix-when-usi" target="_blank" title="https://stackoverflow.com/questions/56414329/how-do-i-override-a-haskell-package-with-a-git-local-package-with-nix-when-usi">https://stackoverflow.com/questions/56414329/how-do-i-override-a-haskell-package-with-a-git-local-package-with-nix-when-usi</a>  for an example that should help! <span aria-label="slight smile" class="emoji emoji-1f642" role="img" title="slight smile">:slight_smile:</span></p>
<div class="message_embed"><a class="message_embed_image" href="https://stackoverflow.com/questions/56414329/how-do-i-override-a-haskell-package-with-a-git-local-package-with-nix-when-usi" style="background-image: url(https://cdn.sstatic.net/Sites/stackoverflow/img/apple-touch-icon@2.png?v=73d79a89bded)" target="_blank"></a><div class="data-container"><div class="message_embed_title"><a href="https://stackoverflow.com/questions/56414329/how-do-i-override-a-haskell-package-with-a-git-local-package-with-nix-when-usi" target="_blank" title="How do I override a Haskell package with a git / local package with Nix when using callPackage?">How do I override a Haskell package with a git / local package with Nix when using callPackage?</a></div><div class="message_embed_description">Essentially I'm using this:

default.nix

{ nixpkgs ? import &lt;nixpkgs&gt; {}, compiler ? "ghc864" }:
nixpkgs.pkgs.haskell.packages.${compiler}.callPackage ./gitchapter.nix { }
gitchapter.nix

{ </div></div></div></div></div></div><div class="comment"><a class="avatar"><img src="https://www.gravatar.com/avatar/ca2e2c3442a73f84394abb35d6236b12"></a><div class="content"><a class="author">Magnus Therning</a><div class="metadata"><a href="#182839168" name="182839168"><div>2019-12-07 10:30:31</div></a></div><div class="text"><p>Thanks, that SO question unlocked it for me. I ended up with the following setup:</p>
<div class="codehilite"><pre><span></span>  sandiPkg = haskellPackages.developPackage {
    root = ./sandi;

    modifier = (t.flip t.pipe)
      [addBuildTools];
  };

  myHaskellPackages = pkgs.haskell.packages.ghc865.override {
    overrides = self: super: rec {
      sandi = sandiPkg;
    };
  };

  omnicodecPkg = myHaskellPackages.developPackage {
    root = ./omnicodec;

    modifier = (t.flip t.pipe)
      [addBuildTools];
  };
</pre></div>


<p>Which seems to work the way I want.</p>
<p>Any suggestions for improvements? (Now it's time to worry about things like re-producability <span aria-label="grinning" class="emoji emoji-1f600" role="img" title="grinning">:grinning:</span> )</p></div></div></div><div class="comment"><a class="avatar"><img src="https://www.gravatar.com/avatar/a3a40b5b547344370d45ad0f805b4d81"></a><div class="content"><a class="author">Ben Kolera</a><div class="metadata"><a href="#182839281" name="182839281"><div>2019-12-07 10:34:46</div></a></div><div class="text"><p>Nah, no other feedback. I just see too many people go to all the trouble of nix and not pin nixpkgs and actually don't get reproducablity. I want to save everyone from this sadness because nix is rad. <span aria-label="slight smile" class="emoji emoji-1f642" role="img" title="slight smile">:slight_smile:</span></p></div></div></div></div></div><div class="ui vertical footer segment"><a href="https://github.com/srid/zulip-archive">Powered by Haskell</a> | Questions? Contact <a href="https://www.srid.ca">srid</a></div></div></body></html>