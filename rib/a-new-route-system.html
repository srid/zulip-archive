<html lang="en"><head><meta content="text/html; charset=utf-8" http-equiv="Content-Type"><meta content="width=device-width, initial-scale=1" name="viewport"><meta content="I&#39;m loving Rib so far! 
But I have found the routing system a little confusing, and it does not really help with the biggest problem in 
static site generation (IMHO): broken links.
So I wrote a small mock up of a more type-safe version:
https://github.com/kalhauge/rib-sample/commit/add34d528ed8dd47" name="description"><link href="https://funprog.srid.ca/rib/a-new-route-system.html" rel="canonical"><meta property="og:title" content="A new Route System? - Rib"><meta property="og:site_name" content="Functional Programming Zulip Archive"><meta property="og:type" content="article"><meta property="og:article:section" content="Rib"><meta property="og:article:modified_time" content="2020-04-18T21:32:12Z"><meta property="og:article:published_time" content="2020-04-17T15:48:17Z"><meta property="og:image" content="https://secure.gravatar.com/avatar/82ab26323f4fd06d4556f0132f85a3f1?d=identicon&amp;version=1"><title>A new Route System? - Rib</title><style type="text/css">
div#thesite
{
  font-family   : "Open Sans", sans-serif;
  font-size     : 1em !important;
  margin-top    : 1em;
  margin-bottom : 1em;
}

div#thesite h1
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite h2
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite h3
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite h4
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite h5
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite h6
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite .ui.breadcrumb.rib .section
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite .header
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite .as-header
{
  font-family : "Roboto", sans-serif;
  line-height : 1.19999em;
}

div#thesite code, pre, tt
{
  font-family : "SFMono-Regular","Menlo","Monaco","Consolas","Liberation Mono","Courier New", monospace;
}

div#thesite .ui.breadcrumb.rib
{
  margin-bottom : 1em;
}



div#thesite .ui.comments.messages .comment .metadata a
{
  color : #808080;
}

div#thesite .ui.comments.messages .comment a.avatar img
{
  height : auto;
}

div#thesite .subtle
{
  color : #808080;
}


div#thesite .messages pre
{
  font-size : 85%;
  overflow  : auto;
  max-width : 100%;
}

div#thesite .messages .message_embed
{
  border-left  : solid 3px #808080;
  padding-left : 0.69999em;
}

div#thesite .messages .message_inline_image img
{
  max-width     : 100%;
  margin-bottom : 1em;
}


/* Generated with Clay, http://fvisser.nl/clay */</style><link href="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.4.1/semantic.min.css" rel="stylesheet"><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/all.min.css" rel="stylesheet"><link href="https://fonts.googleapis.com/css?family=Open+Sans|Oswald&amp;display=swap" rel="stylesheet"><link href="https://fonts.googleapis.com/css?family=Roboto|Open+Sans&amp;display=swap" rel="stylesheet"></head><body><div id="thesite" class="ui text container"><div class="ui violet inverted top attached center aligned segment"><h1 class="ui huge header">A new Route System? - Rib</h1></div><div class="ui attached segment"><div class="ui message"><p>Welcome to the Functional Programming Zulip Chat Archive. You can join the chat <a href="https://funprog.zulipchat.com">here</a>.</p></div><div class="ui breadcrumb rib"><a href="/" class="section">Home</a><i class="right angle icon divider"></i><a href="/rib/" class="section">#Rib</a><i class="right angle icon divider"></i><div class="active section">A new Route System?</div></div><div class="ui comments messages"><div class="comment"><a class="avatar"><img src="https://secure.gravatar.com/avatar/82ab26323f4fd06d4556f0132f85a3f1?d=identicon&amp;version=1"></a><div class="content"><a class="author">Christian Kalhauge</a><div class="metadata"><a href="#194460699" name="194460699"><div>2020-04-17 15:48:17</div></a></div><div class="text"><p>I'm loving Rib so far! </p>
<p>But I have found the routing system a little confusing, and it does not really help with the biggest problem in <br>
static site generation (IMHO): broken links.</p>
<p>So I wrote a small mock up of a more type-safe version:</p>
<p><a href="https://github.com/kalhauge/rib-sample/commit/add34d528ed8dd4760c14ba7195be85495cc1ebc" title="https://github.com/kalhauge/rib-sample/commit/add34d528ed8dd4760c14ba7195be85495cc1ebc">https://github.com/kalhauge/rib-sample/commit/add34d528ed8dd4760c14ba7195be85495cc1ebc</a></p>
<p>If nothing else, I hope it can start a discussion :)</p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/kalhauge/rib-sample/commit/add34d528ed8dd4760c14ba7195be85495cc1ebc" style="background-image: url(https://avatars3.githubusercontent.com/u/1182166?s=400&amp;v=4)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/kalhauge/rib-sample/commit/add34d528ed8dd4760c14ba7195be85495cc1ebc" title="Trying out a new Route system. · kalhauge/rib-sample@add34d5">Trying out a new Route system. · kalhauge/rib-sample@add34d5</a></div><div class="message_embed_description">The goal here is make the routes type-safe.  This means that if a route
exist in the runtime code, that route will be populated on the server,
or the server will throw an error.  Routes are therefo...</div></div></div></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/4429aa8b689608f24a4ad712843ce29862e330d2?x=x&amp;version=2"></a><div class="content"><a class="author">Sridhar Ratnakumar</a><div class="metadata"><a href="#194464336" name="194464336"><div>2020-04-17 16:13:54</div></a></div><div class="text"><p>Cool. I'll take a look. How did you arrive at broken links with Rib.Route?</p></div></div></div><div class="comment"><a class="avatar"><img src="https://secure.gravatar.com/avatar/82ab26323f4fd06d4556f0132f85a3f1?d=identicon&amp;version=1"></a><div class="content"><a class="author">Christian Kalhauge</a><div class="metadata"><a href="#194468559" name="194468559"><div>2020-04-17 16:48:26</div></a></div><div class="text"><p>A Simple example is  I can write:</p>
<p>a_ [href_ (Rib.routeUrl (Route_Article "some_missing_post.md")]</p>
<p>Or with css files I often do something like: </p>
<p>a_ [href_  "/my-missing.css" ]</p>
<p>Ideally I would like a rref_ which guaranteed that the route existed.</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/4429aa8b689608f24a4ad712843ce29862e330d2?x=x&amp;version=2"></a><div class="content"><a class="author">Sridhar Ratnakumar</a><div class="metadata"><a href="#194468871" name="194468871"><div>2020-04-17 16:50:59</div></a></div><div class="text"><p>In your code, you are pre-creating these Route types, and passing it around to the renderer. Isn't that what already happens in rib-sample anyway? i.e., <code>Route_Index :: Route [(Route Pandoc, Pandoc)]</code> takes a list of pre-created routes to individual documents.</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/4429aa8b689608f24a4ad712843ce29862e330d2?x=x&amp;version=2"></a><div class="content"><a class="author">Sridhar Ratnakumar</a><div class="metadata"><a href="#194469108" name="194469108"><div>2020-04-17 16:52:46</div></a></div><div class="text"><p>The general (undocumented) convention I follow when designing routes is that I would <em>never</em> have to create custom routes (like <code>Route_Article "some_missing_post.md"</code>) outside of where the actual file is being processed (eg: <code>forEvery</code>). Once a route is created, I put them in places wherever they are needed (like <code>Route_Index</code>).</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/4429aa8b689608f24a4ad712843ce29862e330d2?x=x&amp;version=2"></a><div class="content"><a class="author">Sridhar Ratnakumar</a><div class="metadata"><a href="#194469406" name="194469406"><div>2020-04-17 16:54:47</div></a></div><div class="text"><p>But prohibiting the custom creation of routes will adversely affect some non-merely-a-static-site apps like neuron, which does create routes using custom data in places outside of Shake monad. Here's an example: <a href="https://github.com/srid/neuron/blob/719fb0bdaf01b8fb2bf0c9de9d3320f124f88e25/src/Neuron/Zettelkasten/Link/View.hs#L41" title="https://github.com/srid/neuron/blob/719fb0bdaf01b8fb2bf0c9de9d3320f124f88e25/src/Neuron/Zettelkasten/Link/View.hs#L41">https://github.com/srid/neuron/blob/719fb0bdaf01b8fb2bf0c9de9d3320f124f88e25/src/Neuron/Zettelkasten/Link/View.hs#L41</a></p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/srid/neuron/blob/719fb0bdaf01b8fb2bf0c9de9d3320f124f88e25/src/Neuron/Zettelkasten/Link/View.hs#L41" style="background-image: url(https://avatars2.githubusercontent.com/u/3998?s=400&amp;v=4)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/srid/neuron/blob/719fb0bdaf01b8fb2bf0c9de9d3320f124f88e25/src/Neuron/Zettelkasten/Link/View.hs#L41" title="srid/neuron">srid/neuron</a></div><div class="message_embed_description">Haskell meets Zettelkasten, for your plain-text delight. - srid/neuron</div></div></div></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/4429aa8b689608f24a4ad712843ce29862e330d2?x=x&amp;version=2"></a><div class="content"><a class="author">Sridhar Ratnakumar</a><div class="metadata"><a href="#194469939" name="194469939"><div>2020-04-17 16:58:11</div></a></div><div class="text"><p>Regarding the new way of rendering ... IIUC, since your renderer doesn't take a route as an argument, it doesn't seem possible to render parts of the HTML based on the route? For example, how would you do this case block? <a href="https://github.com/srid/neuron/blob/719fb0bdaf01b8fb2bf0c9de9d3320f124f88e25/src/Neuron/Web/View.hs#L87-L90" title="https://github.com/srid/neuron/blob/719fb0bdaf01b8fb2bf0c9de9d3320f124f88e25/src/Neuron/Web/View.hs#L87-L90">https://github.com/srid/neuron/blob/719fb0bdaf01b8fb2bf0c9de9d3320f124f88e25/src/Neuron/Web/View.hs#L87-L90</a></p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/srid/neuron/blob/719fb0bdaf01b8fb2bf0c9de9d3320f124f88e25/src/Neuron/Web/View.hs#L87-L90" style="background-image: url(https://avatars2.githubusercontent.com/u/3998?s=400&amp;v=4)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/srid/neuron/blob/719fb0bdaf01b8fb2bf0c9de9d3320f124f88e25/src/Neuron/Web/View.hs#L87-L90" title="srid/neuron">srid/neuron</a></div><div class="message_embed_description">Haskell meets Zettelkasten, for your plain-text delight. - srid/neuron</div></div></div></div></div></div><div class="comment"><a class="avatar"><img src="https://secure.gravatar.com/avatar/82ab26323f4fd06d4556f0132f85a3f1?d=identicon&amp;version=1"></a><div class="content"><a class="author">Christian Kalhauge</a><div class="metadata"><a href="#194469938" name="194469938"><div>2020-04-17 16:58:11</div></a></div><div class="text"><p>Yes, but the code is made so that you can newer create a Route without also specifying how to generate the text for said route.</p>
<div class="codehilite"><pre><span></span>makeRoute ::
  Path Rel File
  -- | The relative name of the route
  -&gt; (s -&gt; Action TL.Text)
  -- | The action required to make the route
  -&gt; SiteGen s Route
</pre></div></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/4429aa8b689608f24a4ad712843ce29862e330d2?x=x&amp;version=2"></a><div class="content"><a class="author">Sridhar Ratnakumar</a><div class="metadata"><a href="#194470091" name="194470091"><div>2020-04-17 16:59:31</div></a></div><div class="text"><blockquote>
<p>Yes, but the code is made so that you can newer create a Route without also specifying how to generate the text for said route.</p>
</blockquote>
<p>Yes, but like I said in that code you <em>can never</em> create a custom/dynamic route <strong>either</strong> (which prevents apps like neuron from being possible). For example, how would you do this (from anywhere)? <a href="https://github.com/srid/neuron/blob/719fb0bdaf01b8fb2bf0c9de9d3320f124f88e25/src/Neuron/Zettelkasten/Link/View.hs#L41" title="https://github.com/srid/neuron/blob/719fb0bdaf01b8fb2bf0c9de9d3320f124f88e25/src/Neuron/Zettelkasten/Link/View.hs#L41">https://github.com/srid/neuron/blob/719fb0bdaf01b8fb2bf0c9de9d3320f124f88e25/src/Neuron/Zettelkasten/Link/View.hs#L41</a></p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/srid/neuron/blob/719fb0bdaf01b8fb2bf0c9de9d3320f124f88e25/src/Neuron/Zettelkasten/Link/View.hs#L41" style="background-image: url(https://avatars2.githubusercontent.com/u/3998?s=400&amp;v=4)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/srid/neuron/blob/719fb0bdaf01b8fb2bf0c9de9d3320f124f88e25/src/Neuron/Zettelkasten/Link/View.hs#L41" title="srid/neuron">srid/neuron</a></div><div class="message_embed_description">Haskell meets Zettelkasten, for your plain-text delight. - srid/neuron</div></div></div></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/4429aa8b689608f24a4ad712843ce29862e330d2?x=x&amp;version=2"></a><div class="content"><a class="author">Sridhar Ratnakumar</a><div class="metadata"><a href="#194470323" name="194470323"><div>2020-04-17 17:00:39</div></a></div><div class="text"><p>By the way, <code>renderZettelLink</code> is not used in renderer. (It is being called from the MMark extension runner)</p></div></div></div><div class="comment"><a class="avatar"><img src="https://secure.gravatar.com/avatar/82ab26323f4fd06d4556f0132f85a3f1?d=identicon&amp;version=1"></a><div class="content"><a class="author">Christian Kalhauge</a><div class="metadata"><a href="#194470689" name="194470689"><div>2020-04-17 17:03:40</div></a></div><div class="text"><p>Sorry I cant write this fast :) </p>
<p>I believe that your View could be fixed with a global map with all the routes to all the Zettles, this way it would break if the zettle does not exist.</p>
<p>The second part is the cool part of the structure of the (SiteGen s s) monad.</p>
<p>The s is the Site in my code, and each rendered route have the ability to access the Site and all the available routes in the Site.</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/4429aa8b689608f24a4ad712843ce29862e330d2?x=x&amp;version=2"></a><div class="content"><a class="author">Sridhar Ratnakumar</a><div class="metadata"><a href="#194471131" name="194471131"><div>2020-04-17 17:06:44</div></a></div><div class="text"><blockquote>
<p>I believe that your View could be fixed with a global map with all the routes to all the Zettles, this way it would break if the zettle does not exist.</p>
</blockquote>
<p>That's indeed doable, but then the MMark extension would no longer be decoupled from the Site rendering types (and its global map). Right now, it only needs to couple with the route GADT (which is a small type, that only describes the routes).</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/4429aa8b689608f24a4ad712843ce29862e330d2?x=x&amp;version=2"></a><div class="content"><a class="author">Sridhar Ratnakumar</a><div class="metadata"><a href="#194471410" name="194471410"><div>2020-04-17 17:08:41</div></a></div><div class="text"><p>By the way,</p>
<blockquote>
<p>Yes, but the code is made so that you can newer create a Route without also specifying how to generate the text for said route.</p>
</blockquote>
<p>If you put <code>Route</code> and the <code>generateSite</code> in Internal.hs (routes can only be created in this module), then wouldn't that solve the problem equally?</p></div></div></div><div class="comment"><a class="avatar"><img src="https://secure.gravatar.com/avatar/82ab26323f4fd06d4556f0132f85a3f1?d=identicon&amp;version=1"></a><div class="content"><a class="author">Christian Kalhauge</a><div class="metadata"><a href="#194471543" name="194471543"><div>2020-04-17 17:09:53</div></a></div><div class="text"><p>Something like this:</p>
<div class="codehilite"><pre><span></span>renderZettelLink :: forall m. Monad m =&gt; Map ZettleID Route -&gt;  LinkTheme -&gt; ZettelStore -&gt; ZettelID -&gt; HtmlT m ()
renderZettelLink routes ltheme store zid = do
  let Zettel {..} = lookupStore zid store
      zurl =  routes Map.! zid
</pre></div>


<p>Your <code>Map ZettleID Route</code> would be part of the <code>Site</code> mentioned before, For example:</p>
<div class="codehilite"><pre><span></span>generateSite :: SiteGen (Map ZettleID Route)  (Map ZettleID Route)
generateSite = do
  Map.fromList &lt;$&gt; forEach [&quot;*.zettle&quot;] \zettle -&gt; do
    let zid = idFromZettlePaht zettle
    r &lt;-  makeRoute zettle $ \(routeMap :: Map ZettleId Route) -&gt;  (... render ...)
    pure (zid, r)
</pre></div></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/4429aa8b689608f24a4ad712843ce29862e330d2?x=x&amp;version=2"></a><div class="content"><a class="author">Sridhar Ratnakumar</a><div class="metadata"><a href="#194471613" name="194471613"><div>2020-04-17 17:10:04</div></a></div><div class="text"><p>Actually, <code>generateSite</code> and <code>rref</code> in Internal.hs; and not using <code>routeUrl</code> outside of Internal.hs</p></div></div></div><div class="comment"><a class="avatar"><img src="https://secure.gravatar.com/avatar/82ab26323f4fd06d4556f0132f85a3f1?d=identicon&amp;version=1"></a><div class="content"><a class="author">Christian Kalhauge</a><div class="metadata"><a href="#194471817" name="194471817"><div>2020-04-17 17:11:42</div></a></div><div class="text"><blockquote>
<p>If you put Route and the generateSite in Internal.hs (routes can only be created in this module), then wouldn't that solve the problem equally?</p>
</blockquote>
<p>I want to protect me against me. That is the biggest problem :)</p></div></div></div><div class="comment"><a class="avatar"><img src="https://secure.gravatar.com/avatar/82ab26323f4fd06d4556f0132f85a3f1?d=identicon&amp;version=1"></a><div class="content"><a class="author">Christian Kalhauge</a><div class="metadata"><a href="#194472312" name="194472312"><div>2020-04-17 17:14:47</div></a></div><div class="text"><blockquote>
<p>That's indeed doable, but then the MMark extension would no longer be decoupled from the Site rendering types (and its global map). Right now, it only needs to couple with the route GADT (which is a small type, that only describes the routes).</p>
</blockquote>
<p>One could argue that the coupling with the GADT is worse, and adding a map from ZettleIDs to a Rib defined Route</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/4429aa8b689608f24a4ad712843ce29862e330d2?x=x&amp;version=2"></a><div class="content"><a class="author">Sridhar Ratnakumar</a><div class="metadata"><a href="#194472666" name="194472666"><div>2020-04-17 17:17:43</div></a></div><div class="text"><blockquote>
<p><code>renderZettelLink :: forall m. Monad m =&gt; Map ZettleID Route -&gt;  LinkTheme -&gt; ZettelStore -&gt; ZettelID -&gt; HtmlT m ()</code></p>
</blockquote>
<p>And you'd have to pass <code>Map ZettleID Route</code> all over the project (or use a <code>Reader</code>).  I find that to be very inconvenient, not to mention for very little benefit; while <code>Map.!</code> will fail as one would expect (in your design), the current <code>lookupStore</code> already does this anyway (with no need for passing global values around).</p>
<blockquote>
<p>One could argue that the coupling with the GADT is worse, and adding a map from ZettleIDs to a Rib defined Route</p>
</blockquote>
<p>I don't see that. The route GADT specifies the routes possible. Your <code>Map ZettelID Route</code> includes route type, but now every place where route is created is forced to verify that the route exists, when that could happen only in the renderer (for eg., <code>rref</code> could error out if it is not in the registry or something).</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/4429aa8b689608f24a4ad712843ce29862e330d2?x=x&amp;version=2"></a><div class="content"><a class="author">Sridhar Ratnakumar</a><div class="metadata"><a href="#194472883" name="194472883"><div>2020-04-17 17:19:37</div></a></div><div class="text"><blockquote>
<p>I want to protect me against me. That is the biggest problem <span aria-label="slight smile" class="emoji emoji-1f642" role="img" title="slight smile">:slight_smile:</span></p>
</blockquote>
<p>How would your approach compare, in that regard, against this: putting <code>generateSite</code> and <code>rref</code> in Internal.hs; and not using <code>Rib.routeUrl</code> outside of Internal.hs?</p>
<p>You get to pass routes to renderers (which is not possible in your approach): <a href="#narrow/stream/218047-Rib/topic/A.20new.20Route.20System.3F/near/194469939" title="#narrow/stream/218047-Rib/topic/A.20new.20Route.20System.3F/near/194469939">https://funprog.zulipchat.com/#narrow/stream/218047-Rib/topic/A.20new.20Route.20System.3F/near/194469939</a></p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/4429aa8b689608f24a4ad712843ce29862e330d2?x=x&amp;version=2"></a><div class="content"><a class="author">Sridhar Ratnakumar</a><div class="metadata"><a href="#194473382" name="194473382"><div>2020-04-17 17:23:21</div></a></div><div class="text"><blockquote>
<p>putting <code>generateSite</code> and <code>rref</code> in Internal.hs; and not using <code>Rib.routeUrl</code> outside of Internal.hs?</p>
</blockquote>
<p>Oh, actually, that won't work. Nevermind. But renderer problem still remains.</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/4429aa8b689608f24a4ad712843ce29862e330d2?x=x&amp;version=2"></a><div class="content"><a class="author">Sridhar Ratnakumar</a><div class="metadata"><a href="#194473832" name="194473832"><div>2020-04-17 17:26:48</div></a></div><div class="text"><p>Actually, we can achieve the same without <code>Map ZettelID Route</code>. Just put the route in the Zettel store. But, that level of protection has never been needed in practice in neuron.</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/4429aa8b689608f24a4ad712843ce29862e330d2?x=x&amp;version=2"></a><div class="content"><a class="author">Sridhar Ratnakumar</a><div class="metadata"><a href="#194475433" name="194475433"><div>2020-04-17 17:40:11</div></a></div><div class="text"><p>This discussion had me thinking about broken links. Correct me if I'm wrong; my conclusion is that - with the rib-sample design, it is impossible to have broken links as long as <code>Rib.routeUrl</code> is invoked only with route passed to <code>renderPage</code> or routes already in the GADT (i.e., no custom route is created outside generateSite). This should go into the rib documentation I think.</p>
<p>Your approach achieves the same goal, however with a significant limitation in the renderer (not being able to render parts of the page based on the route).</p></div></div></div><div class="comment"><a class="avatar"><img src="https://secure.gravatar.com/avatar/82ab26323f4fd06d4556f0132f85a3f1?d=identicon&amp;version=1"></a><div class="content"><a class="author">Christian Kalhauge</a><div class="metadata"><a href="#194476192" name="194476192"><div>2020-04-17 17:46:13</div></a></div><div class="text"><p>You write too fast :)</p>
<blockquote>
<p>Regarding the new way of rendering ... IIUC, since your renderer doesn't take a route as an argument, it doesn't seem possible to render parts of the HTML based on the route? For example, how would you do this case block? <a href="https://github.com/srid/neuron/blob/719fb0bdaf01b8fb2bf0c9de9d3320f124f88e25/src/Neuron/Web/View.hs#L87-L90" title="https://github.com/srid/neuron/blob/719fb0bdaf01b8fb2bf0c9de9d3320f124f88e25/src/Neuron/Web/View.hs#L87-L90">https://github.com/srid/neuron/blob/719fb0bdaf01b8fb2bf0c9de9d3320f124f88e25/src/Neuron/Web/View.hs#L87-L90</a></p>
</blockquote>
<p>I think that My Idea is that you choose your rendering during the creation phase. </p>
<p>Forexample you could  write <br>
<code>renderRouteRedirectHead</code></p>
<p>You could as well add a boolean to the render to inform it weather  to redirect or not. <br>
You could also keep your routes routes as an extra argument to the render.</p>
<p>Or you could change the <code>Page</code> construct I use to have a <code>pageRedirect</code> field or <br>
be a union type?</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/4429aa8b689608f24a4ad712843ce29862e330d2?x=x&amp;version=2"></a><div class="content"><a class="author">Sridhar Ratnakumar</a><div class="metadata"><a href="#194477403" name="194477403"><div>2020-04-17 17:54:19</div></a></div><div class="text"><p>Neuron is a relatively complex app, but here's a simple one that uses the Route GADT to its full extent. <a href="https://github.com/srid/zulip-archive/blob/master/src/Main.hs" title="https://github.com/srid/zulip-archive/blob/master/src/Main.hs">https://github.com/srid/zulip-archive/blob/master/src/Main.hs</a> </p>
<p>I guess if you try to implement your approach in zulip-archive, the value of GADTs might become obvious :-D One thing I'd like to point out is that <code>Rib.Route</code> should always remain an optional feature in rib. But I wonder why you were not able to use <code>Rib.Shake</code> (without copying its fuctions) in your code. </p>
<p>By the way, Rib.Route is based on <a href="https://old.reddit.com/r/haskell/comments/fsgqd6/monthly_hask_anything_april_2020/fm6esky/?context=3" title="https://old.reddit.com/r/haskell/comments/fsgqd6/monthly_hask_anything_april_2020/fm6esky/?context=3">obelisk-route</a>.</p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/srid/zulip-archive/blob/master/src/Main.hs" style="background-image: url(https://avatars2.githubusercontent.com/u/3998?s=400&amp;v=4)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/srid/zulip-archive/blob/master/src/Main.hs" title="srid/zulip-archive">srid/zulip-archive</a></div><div class="message_embed_description">Zulip Archive viewer (statically generated HTML). Contribute to srid/zulip-archive development by creating an account on GitHub.</div></div></div><div class="message_embed"><a class="message_embed_image" href="https://old.reddit.com/r/haskell/comments/fsgqd6/monthly_hask_anything_april_2020/fm6esky/?context=3" style="background-image: url(https://www.redditstatic.com/new-icon.png)"></a><div class="data-container"><div class="message_embed_title"><a href="https://old.reddit.com/r/haskell/comments/fsgqd6/monthly_hask_anything_april_2020/fm6esky/?context=3" title="Monthly Hask Anything (April 2020)">Monthly Hask Anything (April 2020)</a></div><div class="message_embed_description">data FrontendRoute :: * -&gt; * where FrontendRoute_Sub :: FrontendRoute (R SubRoute) data SubRoute :: * -&gt; * where SubRoute_Foo ::...</div></div></div></div></div></div><div class="comment"><a class="avatar"><img src="https://secure.gravatar.com/avatar/82ab26323f4fd06d4556f0132f85a3f1?d=identicon&amp;version=1"></a><div class="content"><a class="author">Christian Kalhauge</a><div class="metadata"><a href="#194480854" name="194480854"><div>2020-04-17 18:21:27</div></a></div><div class="text"><blockquote>
<p>I guess if you try to implement your approach in zulip-archive, the value of GADTs might become obvious :-D One thing I'd like to point out is that Rib.Route should always remain an optional feature in rib.</p>
</blockquote>
<p>I think that the main difference we have is my requirement that I want every Route to be a <em>real</em> route, <br>
where you want the Route to encode information. I believe these two requirements might be orthogonal, and might be combined?</p>
<blockquote>
<p>But I wonder why you were not able to use Rib.Shake (without copying its fuctions) in your code. </p>
</blockquote>
<p>Some of the problems where that I used the custom Monad, the other was that you recently changed out of using the Path library <br>
and I prototyped  with it.</p></div></div></div><div class="comment"><a class="avatar"><img src="https://secure.gravatar.com/avatar/82ab26323f4fd06d4556f0132f85a3f1?d=identicon&amp;version=1"></a><div class="content"><a class="author">Christian Kalhauge</a><div class="metadata"><a href="#194481813" name="194481813"><div>2020-04-17 18:29:23</div></a></div><div class="text"><p>We could redesign the Route so that it can contain the GADT route?</p>
<div class="codehilite"><pre><span></span>data Route a =  Route
  { routeBaseUrl :: Path Rel Dir
  , routeConfig :: a
  }

makeRoute :: IsRoute a =&gt; Route a -&gt; (s -&gt; a -&gt; Action Text) -&gt; SiteGen s (Route a)
</pre></div></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/4429aa8b689608f24a4ad712843ce29862e330d2?x=x&amp;version=2"></a><div class="content"><a class="author">Sridhar Ratnakumar</a><div class="metadata"><a href="#194482248" name="194482248"><div>2020-04-17 18:32:28</div></a></div><div class="text"><p>The "a" in <code>Route a</code> is the value used to render the HTML (or whatever) file for that route. This is why functions (and this includes <code>Rib.routeUrl</code>) which need <em>only</em> the route take <code>Route a</code> as their argument (eg from zulip-archive: <code>routeName</code>, <code>routeCrumbs</code>, etc.), whereas functions that need the value as well would take both <code>Route a</code> and <code>a</code> (eg: <code>renderPage</code>).</p>
<p>Using GADT makes the later kinds of function possible, because the type of <code>a</code> is unified with the specific route passed.</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/4429aa8b689608f24a4ad712843ce29862e330d2?x=x&amp;version=2"></a><div class="content"><a class="author">Sridhar Ratnakumar</a><div class="metadata"><a href="#194482521" name="194482521"><div>2020-04-17 18:34:48</div></a></div><div class="text"><blockquote>
<p><code>(s -&gt; a -&gt; Action Text) </code></p>
</blockquote>
<ul>
<li>I think <code>s ~ a</code></li>
<li>This render function still doesn't know the route associated with <code>a</code>. You'd have to explicitly pass it. But what would you pass?</li>
</ul></div></div></div><div class="comment"><a class="avatar"><img src="https://secure.gravatar.com/avatar/82ab26323f4fd06d4556f0132f85a3f1?d=identicon&amp;version=1"></a><div class="content"><a class="author">Christian Kalhauge</a><div class="metadata"><a href="#194482573" name="194482573"><div>2020-04-17 18:35:09</div></a></div><div class="text"><p>Is there any point in your code where you don't define the route and render the route in the same line?</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/4429aa8b689608f24a4ad712843ce29862e330d2?x=x&amp;version=2"></a><div class="content"><a class="author">Sridhar Ratnakumar</a><div class="metadata"><a href="#194482640" name="194482640"><div>2020-04-17 18:35:44</div></a></div><div class="text"><p>What do you mean by 'define the route'?</p></div></div></div><div class="comment"><a class="avatar"><img src="https://secure.gravatar.com/avatar/82ab26323f4fd06d4556f0132f85a3f1?d=identicon&amp;version=1"></a><div class="content"><a class="author">Christian Kalhauge</a><div class="metadata"><a href="#194482868" name="194482868"><div>2020-04-17 18:37:33</div></a></div><div class="text"><p><span class="user-mention silent" data-user-id="251311">Sridhar Ratnakumar</span> <a href="#narrow/stream/218047-Rib/topic/A.20new.20Route.20System.3F/near/194482248" title="#narrow/stream/218047-Rib/topic/A.20new.20Route.20System.3F/near/194482248">said</a>:</p>
<blockquote>
<p>The "a" in <code>Route a</code> is the value used to render the HTML (or whatever) file for that route. This is why functions (and this includes <code>Rib.routeUrl</code>) which need <em>only</em> the route take <code>Route a</code> as their argument (eg from zulip-archive: <code>routeName</code>, <code>routeCrumbs</code>, etc.), whereas functions that need the value as well would take both <code>Route a</code> and <code>a</code> (eg: <code>renderPage</code>).</p>
</blockquote>
<p>Uh.. In my example I mean that you would have to define an extra <code>GADTRoute x</code> that instatciate <code>IsRoute</code>.</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/4429aa8b689608f24a4ad712843ce29862e330d2?x=x&amp;version=2"></a><div class="content"><a class="author">Sridhar Ratnakumar</a><div class="metadata"><a href="#194483018" name="194483018"><div>2020-04-17 18:38:58</div></a></div><div class="text"><p>I was only explaining the <code>Route a</code> from zulip-archive/rib-sample/neuron</p></div></div></div><div class="comment"><a class="avatar"><img src="https://secure.gravatar.com/avatar/82ab26323f4fd06d4556f0132f85a3f1?d=identicon&amp;version=1"></a><div class="content"><a class="author">Christian Kalhauge</a><div class="metadata"><a href="#194483397" name="194483397"><div>2020-04-17 18:42:27</div></a></div><div class="text"><p><span class="user-mention silent" data-user-id="251311">Sridhar Ratnakumar</span> <a href="#narrow/stream/218047-Rib/topic/A.20new.20Route.20System.3F/near/194482640" title="#narrow/stream/218047-Rib/topic/A.20new.20Route.20System.3F/near/194482640">said</a>:</p>
<blockquote>
<p>What do you mean by 'define the route'?</p>
</blockquote>
<p>In your code you create a new Route <code>let r = Route_Article srcPath</code>, right before you render it:  <code>writeHtmlRoute r doc</code>:</p>
<div class="codehilite"><pre><span></span>    Rib.forEvery [&quot;*.md&quot;] $ \srcPath -&gt; do
      let r = Route_Article srcPath
      doc &lt;- Pandoc.parse Pandoc.readMarkdown srcPath
      writeHtmlRoute r doc
      pure (r, doc)
  writeHtmlRoute Route_Index articles
</pre></div>


<p>We could refactor this, by defining </p>
<div class="codehilite"><pre><span></span>writeHtmlRouteArticle doc
</pre></div>


<p>and</p>
<div class="codehilite"><pre><span></span>writeHtmlRouteIndex article
</pre></div></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/4429aa8b689608f24a4ad712843ce29862e330d2?x=x&amp;version=2"></a><div class="content"><a class="author">Sridhar Ratnakumar</a><div class="metadata"><a href="#194483787" name="194483787"><div>2020-04-17 18:46:14</div></a></div><div class="text"><p>Right; the route is generally created and rendered nearby. And the created route is put back in the <code>a</code> of any other route that uses it (like the index route).</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/4429aa8b689608f24a4ad712843ce29862e330d2?x=x&amp;version=2"></a><div class="content"><a class="author">Sridhar Ratnakumar</a><div class="metadata"><a href="#194483880" name="194483880"><div>2020-04-17 18:47:12</div></a></div><div class="text"><p>So you store routes (with or without their <code>a</code>) as first class values in the <code>a</code> of other routes (exactly what happens with <code>Route_Index</code>). They are generally not created elsewhere (zulip-archive is an exception)</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/4429aa8b689608f24a4ad712843ce29862e330d2?x=x&amp;version=2"></a><div class="content"><a class="author">Sridhar Ratnakumar</a><div class="metadata"><a href="#194484098" name="194484098"><div>2020-04-17 18:48:57</div></a></div><div class="text"><blockquote>
<p>They are generally not created elsewhere</p>
</blockquote>
<p>Except when you do something like <code>Rib.routeUrl Route_Index</code> which is always a safe thing  (but <code>Rib.routeUrl $ Route_Article undefined</code> is not; that's always created before, and never created again)</p></div></div></div><div class="comment"><a class="avatar"><img src="https://secure.gravatar.com/avatar/82ab26323f4fd06d4556f0132f85a3f1?d=identicon&amp;version=1"></a><div class="content"><a class="author">Christian Kalhauge</a><div class="metadata"><a href="#194484116" name="194484116"><div>2020-04-17 18:49:10</div></a></div><div class="text"><p>Or factoring out the case analysis: </p>
<div class="codehilite"><pre><span></span>-- | Define your site HTML here
renderPage :: Route a -&gt; a -&gt; Html ()
renderPage route val = html_ [lang_ &quot;en&quot;] $ do
  head_ $ do
    meta_ [httpEquiv_ &quot;Content-Type&quot;, content_ &quot;text/html; charset=utf-8&quot;]
    title_ routeTitle
    style_ [type_ &quot;text/css&quot;] $ C.render pageStyle
  body_ $ do
    div_ [class_ &quot;header&quot;] $
      a_ [href_ &quot;/&quot;] &quot;Back to Home&quot;
    h1_ routeTitle
    case route of
      Route_Index -&gt;
        div_ $ forM_ val $ \(r, src) -&gt;
          li_ [class_ &quot;pages&quot;] $ do
            let meta = getMeta src
            b_ $ a_ [href_ (Rib.routeUrl r)] $ toHtml $ title meta
            renderMarkdown `mapM_` description meta
      Route_Article _ -&gt;
        article_ $
          Pandoc.render val
  where
    routeTitle :: Html ()
    routeTitle = case route of
      Route_Index -&gt; &quot;Rib sample site&quot;
      Route_Article _ -&gt; toHtml $ title $ getMeta val
    renderMarkdown :: Text -&gt; Html ()
    renderMarkdown =
      Pandoc.render . Pandoc.parsePure Pandoc.readMarkdown
</pre></div>


<p>Becomes: </p>
<div class="codehilite"><pre><span></span> articles &lt;-
    Rib.forEvery [&quot;*.md&quot;] $ \srcPath -&gt; do
      let r = Route_Article srcPath
      doc &lt;- Pandoc.parse Pandoc.readMarkdown srcPath
      writeHtmlRoute ( toHtml $ title $ getMeta doc) $ do
        article_ $ Pandoc.render doc
      pure (r, doc)
  writeHtmlRoute &quot;Rib sample site&quot; $ do
        div_ $ forM_ val $ \(r, src) -&gt;
          li_ [class_ &quot;pages&quot;] $ do
            let meta = getMeta src
            b_ $ a_ [href_ (Rib.routeUrl r)] $ toHtml $ title meta
            renderMarkdown `mapM_` description meta

-- | Define your site HTML here
renderPage : Html () -&gt; Html () -&gt; Html ()
renderPage routeTitle body = html_ [lang_ &quot;en&quot;] $ do
  head_ $ do
    meta_ [httpEquiv_ &quot;Content-Type&quot;, content_ &quot;text/html; charset=utf-8&quot;]
    title_ routeTitle
    style_ [type_ &quot;text/css&quot;] $ C.render pageStyle
  body_ $ do
    div_ [class_ &quot;header&quot;] $
      a_ [href_ &quot;/&quot;] &quot;Back to Home&quot;
    h1_ routeTitle
   body


renderMarkdown :: Text -&gt; Html ()
renderMarkdown =
  Pandoc.render . Pandoc.parsePure Pandoc.readMarkdown
</pre></div></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/4429aa8b689608f24a4ad712843ce29862e330d2?x=x&amp;version=2"></a><div class="content"><a class="author">Sridhar Ratnakumar</a><div class="metadata"><a href="#194484248" name="194484248"><div>2020-04-17 18:50:12</div></a></div><div class="text"><p>That's gonna get unwieldy real fast the more complex your layout becomes. Instead of HTML being defined nicely in one place, it is now spread across!</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/4429aa8b689608f24a4ad712843ce29862e330d2?x=x&amp;version=2"></a><div class="content"><a class="author">Sridhar Ratnakumar</a><div class="metadata"><a href="#194484358" name="194484358"><div>2020-04-17 18:51:07</div></a></div><div class="text"><p>Not to mention, if you want to render your <code>&lt;head&gt;</code> dependent on route, your <code>renderPage</code> will now take both a custom body and a custom head. And what about breadcrumbs? Then it would take a <em>third</em> HTML.</p></div></div></div><div class="comment"><a class="avatar"><img src="https://secure.gravatar.com/avatar/82ab26323f4fd06d4556f0132f85a3f1?d=identicon&amp;version=1"></a><div class="content"><a class="author">Christian Kalhauge</a><div class="metadata"><a href="#194484792" name="194484792"><div>2020-04-17 18:54:39</div></a></div><div class="text"><p>I can see that :). However, I think that is design decision best left for the individual developer?</p>
<p>Where I think that safe routes would be useful for everybody?</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/4429aa8b689608f24a4ad712843ce29862e330d2?x=x&amp;version=2"></a><div class="content"><a class="author">Sridhar Ratnakumar</a><div class="metadata"><a href="#194485292" name="194485292"><div>2020-04-17 18:58:38</div></a></div><div class="text"><p><code>Rib.Route</code> is optional; people don't have to use it. In a way, <code>Rib.Shake</code> too is optional. You can always drop down to using nothing but <code>ribInputDir</code> and <code>ribOutputDir</code> (but still retain the core features of rib).</p>
<p>I think <code>Rib.Route</code> is good enough for static site generation. Your specific requirement of not shooting yourself in the foot (creating of broken links) can, in practice, be solved by the <code>Route a</code> design I explained above. In short, never use <code>Rib.routeUrl</code> with routes other than what's already in the <code>a</code>.</p></div></div></div><div class="comment"><a class="avatar"><img src="https://secure.gravatar.com/avatar/82ab26323f4fd06d4556f0132f85a3f1?d=identicon&amp;version=1"></a><div class="content"><a class="author">Christian Kalhauge</a><div class="metadata"><a href="#194486183" name="194486183"><div>2020-04-17 19:05:17</div></a></div><div class="text"><blockquote>
<p>In short, never use Rib.routeUrl with routes other than what's already in the a.</p>
</blockquote>
<p>Well this will only work if you only put valid routes in the <code>a</code>.  <br>
I, however,  rest my case :)</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/4429aa8b689608f24a4ad712843ce29862e330d2?x=x&amp;version=2"></a><div class="content"><a class="author">Sridhar Ratnakumar</a><div class="metadata"><a href="#194486792" name="194486792"><div>2020-04-17 19:10:42</div></a></div><div class="text"><p>Have you ever had that happen (put invalid routes) to you when using the rib-sample approach, though? You can create invalid routes like below, but it seems quite unlikely for a bug like this to come up.</p>
<div class="codehilite"><pre><span></span>    Rib.forEvery [&quot;*.md&quot;] $ \srcPath -&gt; do
      let r = Route_Article srcPath
      doc &lt;- Pandoc.parse Pandoc.readMarkdown srcPath
      writeHtmlRoute r doc
      let invalidR = Route_Article &quot;I don&#39;t exist&quot;
      pure (invalidR, doc)
  writeHtmlRoute Route_Index articles
</pre></div></div></div></div><div class="comment"><a class="avatar"><img src="https://secure.gravatar.com/avatar/82ab26323f4fd06d4556f0132f85a3f1?d=identicon&amp;version=1"></a><div class="content"><a class="author">Christian Kalhauge</a><div class="metadata"><a href="#194505350" name="194505350"><div>2020-04-17 21:57:16</div></a></div><div class="text"><p>I mainly had problems with the static files, and with index files, like Route_Archive, or Route_Index, which <br>
I sometimes accidentally delete.</p></div></div></div><div class="comment"><a class="avatar"><img src="https://secure.gravatar.com/avatar/82ab26323f4fd06d4556f0132f85a3f1?d=identicon&amp;version=1"></a><div class="content"><a class="author">Christian Kalhauge</a><div class="metadata"><a href="#194506168" name="194506168"><div>2020-04-17 22:06:18</div></a></div><div class="text"><p>I can't stop thinking about it. Is there a reason why the GADT Route and the data have to be seperate, If you always <br>
create the route and render the data in the same location:</p>
<p>Why not join the data and the route?<br>
In this case I'll have another datatype called LocalUrl (which resemble my kind of Route).</p>
<div class="codehilite"><pre><span></span>data LocalUrl = ...

data Route =
  Route_Index  [(LocalUrl, Pandoc)]
  Route_Article  FilePath  Pandoc
</pre></div>


<p>Now we can get away from the higher order type constructs. <br>
This is almost the same code:</p>
<div class="codehilite"><pre><span></span>-- | Define your site HTML here
renderPage :: Route -&gt; Html ()
renderPage route  = html_ [lang_ &quot;en&quot;] $ do
  head_ $ do
    meta_ [httpEquiv_ &quot;Content-Type&quot;, content_ &quot;text/html; charset=utf-8&quot;]
    title_ routeTitle
    style_ [type_ &quot;text/css&quot;] $ C.render pageStyle
  body_ $ do
    div_ [class_ &quot;header&quot;] $
      a_ [href_ &quot;/&quot;] &quot;Back to Home&quot;
    h1_ routeTitle
    case route of
      Route_Index val -&gt;
        div_ $ forM_ val $ \(r, src) -&gt;
          li_ [class_ &quot;pages&quot;] $ do
            let meta = getMeta src
            b_ $ a_ [href_ (Rib.routeUrl r)] $ toHtml $ title meta
            renderMarkdown `mapM_` description meta
      Route_Article _ val -&gt;
        article_ $
          Pandoc.render val
  where
    routeTitle :: Html ()
    routeTitle = case route of
      Route_Index  _-&gt; &quot;Rib sample site&quot;
      Route_Article _ val -&gt; toHtml $ title $ getMeta val
    renderMarkdown :: Text -&gt; Html ()
    renderMarkdown =
      Pandoc.render . Pandoc.parsePure Pandoc.readMarkdown
</pre></div></div></div></div><div class="comment"><a class="avatar"><img src="https://secure.gravatar.com/avatar/82ab26323f4fd06d4556f0132f85a3f1?d=identicon&amp;version=1"></a><div class="content"><a class="author">Christian Kalhauge</a><div class="metadata"><a href="#194506564" name="194506564"><div>2020-04-17 22:11:51</div></a></div><div class="text"><p>I think the thing I'm trying to say Is that it seams like Route, in its current form, is more a data structure to <br>
help rendering over helping to route. </p>
<p>For example the extra type variable tells us nothing about the route except for what data that route <br>
took to be created. We can of cause add special new types wrappers around that data to make  it origin<br>
clear. That <code>Route Index != Route Archive</code>.</p></div></div></div><div class="comment"><a class="avatar"><img src="https://secure.gravatar.com/avatar/82ab26323f4fd06d4556f0132f85a3f1?d=identicon&amp;version=1"></a><div class="content"><a class="author">Christian Kalhauge</a><div class="metadata"><a href="#194507068" name="194507068"><div>2020-04-17 22:17:21</div></a></div><div class="text"><p>Anyhow, I really appricate you work on this project, and I hope that I have not wasted your time on this Idea. <br>
I really just like the Idea of having safe-by-construction routing :).  I can see that the added complexity might not be worth it.</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/4429aa8b689608f24a4ad712843ce29862e330d2?x=x&amp;version=2"></a><div class="content"><a class="author">Sridhar Ratnakumar</a><div class="metadata"><a href="#194507248" name="194507248"><div>2020-04-17 22:19:29</div></a></div><div class="text"><p>What's the definition of <code>LocalUrl</code>?</p></div></div></div><div class="comment"><a class="avatar"><img src="https://secure.gravatar.com/avatar/82ab26323f4fd06d4556f0132f85a3f1?d=identicon&amp;version=1"></a><div class="content"><a class="author">Christian Kalhauge</a><div class="metadata"><a href="#194507513" name="194507513"><div>2020-04-17 22:22:34</div></a></div><div class="text"><p>I just though I would call my kind of Route LocalUrl instead so we did not confuse the two concepts:</p>
<div class="codehilite"><pre><span></span>data LocalUrl = LocalUrl
  { urlBase :: FilePath
  , urlRest :: FilePath
  }
</pre></div></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/4429aa8b689608f24a4ad712843ce29862e330d2?x=x&amp;version=2"></a><div class="content"><a class="author">Sridhar Ratnakumar</a><div class="metadata"><a href="#194507521" name="194507521"><div>2020-04-17 22:22:47</div></a></div><div class="text"><p>Your <code>Route</code> type is not a route; it is more than a route. It would be appropriate to call it <code>Page</code>. Indeed , that's what rib used, and consequently route urls were just string (and not as type safe).  <a href="https://github.com/srid/rib-sample/pull/9/files#diff-f8f3412da88cd4806f23d59fe59ebc3bL32-L36" title="https://github.com/srid/rib-sample/pull/9/files#diff-f8f3412da88cd4806f23d59fe59ebc3bL32-L36">https://github.com/srid/rib-sample/pull/9/files#diff-f8f3412da88cd4806f23d59fe59ebc3bL32-L36</a></p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/srid/rib-sample/pull/9/files#diff-f8f3412da88cd4806f23d59fe59ebc3bL32-L36" style="background-image: url(https://avatars2.githubusercontent.com/u/3998?s=400&amp;v=4)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/srid/rib-sample/pull/9/files#diff-f8f3412da88cd4806f23d59fe59ebc3bL32-L36" title="Use the new Route type by srid · Pull Request #9 · srid/rib-sample">Use the new Route type by srid · Pull Request #9 · srid/rib-sample</a></div><div class="message_embed_description">For srid/rib#110</div></div></div></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/4429aa8b689608f24a4ad712843ce29862e330d2?x=x&amp;version=2"></a><div class="content"><a class="author">Sridhar Ratnakumar</a><div class="metadata"><a href="#194507738" name="194507738"><div>2020-04-17 22:25:41</div></a></div><div class="text"><p>So for all intents and purposes it is a String. Your type really is then:</p>
<div class="codehilite"><pre><span></span>data Page =
  Page_Index  [(FilePath, Pandoc)]
  Page_Article  FilePath  Pandoc
</pre></div>


<p>You can't use <code>Rib.routeUrl</code> here obviously.</p></div></div></div><div class="comment"><a class="avatar"><img src="https://secure.gravatar.com/avatar/82ab26323f4fd06d4556f0132f85a3f1?d=identicon&amp;version=1"></a><div class="content"><a class="author">Christian Kalhauge</a><div class="metadata"><a href="#194507904" name="194507904"><div>2020-04-17 22:27:48</div></a></div><div class="text"><blockquote>
<p>were just string (and not as type safe)</p>
</blockquote>
<p>I think that is my point, both of these approaches are not "type-safe", Strings because you can just create them, and GADT Routes because you can just create them.</p>
<p>The difference is that the GADT Routes are guaranteed to be formatted correctly, which increases the chance that it points to something, but does not gurantee it. </p>
<blockquote>
<p>So for all intents and purposes it is a String. Your type really is then:<br>
You can't use Rib.routeUrl here obviously.</p>
</blockquote>
<p>No, It's not just a string. It's a guarantee that the item in the end of the string exist :)</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/4429aa8b689608f24a4ad712843ce29862e330d2?x=x&amp;version=2"></a><div class="content"><a class="author">Sridhar Ratnakumar</a><div class="metadata"><a href="#194508000" name="194508000"><div>2020-04-17 22:28:47</div></a></div><div class="text"><p>Where would be that guarantee if I invoke <code>renderPage $ Page_Article "/does-not-exist" somePandocDoc</code>?</p></div></div></div><div class="comment"><a class="avatar"><img src="https://secure.gravatar.com/avatar/82ab26323f4fd06d4556f0132f85a3f1?d=identicon&amp;version=1"></a><div class="content"><a class="author">Christian Kalhauge</a><div class="metadata"><a href="#194508126" name="194508126"><div>2020-04-17 22:30:23</div></a></div><div class="text"><p>The Idea is to hide the implementation of LocalUrl from the user. <br>
The user can only get a LocalUrl from the makeLocalUrl (makeRoute) mentioned from before.</p></div></div></div><div class="comment"><a class="avatar"><img src="https://secure.gravatar.com/avatar/82ab26323f4fd06d4556f0132f85a3f1?d=identicon&amp;version=1"></a><div class="content"><a class="author">Christian Kalhauge</a><div class="metadata"><a href="#194508262" name="194508262"><div>2020-04-17 22:32:30</div></a></div><div class="text"><p>In this case the <code>filepath</code> of <code>Page_Article "/does-not-exist" somePandocDoc</code> <del>is never used</del><br>
is only used to encode the route, so I expect it to be something like: </p>
<div class="codehilite"><pre><span></span>lurl &lt;- makeLocalUrl (chageExtension filepath &quot;.html&quot; ) $ \s -&gt; renderPage (Page_article somePandocDoc)
</pre></div></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/4429aa8b689608f24a4ad712843ce29862e330d2?x=x&amp;version=2"></a><div class="content"><a class="author">Sridhar Ratnakumar</a><div class="metadata"><a href="#194508946" name="194508946"><div>2020-04-17 22:42:43</div></a></div><div class="text"><p>Like I said before, try implementing your approach in zulip-archive or neuron, and then I guess what I'm saying will become obvious. Show me a full real-world project that uses your types, and I can be convinced.</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/4429aa8b689608f24a4ad712843ce29862e330d2?x=x&amp;version=2"></a><div class="content"><a class="author">Sridhar Ratnakumar</a><div class="metadata"><a href="#194509027" name="194509027"><div>2020-04-17 22:44:26</div></a></div><div class="text"><p>It will have to satisfy the following:</p>
<ul>
<li>Be able to render in one place, with individual parts of the HTML rendered depending on the routes (including sub routes).<ul>
<li>Imagine being somewhere deep inside the DOM tree, and using <code>case</code>'ing on routes to render differently (this can happen either in <code>renderPage</code> or in some other function it uses)</li>
</ul>
</li>
<li>Allow creating values that say "this is the route to this page" (without necessarily requiring the data used to render it; for example I want to be able to create a route value for a particular zettel given only its ID, but without also requiring the Markdown document data), so as to be able to pass it around. This route value should be type-safe in that it can't be arbitrary string, but it has to point to the individual pages, so that the above <code>case</code>'ing can be done.</li>
</ul></div></div></div><div class="comment"><a class="avatar"><img src="https://secure.gravatar.com/avatar/82ab26323f4fd06d4556f0132f85a3f1?d=identicon&amp;version=1"></a><div class="content"><a class="author">Christian Kalhauge</a><div class="metadata"><a href="#194509367" name="194509367"><div>2020-04-17 22:50:09</div></a></div><div class="text"><p>I think I will be able to do a mock-up in zulip-archive without changing too much of the code. <br>
I'll see when I get time to hack on code again :).</p>
<p>Thank you again, for taking the time to discuss this with me!</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/4429aa8b689608f24a4ad712843ce29862e330d2?x=x&amp;version=2"></a><div class="content"><a class="author">Sridhar Ratnakumar</a><div class="metadata"><a href="#194509417" name="194509417"><div>2020-04-17 22:51:23</div></a></div><div class="text"><p>Actually neuron may be a better example, as zulip-archive uses it idiosyncratically</p></div></div></div><div class="comment"><a class="avatar"><img src="https://secure.gravatar.com/avatar/82ab26323f4fd06d4556f0132f85a3f1?d=identicon&amp;version=1"></a><div class="content"><a class="author">Christian Kalhauge</a><div class="metadata"><a href="#194509440" name="194509440"><div>2020-04-17 22:51:51</div></a></div><div class="text"><blockquote>
<p>This route value should be type-safe in that it can't be arbitrary string, but it has to point to the individual pages, so that the above case'ing can be done.</p>
</blockquote>
<p>Out of curiosity, Do you ever do case analysis on a route you are referencing?</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/4429aa8b689608f24a4ad712843ce29862e330d2?x=x&amp;version=2"></a><div class="content"><a class="author">Sridhar Ratnakumar</a><div class="metadata"><a href="#194509499" name="194509499"><div>2020-04-17 22:52:29</div></a></div><div class="text"><p>Yes, checkout the neuron source code. For example, <code>routeOpenGraph</code> function (but also the Web/View.hs module).</p></div></div></div><div class="comment"><a class="avatar"><img src="https://secure.gravatar.com/avatar/82ab26323f4fd06d4556f0132f85a3f1?d=identicon&amp;version=1"></a><div class="content"><a class="author">Christian Kalhauge</a><div class="metadata"><a href="#194510375" name="194510375"><div>2020-04-17 23:03:16</div></a></div><div class="text"><p>Am I wrong or are <code>routeOpenGraph</code> only run on the "rendered" route and not on any references?</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/4429aa8b689608f24a4ad712843ce29862e330d2?x=x&amp;version=2"></a><div class="content"><a class="author">Sridhar Ratnakumar</a><div class="metadata"><a href="#194510658" name="194510658"><div>2020-04-17 23:07:33</div></a></div><div class="text"><p>References? It is used only during rendering.</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/4429aa8b689608f24a4ad712843ce29862e330d2?x=x&amp;version=2"></a><div class="content"><a class="author">Sridhar Ratnakumar</a><div class="metadata"><a href="#194510718" name="194510718"><div>2020-04-17 23:08:04</div></a></div><div class="text"><p>But a route value  is not necessarily used only by rendering.</p></div></div></div><div class="comment"><a class="avatar"><img src="https://secure.gravatar.com/avatar/82ab26323f4fd06d4556f0132f85a3f1?d=identicon&amp;version=1"></a><div class="content"><a class="author">Christian Kalhauge</a><div class="metadata"><a href="#194511153" name="194511153"><div>2020-04-17 23:14:04</div></a></div><div class="text"><p>My point is that you only use the <code>a</code> part of the <code>Route store graph a</code> when rendering that exact route, <br>
newer when you in one route refer to another.</p></div></div></div><div class="comment"><a class="avatar"><img src="https://secure.gravatar.com/avatar/82ab26323f4fd06d4556f0132f85a3f1?d=identicon&amp;version=1"></a><div class="content"><a class="author">Christian Kalhauge</a><div class="metadata"><a href="#194511177" name="194511177"><div>2020-04-17 23:14:35</div></a></div><div class="text"><p>Anyway it's getting late for me. Nice chatting with you.</p></div></div></div><div class="comment"><a class="avatar"><img src="https://secure.gravatar.com/avatar/82ab26323f4fd06d4556f0132f85a3f1?d=identicon&amp;version=1"></a><div class="content"><a class="author">Christian Kalhauge</a><div class="metadata"><a href="#194538175" name="194538175"><div>2020-04-18 10:46:51</div></a></div><div class="text"><p>Hi again!</p>
<p>I think I might have made my case poorly yesterday, however, I spend the morning implementing the new <br>
route system in neuron. It was surprisingly easy. Extending your code were a breeze, much praise to you from here :).</p>
<p>I have made two commits, to show that the two approaches are orthogonal:</p>
<p>The first commit adds safe LocalUrl, with builtin guarantees that they exist, without changing the<br>
routing system.</p>
<p><a href="https://github.com/kalhauge/neuron/commit/640d8e3f235110e7a5a781dc829380bf0b640e6c" title="https://github.com/kalhauge/neuron/commit/640d8e3f235110e7a5a781dc829380bf0b640e6c">https://github.com/kalhauge/neuron/commit/640d8e3f235110e7a5a781dc829380bf0b640e6c</a></p>
<p>The second commit notices that a Route is only used in rendering that route, and is therefore always  present with  it's data. This means that we can embed the data in the route:</p>
<p><a href="https://github.com/kalhauge/neuron/commit/326113735953502dfbc699b8e137f8baeb36fb89" title="https://github.com/kalhauge/neuron/commit/326113735953502dfbc699b8e137f8baeb36fb89">https://github.com/kalhauge/neuron/commit/326113735953502dfbc699b8e137f8baeb36fb89</a></p>
<p>Both of these commits compile, but I have not tested them with a real website. I hope that this answers both your<br>
bullet points. 1) I have not changed the rendering, 2) Use the safe LocalUrl to refer to other pages. 2b) You newer <br>
really do <code>case</code>ing on references to other pages in Neuron, so I was not able to test that out. Most of the time I recon<br>
that you know what you are referencing.</p>
<p>I don't know if the safe LocalUrl makes sense in the context of Neuron because it the internal routing is pretty simple.</p>
<p>But after moving the LocalUrl to its own module <code>Rib.Site</code> , I think at least it would make a good module in Rib, for sites <br>
with more complex routes?</p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/kalhauge/neuron/commit/640d8e3f235110e7a5a781dc829380bf0b640e6c" style="background-image: url(https://avatars3.githubusercontent.com/u/1182166?s=400&amp;v=4)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/kalhauge/neuron/commit/640d8e3f235110e7a5a781dc829380bf0b640e6c" title="Add safe LocalUrl without changing Route Rendering · kalhauge/neuron@640d8e3">Add safe LocalUrl without changing Route Rendering · kalhauge/neuron@640d8e3</a></div><div class="message_embed_description">In this commit I try to do two things:

1) Define the LocalUrl and SiteGen functionality, in Rib.Site

2) Use it to enforce safe LocalUrl throughout the code-base.

To do 2, I have remove IsRoute f...</div></div></div><div class="message_embed"><a class="message_embed_image" href="https://github.com/kalhauge/neuron/commit/326113735953502dfbc699b8e137f8baeb36fb89" style="background-image: url(https://avatars3.githubusercontent.com/u/1182166?s=400&amp;v=4)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/kalhauge/neuron/commit/326113735953502dfbc699b8e137f8baeb36fb89" title="Remove the 'a' · kalhauge/neuron@3261137">Remove the 'a' · kalhauge/neuron@3261137</a></div><div class="message_embed_description">Now Routes are newer used for referencing, which means that they
are always available with their 'a'.

Embedding the 'a' in the Route is now trivial.</div></div></div></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/4429aa8b689608f24a4ad712843ce29862e330d2?x=x&amp;version=2"></a><div class="content"><a class="author">Sridhar Ratnakumar</a><div class="metadata"><a href="#194552144" name="194552144"><div>2020-04-18 16:15:54</div></a></div><div class="text"><p><span class="user-mention" data-user-id="282827">@Christian Kalhauge</span> I looked at your diffs. That's an improvement (to your original proposal), however you are still passing the <code>site</code> value (that represents the entirety of the static site) all over the code base. This is really bad. Why does a markdown extension, for example, need to know about the entire static site layout? This doesn't improve on <code>Rib.Route</code>; it is <em>worse</em> (and I don't buy the broken links argument). And the second diff also made the <code>Route</code> type ... <em>not</em> a route at all.</p>
<blockquote>
<p>But after moving the LocalUrl to its own module <code>Rib.Site</code> , I think at least it would make a good module in Rib, for sites with more complex routes?</p>
</blockquote>
<p>Do you have a demonstration of your <code>Rib.site</code> being more suitable than <code>Rib.Route</code> for more complex routes (those diffs to neuron do not demonstrate it; they only "complect" things, as Rich Hickey would say)? In any case, you can just make this a library, and put it in hackage under the name say <code>rib-site</code>.</p></div></div></div><div class="comment"><a class="avatar"><img src="https://secure.gravatar.com/avatar/82ab26323f4fd06d4556f0132f85a3f1?d=identicon&amp;version=1"></a><div class="content"><a class="author">Christian Kalhauge</a><div class="metadata"><a href="#194557545" name="194557545"><div>2020-04-18 18:26:04</div></a></div><div class="text"><p>Let me address your concerns in order:</p>
<blockquote>
<p>However you are still passing the site value (that represents the entirety of the static site) all over the code base. This is really bad. Why does a markdown extension, for example, need to know about the entire static site layout?</p>
</blockquote>
<p>I think it is the difference between explicit and implicit coupling. The markdown extension will need to have access to the Routes of the system, <br>
and can create all of them. The Site variable is an <em>explicit</em> reference to all routes of the system. We can, however, improve coupling and only <br>
allow the markdown to access the part of the site we really need:</p>
<div class="codehilite"><pre><span></span>class HasZettelLookup s where
  lookupZettel :: MonadFail m =&gt;  s -&gt; ZettelID -&gt; m LocalUrl

renderMarkdown :: HasZettelLookup s =&gt; s -&gt; ZettleID -&gt;  ... -&gt; Html ()
renderMarkdown s zid ... =
   ...
  url &lt;- lookupZettel s zid
   a_ [Rib.rref_ url ]
   ...
</pre></div>


<p>This markdown render makes it clear that it depends on a site that have a ZettelID lookup, <br>
this can then be implemented by the site. So, total decoupling. </p>
<blockquote>
<p>And the second diff also made the Route type ... not a route at all.</p>
</blockquote>
<p>I think this is my point. When you use the route as a route, and not as a page you never use the complex types, <br>
so instead you can use a simpler type as <code>LocalUrl</code> when you use them as routes, if you accept the cost of passing around the site.</p>
<blockquote>
<p>Do you have a demonstration of your Rib.site being more suitable than Rib.Route for more complex routes. </p>
</blockquote>
<p>I hope that the more complex routes could improve things like,</p>
<p>1) Routes that depend on the data. For example, it is common practice to add the hash of static files like JS <br>
and CSS files to the end of the filenames to improve Caching. For example <code>style.css -&gt; style-abef92031.css</code>. <br>
This would not be possible with a route system like yours.</p>
<p>2) Creating a SiteMap in the system is easier, because we know everything that can possibly be routed to.<br>
  I think this is an issue in <a href="https://github.com/srid/rib/issues/104" title="https://github.com/srid/rib/issues/104">https://github.com/srid/rib/issues/104</a>.</p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/srid/rib/issues/104" style="background-image: url(https://avatars2.githubusercontent.com/u/3998?s=400&amp;v=4)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/srid/rib/issues/104" title="Sitemap support · Issue #104 · srid/rib">Sitemap support · Issue #104 · srid/rib</a></div><div class="message_embed_description">See srid/zulip-archive#10 At minimum, have writeFileCached return the last modified time of the file.</div></div></div></div></div></div><div class="comment"><a class="avatar"><img src="https://secure.gravatar.com/avatar/82ab26323f4fd06d4556f0132f85a3f1?d=identicon&amp;version=1"></a><div class="content"><a class="author">Christian Kalhauge</a><div class="metadata"><a href="#194557724" name="194557724"><div>2020-04-18 18:30:53</div></a></div><div class="text"><p>I really enjoyed this exchange of Ideas but I get the feeling that I will not convince you :). I might just implement <code>rib-site</code> in the future on my own, but do let me know if you change your mind. In that case I would love to help you implement it in <code>Rib</code>. </p>
<p>Thanks again and keep the good work up on <code>Rib</code>.</p></div></div></div><div class="comment"><a class="avatar"><img src="https://zulip-avatars.s3.amazonaws.com/13896/4429aa8b689608f24a4ad712843ce29862e330d2?x=x&amp;version=2"></a><div class="content"><a class="author">Sridhar Ratnakumar</a><div class="metadata"><a href="#194564637" name="194564637"><div>2020-04-18 21:32:12</div></a></div><div class="text"><p>1) It would not be impossible.<br>
2) A sitemap is basically just a list of routes. Your Shake action, which generates these routes, can accumulate them (just as the article routes are accumulated for Route_Index in rib-sample) and generate the sitemap at the end.</p></div></div></div></div></div><div class="ui vertical footer segment"><a href="https://github.com/srid/zulip-archive">Powered by Haskell</a> | Questions? Contact <a href="https://www.srid.ca">srid</a></div></div></body></html>